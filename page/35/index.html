<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="思绪偶尔会在这里停留">
<meta property="og:type" content="website">
<meta property="og:title" content="超凡魔力">
<meta property="og:url" content="https://blog.chaofml.cn/page/35/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="思绪偶尔会在这里停留">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="个人博客、超凡魔力">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.chaofml.cn/page/35/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<title>超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/05/07/%E6%89%93%E5%8D%B0%E8%BE%93%E5%87%BA%EF%BC%88%E6%89%93%E5%BC%80%E4%B8%80%E4%B8%AA%E6%96%B0%E9%A1%B5%E9%9D%A2%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/07/%E6%89%93%E5%8D%B0%E8%BE%93%E5%87%BA%EF%BC%88%E6%89%93%E5%BC%80%E4%B8%80%E4%B8%AA%E6%96%B0%E9%A1%B5%E9%9D%A2%EF%BC%89/" class="post-title-link" itemprop="url">打印输出</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-07 12:12:00" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:00+00:00">2019-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="打印输出"><a href="#打印输出" class="headerlink" title="打印输出"></a>打印输出</h1><blockquote>
<p>今天接到一个奇葩的工作，要求打印出清单。我的想法是，直接生成一个html，然后打印。打开一个新页面使用window.open，但是打开了之后，内容如何传递过去呢？网上找到了答案。</p>
</blockquote>
<h2 id="相关参考"><a href="#相关参考" class="headerlink" title="相关参考"></a>相关参考</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shenba/archive/2009/08/16/1547429.html">参考1</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhouwenhong/p/3891212.html">参考2</a></p>
<p>下面的示例，演示了xtemplate、window.open的用法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">var newWin &#x3D; window.open();</span><br><span class="line"></span><br><span class="line">var tpl &#x3D; new Ext.XTemplate(</span><br><span class="line">	&#39;&lt;html&gt;&#39;,</span><br><span class="line">	&#39;&lt;head&gt;&#39;,</span><br><span class="line">	&#39;&lt;title&gt;&#123;meeting_name&#125;-预约费用清单&lt;&#x2F;title&gt;&#39;,</span><br><span class="line">	&#39;&lt;style&gt;&#39;,</span><br><span class="line">		&#39;body&#123;background: #eee;&#125;&#39;,</span><br><span class="line">		&#39;table&#123;width: 900px;text-align: center;margin: 0 auto;font-size: 18px;line-height: 35px;    border-collapse: collapse;&#125; &#39;,</span><br><span class="line">		&#39;.container&#123;width: 900px;height:1200px;  margin: 0 auto;   padding: 40px;background: white;&#125;&#39;,</span><br><span class="line">		&#39;.bottom div&#123;width: 32%;display: inline-block;font-size: 20px;padding: 20px 0;&#125;&#39;,</span><br><span class="line">		&#39;h1&#123;text-align: center;&#125;&#39;,</span><br><span class="line">	&#39;&lt;&#x2F;style&gt;&#39;,</span><br><span class="line">	&#39;&lt;&#x2F;head&gt;&#39;,</span><br><span class="line">	&#39;&lt;body&gt;&#39;,</span><br><span class="line">	&#39;&lt;div class&#x3D;&quot;container&quot;&gt;&#39;,</span><br><span class="line">		&#39;&lt;h1&gt;预约费用清单&lt;&#x2F;h1&gt;&#39;,</span><br><span class="line">		&#39;&lt;table border&#x3D;&quot;1&quot;&gt;&#39;,</span><br><span class="line">			&#39;&lt;tr&gt;&#39;,</span><br><span class="line">				&#39;&lt;th&gt;序号&lt;&#x2F;th&gt;&#39;,</span><br><span class="line">				&#39;&lt;th&gt;单品&lt;&#x2F;th&gt;&#39;,</span><br><span class="line">				&#39;&lt;th&gt;单价&lt;&#x2F;th&gt;&#39;,</span><br><span class="line">				&#39;&lt;th&gt;数量&lt;&#x2F;th&gt;&#39;,</span><br><span class="line">				&#39;&lt;th&gt;总价&lt;&#x2F;th&gt;&#39;,</span><br><span class="line">			&#39;&lt;&#x2F;tr&gt;&#39;,</span><br><span class="line">			&#39;&lt;tpl for&#x3D;&quot;commodity_id_list&quot;&gt;&#39;,</span><br><span class="line">			&#39;&lt;tr&gt;&#39;,</span><br><span class="line">				&#39;&lt;td&gt;&#123;#&#125;&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">				&#39;&lt;td&gt;&#123;commodity_name&#125;&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">				&#39;&lt;td&gt;￥&#123;commodity_price&#125;&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">				&#39;&lt;td&gt;&#123;count&#125;&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">				&#39;&lt;td&gt;￥&#123;total&#125;&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">			&#39;&lt;&#x2F;tr&gt;&#39;,</span><br><span class="line">			&#39;&lt;&#x2F;tpl&gt;&#39;,</span><br><span class="line">			&#39;&lt;tr&gt;&#39;,</span><br><span class="line">				&#39;&lt;td colspan&#x3D;&quot;4&quot;&gt;合计&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">				&#39;&lt;td&gt;￥&#123;meeting_cost_details&#125;&lt;&#x2F;td&gt;&#39;,</span><br><span class="line">			&#39;&lt;&#x2F;tr&gt;&#39;,</span><br><span class="line">		&#39;&lt;&#x2F;table&gt;&#39;,</span><br><span class="line">		&#39;&lt;div class&#x3D;&quot;bottom&quot;&gt;&#39;,</span><br><span class="line">			&#39;&lt;div&gt;预约方领导签字：&lt;&#x2F;div&gt;&#39;,</span><br><span class="line">			&#39;&lt;div&gt;管理方领导签字：&lt;&#x2F;div&gt;&#39;,</span><br><span class="line">			&#39;&lt;div&gt;主管领导签字：&lt;&#x2F;div&gt;&#39;,</span><br><span class="line">		&#39;&lt;&#x2F;div&gt;&#39;,</span><br><span class="line">	&#39;&lt;&#x2F;div&gt;&#39;,</span><br><span class="line">	&#39;&lt;&#x2F;body&gt;&#39;,</span><br><span class="line">	&#39;&lt;&#x2F;html&gt;&#39;</span><br><span class="line">);</span><br><span class="line">newWin.document.body.innerHTML &#x3D; tpl.apply(record.data);</span><br></pre></td></tr></table></figure>

<h1 id="兼容性问题"><a href="#兼容性问题" class="headerlink" title="兼容性问题"></a>兼容性问题</h1><p>var newWin = window.open();<br>将一段HTML代码，插入到一个页面中有三种方法：</p>
<ul>
<li>1）document.body.appendChild(yourCode)</li>
<li>2 ) document.body.innerHTML = yourCode</li>
<li>3 ) document.write(yourCode)</li>
</ul>
<p>使用newWin.doucment.body.appendChild(formElm )方法将表单元素插入到空页面，IE8下会报错Error:不支持此方法接口 ，而其它浏览器正常，因此选择另外两种方法了。</p>
<p>另外一种方式是，在window.open()的页面内，通过window.opener的方式与父页面进行数据通信。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/05/07/%E6%9F%B1%E7%8A%B6%E5%9B%BE%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/07/%E6%9F%B1%E7%8A%B6%E5%9B%BE%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">柱状图使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-07 12:12:00" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:00+00:00">2019-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<h1 id="柱状图使用"><a href="#柱状图使用" class="headerlink" title="柱状图使用"></a>柱状图使用</h1><h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>具体的学习例子，见官方的sdk例子，地址：extjs/sdk/ext-6.5.3/build/examples/kitchensink/?classic#column-basic</p>
<p>简单粗暴，直接将其items（cartesian）复制过来，然后在其上面更改。将一些函数内的数具注释掉。刚开始，进可能的使用较少的功能。先将整个图显示出来再说。然后再深入每个配置项，调节功能。</p>
<h2 id="每项的参数分析"><a href="#每项的参数分析" class="headerlink" title="每项的参数分析"></a>每项的参数分析</h2><h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>以date作为x轴，注意2019-01-01重复了，实际上，同名的，只有最后一个起作用。但是数字，显示，两个都会显示。具体见图。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:[</span><br><span class="line">	&#123;&#39;date&#39;:&#39;2019-07-01&#39;,&#39;basehospital&#39;:&#39;华山医院&#39;,&#39;price&#39;:&#39;11&#39;,&#39;count&#39;:&#39;1&#39;&#125;,</span><br><span class="line">	&#123;&#39;date&#39;:&#39;2019-07-01&#39;,&#39;basehospital&#39;:&#39;华山医院&#39;,&#39;price&#39;:&#39;13&#39;,&#39;count&#39;:&#39;1&#39;&#125;,</span><br><span class="line">	&#123;&#39;date&#39;:&#39;2019-07-02&#39;,&#39;basehospital&#39;:&#39;华山医院&#39;,&#39;price&#39;:&#39;22&#39;,&#39;count&#39;:&#39;1&#39;&#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><img src="img/1562227106896.png" alt="1562227106896"></p>
<h3 id="axes"><a href="#axes" class="headerlink" title="axes"></a>axes</h3><p>设置横轴、纵轴。<a target="_blank" rel="noopener" href="https://chaofml.gitee.io/extjs/doc/extjs/6.5.3/classic/src/Axis.js.html">Ext.chart.axis.Axis</a> xtype: axis的一个实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">axes: [&#123;</span><br><span class="line">	type: &#39;numeric&#39;,</span><br><span class="line">	position: &#39;left&#39;,</span><br><span class="line">	minimum: 0,</span><br><span class="line">	titleMargin: 20,</span><br><span class="line">	title: &#123;</span><br><span class="line">		text: &#39;人次&#39;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#x2F;&#x2F; listeners: &#123;</span><br><span class="line">	&#x2F;&#x2F; 	rangechange: &#39;onAxisRangeChange&#39;</span><br><span class="line">	&#x2F;&#x2F; &#125;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">	type: &#39;category&#39;,</span><br><span class="line">	position: &#39;bottom&#39;, &#x2F;&#x2F;显示在底部</span><br><span class="line">	title:&#39;日期&#39;</span><br><span class="line">&#125;],</span><br></pre></td></tr></table></figure>

<h3 id="series，设置数据源"><a href="#series，设置数据源" class="headerlink" title="series，设置数据源"></a>series，设置数据源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">series: &#123;</span><br><span class="line">	type: &#39;bar&#39;,</span><br><span class="line">	xField: &#39;date&#39;,</span><br><span class="line">	yField: &#39;price&#39;,</span><br><span class="line">	&#x2F;&#x2F; style: &#123;</span><br><span class="line">	&#x2F;&#x2F; 	minGapWidth: 20  &#x2F;&#x2F;每个柱状图的间隔</span><br><span class="line">	&#x2F;&#x2F; &#125;,</span><br><span class="line">	highlight: &#123;&#x2F;&#x2F;每个轴的高亮</span><br><span class="line">		strokeStyle: &#39;black&#39;,  &#x2F;&#x2F;选择时的边框颜色</span><br><span class="line">		fillStyle: &#39;gold&#39;  &#x2F;&#x2F;选择时的高亮</span><br><span class="line">	&#125;,</span><br><span class="line">	label: &#123;</span><br><span class="line">		field: &#39;price&#39;,</span><br><span class="line">		display: &#39;insideEnd&#39;,</span><br><span class="line">		&#x2F;&#x2F; renderer: &#39;onSeriesLabelRender&#39;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="图表自带预览功能"><a href="#图表自带预览功能" class="headerlink" title="图表自带预览功能"></a>图表自带预览功能</h3><p>这个功能自Ext.draw.Container继承而来，具体的实现比较荣长，可以在控制台输出，就能跳到对应的代码位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	text:&quot;预览&quot;,</span><br><span class="line">	handler:function()&#123;</span><br><span class="line">		var chart &#x3D; me.down(&#39;cartesian&#39;);</span><br><span class="line">		chart.preview();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>sencha app build testing模式下打包，能显示具体的报错信息。如下，提示，某个依赖的组件未认出。</p>
<p><img src="img/1562235669387.png" alt="1562235669387"></p>
<p><strong>解决方法：</strong></p>
<blockquote>
<p>添加依赖，如下。大概就这么多。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">requires:[</span><br><span class="line">		&#39;Ext.chart.axis.Numeric&#39;,</span><br><span class="line">		&#39;Ext.chart.axis.Category&#39;,</span><br><span class="line">		&#39;Ext.chart.series.Bar&#39;,</span><br><span class="line">		&#39;Ext.chart.interactions.ItemHighlight&#39;,</span><br><span class="line">	],</span><br></pre></td></tr></table></figure>

<p>之前一直以为是项目的配置有问题，但是添加了依赖了啊。</p>
<p><img src="img/1562236182844.png" alt="1562236182844"></p>
<h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p>由于每次都要频繁的从后台加载数据，所以略做了优化，将请求的参数作为缓存的键值，对数据进行缓存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">me.cacheData&#x3D;&#123;&#125;  &#x2F;&#x2F;在组件init的时候，进行初始化。   而不是直接在属性上初始化，避免多个公用一个。</span><br><span class="line"></span><br><span class="line">var cacheKey&#x3D;query[&#39;start_date&#39;]+&#39;#&#39;+query[&#39;stop_date&#39;];</span><br><span class="line">&#x2F;&#x2F;尝试读取缓存，如果存在，直接读缓存，并处理</span><br><span class="line">if(me.cacheData[cacheKey])&#123;</span><br><span class="line">	me.analysisData(me.cacheData[cacheKey]);</span><br><span class="line">	return ;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;如果不存在，则发送ajax请求</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/05/07/%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/07/%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">树形结构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-07 12:12:00" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:00+00:00">2019-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="树形结构"><a href="#树形结构" class="headerlink" title="树形结构"></a>树形结构</h1><p>针对树级结构，常用的策略就是递归，另外一种，就是组装成字段。然后从字段里面读字段，这样可以减少递归。</p>
<p>如下，对树级的data进行遍历，但是开销略大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static function setRemark(&amp;$data,$pid,$remark)&#123;</span><br><span class="line">		foreach($data as &amp;$row)&#123;</span><br><span class="line">			if(!isset($row-&gt;parentid)) continue;</span><br><span class="line">			if($row-&gt;parentid &#x3D;&#x3D; $pid)&#123;</span><br><span class="line">				$row-&gt;remark&#x3D;$remark.&#39;&gt;&#39;.$row-&gt;name;&#x2F;&#x2F;设置remark  分割 &gt;</span><br><span class="line">				self::setRemark($data,$row-&gt;id,$row-&gt;remark);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>例外一种，就是想将数组保存成map，或者关联数组，如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cityList =[];<span class="comment">//_city中的对象</span></span><br><span class="line">	<span class="keyword">var</span> cityCode =item.substring(<span class="number">0</span>,<span class="number">6</span>);</span><br><span class="line">	<span class="keyword">var</span> cur  = _city[cityCode];</span><br><span class="line">	cityList.push(cur);</span><br><span class="line">	<span class="keyword">while</span>(cur.pid!==<span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">		<span class="comment">//前进一步</span></span><br><span class="line">		cur=_city[cur.pid];</span><br><span class="line">		cityList.push(cur);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//取反顺序，即由根节点往下</span></span><br><span class="line">	cityList.reverse();</span><br><span class="line">	city= cityList.map(<span class="function"><span class="params">x</span>=&gt;</span>x.name).join(<span class="string">&#x27; &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>php的代码示例</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//机构管理</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatisticsUtils</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$organizationData</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="variable">$organizationPath</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**********	</span></span><br><span class="line"><span class="comment">		2018/7/23</span></span><br><span class="line"><span class="comment">		显示机构列表名称</span></span><br><span class="line"><span class="comment">	*********/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">hospital</span>(<span class="params"><span class="variable">$params</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span> = Zend_Registry::get(<span class="string">&#x27;db&#x27;</span>); </span><br><span class="line">		<span class="variable">$structureId</span> = <span class="variable">$params</span>[<span class="string">&#x27;structure_id&#x27;</span>];	<span class="comment">//structure_id</span></span><br><span class="line">		<span class="variable">$searchDateKey</span> = <span class="keyword">isset</span>(<span class="variable">$params</span>[<span class="string">&#x27;searchDateKey&#x27;</span>])?<span class="variable">$params</span>[<span class="string">&#x27;searchDateKey&#x27;</span>]:<span class="number">1</span>;</span><br><span class="line">		<span class="variable">$startdate</span> =  date(<span class="string">&quot;Y-m-d 00:00:00&quot;</span>,strtotime(<span class="variable">$params</span>[<span class="string">&#x27;start_date&#x27;</span>])); </span><br><span class="line">		<span class="variable">$stopdate</span> =  date(<span class="string">&quot;Y-m-d 23:59:59&quot;</span>,strtotime(<span class="variable">$params</span>[<span class="string">&#x27;stop_date&#x27;</span>]));		</span><br><span class="line"></span><br><span class="line">		<span class="comment">//时间</span></span><br><span class="line">		<span class="variable">$where</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$searchDateKey</span>==<span class="number">1</span>)&#123;<span class="comment">//预约日期</span></span><br><span class="line">			<span class="variable">$where</span>=<span class="string">&quot; and ( c.conversation_schedule_date between &#x27;<span class="subst">$startdate</span>&#x27; and &#x27;<span class="subst">$stopdate</span>&#x27; )&quot;</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;<span class="comment">//下单日期</span></span><br><span class="line">			<span class="variable">$where</span>=<span class="string">&quot; and ( ct.pay_time between &#x27;<span class="subst">$startdate</span>&#x27; and &#x27;<span class="subst">$stopdate</span>&#x27; )&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//查询内容  &quot;专家医生&quot;; </span></span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$params</span>[<span class="string">&#x27;doctor&#x27;</span>]))&#123;</span><br><span class="line">			<span class="variable">$schedule_ids</span> =<span class="variable">$db</span>-&gt;fetchCol(<span class="string">&#x27;select schedule_id from schedule where user_id =:id&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;id&#x27;</span>=&gt;<span class="variable">$params</span>[<span class="string">&#x27;doctor&#x27;</span>]));	</span><br><span class="line">			<span class="keyword">if</span>(count(<span class="variable">$schedule_ids</span>))&#123;<span class="comment">//查找到医生的排班</span></span><br><span class="line">				<span class="variable">$where</span> .= <span class="variable">$db</span>-&gt;quoteInto(<span class="string">&#x27;and ct.schedule_id IN(?)&#x27;</span>, <span class="variable">$schedule_ids</span>);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;<span class="comment">//否则直接返回空结果集</span></span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">array</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$sql</span>= <span class="string">&quot;SELECT ct.organization_id,conversation_schedule_date,pay_price  FROM conversation_treatment AS ct  &quot;</span>.</span><br><span class="line">				<span class="string">&quot;LEFT JOIN conversation AS c ON ct.conversation_id = c.conversation_id  &quot;</span>.</span><br><span class="line">				<span class="string">&quot;WHERE  &quot;</span>.</span><br><span class="line">				<span class="string">&quot;	ct.treatment_type = 1  &quot;</span>. <span class="comment">//门诊</span></span><br><span class="line">				<span class="string">&quot;AND c.conversation_type = 2  &quot;</span>. <span class="comment">//医疗</span></span><br><span class="line">				<span class="string">&quot;AND c.structure_id = <span class="subst">$structureId</span>   &quot;</span>.<span class="comment">//当前机构</span></span><br><span class="line">				<span class="string">&quot; <span class="subst">$where</span> ORDER BY ct.conversation_id ASC  &quot;</span>;</span><br><span class="line">		<span class="comment">// echo $sql;exit;</span></span><br><span class="line">		<span class="variable">$res</span> = <span class="variable">$db</span>-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="variable">$rows</span> = <span class="variable">$res</span>-&gt;fetchAll();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//对数据进行统计分析</span></span><br><span class="line">		<span class="variable">$groupM</span> = <span class="built_in">self</span>::getOrganization(<span class="variable">$structureId</span>);</span><br><span class="line">		<span class="variable">$data</span> = <span class="keyword">array</span>();  <span class="comment">//data [&#x27;organization_id&#x27;][&#x27;date&#x27;][]</span></span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$row</span>)&#123;</span><br><span class="line">			<span class="variable">$oid</span> =<span class="variable">$groupM</span>[<span class="variable">$row</span>[<span class="string">&#x27;organization_id&#x27;</span>]];</span><br><span class="line">			<span class="variable">$date</span> = <span class="variable">$row</span>[<span class="string">&#x27;conversation_schedule_date&#x27;</span>];</span><br><span class="line">			<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$oid</span>]))&#123;</span><br><span class="line">				<span class="variable">$data</span>[<span class="variable">$oid</span>]=<span class="keyword">array</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>]))&#123;</span><br><span class="line">				<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>]=<span class="keyword">array</span>(<span class="string">&#x27;price&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;count&#x27;</span>=&gt;<span class="number">0</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//统计</span></span><br><span class="line">			<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>][<span class="string">&#x27;price&#x27;</span>]+=<span class="variable">$row</span>[<span class="string">&#x27;pay_price&#x27;</span>];</span><br><span class="line">			<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>][<span class="string">&#x27;count&#x27;</span>]+=<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="variable">$result</span> =<span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$oid</span>=&gt;<span class="variable">$oidArr</span>)&#123;</span><br><span class="line">			<span class="keyword">foreach</span>(<span class="variable">$oidArr</span> <span class="keyword">as</span> <span class="variable">$date</span>=&gt;<span class="variable">$dateArr</span>)&#123;</span><br><span class="line">				<span class="variable">$basehospital</span> = <span class="built_in">self</span>::<span class="variable">$organizationData</span>[<span class="variable">$oid</span>];</span><br><span class="line">				<span class="comment">// &#123;&#x27;date&#x27;:&#x27;2019-07-01&#x27;,&#x27;basehospital&#x27;:&#x27;华山医院&#x27;,&#x27;price&#x27;:&#x27;11&#x27;,&#x27;count&#x27;:&#x27;1&#x27;&#125;,</span></span><br><span class="line">				<span class="variable">$result</span>[]=<span class="keyword">array</span>(<span class="string">&#x27;date&#x27;</span>=&gt;<span class="variable">$date</span>,<span class="string">&#x27;basehospital&#x27;</span>=&gt;<span class="variable">$basehospital</span>,<span class="string">&#x27;price&#x27;</span>=&gt;<span class="variable">$dateArr</span>[<span class="string">&#x27;price&#x27;</span>],<span class="string">&#x27;count&#x27;</span>=&gt;<span class="variable">$dateArr</span>[<span class="string">&#x27;count&#x27;</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//排序</span></span><br><span class="line">		<span class="function"><span class="keyword">function</span> <span class="title">cmp</span>(<span class="params"><span class="variable">$a</span>,<span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$a</span>[<span class="string">&#x27;date&#x27;</span>]==<span class="variable">$b</span>[<span class="string">&#x27;date&#x27;</span>])&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> date(<span class="variable">$a</span>[<span class="string">&#x27;date&#x27;</span>])&gt;date(<span class="variable">$b</span>[<span class="string">&#x27;date&#x27;</span>])?<span class="number">1</span>:<span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		usort(<span class="variable">$result</span>,<span class="string">&#x27;cmp&#x27;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/****************</span></span><br><span class="line"><span class="comment">	 * 2019年7月5日</span></span><br><span class="line"><span class="comment">	 * 返回每个组织所归属的医院的map</span></span><br><span class="line"><span class="comment">	 ****************/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getOrganization</span>(<span class="params"><span class="variable">$structureId</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span> = Zend_Registry::get(<span class="string">&#x27;db&#x27;</span>); </span><br><span class="line">		<span class="variable">$rows</span>=<span class="variable">$db</span>-&gt;fetchAll(<span class="string">&#x27;select organization_id id ,organization_parent_id pid,organization_name name from  organization where structure_id =:id;&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;id&#x27;</span>=&gt;<span class="variable">$structureId</span>));</span><br><span class="line">		<span class="built_in">self</span>::<span class="variable">$organizationData</span> = array_column(<span class="variable">$rows</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">		<span class="variable">$mapping</span> = array_column(<span class="variable">$rows</span>,<span class="string">&#x27;pid&#x27;</span>,<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// echo json_encode($mapping );exit;</span></span><br><span class="line">		<span class="variable">$result</span>=<span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$mapping</span> <span class="keyword">as</span> <span class="variable">$id</span>=&gt;<span class="variable">$pid</span>)&#123;</span><br><span class="line">			<span class="variable">$cur</span>=<span class="variable">$pid</span>;</span><br><span class="line">			<span class="variable">$path</span>=<span class="keyword">array</span>(<span class="variable">$pid</span>);</span><br><span class="line">			<span class="keyword">while</span>(<span class="variable">$cur</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">				<span class="comment">// var_dump($cur);</span></span><br><span class="line">				<span class="variable">$cur</span>=<span class="variable">$mapping</span>[<span class="variable">$cur</span>];</span><br><span class="line">				<span class="variable">$path</span>[]=<span class="variable">$cur</span>;</span><br><span class="line">				<span class="keyword">if</span>(count(<span class="variable">$path</span>)&gt;<span class="number">20</span>)&#123;</span><br><span class="line">					<span class="keyword">die</span>(<span class="string">&quot;maximum recursion depth exceeded &quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="variable">$result</span>[<span class="variable">$id</span>]=join(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$path</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">self</span>::<span class="variable">$organizationPath</span> = <span class="variable">$result</span>;</span><br><span class="line">		<span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">			<span class="variable">$tmp</span> = explode(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$v</span>);</span><br><span class="line">			<span class="variable">$len</span> = count(<span class="variable">$tmp</span>);</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$len</span>&gt;<span class="number">1</span>)&#123;</span><br><span class="line">				<span class="variable">$data</span>[<span class="variable">$k</span>]=<span class="variable">$tmp</span>[<span class="variable">$len</span><span class="number">-2</span>];</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/****************</span></span><br><span class="line"><span class="comment">	 * 2019年7月8日</span></span><br><span class="line"><span class="comment">	 * 获取医院</span></span><br><span class="line"><span class="comment">	 ****************/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getHospital</span>(<span class="params"><span class="variable">$params</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span> = Zend_Registry::get(<span class="string">&#x27;db&#x27;</span>); </span><br><span class="line">		<span class="variable">$rows</span>=<span class="variable">$db</span>-&gt;fetchAll(<span class="string">&#x27;select organization_id value ,organization_name name from  organization where structure_id =:id and organization_parent_id = 0;&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;id&#x27;</span>=&gt;<span class="variable">$params</span>[<span class="string">&#x27;structure_id&#x27;</span>]));</span><br><span class="line">		<span class="variable">$option</span> =  <span class="keyword">isset</span>(<span class="variable">$params</span>[<span class="string">&#x27;option&#x27;</span>]) ? <span class="string">&#x27;请选择机构&#x27;</span>:<span class="string">&#x27;全部机构&#x27;</span>;</span><br><span class="line">		<span class="keyword">return</span> array_merge(<span class="keyword">array</span>(<span class="keyword">array</span>(<span class="string">&#x27;name&#x27;</span>=&gt;<span class="variable">$option</span>,<span class="string">&#x27;value&#x27;</span>=&gt;<span class="number">-1</span>)),<span class="variable">$rows</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/************</span></span><br><span class="line"><span class="comment">	 * 2019年7月8日</span></span><br><span class="line"><span class="comment">	 * 获取指定医院的医生</span></span><br><span class="line"><span class="comment">	 ************/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getDoctor</span>(<span class="params"><span class="variable">$params</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable">$db</span> = Zend_Registry::get(<span class="string">&#x27;db&#x27;</span>); </span><br><span class="line">		<span class="variable">$structureId</span> = <span class="variable">$params</span>[<span class="string">&#x27;structure_id&#x27;</span>];</span><br><span class="line">		<span class="variable">$id</span>  = <span class="variable">$params</span>[<span class="string">&#x27;hospital_id&#x27;</span>];</span><br><span class="line"></span><br><span class="line">		<span class="variable">$org</span> = <span class="built_in">self</span>::getOrganization(<span class="variable">$structureId</span>);</span><br><span class="line">		<span class="variable">$orgIds</span>=<span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$org</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$val</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="variable">$val</span> == <span class="variable">$id</span>)&#123;</span><br><span class="line">				<span class="variable">$orgIds</span>[]=<span class="variable">$k</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$orgIds</span>[]=<span class="variable">$id</span>;</span><br><span class="line">		<span class="variable">$where</span> = <span class="variable">$db</span>-&gt;quoteInto(<span class="string">&#x27;organization_id in (?)&#x27;</span>,<span class="variable">$orgIds</span>);</span><br><span class="line">		<span class="variable">$rows</span>=<span class="variable">$db</span>-&gt;fetchAll(<span class="string">&quot;select user.user_id,user_name from user left join user_extend on user.user_id = user_extend.user_id where <span class="subst">$where</span>&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$rows</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/05/07/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%88%E8%BF%9C%E7%A8%8B%E5%8C%BB%E7%96%97%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/07/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%EF%BC%88%E8%BF%9C%E7%A8%8B%E5%8C%BB%E7%96%97%EF%BC%89/" class="post-title-link" itemprop="url">前端Ext</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-07 12:12:00" itemprop="dateCreated datePublished" datetime="2019-05-07T12:12:00+00:00">2019-05-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>[TOC]</p>
<h2 id="前端Ext"><a href="#前端Ext" class="headerlink" title="前端Ext"></a>前端Ext</h2><h3 id="行编辑器功能，动态设置，某列可编辑"><a href="#行编辑器功能，动态设置，某列可编辑" class="headerlink" title="行编辑器功能，动态设置，某列可编辑"></a>行编辑器功能，动态设置，某列可编辑</h3><p>思路有两种，一种是在编辑前，获取editor，然后设置其 disabled属性，但是麻烦。</p>
<p>另外一种，即放在viewmodel中，通过绑定，来达到动态的设置效果。（多采取此类方法）</p>
<p>viewModel设置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">viewModel:&#123;</span><br><span class="line">	data:&#123;</span><br><span class="line">		selections:<span class="number">0</span>,</span><br><span class="line">		item_type:<span class="number">0</span> <span class="comment">//这一项需要动态的设置。在beforeedit</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整个grid表格的监听事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">listeners:&#123;</span><br><span class="line">    <span class="comment">//在这个事件中，进行监听</span></span><br><span class="line">	<span class="string">&quot;beforeedit&quot;</span>:<span class="function"><span class="keyword">function</span>(<span class="params">editor, context, eOpts </span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> width=me.columns[<span class="number">2</span>].getWidth();</span><br><span class="line">		<span class="built_in">console</span>.log(context.record);</span><br><span class="line">		<span class="keyword">var</span> item_type=context.record.get(<span class="string">&#x27;item_type&#x27;</span>);</span><br><span class="line">		me.getViewModel().setData(&#123;<span class="attr">item_type</span>:item_type&#125;);</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&#x27;edit&#x27;</span>:<span class="function"><span class="keyword">function</span>(<span class="params">editor, context, eOpts</span>)</span>&#123;</span><br><span class="line">		<span class="comment">//编辑功能</span></span><br><span class="line">		<span class="keyword">var</span> record =context.record;</span><br><span class="line">		<span class="built_in">console</span>.log(record);</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="number">1222222222222222222</span>);</span><br><span class="line">		Ext.Ajax.request(&#123;</span><br><span class="line">			url: SHINEVMSHTTP + <span class="string">&#x27;/admin/structure/index/edit&#x27;</span>,</span><br><span class="line">			params:record[<span class="string">&#x27;data&#x27;</span>],</span><br><span class="line">			success: <span class="function"><span class="keyword">function</span>(<span class="params">response, opts</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> obj = Ext.decode(response.responseText);</span><br><span class="line">				me.currentEditRecordId=obj[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">				me.store.reload();</span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="string">&#x27;canceledit&#x27;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"> editor, context, eOpts </span>)</span>&#123;</span><br><span class="line">		<span class="comment">//添加时，如果点击取消，那么将删除此行</span></span><br><span class="line">		<span class="keyword">var</span> record=context.record;</span><br><span class="line">		<span class="keyword">var</span> id = record.data.structure_id;</span><br><span class="line">		<span class="keyword">if</span>(id==<span class="number">0</span>)&#123;</span><br><span class="line">			me.store.remove(record);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,		</span><br><span class="line">	<span class="string">&#x27;selectionchange&#x27;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"> cmp, selected, eOpts </span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.getViewModel().setData(&#123;</span><br><span class="line">			selections:selected.length</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		text:<span class="string">&#x27;出诊显示天数&#x27;</span>,</span><br><span class="line">		dataIndex:<span class="string">&#x27;structure_day&#x27;</span>,</span><br><span class="line">		editor:&#123;					</span><br><span class="line">			xtype:<span class="string">&#x27;numberfield&#x27;</span>,</span><br><span class="line">			labelAlign:<span class="string">&quot;right&quot;</span>,			</span><br><span class="line">			valueField: <span class="string">&#x27;key&#x27;</span>,</span><br><span class="line">			bind:&#123;</span><br><span class="line">				disabled:<span class="string">&#x27;&#123;item_type!=2&#125;&#x27;</span>,</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;,</span><br><span class="line">		renderer:<span class="function"><span class="keyword">function</span>(<span class="params">v,metaData,record,rowIndex,colIndex</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> record.get(<span class="string">&#x27;item_type&#x27;</span>) != <span class="number">2</span>?<span class="string">&#x27;&#x27;</span>:(<span class="built_in">parseInt</span>(v)+<span class="string">&#x27;天&#x27;</span>);</span><br><span class="line">		&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>效果图：</strong></p>
<p><img src="img/1560481792860.png" alt="1560481792860"></p>
<p><strong>行编辑器</strong>：注意，新增加的字段，必须在store的field中添加，否则不会生效。第二次踩坑。</p>
<h3 id="排序科室，未注意到共用组件。"><a href="#排序科室，未注意到共用组件。" class="headerlink" title="排序科室，未注意到共用组件。"></a>排序科室，未注意到共用组件。</h3><blockquote>
<p>而且共用组件的配置属性，如果是复杂变量，其也是共享内存的。</p>
</blockquote>
<p>在组件初始化的时候，对其进行了判断，如果为特定的组件，则增加“排序”字段。结果，有两个问题。</p>
<ul>
<li>组件因为是共有的，多次执行后，add多了多个列。</li>
</ul>
<p><img src="img/1560739140891.png" alt="1560739140891"></p>
<ul>
<li>其他不想用到的这个列，也增加了该字段。</li>
</ul>
<p><img src="img/1560739191839.png" alt="1560739191839"></p>
<p>错误代码如下：</p>
<p>initComponent方法内，在调用me.callParent();方法之前。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(me.cmpbox &amp;&amp; me.cmpbox==<span class="string">&#x27;departmenthome&#x27;</span>)&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;我执行啦&#x27;</span>);</span><br><span class="line">	me.columns.push(&#123; </span><br><span class="line">		text: <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">		sortable: <span class="literal">false</span>,</span><br><span class="line">		dataIndex: <span class="string">&#x27;show_order&#x27;</span>,</span><br><span class="line">		width:<span class="number">100</span></span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改为：</p>
<blockquote>
<p>防止复杂变量属性（数组、对象）在原型上共用同一地址。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> col1=&#123; </span><br><span class="line">	xtype:<span class="string">&quot;treecolumn&quot;</span>,</span><br><span class="line">	text: <span class="string">&#x27;科目名称&#x27;</span>,</span><br><span class="line">	sortable: <span class="literal">false</span>,</span><br><span class="line">	height:<span class="number">0</span>,</span><br><span class="line">	dataIndex: <span class="string">&#x27;department_name&#x27;</span>,</span><br><span class="line">	flex: <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> col2=&#123; </span><br><span class="line">	text: <span class="string">&#x27;排序&#x27;</span>,</span><br><span class="line">	sortable: <span class="literal">false</span>,</span><br><span class="line">	dataIndex: <span class="string">&#x27;show_order&#x27;</span>,</span><br><span class="line">	width:<span class="number">100</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span>(me.cmpbox &amp;&amp; me.cmpbox==<span class="string">&#x27;departmenthome&#x27;</span>)&#123;</span><br><span class="line">	me.columns = [col1,col2];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	me.columns = [col1];</span><br><span class="line">&#125;</span><br><span class="line">me.callParent();</span><br></pre></td></tr></table></figure>

<p>上面的代码似曾相识，在别人的老代码中见到过类似的写法。</p>
<p><strong>总结：</strong>1、遇到通用组件，需要在不同的状态下，实例不同的属性，一定要用赋值一个新的变量，而不要修改。（之前，总是关注自定义的）2、与到通用的组件，要注意，在其他组件的显示特性。</p>
<h3 id="门诊管理菜单改造"><a href="#门诊管理菜单改造" class="headerlink" title="门诊管理菜单改造"></a>门诊管理菜单改造</h3><ul>
<li><p>创建没有标签的下拉选择框</p>
<blockquote>
<p>只需要将fieldLabel等属性注释掉即可。代码如下：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">me.searchDateCmb = Ext.create(<span class="string">&#x27;Ext.form.ComboBox&#x27;</span>, &#123;</span><br><span class="line">	<span class="comment">// fieldLabel:&#x27;查询类型&#x27;,</span></span><br><span class="line">	<span class="comment">// labelAlign:&quot;right&quot;,</span></span><br><span class="line">	<span class="comment">// labelWidth:60,</span></span><br><span class="line">	value:<span class="number">1</span>,</span><br><span class="line">	width:<span class="number">160</span>,</span><br><span class="line">	editable:<span class="literal">false</span>,</span><br><span class="line">	store:&#123;</span><br><span class="line">		fields: [<span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">		data :[</span><br><span class="line">			&#123;<span class="attr">key</span>:<span class="number">1</span>,<span class="attr">name</span>:<span class="string">&quot;预约日期&quot;</span>&#125;,					</span><br><span class="line">			&#123;<span class="attr">key</span>:<span class="number">2</span>,<span class="attr">name</span>:<span class="string">&quot;下单日期&quot;</span>&#125;				</span><br><span class="line">		]</span><br><span class="line">	&#125;,</span><br><span class="line">	listeners:&#123;</span><br><span class="line">		change:<span class="function"><span class="keyword">function</span>(<span class="params">c, newValue, oldValue, eOpts</span>)</span>&#123;</span><br><span class="line">			me.searchDateKey = newValue;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	queryMode: <span class="string">&#x27;local&#x27;</span>,</span><br><span class="line">	displayField: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">	valueField: <span class="string">&#x27;key&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>双层菜单栏设计：</p>
<p>简单的原理如下：</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">tbar:[&#123;</span><br><span class="line">	xtype:<span class="string">&#x27;panel&#x27;</span>,</span><br><span class="line">	layout:<span class="string">&#x27;vbox&#x27;</span>,</span><br><span class="line">	items:[&#123;</span><br><span class="line">		html:<span class="string">&#x27;我是第一行&#x27;</span></span><br><span class="line">	&#125;,&#123;</span><br><span class="line">	html:<span class="string">&#x27;我是第二行&#x27;</span></span><br><span class="line"> 	&#125;]</span><br><span class="line"> &#125;],</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>需要注意的是：vbox布局，需要设置宽度，没有则可能显示不正常。所以每个items里面都是一个panel，设置width:’100%’。然后每个panel都有一个tbar。   或者，不想每个都设置高度的话，则修改布局如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">layout: &#123;</span><br><span class="line">	type: <span class="string">&#x27;vbox&#x27;</span>,</span><br><span class="line">	align: <span class="string">&#x27;stretch&#x27;</span><span class="comment">//默认每个100%宽度</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



<p>另外，别人代码是这样设计的。</p>
<blockquote>
<p>grid表格没有toobar,然后单独的制作两个toobar。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Ext.define(<span class="string">&quot;View.AppointMenu&quot;</span>, &#123;</span><br><span class="line">    extend: <span class="string">&quot;Ext.panel.Panel&quot;</span>, <span class="attr">alias</span>: <span class="string">&quot;widget.AppointMenu&quot;</span>,</span><br><span class="line">    layout: &#123; <span class="attr">type</span>: <span class="string">&quot;vbox&quot;</span>, <span class="attr">align</span>: <span class="string">&quot;stretch&quot;</span> &#125;,</span><br><span class="line">    items: [</span><br><span class="line">       &#123; <span class="attr">xtype</span>: <span class="string">&quot;appointmain_toolbar&quot;</span>, <span class="attr">height</span>: <span class="number">40</span>, <span class="attr">border</span>: <span class="number">1</span> &#125;,</span><br><span class="line">       &#123; <span class="attr">xtype</span>: <span class="string">&quot;appointmain_toolbar2&quot;</span>, <span class="attr">height</span>: <span class="number">40</span>, <span class="attr">border</span>: <span class="number">1</span> &#125;,</span><br><span class="line">       &#123; <span class="attr">xtype</span>: <span class="string">&quot;appointmain_grid&quot;</span>, <span class="attr">flex</span>: <span class="number">1.0</span>, <span class="attr">border</span>: <span class="literal">false</span>, &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//菜单对象创建</span></span><br><span class="line"></span><br><span class="line">Ext.define(<span class="string">&quot;View.AppointMain_Toolbar&quot;</span>, &#123;</span><br><span class="line">    extend: <span class="string">&quot;Ext.toolbar.Toolbar&quot;</span>, <span class="attr">alias</span>: <span class="string">&quot;widget.appointmain_toolbar&quot;</span>,</span><br><span class="line">    items: [</span><br><span class="line">        <span class="comment">//&#123; xtype: &quot;container&quot;, html: &quot;&lt;div&gt;预约日期&lt;/div&gt;&quot;, &#125;,</span></span><br><span class="line">        &#123;&#125;]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>发现问题：在tbar:[]中实例化时，括号中，如果是已创建的实例，则不能共用，（共用，则出现，最后一个能用到，前面引用的实例是不会显示的。）如果是配置文件，则互不干扰。</p>
<p>效果如图：</p>
<p><img src="img/1560843640304.png" alt="1560843640304"></p>
<p>tbar想采用方式一，设置，结果总是报错。无奈采用第二种方式。（没想到这也行。）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//方式一</span></span><br><span class="line">dockedItems: [&#123;</span><br><span class="line">	xtype: <span class="string">&#x27;toolbar-overflowbar&#x27;</span>,</span><br><span class="line">	dock: <span class="string">&#x27;top&#x27;</span>,</span><br><span class="line">	overflowHandler: <span class="string">&#x27;menu&#x27;</span></span><br><span class="line">&#125;]</span><br><span class="line"><span class="comment">//方式二：</span></span><br><span class="line">tbar:&#123;</span><br><span class="line">	items:[me.searchDateCmb],</span><br><span class="line">	overflowHandler :<span class="string">&#x27;scroller&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>store的data无法使用绑定。（好像）。延伸：是不是复杂变量，都不能进行绑定？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义好数组，供store用</span></span><br><span class="line">viewModel:&#123;</span><br><span class="line">	data:&#123;</span><br><span class="line">		doctorList:[</span><br><span class="line">			&#123;<span class="string">&quot;display&quot;</span>:<span class="string">&quot;一星&quot;</span>, <span class="string">&quot;v&quot;</span>:<span class="number">1</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;display&quot;</span>:<span class="string">&quot;二星&quot;</span>, <span class="string">&quot;v&quot;</span>:<span class="number">2</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;display&quot;</span>:<span class="string">&quot;三星&quot;</span>, <span class="string">&quot;v&quot;</span>:<span class="number">3</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;display&quot;</span>:<span class="string">&quot;四星&quot;</span>, <span class="string">&quot;v&quot;</span>:<span class="number">4</span>&#125;,</span><br><span class="line">			&#123;<span class="string">&quot;display&quot;</span>:<span class="string">&quot;五星&quot;</span>, <span class="string">&quot;v&quot;</span>:<span class="number">5</span>&#125;</span><br><span class="line">		],</span><br><span class="line">		doctor_id:<span class="literal">null</span>,</span><br><span class="line">		date:<span class="literal">null</span>,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;<span class="comment">//组合框   //修改医生</span></span><br><span class="line">	xtype:<span class="string">&quot;combobox&quot;</span>,</span><br><span class="line">	fieldLabel: <span class="string">&#x27;修改医生&#x27;</span>,</span><br><span class="line">	name: <span class="string">&#x27;doctor_id&#x27;</span>,</span><br><span class="line">	forceSelection:<span class="literal">true</span>,<span class="comment">//强制选择项</span></span><br><span class="line">	editable:<span class="literal">false</span>,</span><br><span class="line">	store: &#123;</span><br><span class="line">		fields: [<span class="string">&#x27;display&#x27;</span>, <span class="string">&#x27;v&#x27;</span>],</span><br><span class="line">		bind:&#123;</span><br><span class="line">			data:<span class="string">&#x27;&#123;doctorList&#125;&#x27;</span> <span class="comment">//事实上，好像并不起作用</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	queryMode: <span class="string">&#x27;local&#x27;</span>,</span><br><span class="line">	displayField: <span class="string">&#x27;display&#x27;</span>,</span><br><span class="line">	valueField: <span class="string">&#x27;v&#x27;</span>,</span><br><span class="line">	submitValue:<span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**************</span></span><br><span class="line"><span class="comment">     * 2019年6月20日</span></span><br><span class="line"><span class="comment">     * 获取当前的查询条件</span></span><br><span class="line"><span class="comment">     **************/</span></span><br><span class="line">	queryParams:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> me =<span class="built_in">this</span>;</span><br><span class="line">		<span class="keyword">var</span> v= me.getViewModel().getData();</span><br><span class="line">		<span class="built_in">console</span>.log(v);</span><br><span class="line">		<span class="keyword">var</span> fn = <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> Ext.Date.format(<span class="keyword">new</span> <span class="built_in">Date</span>(v),<span class="string">&#x27;Y-m-d&#x27;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		v[<span class="string">&#x27;startdate&#x27;</span>]=fn(v[<span class="string">&#x27;startdate&#x27;</span>]);</span><br><span class="line">		v[<span class="string">&#x27;stopdate&#x27;</span>]=fn(v[<span class="string">&#x27;stopdate&#x27;</span>]);</span><br><span class="line">		v[<span class="string">&#x27;structureId&#x27;</span>]=ShineMessageHub.structureId;</span><br><span class="line">		<span class="built_in">console</span>.log(v);</span><br><span class="line">		<span class="keyword">return</span> v;</span><br><span class="line">	&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="共用查询条件（导出）"><a href="#共用查询条件（导出）" class="headerlink" title="共用查询条件（导出）"></a>共用查询条件（导出）</h3><blockquote>
<p>查询在页面显示跟下载，共用一组条件，这样好处是，保证了所见即所得。另外，两个也共用了一套的查询逻辑。导出，利用了自己抽象的组件（参见：数据导出）</p>
<p>另一点，创新之出，利用了viewModel，将各个选择的项进行了绑定，这样获取当前的查询条件比较方便。（多用viewModel思路）</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**************</span></span><br><span class="line"><span class="comment"> * 2019年6月20日</span></span><br><span class="line"><span class="comment"> * 获取当前的查询条件</span></span><br><span class="line"><span class="comment"> **************/</span></span><br><span class="line">queryParams:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> me =<span class="built_in">this</span>;</span><br><span class="line">	<span class="keyword">var</span> v= me.getViewModel().getData();</span><br><span class="line">	<span class="built_in">console</span>.log(v);</span><br><span class="line">	<span class="keyword">var</span> fn = <span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Ext.Date.format(<span class="keyword">new</span> <span class="built_in">Date</span>(v),<span class="string">&#x27;Y-m-d&#x27;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	v[<span class="string">&#x27;startdate&#x27;</span>]=fn(v[<span class="string">&#x27;startdate&#x27;</span>]);</span><br><span class="line">	v[<span class="string">&#x27;stopdate&#x27;</span>]=fn(v[<span class="string">&#x27;stopdate&#x27;</span>]);</span><br><span class="line">	v[<span class="string">&#x27;structureId&#x27;</span>]=ShineMessageHub.structureId;</span><br><span class="line">	<span class="built_in">console</span>.log(v);</span><br><span class="line">	<span class="keyword">return</span> v;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">//数据加载前，添加搜索条件</span></span><br><span class="line"><span class="string">&#x27;beforeload&#x27;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"> store, operation, eOpts</span>)</span>&#123;</span><br><span class="line">	operation[<span class="string">&#x27;_params&#x27;</span>] = me.queryParams();;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="缺少滚动条"><a href="#缺少滚动条" class="headerlink" title="缺少滚动条"></a>缺少滚动条</h3><p>使用了hbox  vbox布局，一定要仔细处理高度跟宽度。避免造成布局问题。</p>
<p>问题如下 ：</p>
<p><img src="img/1561359094251.png" alt="1561359094251"></p>
<p>原因就是，hbox，左右布局，但是没有为每个items指定高度，所以右侧虽然撑开了，但是组件不知道自己的高度。就缺少了滚动条。</p>
<p><strong>解决方式：</strong></p>
<p>指定第二个组件的高度为100%，另外也可以从layout来解决。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">items:[&#123;</span><br><span class="line">					xtype:<span class="string">&quot;organizationlist&quot;</span>,</span><br><span class="line">					split:<span class="literal">true</span>,</span><br><span class="line">					<span class="comment">//collapsible:true,</span></span><br><span class="line">					hideCollapseTool : <span class="literal">true</span>,</span><br><span class="line">					collapseDirection:<span class="string">&#x27;left&#x27;</span>,</span><br><span class="line">					collapseMode : <span class="string">&#x27;mini&#x27;</span>,</span><br><span class="line">					title:<span class="string">&quot;出诊基层&quot;</span>,</span><br><span class="line">					switchHandler:<span class="number">8</span>,</span><br><span class="line">					width:<span class="number">450</span>,</span><br><span class="line">					height:<span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">				&#125;</span><br><span class="line"><span class="comment">//解决方式二，但是，这个却不起作用。  难道stretch只适合vbox？</span></span><br><span class="line">layout: &#123;</span><br><span class="line">	type: <span class="string">&#x27;hbox&#x27;</span>,</span><br><span class="line">	align: <span class="string">&#x27;stretch&#x27;</span><span class="comment">//默认每个100%宽度。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="listeners"><a href="#listeners" class="headerlink" title="listeners"></a>listeners</h3><p>组件已经包含了listeners，引用组件时候，还能再次添加listeners，这两个listeners其实都能起作用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">items:[&#123;</span><br><span class="line">		xtype:<span class="string">&quot;departmentgrid&quot;</span>,</span><br><span class="line">		region:<span class="string">&quot;east&quot;</span>,</span><br><span class="line">		tbarIsHidden:<span class="number">1</span>,</span><br><span class="line">		title:<span class="string">&quot;科目信息&quot;</span>,</span><br><span class="line">		split:<span class="literal">true</span>,</span><br><span class="line">		cmpbox:<span class="string">&quot;medicinehome&quot;</span>,</span><br><span class="line">		width:<span class="number">300</span>,</span><br><span class="line">		listeners:&#123;</span><br><span class="line">			<span class="string">&quot;rowcontextmenu&quot;</span> :<span class="function"><span class="keyword">function</span>(<span class="params"> c, record, tr, rowIndex, e, eOpts </span>)</span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;右键菜单-药品&#x27;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="listeners中的cmp并不总是this"><a href="#listeners中的cmp并不总是this" class="headerlink" title="listeners中的cmp并不总是this"></a>listeners中的cmp并不总是this</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Ext.tree.Panel  组件的listeners</span></span><br><span class="line">listeners:&#123;</span><br><span class="line">		<span class="string">&quot;rowcontextmenu&quot;</span> :<span class="function"><span class="keyword">function</span>(<span class="params"> c, record, tr, rowIndex, e, eOpts </span>)</span>&#123;</span><br><span class="line">			c == <span class="built_in">this</span> <span class="comment">//false</span></span><br><span class="line">            <span class="comment">//这里面的c居然并不是组件  的this.</span></span><br><span class="line">            <span class="comment">//输出c，发现   xtype: &quot;treeview&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="用textfield替代hiddenfield"><a href="#用textfield替代hiddenfield" class="headerlink" title="用textfield替代hiddenfield"></a>用textfield替代hiddenfield</h3><p>如下代码，可以将一个输入项隐藏起来。代码本身没有什么亮点，重点在于，用其替代hiddenfield。为啥要替代，因为hiddenfield的功能，没有textfield功能齐全。比如，是否要提交、是否为空等验证。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	hidden:<span class="literal">true</span>,</span><br><span class="line">	xtype:<span class="string">&quot;textfield&quot;</span>,</span><br><span class="line">	name:<span class="string">&quot;lastaccountid&quot;</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h3 id="尽量用viewmodel来代替具体的索引"><a href="#尽量用viewmodel来代替具体的索引" class="headerlink" title="尽量用viewmodel来代替具体的索引"></a>尽量用viewmodel来代替具体的索引</h3><p>在远程医疗模块中，添加终端功能，其内部大量使用了items.getAt（索引号）功能，但是随着需求的更改，变得非常难维护，增加一个items项，代码影响很大。所以能用viewmodel的时候，尽量用。或者用me.query(‘’)方式，尽量代码与其具体的索引无关。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">me.editPanel.items.getAt(me.editPanel.items.length-<span class="number">4</span>).setValue(me.LastAccountID);</span><br><span class="line">me.editPanel.items.getAt(me.editPanel.items.length-<span class="number">3</span>).setValue(Ext.encode(OutData));</span><br></pre></td></tr></table></figure>

<h3 id="allowBlank改造，为组件增加set方法"><a href="#allowBlank改造，为组件增加set方法" class="headerlink" title="allowBlank改造，为组件增加set方法"></a>allowBlank改造，为组件增加set方法</h3><p>组件的viewmodel方法绑定时，只能绑定有set方法的配置项。如果没有，则会报错。在切换时，有的时候想动态的设置allowBlank，即，在有的选项下进行验证，有的方法下不验证。想通过listeners的blur方法进行切换，markInvalid标记验证结果，触发验证。结果是，在allowBlank=true的情况下，都不会再验证了。后来，在源码观察中，发现allowBlank可以进行改造。遂改造，并实现了效果：<strong>动态开启、关闭验证</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	fieldLabel: <span class="string">&quot;IP地址&quot;</span>,</span><br><span class="line">	labelAlign:<span class="string">&quot;right&quot;</span>,</span><br><span class="line">	name: <span class="string">&#x27;device_ip&#x27;</span>,</span><br><span class="line">	xtype: <span class="string">&#x27;textfield&#x27;</span>,</span><br><span class="line">	regex:<span class="regexp">/^((25[0-5]|2[0-4]\d|[01]?\d\d?)($|(?!\.$)\.))&#123;4&#125;$/</span>,</span><br><span class="line">	regexText : <span class="string">&#x27;请输入正确的ip地址！&#x27;</span>,</span><br><span class="line">	<span class="comment">//注意allowBlank，没有设置方法，下面的绑定，会报错。</span></span><br><span class="line">	bind:&#123;</span><br><span class="line">		allowBlank:<span class="string">&#x27;&#123;virtual==1&#125;&#x27;</span></span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="comment">//为了解决动态设置allowBlank的问题，自己手动的增加。</span></span><br><span class="line">	setAllowBlank:<span class="function"><span class="keyword">function</span>(<span class="params">v</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">this</span>.allowBlank=v;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//下面的方法，没有达到预定效果。</span></span><br><span class="line">	<span class="comment">// listeners:&#123;</span></span><br><span class="line">	<span class="comment">// 	&#x27;blur&#x27;:function( cmp, event, eOpts )&#123;</span></span><br><span class="line">	<span class="comment">// 		var v=me.getViewModel().getData();</span></span><br><span class="line">	<span class="comment">// 		if(v[&#x27;virtual&#x27;]==0)&#123;</span></span><br><span class="line">	<span class="comment">// 			console.log(&#x27;真实设备&#x27;);</span></span><br><span class="line">	<span class="comment">// 			cmp.markInvalid(cmp.regexText);</span></span><br><span class="line">	<span class="comment">// 			cmp.isValid();</span></span><br><span class="line">	<span class="comment">// 		&#125;</span></span><br><span class="line">	<span class="comment">// 	&#125;</span></span><br><span class="line">	<span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="获取上传文件的内容"><a href="#获取上传文件的内容" class="headerlink" title="获取上传文件的内容"></a>获取上传文件的内容</h3><p>只有一种方式，items.getAt(1).getValue()，其他的方式，都无法获取到上传表单的值。难道这算是一个bug？</p>
<ul>
<li>几种方式对比如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bform = me.down(<span class="string">&#x27;form&#x27;</span>).getForm();</span><br><span class="line"><span class="keyword">var</span> filename=bform.getValues()[<span class="string">&#x27;attachment&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(bform.getValues());</span><br><span class="line"><span class="keyword">var</span> filename1=me.down(<span class="string">&#x27;form&#x27;</span>).items.getAt(<span class="number">1</span>).getValue();</span><br><span class="line"><span class="built_in">console</span>.log(&#123;filename,filename1&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果图：</li>
</ul>
<p><img src="img/1561711141877.png" alt="1561711141877"></p>
<h3 id="window的自适应"><a href="#window的自适应" class="headerlink" title="window的自适应"></a>window的自适应</h3><p>设置window的组件的布局 layout:’fit’,其可以被内部的元素主动撑开，不需要自己再手动的调整高度。</p>
<p>这个对那种需要动态隐藏某些组件的来说，非常方便。</p>
<h3 id="需要优化的嵌套if语句"><a href="#需要优化的嵌套if语句" class="headerlink" title="需要优化的嵌套if语句"></a>需要优化的嵌套if语句</h3><p>if的嵌套，有时候可以变成并列条件，也可以反过来。对下面的进行分析，GroupType与filename进行合并，然后else正好合并到了上一级。但是  Msg这一块却没有办法优化，因为其需要回掉。同时，才将submitAction合并成一个函数。另外，这个应该也可以用消息传递、或者promise对象来完成。</p>
<p><img src="img/1561947417403.png" alt="1561947417403"></p>
<p>优化成这个样子：</p>
<p><img src="img/1561947737954.png" alt="1561947737954"></p>
<h3 id="fieldcontainer，按钮同行布局"><a href="#fieldcontainer，按钮同行布局" class="headerlink" title="fieldcontainer，按钮同行布局"></a>fieldcontainer，按钮同行布局</h3><p>说明：有这样的需求，在原有的行上面增加一个按钮。之前试过用代码动态的插，费时费力，效果也不是很好。后来，fieldcontainer很好用。</p>
<p>但是需要注意的是，fieldcontainer会将内部的标签fieldLabel提到外部，但是字段的name不能提升，因为其没有。另外，整体的布局样式，应该也是加载fieldcontainer上的，一般都是放在defaults上面。</p>
<p>代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	xtype:<span class="string">&#x27;fieldcontainer&#x27;</span>,</span><br><span class="line">	fieldLabel:<span class="string">&#x27;宣传片&#x27;</span>,</span><br><span class="line">	layout: <span class="string">&#x27;hbox&#x27;</span>,</span><br><span class="line">	hidden: (GroupType==<span class="number">1</span>)?<span class="literal">false</span>:<span class="literal">true</span>,</span><br><span class="line">	items:[&#123;</span><br><span class="line">		xtype:<span class="string">&#x27;filefield&#x27;</span>,</span><br><span class="line">		name: <span class="string">&#x27;organization_video&#x27;</span>,</span><br><span class="line">		buttonText: <span class="string">&#x27;浏览&#x27;</span>,</span><br><span class="line">		flex:<span class="number">1</span>,</span><br><span class="line">	&#125;,&#123;</span><br><span class="line">		xtype:<span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">		margin:<span class="string">&#x27;0 0 0 5&#x27;</span>,</span><br><span class="line">		text:<span class="string">&#x27;清空&#x27;</span>,</span><br><span class="line">		idth:<span class="number">42</span></span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>效果图如下：</p>
<p><img src="img/1561951575932.png" alt="1561951575932"></p>
<h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h3><ul>
<li>初始化变量的一些小技巧</li>
</ul>
<p>下面的方式初始化数组。（有用过类似的方法，但下面的例子让我感兴趣。）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fields: &quot;name,price,count&quot;.split(&quot;,&quot;),</span><br></pre></td></tr></table></figure>

<ul>
<li>items数组的动态</li>
</ul>
<p>其中items3为根据flag的值动态加载。若加，设置为null，不会加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">items:[items1,items2,(flag)?item3:null,item4]</span><br></pre></td></tr></table></figure>

<ul>
<li>发布版本，清除输出</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log&#x3D; function()&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数组合并或者复制数组</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;[1,2,3,4]</span><br><span class="line">b&#x3D;[...a] &#x2F;&#x2F;拷贝a，并形成一个副本</span><br><span class="line">&#x2F;&#x2F;同理，合并数组</span><br><span class="line">c&#x3D;[...a,...b]</span><br><span class="line">&#x2F;&#x2F;之前用的是比较low的方法</span><br><span class="line">c&#x3D;[]</span><br><span class="line">c.splice(c.length,0,...a)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="store-loadData方法使用"><a href="#store-loadData方法使用" class="headerlink" title="store loadData方法使用"></a>store loadData方法使用</h3><p>重要的事说三遍，是数组，一定要是数组，否则不起作用。 loadData应该是立即执行的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> item = [&#123;<span class="attr">id</span>:-<span class="number">1</span>,<span class="attr">name</span>:<span class="string">&#x27;请选择地区&#x27;</span>&#125;];<span class="comment">//一定要是数组格式。</span></span><br><span class="line"><span class="keyword">var</span> data=me.cityList[newValue]?Ext.Array.merge(item,me.cityList[newValue]):item;</span><br><span class="line">cityCombo.store.loadData(data);<span class="comment">//data一定要是数组格式，否则不起作用</span></span><br></pre></td></tr></table></figure>

<p>combo选择功能，再次遇到坑。花费了接近1天的时间才解决。具体代码参见;OrganizationGrid.js</p>
<p>说一下具体的思路：</p>
<p>省、市、县的三级联动。默认从后台获取好数据，并组织好，以父级的id作为分组。然后整体一次加载到数据，并存到变量中。每次选择变化时，监听省、市的变化，值变化后，在change事件中，获取到下级的组件store，并动态的为其加载数据，loadData，注意，loadData方法加载很快，然后由于更改了选择，应使下级选择重置。</p>
<p>每级只需要关注change事件，并为下级动态的加载tstore。</p>
<p>部分代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#123;					</span><br><span class="line">	xtype:<span class="string">&quot;combo&quot;</span>,</span><br><span class="line">	fieldLabel : <span class="string">&#x27;城　　市&#x27;</span>, 									</span><br><span class="line">	name : <span class="string">&#x27;city_id&#x27;</span>,</span><br><span class="line">	store:&#123;</span><br><span class="line">		fields: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">		data  :[&#123;<span class="attr">id</span>:-<span class="number">1</span>,<span class="attr">name</span>:<span class="string">&#x27;请选择地区&#x27;</span>&#125;]  <span class="comment">//增加了请选择的功能</span></span><br><span class="line">	&#125;,</span><br><span class="line">	queryMode: <span class="string">&#x27;local&#x27;</span>,</span><br><span class="line">	displayField: <span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">	editable:<span class="literal">false</span>,</span><br><span class="line">	forceSelection:<span class="literal">true</span>,<span class="comment">//有无均可，editable已经限制了。</span></span><br><span class="line">	valueField: <span class="string">&#x27;id&#x27;</span>,</span><br><span class="line">	value:-<span class="number">1</span>,  <span class="comment">//默认选择</span></span><br><span class="line">	listeners:&#123;</span><br><span class="line">		<span class="string">&#x27;change&#x27;</span>:<span class="function"><span class="keyword">function</span>(<span class="params"> cmp, newValue, oldValue, eOpts </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> countyCombo=me.DepartmentWin.query(<span class="string">&#x27;combo[name=county_id]&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line">			<span class="keyword">var</span> item = [&#123;<span class="attr">id</span>:-<span class="number">1</span>,<span class="attr">name</span>:<span class="string">&#x27;请选择区县&#x27;</span>&#125;];  <span class="comment">//注意其为数组。</span></span><br><span class="line">			<span class="keyword">var</span> data=me.cityList[newValue]?Ext.Array.merge(item,me.cityList[newValue]):item;</span><br><span class="line">			countyCombo.store.loadData(data); <span class="comment">//加载的一定要为数组，否则，则不成功</span></span><br><span class="line">			countyCombo.setValue(-<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;					</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//直接使用下列方式，进行重置</span></span><br><span class="line"><span class="comment">// bform.setValues(&#123;province_id:3,city_id:39,county_id:336&#125;)</span></span><br><span class="line"><span class="comment">//在beforeshow事件中，进行调用。</span></span><br><span class="line">getCityValue:<span class="function"><span class="keyword">function</span>(<span class="params">id</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> me=<span class="built_in">this</span>;</span><br><span class="line">	Ext.Ajax.request(&#123;</span><br><span class="line">		url: SHINEVMSHTTP+<span class="string">&#x27;/admin/organization/Organization/cityvalue&#x27;</span>,</span><br><span class="line">		method:<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">		params:&#123;<span class="string">&quot;GroupID&quot;</span>:id&#125;,</span><br><span class="line">		success: <span class="function"><span class="keyword">function</span>(<span class="params">response, opts</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> obj = Ext.decode(response.responseText);</span><br><span class="line">			<span class="built_in">console</span>.log(obj);</span><br><span class="line">			<span class="keyword">if</span>(!obj)&#123;</span><br><span class="line">				<span class="keyword">return</span> ;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">var</span> bform = me.DepartmentWin.items.items[<span class="number">0</span>].getForm();</span><br><span class="line">			<span class="comment">//直接使用下列方式，进行重置</span></span><br><span class="line">			<span class="comment">// bform.setValues(&#123;province_id:3,city_id:39,county_id:336&#125;)</span></span><br><span class="line">			bform.setValues(&#123;<span class="attr">province_id</span>:obj.province_id,<span class="attr">city_id</span>:obj.city_id,<span class="attr">county_id</span>:obj.county_id&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>loadData</p>
<h3 id="me-down、me-query、getForm-findField-‘name’-查找组件"><a href="#me-down、me-query、getForm-findField-‘name’-查找组件" class="headerlink" title="me.down、me.query、getForm().findField(‘name’) 查找组件"></a>me.down、me.query、getForm().findField(‘name’) 查找组件</h3><p>查找组件，不只有一种方法。每种方法，都有各自的有缺点。但是最好，别用getAt索引的方式查找，代码扩展性不好，增加减少或者重新排序组件，都需要重新更改索引。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//常用的</span></span><br><span class="line">me.down() <span class="comment">//只能找到第一个组件</span></span><br><span class="line">me.items.getAt(<span class="number">0</span>) <span class="comment">//通过索引查找</span></span><br><span class="line"><span class="comment">//根据特殊的属性查找，能保存找到的是唯一，但是注意，其为数组。</span></span><br><span class="line">me.query(<span class="string">&#x27;combo[name=doctor]&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">//如果是form组件，则可以使用下列方式查找。如果不是，理论上也能包裹一层form</span></span><br><span class="line">getForm().findField(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//只能往查找</span></span><br><span class="line">me.up()</span><br></pre></td></tr></table></figure>

<h3 id="filefield设置value（重点在思路）"><a href="#filefield设置value（重点在思路）" class="headerlink" title="filefield设置value（重点在思路）"></a>filefield设置value（重点在思路）</h3><p>核心的做法，找到dom，利用原生的js代码，修改dom值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var bform&#x3D;c.down(&#39;form&#39;).getForm();</span><br><span class="line">bform.findField (&#39;attachment&#39;).inputEl.dom.value&#x3D; 12343431;</span><br></pre></td></tr></table></figure>

<p>先说一下排查的思路。首先，为啥setValue不起作用？其实我也不知道。后来，直接在控制台输出，发现如下：<br>输入cmp.setValue，得到一个空函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ƒ () &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>输出cmp.getValue，得到如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ƒ () &#123;</span><br><span class="line">        var me &#x3D; this,</span><br><span class="line">            val &#x3D; me.rawToValue(me.processRawValue(me.getRawValue()));</span><br><span class="line">        me.value &#x3D; val;</span><br><span class="line">        return val;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>输入，cmp.getRawValue，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ƒ () &#123;</span><br><span class="line">        var me &#x3D; this,</span><br><span class="line">            v &#x3D; (me.inputEl ? me.inputEl.getValue() : Ext.valueFrom(me.rawValue, &#39;&#39;));</span><br><span class="line">        me.rawValue &#x3D; v;</span><br><span class="line">        return v;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>输入cmp.inputEl.getValue</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ƒ (asNumber) &#123;</span><br><span class="line">            var value &#x3D; this.dom.value;</span><br><span class="line">            return asNumber ? parseInt(value, 10) : value;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>然后发现，实际上是dom的值。this指  cmp.inputEl。所以直接就修改了。（之前在Ext的源码里面，也试图找，结果没有找到）</p>
<p><strong>所以，很重要的一点就是，学会利用控制台查看，函数的源码。</strong></p>
<p>另外，之前做了另外一个版本的代码是真长。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var videoSrc&#x3D;me.currentEditRecord.organization_video;</span><br><span class="line">		var html&#x3D;&#39;&lt;div class&#x3D;&quot;x-form-text-wrap x-form-text-wrap-default&quot;&gt;&lt;input type&#x3D;&quot;text&quot; value&#x3D;&quot;&#39;+videoSrc+&#39;&quot; readonly&#x3D;&quot;readonly&quot; class&#x3D;&quot;x-form-field x-form-text x-form-text-default x-form-text-file  x-form-empty-field x-form-empty-field-default&quot;&gt;&lt;&#x2F;div&gt;&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;这个是主要的逻辑，因为show的时候，要显示能改变的html的值</span><br><span class="line">&#39;show&#39;:function()&#123;</span><br><span class="line">	var video&#x3D;me.DepartmentWin.down(&#39;filefield[name&#x3D;organization_video]&#39;);</span><br><span class="line">	var el&#x3D;video.getEl();</span><br><span class="line">	var div&#x3D;me.DepartmentWin.inputDiv&#x3D;el.down(&#39;#&#39;+el.id+&#39;-inputWrap&#39;);</span><br><span class="line">	div.setStyle(&#39;display&#39;,&#39;none&#39;);</span><br><span class="line">	me.DepartmentWin.inputNew&#x3D;Ext.DomHelper.insertAfter(div,html,true);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">&#x2F;&#x2F;change后，就显示新的原本的textfield的原本的值</span><br><span class="line"></span><br><span class="line">listeners:&#123;</span><br><span class="line">	&#39;change&#39;:function(cmp, value, eOpts )&#123;</span><br><span class="line">		var div&#x3D;me.DepartmentWin.inputDiv;</span><br><span class="line">		div &amp;&amp; div.setStyle(&#39;display&#39;,&#39;block&#39;);</span><br><span class="line">		me.DepartmentWin.inputNew.setStyle(&#39;display&#39;,&#39;none&#39;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="利用nginx在本地开发"><a href="#利用nginx在本地开发" class="headerlink" title="利用nginx在本地开发"></a>利用nginx在本地开发</h2><p>按之前的套路，开发的时候利用netty，在本地跑一个web服务，跑前端服务，然后在首页index.html配置好后端的服务器，以后代码中所有的url，均利用该配置，这样凡是ajax调用的地方，均访问真实的后端服务。在去年沈阳加班的时候，那个时候就在想，如何整合前、后端的。</p>
<p>所以，我那时就想到了，用nginx将前后整合到一台服务器上。再后来，我又发现netty本身是个服务器，也能代理后端的请求。我记得我当时还作了笔记。有空，放到一起。</p>
<h3 id="之前采取方式的弊端："><a href="#之前采取方式的弊端：" class="headerlink" title="之前采取方式的弊端："></a>之前采取方式的弊端：</h3><ul>
<li>前后端分离，ajax等存在跨域，虽然可以通过设置响应通来允许访问。但是对与session、cookie和Ext中的表单支持不好。十分不方便调试。如果，1、上传文件，能上传成功，但是具体的相应是不对的。2、form提交表单，也会返回错误。</li>
<li>无法利用session，那么无法利用到角色、登录功能。那么开发过程中，只能手动的设置角色。先将角色写死，然后后期整合的时候，再进行调整，非常的不方便。</li>
</ul>
<h3 id="那么，具体说，nginx的代理服务。"><a href="#那么，具体说，nginx的代理服务。" class="headerlink" title="那么，具体说，nginx的代理服务。"></a>那么，具体说，nginx的代理服务。</h3><ul>
<li><p>设置本地的开发域名host。win+r  运行，输入system32，依次找到drivers\etc，在host文件中，增加一行，dev.com。我host文件内容如下，最后一行是新添加的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1       localhost</span><br><span class="line">127.0.0.1       zend.scc</span><br><span class="line">127.0.0.1       www.openpoor.com</span><br><span class="line">127.0.0.1       www.myspace.com</span><br><span class="line">127.0.0.1       dev.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nginx的代理功能</p>
<blockquote>
<p>找到nginx目录，在conf/nginx.conf文件中，有设置。在http 大括号内，最末尾添加自己的代理内容。记得配置好后，运行 nginx.exe -t 进行测试配置文件。如果错误了，查看错误，并解决错误。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name dev.com;</span><br><span class="line">	location &#x2F; &#123;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;localhost:1841&#x2F;;</span><br><span class="line">	&#125;</span><br><span class="line">	location &#x2F;admin &#123;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;172.168.4.36&#x2F;admin;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>说明：默认将所有的访问都重定向到前端服务器locahost:1841，然后将以/admin开头的重定向到后端服务器172.168.4.36</p>
<p>完美访问：</p>
</li>
</ul>
<p><img src="img/1560829022696.png" alt="1560829022696"></p>
<h3 id="奇葩的代理需求"><a href="#奇葩的代理需求" class="headerlink" title="奇葩的代理需求"></a>奇葩的代理需求</h3><p>  需求：同事要做版本的迁移工作，需要将数据从原有的系统中迁移到新版本中。所有就有了两个数据库。想根据不同的请求，使用不同的数据库。</p>
<p>  核心原理是，添加不同的请求头，根据不同的请求头，选择不同的库。如下:</p>
<ul>
<li><p>php代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$params &#x3D;  参数1 ;&#x2F;&#x2F; 数据库参数</span><br><span class="line">if(isset($_SERVER[&quot;HTTP_DATABASE&quot;]) &amp;&amp; strpos($_SERVER[&quot;HTTP_DATABASE&quot;],&#39;shinejinyu&#39;) &gt;&#x3D; 0)&#123;</span><br><span class="line">	</span><br><span class="line">	$params  &#x3D;  参数2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>nginx配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name dev.com;</span><br><span class="line">	location &#x2F; &#123;</span><br><span class="line">		proxy_set_header database &#39;shinejinyu&#39;;</span><br><span class="line">		proxy_pass http:&#x2F;&#x2F;172.168.4.36&#x2F;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><h3 id="Zend引入模块"><a href="#Zend引入模块" class="headerlink" title="Zend引入模块"></a>Zend引入模块</h3><blockquote>
<p>Zend要求引入的模块，跟类的名称必须一致。否则会报如下错误。</p>
</blockquote>
<p><img src="img/1561019557714.png" alt="1561019557714"></p>
<p>显示的具体原因。</p>
<p><img src="img/1561019586941.png" alt="1561019586941"></p>
<h3 id="字符串变量"><a href="#字符串变量" class="headerlink" title="字符串变量"></a>字符串变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$fun&#x3D;&#39;hello&#39;;</span><br><span class="line">self::$fun();&#x2F;&#x2F;会调用静态函数  hello，并输出。</span><br></pre></td></tr></table></figure>

<h3 id="数据导出功能"><a href="#数据导出功能" class="headerlink" title="数据导出功能"></a>数据导出功能</h3><blockquote>
<p>利用现成的PHPExcel功能，要求自己对原有的功能，再进行一次封装。所以，对调用者来说，更方便、更通用。满足两个功能：1、从数据库查出的数据，每行一条记录，填充到excel中；2、有简单的替换功能，通过设置header功能。</p>
<p>代码的通用性比较好，是要对其进行更高级的抽象。这个时候确实感受到了抽象的重要性。另外，这个代码核心的思想就是：1、用数组写一行数组。2、用数组写一列数据。3、用数组，指定起点，填充一列数据。这些都是要对原有提供的底层的api进行封装。</p>
<p>代码质量不高。但是应该从中<strong>学会抽象。</strong></p>
</blockquote>
<ul>
<li>遇到的第一个下马威：</li>
</ul>
<p>错误提示如下，只能将570的break注释掉，然后能正常的生成文件呢。（不明白为啥会有这个错误）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Fatal error: &#39;break&#39; not in the &#39;loop&#39; or &#39;switch&#39; context in D:\ShineVMS\xampp\htdocs\admin\library\PHPExcel\PHPExcel\Calculation\Functions.php on line 570</span><br></pre></td></tr></table></figure>

<p><img src="img/1561024246876.png" alt="1561024246876"></p>
<ul>
<li>准备工作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;入口文件，添加默认的库的导入路径 set_include_path 添加</span><br><span class="line">set_include_path( . PATH_SEPARATOR . &#39;library&#x2F;phpexcel&#39;)</span><br><span class="line">&#x2F;&#x2F;将库文件放到 library&#x2F;phpexcel，大小写没有关系。</span><br><span class="line">&#x2F;&#x2F;引入库</span><br><span class="line">Zend_Loader::loadClass(&#39;PHPExcel&#39;);</span><br></pre></td></tr></table></figure>

<ul>
<li>核心php代码：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*********</span></span><br><span class="line"><span class="comment"> * 2019年6月20日</span></span><br><span class="line"><span class="comment"> * 将从数据库查询出的数据导出为excel格式。 author 苏传超</span></span><br><span class="line"><span class="comment">*********/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataExportUtils</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">static</span> <span class="keyword">protected</span> <span class="variable">$titleInfo</span> = <span class="keyword">array</span>(</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;patient_name&#x27;</span>,<span class="string">&#x27;患者&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;patient_sex&#x27;</span>,<span class="string">&#x27;性别&#x27;</span>,<span class="number">10</span>,<span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="string">&#x27;男&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;女&#x27;</span>)),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;patient_birthday&#x27;</span>,<span class="string">&#x27;年龄&#x27;</span>,<span class="number">10</span>,<span class="string">&#x27;getBrithAge&#x27;</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;patient_id_card&#x27;</span>,<span class="string">&#x27;身份证&#x27;</span>,<span class="number">10</span>,<span class="string">&#x27;tostring&#x27;</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;patient_phone&#x27;</span>,<span class="string">&#x27;手机号&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;department_name&#x27;</span>,<span class="string">&#x27;科室&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="comment">// array(&#x27;conversation_id&#x27;,&#x27;病区&#x27;,10),</span></span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;hospital&#x27;</span>,<span class="string">&#x27;所属医院&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;doctor&#x27;</span>,<span class="string">&#x27;医生&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;conversation_schedule_date&#x27;</span>,<span class="string">&#x27;预约日期&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;visit_status&#x27;</span>,<span class="string">&#x27;就诊状态&#x27;</span>,<span class="number">10</span>,<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;未预检&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;预检等候&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;叫号&#x27;</span>,<span class="number">3</span>=&gt;<span class="string">&#x27;过号&#x27;</span>,<span class="number">4</span>=&gt;<span class="string">&#x27;复诊&#x27;</span>,<span class="number">5</span>=&gt;<span class="string">&#x27;诊结&#x27;</span>,<span class="number">6</span>=&gt;<span class="string">&#x27;复诊等候&#x27;</span>)),<span class="comment">//门诊（未预检=0，预检等候=1，叫号=2，过号=3，复诊=4，诊结=5，复诊等候=6）</span></span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;order_type&#x27;</span>,<span class="string">&#x27;预约方式&#x27;</span>,<span class="number">10</span>,<span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="string">&#x27;预约机&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;手机&#x27;</span>,<span class="number">3</span>=&gt;<span class="string">&#x27;工作站预约&#x27;</span>)),  <span class="comment">//预约机=1，手机=2，工作站预约=3</span></span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;pay_type&#x27;</span>,<span class="string">&#x27;支付方式&#x27;</span>,<span class="number">10</span>,<span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="string">&#x27;微信&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;支付宝&#x27;</span>)), <span class="comment">//微信=1，支付宝=2</span></span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;pay_status&#x27;</span>,<span class="string">&#x27;支付状态&#x27;</span>,<span class="number">10</span>,<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&#x27;未支付&#x27;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;等待支付&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;已支付&#x27;</span>,<span class="number">3</span>=&gt;<span class="string">&#x27;等待退款&#x27;</span>,<span class="number">4</span>=&gt;<span class="string">&#x27;已退款&#x27;</span>)),  <span class="comment">//未支付=0，等待支付=1，已支付=2，等待退款=3，已退款=4</span></span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;pay_ordernumber&#x27;</span>,<span class="string">&#x27;订单号&#x27;</span>,<span class="number">10</span>,<span class="string">&#x27;tostring&#x27;</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;pay_price&#x27;</span>,<span class="string">&#x27;价格&#x27;</span>,<span class="number">10</span>),</span><br><span class="line">		<span class="keyword">array</span>(<span class="string">&#x27;pay_time&#x27;</span>,<span class="string">&#x27;下单时间&#x27;</span>,<span class="number">10</span>)</span><br><span class="line">	);</span><br><span class="line">	<span class="built_in">static</span> <span class="keyword">protected</span> <span class="variable">$colIndex</span> = <span class="keyword">array</span>(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>,<span class="string">&#x27;AA&#x27;</span>,<span class="string">&#x27;AB&#x27;</span>,<span class="string">&#x27;AC&#x27;</span>,<span class="string">&#x27;AD&#x27;</span>,<span class="string">&#x27;AE&#x27;</span>,<span class="string">&#x27;AF&#x27;</span>,<span class="string">&#x27;AG&#x27;</span>,<span class="string">&#x27;AH&#x27;</span>,<span class="string">&#x27;AI&#x27;</span>,<span class="string">&#x27;AJ&#x27;</span>,<span class="string">&#x27;AK&#x27;</span>,<span class="string">&#x27;AL&#x27;</span>,<span class="string">&#x27;AM&#x27;</span>,<span class="string">&#x27;AN&#x27;</span>,<span class="string">&#x27;AO&#x27;</span>,<span class="string">&#x27;AP&#x27;</span>,<span class="string">&#x27;AQ&#x27;</span>,<span class="string">&#x27;AR&#x27;</span>,<span class="string">&#x27;AS&#x27;</span>,<span class="string">&#x27;AT&#x27;</span>,<span class="string">&#x27;AU&#x27;</span>,<span class="string">&#x27;AV&#x27;</span>,<span class="string">&#x27;AW&#x27;</span>,<span class="string">&#x27;AX&#x27;</span>,<span class="string">&#x27;AY&#x27;</span>,<span class="string">&#x27;AZ&#x27;</span>);</span><br><span class="line">	<span class="comment">/***********</span></span><br><span class="line"><span class="comment">	 * 2019年6月20日</span></span><br><span class="line"><span class="comment">	 * 导出数据</span></span><br><span class="line"><span class="comment">	***********/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">exportData</span>(<span class="params"><span class="variable">$records</span></span>)</span>&#123;</span><br><span class="line">		<span class="comment">// echo json_encode($records);exit;</span></span><br><span class="line">		<span class="variable">$objPHPExcel</span>=<span class="keyword">new</span> PHPExcel();</span><br><span class="line">		<span class="variable">$objPHPExcel</span>-&gt;getProperties()</span><br><span class="line">					-&gt;setCreator(<span class="string">&quot;神州视翰&quot;</span>)</span><br><span class="line">					-&gt;setLastModifiedBy(<span class="string">&quot;神州视翰&quot;</span>)</span><br><span class="line">					-&gt;setTitle(<span class="string">&quot;数据EXCEL导出&quot;</span>)</span><br><span class="line">					-&gt;setSubject(<span class="string">&quot;数据EXCEL导出&quot;</span>)</span><br><span class="line">					-&gt;setDescription(<span class="string">&quot;会议数据&quot;</span>)</span><br><span class="line">					-&gt;setKeywords(<span class="string">&quot;excel&quot;</span>)</span><br><span class="line">					-&gt;setCategory(<span class="string">&quot;result file&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$objPHPExcel</span>-&gt;setActiveSheetIndex(<span class="number">0</span>);</span><br><span class="line">		<span class="comment">//设置表头</span></span><br><span class="line">		<span class="keyword">foreach</span>(<span class="built_in">self</span>::<span class="variable">$titleInfo</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">			<span class="variable">$key</span> = <span class="built_in">self</span>::<span class="variable">$colIndex</span>[<span class="variable">$k</span>].<span class="string">&#x27;1&#x27;</span>;</span><br><span class="line">			<span class="variable">$value</span>= <span class="variable">$v</span>[<span class="number">1</span>];</span><br><span class="line">			<span class="variable">$objPHPExcel</span>-&gt;getActiveSheet()-&gt;setCellValue(<span class="variable">$key</span>, <span class="variable">$value</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//填充数据</span></span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$records</span> <span class="keyword">as</span> <span class="variable">$index</span>=&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">			<span class="keyword">foreach</span>(<span class="built_in">self</span>::<span class="variable">$titleInfo</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">				<span class="variable">$key</span> = <span class="built_in">self</span>::<span class="variable">$colIndex</span>[<span class="variable">$k</span>].(<span class="variable">$index</span>+<span class="number">2</span>);</span><br><span class="line">				<span class="variable">$cellValue</span> = <span class="built_in">self</span>::convert(<span class="variable">$value</span>[<span class="variable">$v</span>[<span class="number">0</span>]],<span class="variable">$k</span>);</span><br><span class="line">				<span class="variable">$objPHPExcel</span>-&gt;getActiveSheet()-&gt;setCellValue(<span class="variable">$key</span>, <span class="variable">$cellValue</span>);<span class="comment">// PHPExcel_Cell_DataType::TYPE_STRING</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//设置居左</span></span><br><span class="line">		<span class="variable">$objPHPExcel</span>-&gt;getDefaultStyle()-&gt;getAlignment()-&gt;setHorizontal(PHPExcel_Style_Alignment::HORIZONTAL_LEFT);</span><br><span class="line">		<span class="comment">//设置列宽</span></span><br><span class="line">		<span class="keyword">foreach</span>(<span class="built_in">self</span>::<span class="variable">$titleInfo</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt;<span class="variable">$v</span>)&#123;</span><br><span class="line">			<span class="variable">$key</span> = <span class="built_in">self</span>::<span class="variable">$colIndex</span>[<span class="variable">$k</span>];</span><br><span class="line">			<span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$v</span>[<span class="number">2</span>]))&#123;</span><br><span class="line">				<span class="variable">$objPHPExcel</span>-&gt;getActiveSheet()-&gt;getColumnDimension(<span class="variable">$key</span>)-&gt;setWidth(<span class="variable">$v</span>[<span class="number">2</span>]);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$objPHPExcel</span>-&gt;getActiveSheet()-&gt;setTitle(<span class="string">&quot;会议导出记录&quot;</span>);	</span><br><span class="line">		<span class="variable">$objPHPExcel</span>-&gt;setActiveSheetIndex(<span class="number">0</span>);</span><br><span class="line">		<span class="variable">$fileName</span> = iconv(<span class="string">&#x27;utf-8&#x27;</span>, <span class="string">&#x27;gb2312&#x27;</span>,<span class="string">&quot;会议导出&quot;</span>);</span><br><span class="line">		<span class="variable">$time</span> = date(<span class="string">&#x27;Y-m-d-H-i-s&#x27;</span>,time()).<span class="string">&quot;.xls&quot;</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//保存结果</span></span><br><span class="line">		<span class="variable">$objWriter</span> = PHPExcel_IOFactory::createWriter(<span class="variable">$objPHPExcel</span>,<span class="string">&#x27;Excel5&#x27;</span>);</span><br><span class="line">		<span class="variable">$objWriter</span> -&gt; save(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="variable">$fileName</span>.<span class="variable">$time</span>);<span class="comment">//			 </span></span><br><span class="line">		<span class="variable">$settingdata</span> = <span class="keyword">array</span>(<span class="string">&#x27;code&#x27;</span>=&gt;<span class="number">0</span>,<span class="string">&#x27;url&#x27;</span>=&gt;<span class="string">&quot;会议导出&quot;</span>.<span class="variable">$time</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$settingdata</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/***********</span></span><br><span class="line"><span class="comment">		2019年1月7日</span></span><br><span class="line"><span class="comment">		获取数组的值</span></span><br><span class="line"><span class="comment">	***********/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span>(<span class="params"><span class="variable">$map</span>,<span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(array_key_exists(<span class="variable">$key</span>,<span class="variable">$map</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$map</span>[<span class="variable">$key</span>];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$key</span>;<span class="comment">//修改bug，原来是返回$map</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/***********</span></span><br><span class="line"><span class="comment">	 * 2019年6月21日  </span></span><br><span class="line"><span class="comment">	 * 数值转换函数  苏传超</span></span><br><span class="line"><span class="comment">	***********/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params"><span class="variable">$v</span>,<span class="variable">$index</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="built_in">self</span>::<span class="variable">$titleInfo</span>[<span class="variable">$index</span>][<span class="number">3</span>]))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="variable">$v</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$cv</span>=<span class="built_in">self</span>::<span class="variable">$titleInfo</span>[<span class="variable">$index</span>][<span class="number">3</span>];</span><br><span class="line">		<span class="keyword">if</span>(is_array(<span class="variable">$cv</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">self</span>::getValue(<span class="variable">$cv</span>,<span class="variable">$v</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(is_string(<span class="variable">$cv</span>))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">self</span>::<span class="variable">$cv</span>(<span class="variable">$v</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/***********</span></span><br><span class="line"><span class="comment">	 * 2019年6月21日  </span></span><br><span class="line"><span class="comment">	 * 根据出生日期，求年龄  苏传超</span></span><br><span class="line"><span class="comment">	***********/</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getBrithAge</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> date(<span class="string">&#x27;Y&#x27;</span>)-date(<span class="string">&#x27;Y&#x27;</span>,strtotime(<span class="variable">$v</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">tostring</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&#x27;<span class="subst">$v</span>&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="产生虚拟ip、mac地址"><a href="#产生虚拟ip、mac地址" class="headerlink" title="产生虚拟ip、mac地址"></a>产生虚拟ip、mac地址</h3><p>具体代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ip</span>=sprintf(<span class="string">&quot;0.%d.%d.%d&quot;</span>,mt_rand(<span class="number">1</span>,<span class="number">255</span>),mt_rand(<span class="number">1</span>,<span class="number">255</span>),mt_rand(<span class="number">1</span>,<span class="number">255</span>));</span><br><span class="line"><span class="variable">$mac</span>=sprintf(<span class="string">&quot;00:00:%02X:%02X:%02X:%02X&quot;</span>,mt_rand(<span class="number">1</span>,<span class="number">255</span>),mt_rand(<span class="number">1</span>,<span class="number">255</span>),mt_rand(<span class="number">1</span>,<span class="number">255</span>),mt_rand(<span class="number">1</span>,<span class="number">255</span>));</span><br></pre></td></tr></table></figure>

<p>上面的代码，虽然是简单，但是想记录当时的思维过程。使用了sprintf函数，第一次感觉到C语言的标准函数功能强大之处。前人，设计C语言函数库的时候，真是非常强大。记得有一次，用js做时间处理的时候，就在想js里面为啥没有这样的函数，所以只好手动补0，1:2转换为01:02的格式。</p>
<p>写代码，首先要有大局的思路。首先想大体的想，可能有几种方式。然后逐一考虑各个方法的优缺点。择优选择。上面代码的思维过程：1、将ip作为一个整体来处理。比如：192.168.2.235当成256进制的数，然后将产生的一个比较大的数字，再转换为ip，再进行分隔。所以，有点麻烦了不是。2、后来，中午吃饭，快走回来的时候，想到了，ip呢，当随机数处理。MAC地址，就当作字符处理。随机选择[0-9A-F]中的一个字符。再join。3、实际编码的过程中，简单粗暴，直接按上面的代码处理。反正为啥要用到sprintf函数，不知道，灵光一现吧。</p>
<p>（差点想要循环，join等函数呢。）</p>
<h3 id="php中对应的序列解包功能-可变数量的参数列表"><a href="#php中对应的序列解包功能-可变数量的参数列表" class="headerlink" title="php中对应的序列解包功能  - 可变数量的参数列表"></a>php中对应的序列解包功能  - 可变数量的参数列表</h3><p>php中，好像没有办法，将一个数组，直接解包成逐个的变量，代入到函数的调用中。那么只好使用了替代的方法，call_user_func_array，跟js中的apply，有点像。算是一种替代的方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$params</span>=<span class="keyword">array</span>(<span class="string">&quot;00.00.%02X.%02X.%02X.%02X&quot;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;substr_count(<span class="variable">$params</span>[<span class="number">0</span>], <span class="string">&#x27;%&#x27;</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">	<span class="variable">$params</span>[]=mt_rand(<span class="number">1</span>,<span class="number">255</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> call_user_func_array(<span class="string">&#x27;sprintf&#x27;</span>,<span class="variable">$params</span>);</span><br></pre></td></tr></table></figure>

<p>作为对比，看js的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params">a,b,c</span>)</span>&#123;<span class="keyword">return</span> c&#125;</span><br><span class="line">test.apply(<span class="built_in">this</span>,[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])  <span class="comment">//3  这个跟call_user_func_array像。</span></span><br><span class="line">test.call(<span class="built_in">this</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)    <span class="comment">//这个是直接调用</span></span><br><span class="line">test(...[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])        <span class="comment">//其实，想要的是这个运算符</span></span><br></pre></td></tr></table></figure>

<p>后来发现，php中也有类似的写发。叫<strong>可变数量的参数列表</strong>（PHP5.6版本以上）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//直接调用</span></span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&#x27;00.00.%02X.%02X.%02X.%02X&#x27;</span>,...<span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//就是将传入的参数变成一个索引数组</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">app</span>(<span class="params">...<span class="variable">$num</span></span>) </span>&#123;</span><br><span class="line">    var_dump(<span class="variable">$num</span>); <span class="comment">//输出为一个索引数组</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> app(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="comment">//就是传入一个数组，参数依次接收</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">app</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span> + <span class="variable">$b</span>; <span class="comment">//输出3</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$arr</span> = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">app(...<span class="variable">$num</span>);</span><br></pre></td></tr></table></figure>

<h3 id="php上传文件格式判断"><a href="#php上传文件格式判断" class="headerlink" title="php上传文件格式判断"></a>php上传文件格式判断</h3><p>上传文件时，当然需要对上传文件的格式进行判断。之前一直采用获取文件的扩展名，转换小写，并判断是否在允许上传的格式中。然后，又发现另外一种好方法，好像浏览器会根据上传的文件，进行自动判断格式。type字段，有上传的格式信息。如下：</p>
<p>之前的老方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//允许上传的文件类型</span></span><br><span class="line"><span class="keyword">if</span>(!in_array(<span class="variable">$ext</span>,<span class="keyword">array</span>(<span class="string">&#x27;.avi&#x27;</span>,<span class="string">&#x27;.mov&#x27;</span>,<span class="string">&#x27;.rmvb&#x27;</span>,<span class="string">&#x27;.mpeg&#x27;</span>,<span class="string">&#x27;mpg&#x27;</span>,<span class="string">&#x27;mpe&#x27;</span>,<span class="string">&#x27;.mkv&#x27;</span>,<span class="string">&#x27;.flv&#x27;</span>,<span class="string">&#x27;.m4v&#x27;</span>,<span class="string">&#x27;.rm&#x27;</span>,<span class="string">&#x27;.3gp&#x27;</span>,<span class="string">&#x27;.dat&#x27;</span>,<span class="string">&#x27;.mp4&#x27;</span>,<span class="string">&#x27;.wmv&#x27;</span>)))&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;msg&#x27;</span>=&gt;<span class="string">&#x27;文件上传失败，视频格式不支持！&#x27;</span>,<span class="string">&#x27;success&#x27;</span>=&gt;<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(strpos(<span class="variable">$_FILES</span>[<span class="variable">$field</span>][<span class="string">&#x27;type&#x27;</span>],<span class="string">&#x27;video/&#x27;</span>)!==<span class="number">0</span>)&#123;</span><br><span class="line">	 <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">&#x27;msg&#x27;</span>=&gt;<span class="string">&#x27;文件上传失败，视频格式不支持！&#x27;</span>,<span class="string">&#x27;success&#x27;</span>=&gt;<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="php中的树数据结构，遍历"><a href="#php中的树数据结构，遍历" class="headerlink" title="php中的树数据结构，遍历"></a>php中的树数据结构，遍历</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getOrganization</span>(<span class="params"><span class="variable">$structureId</span></span>)</span>&#123;</span><br><span class="line">	<span class="variable">$db</span> = Zend_Registry::get(<span class="string">&#x27;db&#x27;</span>); </span><br><span class="line">	<span class="variable">$rows</span>=<span class="variable">$db</span>-&gt;fetchAll(<span class="string">&#x27;select organization_id id ,organization_parent_id pid,organization_name name from  organization where structure_id =:id;&#x27;</span>,<span class="keyword">array</span>(<span class="string">&#x27;id&#x27;</span>=&gt;<span class="variable">$structureId</span>));</span><br><span class="line">	<span class="variable">$mapping</span> = array_column(<span class="variable">$rows</span>,<span class="string">&#x27;pid&#x27;</span>,<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">	<span class="built_in">self</span>::<span class="variable">$organizationData</span> = <span class="variable">$mapping</span>;</span><br><span class="line">	<span class="variable">$result</span>=<span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$mapping</span> <span class="keyword">as</span> <span class="variable">$id</span>=&gt;<span class="variable">$pid</span>)&#123;</span><br><span class="line">		<span class="variable">$cur</span>=<span class="variable">$pid</span>;</span><br><span class="line">		<span class="variable">$path</span>=<span class="keyword">array</span>(<span class="variable">$pid</span>);</span><br><span class="line">		<span class="keyword">while</span>(<span class="variable">$cur</span>&gt;<span class="number">0</span>)&#123;<span class="comment">//末级节点</span></span><br><span class="line">			<span class="variable">$cur</span>=<span class="variable">$mapping</span>[<span class="variable">$cur</span>];</span><br><span class="line">			<span class="variable">$path</span>[]=<span class="variable">$cur</span>;</span><br><span class="line">			<span class="keyword">if</span>(count(<span class="variable">$path</span>)&gt;<span class="number">20</span>)&#123;<span class="comment">//防止死循环</span></span><br><span class="line">				<span class="keyword">die</span>(<span class="string">&quot;maximum recursion depth exceeded &quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$result</span>[<span class="variable">$id</span>]=join(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$path</span>);<span class="comment">//路径</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分组统计"><a href="#分组统计" class="headerlink" title="分组统计"></a>分组统计</h3><blockquote>
<p>分组统计，则需要对数据创建数组。有可能是高维的。高维数组，注意初始化数组。js代码估计也差不多。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对数据进行分组统计，创建一个三维的数组，然后每个数组叠加。</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="keyword">array</span>();  <span class="comment">//data [&#x27;organization_id&#x27;][&#x27;date&#x27;][]</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$rows</span> <span class="keyword">as</span> <span class="variable">$k</span>=&gt;&amp;<span class="variable">$row</span>)&#123;</span><br><span class="line">	<span class="variable">$oid</span>=<span class="variable">$row</span>[<span class="string">&#x27;organization_id&#x27;</span>];</span><br><span class="line">	<span class="variable">$date</span> = <span class="variable">$row</span>[<span class="string">&#x27;conversation_schedule_date&#x27;</span>];</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$oid</span>]))&#123;<span class="comment">//如果当前的，不存在，则进行初始化。</span></span><br><span class="line">		<span class="variable">$data</span>[<span class="variable">$oid</span>]=<span class="keyword">array</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>]))&#123;</span><br><span class="line">		<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>]=<span class="keyword">array</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="variable">$data</span>[<span class="variable">$oid</span>][<span class="variable">$date</span>][]=<span class="variable">$row</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//最后再对每个数组，进行求和、或者处理。或者在上一步的时候，进行处理。</span></span><br></pre></td></tr></table></figure>

<p>然后将多维的数组，再次降成一维数组，输出。</p>
<blockquote>
<p>需要注意的时候，嵌套的循环，内部的foreach，则是外层的循环变量，如$oidArr。我在写的过程成，错写成了$data。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> =<span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$oid</span>=&gt;<span class="variable">$oidArr</span>)&#123;</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$oidArr</span> <span class="keyword">as</span> <span class="variable">$date</span>=&gt;<span class="variable">$dateArr</span>)&#123;</span><br><span class="line">		<span class="variable">$basehospital</span> = <span class="built_in">self</span>::<span class="variable">$organizationData</span>[<span class="variable">$oid</span>];</span><br><span class="line">		<span class="comment">// &#123;&#x27;date&#x27;:&#x27;2019-07-01&#x27;,&#x27;basehospital&#x27;:&#x27;华山医院&#x27;,&#x27;price&#x27;:&#x27;11&#x27;,&#x27;count&#x27;:&#x27;1&#x27;&#125;,</span></span><br><span class="line">		<span class="variable">$result</span>[]=<span class="keyword">array</span>(<span class="string">&#x27;date&#x27;</span>=&gt;<span class="variable">$date</span>,<span class="string">&#x27;basehospital&#x27;</span>=&gt;<span class="variable">$basehospital</span>,<span class="string">&#x27;price&#x27;</span>=&gt;<span class="variable">$dateArr</span>[<span class="string">&#x27;price&#x27;</span>],<span class="string">&#x27;count&#x27;</span>=&gt;<span class="variable">$dateArr</span>[<span class="string">&#x27;count&#x27;</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>  sql中如果有BETWEEN关键字，由于其已经包含了and，所以整句应该添加一个括号，包裹。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and (visit_status BETWEEN 1 and 10)</span><br></pre></td></tr></table></figure>

<ul>
<li>sql替换<blockquote>
<p>两种其实差不多，后一种为了查询更多内容。</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql &#x3D; &quot;select user_name from user_extend where user_id &#x3D; (select user_id from schedule where schedule_id &#x3D; $id)&quot;;</span><br><span class="line"></span><br><span class="line">$sql&#x3D; &quot;select s.user_id,user_name from schedule  as s  left join user_extend as u  on s.user_id&#x3D;u.user_id where schedule_id &#x3D; $id&quot;;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/05/05/2019-05-05/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/05/2019-05-05/" class="post-title-link" itemprop="url">typecho 源码解读（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-05 12:12:00" itemprop="dateCreated datePublished" datetime="2019-05-05T12:12:00+00:00">2019-05-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="typecho-源码解读（二）"><a href="#typecho-源码解读（二）" class="headerlink" title="typecho 源码解读（二）"></a>typecho 源码解读（二）</h1><blockquote>
<p>接之前的源码分析，继续对其进行分析。</p>
</blockquote>
<h2 id="首页是如何显示出来的"><a href="#首页是如何显示出来的" class="headerlink" title="首页是如何显示出来的"></a>首页是如何显示出来的</h2><p>需要经具体的路由呢。<br>Router.php中的注释（TODO 增加cache缓存）依然没有实现。</p>
<h3 id="dispatch方法："><a href="#dispatch方法：" class="headerlink" title="dispatch方法："></a>dispatch方法：</h3><blockquote>
<p>循环路由表，根据匹配到的值，匹配到出口，然后执行try中的语句。跟match方法很像。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * 路由分发函数</span><br><span class="line">    *</span><br><span class="line">    * @return void</span><br><span class="line">    * @throws Exception</span><br><span class="line">    *&#x2F;</span><br><span class="line">   public static function dispatch()</span><br><span class="line">   &#123;</span><br><span class="line">       &#x2F;** 获取PATHINFO *&#x2F;</span><br><span class="line">       $pathInfo &#x3D; self::getPathInfo();</span><br><span class="line"></span><br><span class="line">       foreach (self::$_routingTable as $key &#x3D;&gt; $route) &#123;</span><br><span class="line">           if (preg_match($route[&#39;regx&#39;], $pathInfo, $matches)) &#123;</span><br><span class="line">               self::$current &#x3D; $key;</span><br><span class="line"></span><br><span class="line">               try &#123;</span><br><span class="line">                   &#x2F;** 载入参数 *&#x2F;</span><br><span class="line">                   $params &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">                   if (!empty($route[&#39;params&#39;])) &#123;</span><br><span class="line">                       unset($matches[0]);</span><br><span class="line">                       $params &#x3D; array_combine($route[&#39;params&#39;], $matches);</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   $widget &#x3D; Typecho_Widget::widget($route[&#39;widget&#39;], NULL, $params);</span><br><span class="line"></span><br><span class="line">                   if (isset($route[&#39;action&#39;])) &#123;</span><br><span class="line">                       $widget-&gt;&#123;$route[&#39;action&#39;]&#125;();</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   Typecho_Response::callback();</span><br><span class="line">                   return;</span><br><span class="line"></span><br><span class="line">               &#125; catch (Exception $e) &#123;</span><br><span class="line">                   if (404 &#x3D;&#x3D; $e-&gt;getCode()) &#123;</span><br><span class="line">                       Typecho_Widget::destory($route[&#39;widget&#39;]);</span><br><span class="line">                       continue;</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   throw $e;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       &#x2F;** 载入路由异常支持 *&#x2F;</span><br><span class="line">       throw new Typecho_Router_Exception(&quot;Path &#39;&#123;$pathInfo&#125;&#39; not found&quot;, 404);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>在路由分发之前，其实已经获取到了路由表。可是从哪一步获取到的呢？正常加载，config.inc.php然后到index.php。加载是在Typecho_Widget::widget(‘Widget_Init’);过程中有了路由表，那么全局Router::setRoutes只调用了一次。而其作用是设置路由表的。那么其又是如何被调用的？通过全局搜索，找到Init.php中有如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 初始化路由器 *&#x2F;</span><br><span class="line">Typecho_Router::setRoutes($options-&gt;routingTable);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果上述初始化代码被注释，有如下报错，而且还有404页面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Notice: Undefined index: feed in D:\phpStudy\PHPTutorial\zend\typecho\var\Typecho\Router.php on line 176</span><br><span class="line"></span><br><span class="line">Warning: Invalid argument supplied for foreach() in D:\phpStudy\PHPTutorial\zend\typecho\var\Typecho\Router.php on line 180</span><br></pre></td></tr></table></figure>

<p>重点来了**Typecho_Widget::widget(‘Widget_Init’);**作用是，初始化，Widget文件夹下面的Init.php。并执行execute方法体。（稍后研究）</p>
<p>index.php中，调试路由表的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;index.php</span><br><span class="line">&#x2F;** 开始路由分发 *&#x2F;</span><br><span class="line">var_dump(Typecho_Router::getTable());</span><br><span class="line">Typecho_Router::dispatch();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;在Router.php中增加方法，输出私有变量</span><br><span class="line">public static function getTable()</span><br><span class="line">&#123;</span><br><span class="line">	return self::$_routingTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>路径获取，类似于，有限从类的缓存，静态变量中获取，如果没有，则重新获取（实际上是默认参数），代码如下（略过）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 设置全路径</span><br><span class="line"> *</span><br><span class="line"> * @access public</span><br><span class="line"> * @param string $pathInfo</span><br><span class="line"> * @return void</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static function setPathInfo($pathInfo &#x3D; &#39;&#x2F;&#39;)</span><br><span class="line">&#123;</span><br><span class="line">    self::$_pathInfo &#x3D; $pathInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 获取全路径</span><br><span class="line"> *</span><br><span class="line"> * @access public</span><br><span class="line"> * @return string</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static function getPathInfo()</span><br><span class="line">&#123;	</span><br><span class="line">	&#x2F;&#x2F;优先从“缓冲”中读取，如果没有，则先设置“缓存”再读取</span><br><span class="line">    if (NULL &#x3D;&#x3D;&#x3D; self::$_pathInfo) &#123;</span><br><span class="line">        self::setPathInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return self::$_pathInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实例化Widget组件"><a href="#实例化Widget组件" class="headerlink" title="实例化Widget组件"></a>实例化Widget组件</h3><p>在dispatch中，其实有这样的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$widget &#x3D; Typecho_Widget::widget($route[&#39;widget&#39;], NULL, $params);</span><br><span class="line"></span><br><span class="line">if (isset($route[&#39;action&#39;])) &#123;</span><br><span class="line">    $widget-&gt;&#123;$route[&#39;action&#39;]&#125;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即实例化路由表中的组件，已经调用action。打印（Router::dispatch中var_dump(self::$_routingTable);）得到路由表，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[&quot;index&quot;]&#x3D;&gt;</span><br><span class="line">  array(6) &#123;</span><br><span class="line">    [&quot;url&quot;]&#x3D;&gt;</span><br><span class="line">    string(1) &quot;&#x2F;&quot;</span><br><span class="line">    [&quot;widget&quot;]&#x3D;&gt;</span><br><span class="line">    string(14) &quot;Widget_Archive&quot;</span><br><span class="line">    [&quot;action&quot;]&#x3D;&gt;</span><br><span class="line">    string(6) &quot;render&quot;</span><br><span class="line">    [&quot;regx&quot;]&#x3D;&gt;</span><br><span class="line">    string(8) &quot;|^[&#x2F;]?$|&quot;</span><br><span class="line">    [&quot;format&quot;]&#x3D;&gt;</span><br><span class="line">    string(1) &quot;&#x2F;&quot;</span><br><span class="line">    [&quot;params&quot;]&#x3D;&gt;</span><br><span class="line">    array(0) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>所以，首页会渲染Widget_Archive组件，并调用render方法。那么根据Typecho_Widget的定义，widget方法会检测，如果没有实例化这个变量，则实例化这个变量，然后调用execute方法。</p>
<p>Widget_Archive组件的继承关系：Widget_Archive→Widget_Abstract_Contents→Widget_Abstract→Typecho_Widget。所以首页的文章是这样的出来的。具体细节待再分析。</p>
<h2 id="Widget-Init类"><a href="#Widget-Init类" class="headerlink" title="Widget_Init类"></a>Widget_Init类</h2><p>先贴代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化模块</span><br><span class="line"> *</span><br><span class="line"> * @package Widget</span><br><span class="line"> *&#x2F;</span><br><span class="line">class Widget_Init extends Typecho_Widget</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 入口函数,初始化路由器</span><br><span class="line">     *</span><br><span class="line">     * @access public</span><br><span class="line">     * @return void</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public function execute()</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;** 对变量赋值 *&#x2F;</span><br><span class="line">        $options &#x3D; $this-&gt;widget(&#39;Widget_Options&#39;);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 检查安装状态 *&#x2F;</span><br><span class="line">        if (!$options-&gt;installed) &#123;</span><br><span class="line">            $options-&gt;update(array(&#39;value&#39; &#x3D;&gt; 1), Typecho_Db::get()-&gt;sql()-&gt;where(&#39;name &#x3D; ?&#39;, &#39;installed&#39;));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;** 语言包初始化 *&#x2F;</span><br><span class="line">        if ($options-&gt;lang &amp;&amp; $options-&gt;lang !&#x3D; &#39;zh_CN&#39;) &#123;</span><br><span class="line">            $dir &#x3D; defined(&#39;__TYPECHO_LANG_DIR__&#39;) ? __TYPECHO_LANG_DIR__ : __TYPECHO_ROOT_DIR__ . &#39;&#x2F;usr&#x2F;langs&#39;;</span><br><span class="line">            Typecho_I18n::setLang($dir . &#39;&#x2F;&#39; . $options-&gt;lang . &#39;.mo&#39;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;** 备份文件目录初始化 *&#x2F;</span><br><span class="line">        if (!defined(&#39;__TYPECHO_BACKUP_DIR__&#39;)) &#123;</span><br><span class="line">            define(&#39;__TYPECHO_BACKUP_DIR__&#39;, __TYPECHO_ROOT_DIR__ . &#39;&#x2F;usr&#x2F;backups&#39;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;** cookie初始化 *&#x2F;</span><br><span class="line">        Typecho_Cookie::setPrefix($options-&gt;rootUrl);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 初始化charset *&#x2F;</span><br><span class="line">        Typecho_Common::$charset &#x3D; $options-&gt;charset;</span><br><span class="line"></span><br><span class="line">        &#x2F;** 初始化exception *&#x2F;</span><br><span class="line">        Typecho_Common::$exceptionHandle &#x3D; &#39;Widget_ExceptionHandle&#39;;</span><br><span class="line"></span><br><span class="line">        &#x2F;** 设置路径 *&#x2F;</span><br><span class="line">        if (defined(&#39;__TYPECHO_PATHINFO_ENCODING__&#39;)) &#123;</span><br><span class="line">            $pathInfo &#x3D; $this-&gt;request-&gt;getPathInfo(__TYPECHO_PATHINFO_ENCODING__, $options-&gt;charset);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $pathInfo &#x3D; $this-&gt;request-&gt;getPathInfo();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Typecho_Router::setPathInfo($pathInfo);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 初始化路由器 *&#x2F;</span><br><span class="line">        Typecho_Router::setRoutes($options-&gt;routingTable);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 初始化插件 *&#x2F;</span><br><span class="line">        Typecho_Plugin::init($options-&gt;plugins);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 初始化回执 *&#x2F;</span><br><span class="line">        $this-&gt;response-&gt;setCharset($options-&gt;charset);</span><br><span class="line">        $this-&gt;response-&gt;setContentType($options-&gt;contentType);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 初始化时区 *&#x2F;</span><br><span class="line">        Typecho_Date::setTimezoneOffset($options-&gt;timezone);</span><br><span class="line"></span><br><span class="line">        &#x2F;** 开始会话, 减小负载只针对后台打开session支持 *&#x2F;</span><br><span class="line">        if ($this-&gt;widget(&#39;Widget_User&#39;)-&gt;hasLogin()) &#123;</span><br><span class="line">            @session_start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;** 监听缓冲区 *&#x2F; </span><br><span class="line">        ob_start();&#x2F;&#x2F;只有两处，另外一处是在install.php中</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ob_start缓存区开了，但是找不到关的地方。backup.php中确实有，但好像并不是总会调用。</p>
<h2 id="ajax请求"><a href="#ajax请求" class="headerlink" title="ajax请求"></a>ajax请求</h2><p>查看，ajax请求，是如何响应的。那么第一个问题是，怎么鉴定一个请求是不是ajax请求？从network中，过滤xhr发现并没有，而登录好像并不是ajax请求？那么这个框架，能实现ajax请求吗？暂略。</p>
<p>Widget_Ajax这个好像是跟ajax相关的。但是这个类的方法比较少。那么猜想，这个Widget组件是如何被调用的呢？全局搜索Widget_Ajax只在Widget_Do extends Typecho_Widget中发现。这个类，有个映射关系变量，另外实现了一个execute方法。此文件的原理，有待考究。有一处重点代码，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (isset($widgetName) &amp;&amp; class_exists($widgetName)) &#123;</span><br><span class="line">    &#x2F;&#x2F;类反射</span><br><span class="line">    $reflectionWidget &#x3D;  new ReflectionClass($widgetName);</span><br><span class="line">    &#x2F;&#x2F;如果这个类实现了Widget_Interface_Do接口，则执行</span><br><span class="line">    if ($reflectionWidget-&gt;implementsInterface(&#39;Widget_Interface_Do&#39;)) &#123;</span><br><span class="line">        $this-&gt;widget($widgetName)-&gt;action();</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Widget_Do这个只在Upgrade中使用。升级文件洋洋洒洒2千行，主要功能是对数据库文件进行转换格式等，确保数据库的格式兼容。以后有用到升级相关的，考究一下。</p>
<h2 id="数据库的深层机理"><a href="#数据库的深层机理" class="headerlink" title="数据库的深层机理"></a>数据库的深层机理</h2><h2 id="一些特别的代码"><a href="#一些特别的代码" class="headerlink" title="一些特别的代码"></a>一些特别的代码</h2><h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><p>位于Archive.php中。switch一般都是一个变量，case是一个常量。而下面的true即为case表达式中的返回值情况，如果未真，则执行。不知道其他语言，有没有这个特点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 判断聚合类型 *&#x2F;</span><br><span class="line">switch (true) &#123;</span><br><span class="line">    case 0 &#x3D;&#x3D;&#x3D; strpos($this-&gt;request-&gt;feed, &#39;&#x2F;rss&#x2F;&#39;) || &#39;&#x2F;rss&#39; &#x3D;&#x3D; $this-&gt;request-&gt;feed:</span><br><span class="line">        &#x2F;** 如果是RSS1标准 *&#x2F;</span><br><span class="line">        $this-&gt;request-&gt;feed &#x3D; substr($this-&gt;request-&gt;feed, 4);</span><br><span class="line">        $this-&gt;_feedType &#x3D; Typecho_Feed::RSS1;</span><br><span class="line">        $this-&gt;_currentFeedUrl &#x3D; $this-&gt;options-&gt;feedRssUrl;</span><br><span class="line">        $this-&gt;_feedContentType &#x3D; &#39;application&#x2F;rdf+xml&#39;;</span><br><span class="line">        break;</span><br><span class="line">    case 0 &#x3D;&#x3D;&#x3D; strpos($this-&gt;request-&gt;feed, &#39;&#x2F;atom&#x2F;&#39;) || &#39;&#x2F;atom&#39; &#x3D;&#x3D; $this-&gt;request-&gt;feed:</span><br><span class="line">        &#x2F;** 如果是ATOM标准 *&#x2F;</span><br><span class="line">        $this-&gt;request-&gt;feed &#x3D; substr($this-&gt;request-&gt;feed, 5);</span><br><span class="line">        $this-&gt;_feedType &#x3D; Typecho_Feed::ATOM1;</span><br><span class="line">        $this-&gt;_currentFeedUrl &#x3D; $this-&gt;options-&gt;feedAtomUrl;</span><br><span class="line">        $this-&gt;_feedContentType &#x3D; &#39;application&#x2F;atom+xml&#39;;</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        $this-&gt;_feedType &#x3D; Typecho_Feed::RSS2;</span><br><span class="line">        $this-&gt;_currentFeedUrl &#x3D; $this-&gt;options-&gt;feedUrl;</span><br><span class="line">        $this-&gt;_feedContentType &#x3D; &#39;application&#x2F;rss+xml&#39;;</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/04/29/2019-04-29/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/29/2019-04-29/" class="post-title-link" itemprop="url">php中的一个bug的排查过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-29 12:12:00" itemprop="dateCreated datePublished" datetime="2019-04-29T12:12:00+00:00">2019-04-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="php中的一个bug的排查过程"><a href="#php中的一个bug的排查过程" class="headerlink" title="php中的一个bug的排查过程"></a>php中的一个bug的排查过程</h1><blockquote>
<p>1、首先，根据出问题的地方，确定好文件。2、通过echo 来确定查找到的文件是否正常。通过在一段代码中，设置多出的echo，发现有的echo并未输出。3、然后以这种方式，确定了出问题的地方是一个函数。（差点误导我了，我最开始以为代码未执行完，是因为代码中有exit，所以主动放弃执行了，所以导致代码未执行完。没有想到出错导致代码未完成。）</p>
</blockquote>
<ul>
<li>出问题的代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 2222;&#x2F;&#x2F;这个正常输出了</span><br><span class="line">$sock &#x3D; socket_create(AF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));</span><br><span class="line">echo 3333;&#x2F;&#x2F;这个没有输出了</span><br></pre></td></tr></table></figure>

<ul>
<li>这个时候才想到，显示所有的错误（有点晚了）：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(E_ALL);</span><br></pre></td></tr></table></figure>
<ul>
<li>然后看到错误提示：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Call to undefined function socket_create() in </span><br></pre></td></tr></table></figure>
<ul>
<li>直接搜到的解决办法：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/leoyi330/articles/6806567.html">Fatal error: Call to undefined function socket_create() 解决办法</a></li>
</ul>
<p>然后开启php扩展：extension=php_sockets.dll</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/04/29/2019-04-29-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/29/2019-04-29-2/" class="post-title-link" itemprop="url">typecho 源码解读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-29 12:12:00" itemprop="dateCreated datePublished" datetime="2019-04-29T12:12:00+00:00">2019-04-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="typecho-源码解读"><a href="#typecho-源码解读" class="headerlink" title="typecho 源码解读"></a>typecho 源码解读</h1><p>typecho没有用到命名空间。此框架用到较多以类封装的静态函数的方式。解读这个框架的源码，首先，了解其大致的加载流程。其次呢，了解一些重要的类的加载，比如数据库的加载。再次，就是根据实际操作，查看请求的具体信息，来了解一个请求，是如何加载进来的。还有，主题里面的各个布局文件，是如何正确的加载进来。整个框架，一些重要的变量是如何传递的？</p>
<p>通过这个框架的研究，加上之前多媒体后台，前后端不分离的项目，php、js、html混合在一起，开发的难度确实大。如果选择的框架又不好用或者对代码没有一定的约束力，那么整体代码都失控了。</p>
<h2 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h2><h3 id="入口文件index-php"><a href="#入口文件index-php" class="headerlink" title="入口文件index.php"></a>入口文件index.php</h3><p>首先，检测 __TYPECHO_ROOT_DIR__这个变量（全部文件都以此变量区分是否属于入口加载，）加载config.inc.php，判断结构  if( ! a  &amp;&amp; !b) 等价与 if(!(a || b)) ,即a，b只要有一个为真，就不执行判断内部的逻辑，也即__TYPECHO_ROOT_DIR__定义或者成功加载 config.inc.php，就不会进入if内部。但实际变量不存在，那么就看能不能加载到配置文件，config.inc.php，如果没有加载成功，则进重定向到安装模块，进行安装。</p>
<p>正常加载到配置文件，那么执行后面四个语言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 初始化组件 *&#x2F;</span><br><span class="line">Typecho_Widget::widget(&#39;Widget_Init&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;** 注册一个初始化插件 *&#x2F;</span><br><span class="line">Typecho_Plugin::factory(&#39;index.php&#39;)-&gt;begin();</span><br><span class="line"></span><br><span class="line">&#x2F;** 开始路由分发 *&#x2F;</span><br><span class="line">Typecho_Router::dispatch();</span><br><span class="line"></span><br><span class="line">&#x2F;** 注册一个结束插件 *&#x2F;</span><br><span class="line">Typecho_Plugin::factory(&#39;index.php&#39;)-&gt;end();</span><br></pre></td></tr></table></figure>

<p>那么就需要看看配置文件到底是啥？怎么能为上面四句提供环境的？</p>
<h3 id="安装模块install-php"><a href="#安装模块install-php" class="headerlink" title="安装模块install.php"></a>安装模块install.php</h3><p>此文件代码较多，但是php代码200行，其他都是html。目的，如果没有定义config，那么正常安装。如果有config，检查发现有数据库，数据库中有install等字段，那么直接屏蔽用户的请求，给个404。<br>主要的逻辑是：定义根目录，设置系统加载的路径，定义根目录，（全局变量的形式： __TYPECHO_ROOT_DIR__），</p>
<ul>
<li>根目录、</li>
<li>插件目录/usr/plugins</li>
<li>模板目录/usr/themes</li>
<li>后台目录/admin/。<br>设置加载目录： /var（框架的主要目录），插件目录。     代码：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;跟zendframework  很象</span><br><span class="line">@set_include_path(get_include_path() . PATH_SEPARATOR .</span><br></pre></td></tr></table></figure>
载入API支持（var目录下）， require_once ‘Typecho/Common.php’;<br>然后调用程序初始化。Typecho_Common::init();</li>
</ul>
<p>以上是不存在配置文件的执行方式，如果存在则加载执行下面的代码。</p>
<p>获取数据库对象，$db = Typecho_Db::get();<br>根据table.options表中installed字段，如果$installed为空值或者有值value=1都会进行404响应Typecho_Response::setStatus(404);，并退出。</p>
<p>正常往下执行的时候，有一端根据referer来阻止访问的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 挡掉可能的跨站请求</span><br><span class="line">if (!empty($_GET) || !empty($_POST)) &#123;</span><br><span class="line">    if (empty($_SERVER[&#39;HTTP_REFERER&#39;])) &#123;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $parts &#x3D; parse_url($_SERVER[&#39;HTTP_REFERER&#39;]);</span><br><span class="line">	if (!empty($parts[&#39;port&#39;])) &#123;</span><br><span class="line">        $parts[&#39;host&#39;] &#x3D; &quot;&#123;$parts[&#39;host&#39;]&#125;:&#123;$parts[&#39;port&#39;]&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (empty($parts[&#39;host&#39;]) || $_SERVER[&#39;HTTP_HOST&#39;] !&#x3D; $parts[&#39;host&#39;]) &#123;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面就是定义一些功能函数，然后进入到安装界面。代码分析不够透彻，先略过。</p>
<h3 id="配置文件config-inc-php"><a href="#配置文件config-inc-php" class="headerlink" title="配置文件config.inc.php"></a>配置文件config.inc.php</h3><p>配置文件是安装之后，产生的，跟上面安装文件，流程大致一样。程序的Typecho_Common::init();具体是什么作用？需要研究。<br>配置文件的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 定义根目录 *&#x2F;</span><br><span class="line">define(&#39;__TYPECHO_ROOT_DIR__&#39;, dirname(__FILE__));</span><br><span class="line"></span><br><span class="line">&#x2F;** 定义插件目录(相对路径) *&#x2F;</span><br><span class="line">define(&#39;__TYPECHO_PLUGIN_DIR__&#39;, &#39;&#x2F;usr&#x2F;plugins&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;** 定义模板目录(相对路径) *&#x2F;</span><br><span class="line">define(&#39;__TYPECHO_THEME_DIR__&#39;, &#39;&#x2F;usr&#x2F;themes&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;** 后台路径(相对路径) *&#x2F;</span><br><span class="line">define(&#39;__TYPECHO_ADMIN_DIR__&#39;, &#39;&#x2F;admin&#x2F;&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;** 设置包含路径 *&#x2F;</span><br><span class="line">@set_include_path(get_include_path() . PATH_SEPARATOR .</span><br><span class="line">__TYPECHO_ROOT_DIR__ . &#39;&#x2F;var&#39; . PATH_SEPARATOR .</span><br><span class="line">__TYPECHO_ROOT_DIR__ . __TYPECHO_PLUGIN_DIR__);</span><br><span class="line"></span><br><span class="line">&#x2F;** 载入API支持 *&#x2F;</span><br><span class="line">require_once &#39;Typecho&#x2F;Common.php&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;** 程序初始化 *&#x2F;</span><br><span class="line">Typecho_Common::init();</span><br><span class="line"></span><br><span class="line">&#x2F;** 定义数据库参数 *&#x2F;</span><br><span class="line">$db &#x3D; new Typecho_Db(&#39;Pdo_SQLite&#39;, &#39;typecho_&#39;);</span><br><span class="line">$db-&gt;addServer(array (</span><br><span class="line">  &#39;file&#39; &#x3D;&gt; &#39;D:&#x2F;phpStudy&#x2F;PHPTutorial&#x2F;zend&#x2F;typecho&#x2F;usr&#x2F;5cc69e9d3bb13.db&#39;,</span><br><span class="line">), Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">Typecho_Db::set($db);</span><br></pre></td></tr></table></figure>

<p>那么剩下的就是，看index.php的流程了。主要分为：</p>
<ul>
<li>程序初始化Typecho_Common::init();</li>
<li>初始化组件Typecho_Widget::widget(‘Widget_Init’);</li>
<li>注册一个初始化插件Typecho_Plugin::factory(‘index.php’)-&gt;begin();</li>
<li>开始路由分发Typecho_Router::dispatch();</li>
<li>注册一个结束插件Typecho_Plugin::factory(‘index.php’)-&gt;end();</li>
</ul>
<h3 id="程序初始化"><a href="#程序初始化" class="headerlink" title="程序初始化"></a>程序初始化</h3><p>Typecho_Common是一个类文件，类之前定义了一些函数。总代码比较多。init代码如下：</p>
<blockquote>
<p>此代码的作用是，提供了一个自动加载类的方式。对比Zend、Thinkphp5.1、php-crud-api中加载的方式。同样也是注册一个加载函数，spl_autoload_register，另外，加上前面的自动加载目录，所以能自动加载到类。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">* 自动载入类</span><br><span class="line">*</span><br><span class="line">* @param $className</span><br><span class="line">*&#x2F;</span><br><span class="line">public static function __autoLoad($className)</span><br><span class="line">&#123;</span><br><span class="line">@include_once str_replace(array(&#39;\\&#39;, &#39;_&#39;), &#39;&#x2F;&#39;, $className) . &#39;.php&#39;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line">* 程序初始化方法</span><br><span class="line">*</span><br><span class="line">* @access public</span><br><span class="line">* @return void</span><br><span class="line">*&#x2F;</span><br><span class="line">public static function init()</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;** 设置自动载入函数 *&#x2F;</span><br><span class="line">spl_autoload_register(array(&#39;Typecho_Common&#39;, &#39;__autoLoad&#39;));</span><br><span class="line"></span><br><span class="line">&#x2F;** 兼容php6 *&#x2F;</span><br><span class="line">if (function_exists(&#39;get_magic_quotes_gpc&#39;) &amp;&amp; get_magic_quotes_gpc()) &#123;</span><br><span class="line">    $_GET &#x3D; self::stripslashesDeep($_GET);</span><br><span class="line">    $_POST &#x3D; self::stripslashesDeep($_POST);</span><br><span class="line">    $_COOKIE &#x3D; self::stripslashesDeep($_COOKIE);</span><br><span class="line"></span><br><span class="line">    reset($_GET);</span><br><span class="line">    reset($_POST);</span><br><span class="line">    reset($_COOKIE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;** 设置异常截获函数 *&#x2F;</span><br><span class="line">set_exception_handler(array(&#39;Typecho_Common&#39;, &#39;exceptionHandle&#39;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化组件"><a href="#初始化组件" class="headerlink" title="初始化组件"></a>初始化组件</h3><p>Typecho_Widget::widget(‘Widget_Init’);</p>
<blockquote>
<p>这代码Typecho_Widget::widget的大致所有是：静态化一个实例，并储存到主件池$_widgetPool变量中（私有静态变量）。如果这个类需要有多个实例的话，那么可以起一个别名，以@符号进行分隔，如Widget_Init@first，那么如果要获得这个实例，alias(‘Widget_Init’,’first’)。除此之外，还为组件自动绑定变量（跟传入的参数差不多），这个功能有点象容器注入（控制反转）。<br>此函数的注释如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">   &#x2F;**</span><br><span class="line">    * 工厂方法,将类静态化放置到列表中</span><br><span class="line">    *</span><br><span class="line">    * @access public</span><br><span class="line">    * @param string $alias 组件别名</span><br><span class="line">    * @param mixed $params 传递的参数</span><br><span class="line">    * @param mixed $request 前端参数</span><br><span class="line">    * @param boolean $enableResponse 是否允许http回执</span><br><span class="line">    * @return Typecho_Widget</span><br><span class="line">    * @throws Typecho_Exception</span><br><span class="line">    *&#x2F;</span><br><span class="line">   public static function widget($alias, $params &#x3D; NULL, $request &#x3D; NULL, $enableResponse &#x3D; true)</span><br><span class="line">   &#123;</span><br><span class="line">   	&#x2F;&#x2F;$className 跟$alias 以@分隔，否则，两者都是$alias</span><br><span class="line">$parts &#x3D; explode(&#39;@&#39;, $alias);</span><br><span class="line">       $className &#x3D; $parts[0];</span><br><span class="line">       $alias &#x3D; empty($parts[1]) ? $className : $parts[1];</span><br><span class="line"></span><br><span class="line">       if (isset(self::$_widgetAlias[$className])) &#123;</span><br><span class="line">           $className &#x3D; self::$_widgetAlias[$className];</span><br><span class="line">       &#125;</span><br><span class="line">&#x2F;&#x2F;1、从组件池中获取，如果不存在，那么先创建一个放到池子内。</span><br><span class="line">       if (!isset(self::$_widgetPool[$alias])) &#123;</span><br><span class="line">           &#x2F;** 如果类不存在 *&#x2F;</span><br><span class="line">           if (!class_exists($className)) &#123;</span><br><span class="line">               throw new Typecho_Widget_Exception($className);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           &#x2F;** 初始化request *&#x2F;</span><br><span class="line">           if (!empty($request)) &#123;</span><br><span class="line">               $requestObject &#x3D; new Typecho_Request();</span><br><span class="line">               $requestObject-&gt;setParams($request);</span><br><span class="line">           &#125; else &#123;</span><br><span class="line">               $requestObject &#x3D; Typecho_Request::getInstance();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           &#x2F;** 初始化response *&#x2F;</span><br><span class="line">           $responseObject &#x3D; $enableResponse ? Typecho_Response::getInstance()</span><br><span class="line">           : Typecho_Widget_Helper_Empty::getInstance();</span><br><span class="line"></span><br><span class="line">           &#x2F;** 初始化组件 *&#x2F;</span><br><span class="line">           $widget &#x3D; new $className($requestObject, $responseObject, $params);&#x2F;&#x2F;注入了一些参数，有点象容器</span><br><span class="line"></span><br><span class="line">           $widget-&gt;execute();</span><br><span class="line">           self::$_widgetPool[$alias] &#x3D; $widget;</span><br><span class="line">       &#125;</span><br><span class="line">&#x2F;&#x2F;2、直接从组件池中获取</span><br><span class="line">       return self::$_widgetPool[$alias];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>从实际的请求中，发现manage-pages.php其实已经是一个独立的页面，那么此页面是如何完成页面渲染的呢？通过导入include ‘common.php’;完成页面的初始化工作。然后，发现下面的代码，作用是，将值分配到$pages对象中，然后遍历得到页面的结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Typecho_Widget::widget(&#39;Widget_Contents_Page_Admin&#39;)-&gt;to($pages)</span><br></pre></td></tr></table></figure>

<p>上面的Request、Response都还未深入分析。那么，下一步：</p>
<h3 id="注册一个初始化插件"><a href="#注册一个初始化插件" class="headerlink" title="注册一个初始化插件"></a>注册一个初始化插件</h3><p>Typecho_Plugin::factory(‘index.php’)-&gt;begin();插件代码功能大概有400行。</p>
<blockquote>
<p>功能也是将插件进行了缓存。（缓存？是不是类似Zend_Register?也能集中管理？）</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">* 获取实例化插件对象</span><br><span class="line">*</span><br><span class="line">* @access public</span><br><span class="line">* @param string $handle 插件</span><br><span class="line">* @return Typecho_Plugin</span><br><span class="line">*&#x2F;</span><br><span class="line">public static function factory($handle)</span><br><span class="line">&#123;</span><br><span class="line">	return isset(self::$_instances[$handle]) ? self::$_instances[$handle] :</span><br><span class="line">	(self::$_instances[$handle] &#x3D; new Typecho_Plugin($handle));</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;Typecho_Plugin的构造函数</span><br><span class="line">&#x2F;**</span><br><span class="line">* 插件初始化</span><br><span class="line">*</span><br><span class="line">* @access public</span><br><span class="line">* @param string $handle 插件</span><br><span class="line">*&#x2F;</span><br><span class="line">public function __construct($handle)</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;** 初始化变量 *&#x2F;</span><br><span class="line">	$this-&gt;_handle &#x3D; $handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码来看，注册一个插件，并没有做什么实质的动作。估计是在其他地方，方便调用。类似注册成全局的变量一个。（暂时这样猜测）。那么到下一步。</p>
<h3 id="开始路由分发"><a href="#开始路由分发" class="headerlink" title="开始路由分发"></a>开始路由分发</h3><p>Typecho_Router::dispatch();</p>
<blockquote>
<p>这个类的代码两百多行。</p>
</blockquote>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 路由分发函数</span><br><span class="line"> *</span><br><span class="line"> * @return void</span><br><span class="line"> * @throws Exception</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static function dispatch()</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;** 获取PATHINFO *&#x2F;</span><br><span class="line">    $pathInfo &#x3D; self::getPathInfo();</span><br><span class="line"></span><br><span class="line">    foreach (self::$_routingTable as $key &#x3D;&gt; $route) &#123;</span><br><span class="line">        if (preg_match($route[&#39;regx&#39;], $pathInfo, $matches)) &#123;</span><br><span class="line">            self::$current &#x3D; $key;&#x2F;&#x2F;当前匹配到的路由表</span><br><span class="line"></span><br><span class="line">            try &#123;</span><br><span class="line">                &#x2F;** 载入参数 *&#x2F;</span><br><span class="line">                $params &#x3D; NULL;</span><br><span class="line"></span><br><span class="line">                if (!empty($route[&#39;params&#39;])) &#123;</span><br><span class="line">                    unset($matches[0]);</span><br><span class="line">                    $params &#x3D; array_combine($route[&#39;params&#39;], $matches);</span><br><span class="line">                &#125;</span><br><span class="line">                &#x2F;&#x2F;同样，将当前匹配到的$route[&#39;widget&#39;]，注册成一个组件。</span><br><span class="line">                $widget &#x3D; Typecho_Widget::widget($route[&#39;widget&#39;], NULL, $params);</span><br><span class="line">  &#x2F;&#x2F;如果当前路由有action属性，那么调用此方法</span><br><span class="line">                if (isset($route[&#39;action&#39;])) &#123;</span><br><span class="line">                    $widget-&gt;&#123;$route[&#39;action&#39;]&#125;();</span><br><span class="line">                &#125;</span><br><span class="line">  &#x2F;&#x2F;下面的，是如何获取到数据的？？</span><br><span class="line">                Typecho_Response::callback();</span><br><span class="line">                return;</span><br><span class="line"></span><br><span class="line">            &#125; catch (Exception $e) &#123;</span><br><span class="line">                if (404 &#x3D;&#x3D; $e-&gt;getCode()) &#123;</span><br><span class="line">                    Typecho_Widget::destory($route[&#39;widget&#39;]);</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                throw $e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;** 载入路由异常支持 *&#x2F;</span><br><span class="line">    throw new Typecho_Router_Exception(&quot;Path &#39;&#123;$pathInfo&#125;&#39; not found&quot;, 404);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么在顺道看有一下Typecho_Response::callback()这个函数是做哪些东西？<br>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">    * 结束前的统一回调函数</span><br><span class="line">    *&#x2F;</span><br><span class="line">   public static function callback()</span><br><span class="line">   &#123;</span><br><span class="line">       &#x2F;&#x2F;注意此变量为静态变量，相当于锁功能。即在一次请求中，后面的代码只执行一次。</span><br><span class="line">       static $called;</span><br><span class="line"></span><br><span class="line">       if ($called) &#123;</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       $called &#x3D; true;</span><br><span class="line">       foreach (self::$_callbacks as $callback) &#123;</span><br><span class="line">           call_user_func($callback);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F;Typecho_Response类并不是真正的单例模式，因为其__construct、__clone没有做任何处理，也未定义。</span><br><span class="line">   &#x2F;**</span><br><span class="line">    * 获取单例句柄</span><br><span class="line">    *</span><br><span class="line">    * @access public</span><br><span class="line">    * @return Typecho_Response</span><br><span class="line">    *&#x2F;</span><br><span class="line">   public static function getInstance()</span><br><span class="line">   &#123;</span><br><span class="line">       if (null &#x3D;&#x3D;&#x3D; self::$_instance) &#123;</span><br><span class="line">           self::$_instance &#x3D; new Typecho_Response();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return self::$_instance;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>另外，Typecho_Response类还有中写方法throwXml、throwJson、redirect、goBack</p>
<h3 id="注册一个结束插件"><a href="#注册一个结束插件" class="headerlink" title="注册一个结束插件"></a>注册一个结束插件</h3><p>Typecho_Plugin::factory(‘index.php’)-&gt;end();</p>
<blockquote>
<p>有点迷糊了，Typecho_Plugin::factory(‘index.php’)返回的就是一个Typecho_Plugin，参数只是一个区分而已。而插件并没有begin、end方法。这是为什么呢？难道有更深的机制？</p>
</blockquote>
<p>这个到底是什么？为什么能调用这样了两个方法begin、start?</p>
<p>类反射，查看一下，也没有什么想要的信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$tmp&#x3D;Typecho_Plugin::factory(&#39;index.php&#39;);</span><br><span class="line">var_dump(get_class_methods($tmp));</span><br></pre></td></tr></table></figure>

<p>测试过了，如果注释掉注册插件这两行代码，其实对页面也没有任何影响。另外，随便写一个方法Typecho_Plugin::factory(‘index.php’)-&gt;ttt()，也不报错。这是因为使用了__call魔术方法。另外还使用了__set,__get魔术方法。如果将此Typecho_Plugin::__call方法注释掉，错误提示如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;下面这个是框架的报错提示，非系统提醒</span><br><span class="line">Call to undefined method Typecho_Plugin::begin();</span><br></pre></td></tr></table></figure>

<p>Typecho_Plugin::__call源代码(实现调用任意方法)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">     * 回调处理函数</span><br><span class="line">     *</span><br><span class="line">     * @access public</span><br><span class="line">     * @param string $component 当前组件</span><br><span class="line">     * @param string $args 参数</span><br><span class="line">     * @return mixed</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public function __call($component, $args)</span><br><span class="line">    &#123;</span><br><span class="line">        $component &#x3D; $this-&gt;_handle . &#39;:&#39; . $component;</span><br><span class="line">        $last &#x3D; count($args);</span><br><span class="line">        $args[$last] &#x3D; $last &gt; 0 ? $args[0] : false;</span><br><span class="line"></span><br><span class="line">        if (isset(self::$_plugins[&#39;handles&#39;][$component])) &#123;</span><br><span class="line">            $args[$last] &#x3D; NULL;</span><br><span class="line">            $this-&gt;_signal &#x3D; true;</span><br><span class="line">            foreach (self::$_plugins[&#39;handles&#39;][$component] as $callback) &#123;</span><br><span class="line">                $args[$last] &#x3D; call_user_func_array($callback, $args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $args[$last];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>那么到了这一步，自然想知道，此框架的插件机制是如何的？</p>
<p><a target="_blank" rel="noopener" href="http://docs.typecho.org/plugins/hello-world">官网给的helloworld</a>例子，结合本地的helloworld插件/usr/plugins/HelloWorld的代码，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">class HelloWorld_Plugin implements Typecho_Plugin_Interface</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 激活插件方法,如果激活失败,直接抛出异常</span><br><span class="line">     * </span><br><span class="line">     * @access public</span><br><span class="line">     * @return void</span><br><span class="line">     * @throws Typecho_Plugin_Exception</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static function activate()</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;这其实就是设置了一个回调函数。navBar确实在admin&#x2F;menu.php中调用了。</span><br><span class="line">        Typecho_Plugin::factory(&#39;admin&#x2F;menu.php&#39;)-&gt;navBar &#x3D; array(&#39;HelloWorld_Plugin&#39;, &#39;render&#39;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>activate: 插件的激活接口，主要填写一些插件的初始化程序。</li>
<li>deactivate: 这个是插件的禁用接口，主要就是插件在禁用时对一些资源的释放。</li>
<li>config: 插件的配置面板，用于制作插件的标准配置菜单。</li>
<li>personalConfig: 个人用户的配置面板，基本用不到。</li>
<li>render: 自己定义的方法，用来实现插件要完成的功能。</li>
</ul>
<p>admin/menu.php</p>
<p>在此处调用：<?php Typecho_Plugin::factory('admin/menu.php')->navBar(); ?></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php if(!defined(&#39;__TYPECHO_ADMIN__&#39;)) exit; ?&gt;</span><br><span class="line">&lt;div class&#x3D;&quot;typecho-head-nav clearfix&quot; role&#x3D;&quot;navigation&quot;&gt;</span><br><span class="line">    &lt;nav id&#x3D;&quot;typecho-nav-list&quot;&gt;</span><br><span class="line">        &lt;?php $menu-&gt;output(); ?&gt;</span><br><span class="line">    &lt;&#x2F;nav&gt;</span><br><span class="line">    &lt;div class&#x3D;&quot;operate&quot;&gt;</span><br><span class="line">        &lt;?php Typecho_Plugin::factory(&#39;admin&#x2F;menu.php&#39;)-&gt;navBar(); ?&gt;&lt;a title&#x3D;&quot;&lt;?php</span><br><span class="line">                    if ($user-&gt;logged &gt; 0) &#123;</span><br><span class="line">                        $logged &#x3D; new Typecho_Date($user-&gt;logged);</span><br><span class="line">                        _e(&#39;最后登录: %s&#39;, $logged-&gt;word());</span><br><span class="line">                    &#125;</span><br><span class="line">                    ?&gt;&quot; href&#x3D;&quot;&lt;?php $options-&gt;adminUrl(&#39;profile.php&#39;); ?&gt;&quot; class&#x3D;&quot;author&quot;&gt;&lt;?php $user-&gt;screenName(); ?&gt;&lt;&#x2F;a&gt;&lt;a class&#x3D;&quot;exit&quot; href&#x3D;&quot;&lt;?php $options-&gt;logoutUrl(); ?&gt;&quot;&gt;&lt;?php _e(&#39;登出&#39;); ?&gt;&lt;&#x2F;a&gt;&lt;a href&#x3D;&quot;&lt;?php $options-&gt;siteUrl(); ?&gt;&quot;&gt;&lt;?php _e(&#39;网站&#39;); ?&gt;&lt;&#x2F;a&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>所以呢，结合此插件，大致明白了注册开始、结束插件的意思呢，反正就是预留了一些代码钩子，如果用户确实实现了这个插件，那么就调用了。</p>
<p>理解这种插件机制的作用？为啥这样设计？</p>
<blockquote>
<p>个人理解，其实这样设计并没有什么太大的好处。插件嘛，类似于AOP，在固定的位置调用方法。其实也能理解js的事件回调。在固定的位置触发一个事件，然后响应这个事件。测试过，确实，一个地方，触发了这个插件，<strong>多个插件都响应了</strong>。插件代码中的注释，居然还能作为内容显示在页面中。</p>
</blockquote>
<h3 id="页面流转"><a href="#页面流转" class="headerlink" title="页面流转"></a>页面流转</h3><blockquote>
<p>发现这个框架的页面跳转，其实跟之前想得很不一样。首先，管理后台,是要跳到/admin/文件夹中，然后就不再是统一的入口呢。</p>
</blockquote>
<p>/admin文件夹中，有两个文件，common-js.php跟common.php。估计前面的是为了加载js用的，后面，相当于一个入口函数。</p>
<h4 id="common-js-php"><a href="#common-js-php" class="headerlink" title="common-js.php"></a>common-js.php</h4><p>php往js脚本中注入了一些变量。js脚本功能：处理消息机制（立即执行函数形式，防止变量泄漏成全局）、导航菜单 tab 聚焦时展开下拉菜单。加载js库jquery.js、jquery-ui.js、typecho.js。</p>
<h4 id="common-php"><a href="#common-php" class="headerlink" title="common.php"></a>common.php</h4><h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h2><h3 id="定义数据库"><a href="#定义数据库" class="headerlink" title="定义数据库"></a>定义数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 定义数据库参数 *&#x2F;</span><br><span class="line">$db &#x3D; new Typecho_Db(&#39;Pdo_SQLite&#39;, &#39;typecho_&#39;);</span><br><span class="line">$db-&gt;addServer(array (</span><br><span class="line">  &#39;file&#39; &#x3D;&gt; &#39;D:&#x2F;phpStudy&#x2F;PHPTutorial&#x2F;zend&#x2F;typecho&#x2F;usr&#x2F;5cc69e9d3bb13.db&#39;,</span><br><span class="line">), Typecho_Db::READ | Typecho_Db::WRITE);</span><br><span class="line">Typecho_Db::set($db);</span><br></pre></td></tr></table></figure>

<h3 id="获取数据库对象实例："><a href="#获取数据库对象实例：" class="headerlink" title="获取数据库对象实例："></a>获取数据库对象实例：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** 初始化数据库 *&#x2F;</span><br><span class="line">$this-&gt;db &#x3D; Typecho_Db::get();</span><br></pre></td></tr></table></figure>

<h2 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PHP获取当前类名、方法名</span><br><span class="line">  __CLASS__ 获取当前类名</span><br><span class="line">  __FUNCTION__ 当前函数名（confirm）</span><br><span class="line">  __METHOD__ 当前方法名 （bankcard::confirm）</span><br><span class="line">__FUNCTION__    函数名称（PHP 4.3.0 新加）。自 PHP 5 起本常量返回该函数被定义时的名字（区分大小写）。在 PHP 4 中该值总是小写字母的。</span><br><span class="line">__CLASS__    类的名称（PHP 4.3.0 新加）。自 PHP 5 起本常量返回该类被定义时的名字（区分大小写）。在 PHP 4 中该值总是小写字母的。</span><br><span class="line">__METHOD__    类的方法名（PHP 5.0.0 新加）。返回该方法被定义时的名字（区分大小写）。</span><br><span class="line"></span><br><span class="line">get_class(class name);&#x2F;&#x2F;取得当前语句所在类的类名</span><br><span class="line">get_class_methods(class name);&#x2F;&#x2F;取得class name 类的所有的方法名，并且组成一个数组</span><br><span class="line">get_class_vars(class name);&#x2F;&#x2F;取得class name 类的所有的变亮名，并组成一个数组</span><br></pre></td></tr></table></figure>

<p>反射的形式获取：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;用反射类可以获得私有属性和私有方法</span><br><span class="line">$ref &#x3D; new ReflectionClass(Class1);&#x2F;&#x2F;Class1 可以为对象实例 $class &#x3D; new Class();</span><br><span class="line"> </span><br><span class="line">print_r($ref-&gt;getMethods());</span><br><span class="line">print_r($ref-&gt;getProperties());</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/04/28/2019-04-28-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/28/2019-04-28-2/" class="post-title-link" itemprop="url">右键菜单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-28 12:12:00" itemprop="dateCreated datePublished" datetime="2019-04-28T12:12:00+00:00">2019-04-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="右键菜单"><a href="#右键菜单" class="headerlink" title="右键菜单"></a>右键菜单</h1><blockquote>
<p>在grid表格中，经常用到右键菜单，一般的右键菜单如下，但是存在问题，每次创建右键时，都会创建一个新的右键菜单实例，虽然没有啥大的问题（存在对象泄漏），本着负责的态度，在隐藏的时候，主动删除这个对象：</p>
</blockquote>
<blockquote>
<p>另外一种常见的处理方式是，像之前其他的一样，在主grid表格创建时，手动创建一个实例，每次右键的时候，调用这个实例的show方法。就不存在泄漏。但在grid表格销毁的时候，所有手动create的组件都要手动销毁。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;右键菜单</span><br><span class="line">&quot;rowcontextmenu&quot;:function ( c, record, tr, rowIndex, e, eOpts )&#123;</span><br><span class="line">    var me &#x3D; this;</span><br><span class="line">    var v&#x3D;me.getViewModel().getData();</span><br><span class="line">    &#x2F;&#x2F;增加右键菜单可用情况判断</span><br><span class="line">    Ext.create(&#39;Ext.menu.Menu&#39;, &#123;</span><br><span class="line">        bodyStyle:&quot;padding:5px;&quot;,</span><br><span class="line">        items: [&#123;</span><br><span class="line">            text: &#39;编辑护士&#39;,</span><br><span class="line">            iconCls:&#39;edit&#39;,</span><br><span class="line">            disabled:v[&#39;selections&#39;]!&#x3D;1,</span><br><span class="line">            handler:function(btn)&#123;</span><br><span class="line">                me.addNurseWin.animateTarget &#x3D; btn;</span><br><span class="line">                me.addNurseWin.actionType&#x3D;2;</span><br><span class="line">                me.addNurseWin.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            text: &#39;删除护士&#39;,</span><br><span class="line">            iconCls:&#39;delete&#39;,</span><br><span class="line">            disabled:v[&#39;selections&#39;]&#x3D;&#x3D;0,</span><br><span class="line">            handler:function()&#123;</span><br><span class="line">                me.confirmDelete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;],</span><br><span class="line">        &#x2F;&#x2F;下面的代码，hide时主动删除此菜单。</span><br><span class="line">        listeners:&#123;</span><br><span class="line">            &#39;destroy&#39;:function( cmp, eOpts) &#123;</span><br><span class="line">                console.log(&#39;我销毁啦&#39;);</span><br><span class="line">            &#125;,</span><br><span class="line">            hide:function ( cmp, eOpts )&#123;</span><br><span class="line">                console.log(&#39;我隐藏啦&#39;);</span><br><span class="line">                this.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).showAt(e.getXY());</span><br><span class="line">    e.preventDefault();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="tbar中用到的菜单实例"><a href="#tbar中用到的菜单实例" class="headerlink" title="tbar中用到的菜单实例"></a>tbar中用到的菜单实例</h2><p>代码如下，重点关注，button中menu的写法结构。（button有menu这个属性）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    text:&#39;护理菜单&#39;,</span><br><span class="line">    iconCls:&quot;grade&quot;,</span><br><span class="line">    menu:&#123;</span><br><span class="line">        defaults: &#123;</span><br><span class="line">            iconCls:&#39;icon-book&#39;</span><br><span class="line">        &#125;,</span><br><span class="line">        items:[&#123;</span><br><span class="line">            text:&#39;护理文书&#39;,</span><br><span class="line">            handler:function(btn)&#123;</span><br><span class="line">                var menu&#x3D;btn.up(&#39;button&#39;);</span><br><span class="line">                var win&#x3D;Ext.widget(&#123;</span><br><span class="line">                    xtype:&#39;window&#39;,</span><br><span class="line">                    title:&#39;护理文书&#39;,</span><br><span class="line">                    layout:&#39;fit&#39;,</span><br><span class="line">                    width:650,</span><br><span class="line">                    height:500,</span><br><span class="line">                    modal:true,</span><br><span class="line">                    resizable:false,</span><br><span class="line">                    animateTarget:menu,</span><br><span class="line">                    items:[&#123;</span><br><span class="line">                        xtype:&#39;descriptiongrid&#39;,</span><br><span class="line">                        width:&#39;100%&#39;,</span><br><span class="line">                    &#125;]</span><br><span class="line">                &#125;);</span><br><span class="line">                win.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,&#123;</span><br><span class="line">            text:&#39;护理等级&#39;,</span><br><span class="line">            handler:function(btn)&#123;</span><br><span class="line">                var menu&#x3D;btn.up(&#39;button&#39;);</span><br><span class="line">                var win&#x3D;Ext.widget(&#123;</span><br><span class="line">                    xtype:&#39;window&#39;,</span><br><span class="line">                    title:&#39;护理等级&#39;,</span><br><span class="line">                    layout:&#39;fit&#39;,</span><br><span class="line">                    width:650,</span><br><span class="line">                    height:500,</span><br><span class="line">                    modal:true,</span><br><span class="line">                    resizable:false,</span><br><span class="line">                    animateTarget:menu,</span><br><span class="line">                    items:[&#123;</span><br><span class="line">                        xtype:&#39;nursinggradegrid&#39;,</span><br><span class="line">                        width:&#39;100%&#39;,</span><br><span class="line">                    &#125;]</span><br><span class="line">                &#125;);</span><br><span class="line">                win.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/04/28/2019-04-28/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/28/2019-04-28/" class="post-title-link" itemprop="url">Ext.Deferred使用教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-28 12:12:00" itemprop="dateCreated datePublished" datetime="2019-04-28T12:12:00+00:00">2019-04-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Ext-Deferred使用教程"><a href="#Ext-Deferred使用教程" class="headerlink" title="Ext.Deferred使用教程"></a>Ext.Deferred使用教程</h1><blockquote>
<p>前几天写的，今天才贴出来。主要是Deferred的使用，这个需要与ES6的语法进行对比学习。</p>
</blockquote>
<h2 id="生成deferred"><a href="#生成deferred" class="headerlink" title="生成deferred"></a>生成deferred</h2><p>下面是个简单的例子，参考手册上新的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">deleteUserDevices:function()&#123;</span><br><span class="line">        var me&#x3D;this;</span><br><span class="line">        var deferred &#x3D; new Ext.Deferred();</span><br><span class="line">        if(!me.userDeviceList)&#123;</span><br><span class="line">            return deferred.reject(&quot;未选择任何数据.&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        var ids&#x3D;Ext.Array.map(me.userDeviceList,function(item)&#123;</span><br><span class="line">            return item.id;</span><br><span class="line">        &#125;);</span><br><span class="line">        Ext.Ajax.request(&#123;</span><br><span class="line">            method:&quot;DELETE&quot;,</span><br><span class="line">            url:SHINEECALLHOST+&#39;&#x2F;api.php&#x2F;records&#x2F;hospital_user_devices&#x2F;&#39;+ids.join(),</span><br><span class="line">            success: function(response, opts) &#123;</span><br><span class="line">                console.log(response.responseText);</span><br><span class="line">                deferred.resolve();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        return deferred.promise;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h2 id="触发deferred"><a href="#触发deferred" class="headerlink" title="触发deferred"></a>触发deferred</h2><p>使用下面的方式，进行触发。注意参数形式，deleteUserDevices函数内部的this，需要根据第二个参数确定。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ext.Deferred.sequence([me.deleteUserDevices,me.submitUserDevices],me);</span><br></pre></td></tr></table></figure>

<h2 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h2><p>对于不需要异常捕捉的话，还不如直接传入一个函数参数进去。这样没有什么理解难度。即如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">submitUserDevices:function(id,fn)&#123;</span><br><span class="line">        var me&#x3D;this;</span><br><span class="line">        Ext.Ajax.request(&#123;</span><br><span class="line">            method:&quot;POST&quot;,</span><br><span class="line">            params:&#123;DeviceID:id,UserID:me.currentEditRecordId&#125;,</span><br><span class="line">            url:SHINEECALLHOST+&#39;&#x2F;api.php&#x2F;records&#x2F;hospital_user_devices&#x2F;&#39;,</span><br><span class="line">            success: function(response, opts) &#123;</span><br><span class="line">                console.log(response.responseText);</span><br><span class="line">		fn();&#x2F;&#x2F;调用回调函数</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<p>后来发现，删除、添加新的，之间没有严格的顺序依赖。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2019/04/26/2019-04-26/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/04/26/2019-04-26/" class="post-title-link" itemprop="url">Fri Apr 26 2019 00:00:00 GMT+0000 (Coordinated Universal Time)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-26 12:12:00" itemprop="dateCreated datePublished" datetime="2019-04-26T12:12:00+00:00">2019-04-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:31:10" itemprop="dateModified" datetime="2023-01-19T09:31:10+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="fieldcontainer使用"><a href="#fieldcontainer使用" class="headerlink" title="fieldcontainer使用"></a>fieldcontainer使用</h1><blockquote>
<p>一直没有实现的布局样式，即文本输入框，跟按钮在一行内的布局，终于实现了。fieldcontainer有fieldLabel属性，属于整行的标签，这样整体布局不会乱。具体如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    xtype: &#39;fieldcontainer&#39;,</span><br><span class="line">    layout: &quot;hbox&quot;,</span><br><span class="line">    &#x2F;&#x2F;1 注意下面，标签放在1位置跟2位置有很大的差别。</span><br><span class="line">    fieldLabel: &#39;责任医生&#39;,</span><br><span class="line">    items: [&#123;</span><br><span class="line">            xtype: &#39;textfield&#39;,</span><br><span class="line">	    &#x2F;&#x2F;2 这个标签就不用了。</span><br><span class="line">            flex: 1,</span><br><span class="line">            name: &#39;Doctor_Name&#39;</span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            xtype: &quot;button&quot;,</span><br><span class="line">            text: &quot;添加&quot;,</span><br><span class="line">            margin: &#39;0 0 0 10&#39;,</span><br><span class="line">            handler: function () &#123;</span><br><span class="line">                &#x2F;&#x2F; me.priceProductWindow.show();</span><br><span class="line">            &#125;,</span><br><span class="line">            width: 100,</span><br><span class="line">        &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>另外，见别人这样写，利用panel作为容器，严格控制各个宽度，也能达到效果。代码如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	xtype:&quot;panel&quot;,</span><br><span class="line">	layout:&quot;hbox&quot;,</span><br><span class="line">	height:30,</span><br><span class="line">	border:0,</span><br><span class="line">	items:[&#123;</span><br><span class="line">		width:363,</span><br><span class="line">		xtype:&#39;textfield&#39;,</span><br><span class="line">		labelWidth:70,</span><br><span class="line">		editable:false,</span><br><span class="line">		fieldLabel: SHINEECALL_PATIENT_PATIENTINFO_PATIENTFORM_PATIENT_DOCTOR,</span><br><span class="line">		labelAlign:&quot;right&quot;,</span><br><span class="line">		name: &#39;Doctor_Name&#39;</span><br><span class="line">	&#125;,&#123;</span><br><span class="line">		xtype:&quot;button&quot;,</span><br><span class="line">		text:SHINEECALL_PATIENT_PATIENTINFO_PATIENTFORM_SELECT_DOCTOR,</span><br><span class="line">		style:&#123;</span><br><span class="line">			&#39;margin-left&#39;:&quot;10px&quot;,</span><br><span class="line">			width:&quot;90px&quot;</span><br><span class="line">		&#125;,</span><br><span class="line">		handler:function()&#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="行编辑器中难排查的bug"><a href="#行编辑器中难排查的bug" class="headerlink" title="行编辑器中难排查的bug"></a>行编辑器中难排查的bug</h1><p>一般来说store中的fields可以不写。但是在行编辑器中，store的fields字段必须要填。否则，context.record始终没有任何变化。而且还很难排查。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">store:&#123;</span><br><span class="line">	&#x2F;&#x2F;行编辑器中的fields必须要填</span><br><span class="line">	fields:[</span><br><span class="line">	    &#123;name: &#39;Grade_ID&#39;,type: &#39;int&#39;&#125;,</span><br><span class="line">	    &#123;name: &#39;Grade_Name&#39;,type: &#39;string&#39;&#125;,</span><br><span class="line">	    &#123;name: &#39;Grade_Color&#39;,type: &#39;string&#39;&#125;,</span><br><span class="line">	    &#123;name: &#39;Grade_Background&#39;,type: &#39;string&#39;&#125;</span><br><span class="line">	],</span><br><span class="line">&#x2F;&#x2F;否则下面的context，context.record始终没有变化，而且也没有触发验证</span><br><span class="line">&#x2F;&#x2F;记录上也没有红点。</span><br><span class="line"> listeners:&#123;</span><br><span class="line">        &quot;edit&quot;:function(editor, context, eOpts)&#123;</span><br><span class="line">            var me&#x3D;this;</span><br><span class="line">            &#x2F;&#x2F;点击保存触发ajax请求</span><br><span class="line">            var record &#x3D;context.record;</span><br><span class="line">            console.log(record[&#39;data&#39;]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="表格渲染效果"><a href="#表格渲染效果" class="headerlink" title="表格渲染效果"></a>表格渲染效果</h1><blockquote>
<p>一般常用renderer来进行数据的转换展示，比如，将1、2转换成男、女展示。但此函数还有很强大的功能，比如更改展示的效果，在renderer返回值中，添加要插入的图标，一并插入的展示中。下面两个示例。</p>
</blockquote>
<ul>
<li>结果转换，记得，这个转换好像会污染到变量。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">renderer:function(v)&#123;</span><br><span class="line">    &#x2F;&#x2F;下面的这个m也能使用全局或者类成员的属性，或者</span><br><span class="line">    &#x2F;&#x2F;通过ajax从后台获取，完成 一对多的 联表效果（但是性能嘛，不高。）</span><br><span class="line">    var m&#x3D;&#123;1:&#39;男&#39;,2:&#39;女&#39;&#125;;</span><br><span class="line">    return m[v];</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>这个是通过返回值来进行更改效果。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    text: &quot;字体颜色&quot;,</span><br><span class="line">    width:100,</span><br><span class="line">    sortable: false, </span><br><span class="line">    dataIndex: &#39;Grade_Color&#39;,</span><br><span class="line">    editor: &#123;</span><br><span class="line">	allowBlank: false&#x2F;&#x2F;要求数据不能为空。</span><br><span class="line">    &#125;,</span><br><span class="line">    &#x2F;&#x2F;这个是通过返回值来进行更改效果。</span><br><span class="line">    renderer:function(v)&#123;</span><br><span class="line">	var m &#x3D; &#39;&lt;div style&#x3D;&quot;background:&#39;+v+&#39;&quot;&gt;&#39;+v+&#39;&lt;&#x2F;div&gt;&#39;;</span><br><span class="line">	return m;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>通过metaData更改效果。 metaDa.tdCls 指定类名、metaData.tdStyle写css样式(能批量)、metaData.tdAttr指定一个属性（不能批量）。下面使用了两种方式：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">    text: &quot;背景颜色&quot;,</span><br><span class="line">    width:100,</span><br><span class="line">    sortable: false, </span><br><span class="line">    dataIndex: &#39;Grade_Background&#39;,</span><br><span class="line">    editor: &#123;</span><br><span class="line">	allowBlank: false&#x2F;&#x2F;要求数据不能为空。</span><br><span class="line">    &#125;,</span><br><span class="line">    renderer:function(v,metaData)&#123;</span><br><span class="line">        &#x2F;&#x2F;注意，下面是使用了 等号&#x3D;</span><br><span class="line">	&#x2F;&#x2F;这种只更改一种属性，写法比较简单。</span><br><span class="line">	metaData.tdAttr &#x3D; &#39;bgcolor&#x3D;&quot;&#39; + v + &#39;&quot;&#39;;</span><br><span class="line">	return v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    text: &quot;预览&quot;,</span><br><span class="line">    width:100,</span><br><span class="line">    sortable: false,</span><br><span class="line">    dataIndex: &#39;Grade_Background&#39;,</span><br><span class="line">    &#x2F;&#x2F;metaData.tdStyle  可以直接写css，记得使用冒号:分隔，另外</span><br><span class="line">    &#x2F;&#x2F;background-color不能写成backgroundColor,这个地方不会进行转换。</span><br><span class="line">    renderer:function(v,metaData,record)&#123;</span><br><span class="line">	var color&#x3D;record.get(&#39;Grade_Color&#39;);</span><br><span class="line">	metaData.tdStyle&#x3D;&#39;background-color:&#39;+ v +&#39;;color:&#39;+color+&#39;;&#39;;</span><br><span class="line">	return &#39;示例效果&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="dataview-选择功能"><a href="#dataview-选择功能" class="headerlink" title="dataview 选择功能"></a>dataview 选择功能</h1><p>在查看dataview的帮助时，发现其有selectionModel这个属性。既然有这个属性，就想设置一些选择特性。但是遗憾的是，没有成功。虽然，用dataview的getSelection()、getSelectionModel()来获取，选择模型确实生效了，但是效果却没有。而且测试时，dataview的并未添加任何listeners事件。我猜测，可能跟选择模型有关，这个选择模型，可能没有这个功能。测试使用了其他的选择模型，没有报错，但是一样没有效果。<br>beforeselect方法，在选择边框的时候，也并不能触发。</p>
<p>看来还是只能使用以前的土方法呢。（之前记载过这个方法，即桌面版选择会议室功能）</p>
<p>由此，应该关注SelectionModel的使用方法。类的继承关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">selectionModel:&#123;</span><br><span class="line">    type: &#39;dataviewmodel&#39;,</span><br><span class="line">    allowDeselect:false,</span><br><span class="line">    mode : &quot;MULTI&quot; ,</span><br><span class="line">    toggleOnClick:true</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>但是，改进了dataview的保持选择一个的</strong>功能，可以不用引入一个变量保存上次选择的。直接用lastSelected</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xtype:&quot;dataview&quot;,</span><br><span class="line">listeners:&#123;</span><br><span class="line">    &#39;selectionchange&#39;:function(cmp, selected, eOpts )&#123;&#x2F;&#x2F;只选择一个。</span><br><span class="line">	var selModel&#x3D;this.getSelectionModel();</span><br><span class="line">	if(selected.length&#x3D;&#x3D;&#x3D;0)&#123;&#x2F;&#x2F;没有选择项，则不能取消</span><br><span class="line">	    if(selModel.lastSelected)&#123;</span><br><span class="line">		selModel.select(selModel.lastSelected);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h1 id="select-不要触发事件"><a href="#select-不要触发事件" class="headerlink" title="select 不要触发事件"></a>select 不要触发事件</h1><p>第一次选择的时候，不希望触发select事件，之前想到过，使用一个标志位进行标记，但突然想到，框架里面好像有忽略触发消息的功能。然后隧完成如下。</p>
<p>如果不加这个参数，在这个颜色选择模块会造成事循环。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">selectColor:function()&#123;</span><br><span class="line">        var me&#x3D;this;</span><br><span class="line">        var color &#x3D; me.getValue();</span><br><span class="line">        var dv&#x3D;me.popupWin.down(&#39;dataview&#39;);</span><br><span class="line">        var selRd&#x3D;null;</span><br><span class="line">        dv.store.each(function(rd)&#123;&#x2F;&#x2F;查找选中的record</span><br><span class="line">            if(rd.get(&#39;color&#39;)&#x3D;&#x3D;color)&#123;</span><br><span class="line">                selRd&#x3D;rd;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        if(selRd)&#123;</span><br><span class="line">	    &#x2F;&#x2F;这个是初始化的时候，使用的，所以呢，应该忽略触发消息。</span><br><span class="line">            dv.getSelectionModel().select(selRd,false,true);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            dv.getSelectionModel().deselectAll(true);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="rowedit"><a href="#rowedit" class="headerlink" title="rowedit"></a>rowedit</h1><p>对与每个editor而言，生命周期比较长，在rowedit所属的grid的销毁时，才销毁。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/34/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/34/">34</a><span class="page-number current">35</span><a class="page-number" href="/page/36/">36</a><a class="page-number" href="/page/37/">37</a><a class="extend next" rel="next" href="/page/36/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
