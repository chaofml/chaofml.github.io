<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Pisces","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="这是一个用Python写的爬虫框架，并以web服务的形式，提供了创建、编辑、运行、管理任务。整体的思路还是非常不错的。以前在ubuntu上安装过，因为依赖的存在，可能并不好安装。但是，有了docker，安装瞬间不成问题。 由于提供了web界面，所有的操作都可以在web操作，熟练后，对于常见的网站，20分钟内，就能编写好爬写任务，所以，还是非常不错的。 本文简述一下使用方式。">
<meta property="og:type" content="article">
<meta property="og:title" content="pyspider">
<meta property="og:url" content="https://blog.chaofml.cn/2022/01/07/python/pyspider/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="这是一个用Python写的爬虫框架，并以web服务的形式，提供了创建、编辑、运行、管理任务。整体的思路还是非常不错的。以前在ubuntu上安装过，因为依赖的存在，可能并不好安装。但是，有了docker，安装瞬间不成问题。 由于提供了web界面，所有的操作都可以在web操作，熟练后，对于常见的网站，20分钟内，就能编写好爬写任务，所以，还是非常不错的。 本文简述一下使用方式。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.chaofml.cn/2022/01/07/python/pyspider/pyspider.assets/pyspider-arch.png">
<meta property="article:published_time" content="2022-01-07T18:10:07.000Z">
<meta property="article:modified_time" content="2023-01-25T02:58:29.831Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.chaofml.cn/2022/01/07/python/pyspider/pyspider.assets/pyspider-arch.png">


<link rel="canonical" href="https://blog.chaofml.cn/2022/01/07/python/pyspider/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>pyspider | 超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%BA%90"><span class="nav-number">1.</span> <span class="nav-text">资源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6"><span class="nav-number">3.1.</span> <span class="nav-text">资源文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%8D%95%E6%8D%89"><span class="nav-number">3.2.</span> <span class="nav-text">异常捕捉</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-number">4.1.</span> <span class="nav-text">操作流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6"><span class="nav-number">4.2.</span> <span class="nav-text">模板文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%9E%90"><span class="nav-number">4.3.</span> <span class="nav-text">解析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#pyquery"><span class="nav-number">4.3.1.</span> <span class="nav-text">pyquery</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#json"><span class="nav-number">4.3.2.</span> <span class="nav-text">json</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#re"><span class="nav-number">4.3.3.</span> <span class="nav-text">re</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PhantomJS"><span class="nav-number">4.3.4.</span> <span class="nav-text">PhantomJS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E7%BA%A7%E9%A1%B5%E9%9D%A2"><span class="nav-number">4.4.</span> <span class="nav-text">多级页面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A1%B5%E9%9D%A2%E5%88%86%E7%B1%BB"><span class="nav-number">4.4.1.</span> <span class="nav-text">页面分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E4%BC%A0%E9%80%92"><span class="nav-number">4.4.2.</span> <span class="nav-text">变量传递</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="nav-number">4.4.3.</span> <span class="nav-text">多返回值</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E7%94%A8%E5%8F%98%E9%87%8F"><span class="nav-number">4.5.</span> <span class="nav-text">可用变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%99%E6%95%B0%E6%8D%AE"><span class="nav-number">4.6.</span> <span class="nav-text">写数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">4.6.1.</span> <span class="nav-text">二进制文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84"><span class="nav-number">4.7.</span> <span class="nav-text">结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-number">4.7.1.</span> <span class="nav-text">结构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="nav-number">4.7.2.</span> <span class="nav-text">结构说明：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%84%E4%BB%B6"><span class="nav-number">4.7.3.</span> <span class="nav-text">组件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="nav-number">4.7.3.1.</span> <span class="nav-text">调度器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%99%A8"><span class="nav-number">4.7.3.2.</span> <span class="nav-text">下载器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E5%99%A8"><span class="nav-number">4.7.3.3.</span> <span class="nav-text">处理器</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Result-Worker"><span class="nav-number">4.7.3.4.</span> <span class="nav-text">Result Worker</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#WebUI"><span class="nav-number">4.7.3.5.</span> <span class="nav-text">WebUI</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="nav-number">4.7.4.</span> <span class="nav-text">数据流</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1"><span class="nav-number">4.8.</span> <span class="nav-text">任务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E4%BB%BB%E5%8A%A1%EF%BC%9A"><span class="nav-number">4.8.1.</span> <span class="nav-text">新任务：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E9%87%8D%E8%AF%95%EF%BC%9A"><span class="nav-number">4.8.2.</span> <span class="nav-text">任务重试：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E4%BB%BB%E5%8A%A1"><span class="nav-number">4.8.3.</span> <span class="nav-text">删除任务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">4.9.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%90%86"><span class="nav-number">4.9.1.</span> <span class="nav-text">代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#every-minutes-24-60"><span class="nav-number">4.9.2.</span> <span class="nav-text">@every(minutes&#x3D;24 * 60)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#config-age-10-24-60-60"><span class="nav-number">4.9.3.</span> <span class="nav-text">@config(age&#x3D;10 * 24 * 60 * 60)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config-priority-2"><span class="nav-number">4.10.</span> <span class="nav-text">@config(priority&#x3D;2)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#rate-brust"><span class="nav-number">4.10.1.</span> <span class="nav-text">rate&#x2F;brust</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86"><span class="nav-number">4.11.</span> <span class="nav-text">任务处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">4.12.</span> <span class="nav-text">其他</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F"><span class="nav-number">4.13.</span> <span class="nav-text">分布式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E5%8A%A0%E5%AF%86"><span class="nav-number">4.14.</span> <span class="nav-text">访问加密</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9D%9F%E5%90%8E%EF%BC%8C%E8%A7%A6%E5%8F%91"><span class="nav-number">4.15.</span> <span class="nav-text">结束后，触发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8"><span class="nav-number">4.16.</span> <span class="nav-text">存储</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#api"><span class="nav-number">5.</span> <span class="nav-text">api</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#self-crawl"><span class="nav-number">5.1.</span> <span class="nav-text">self.crawl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#age"><span class="nav-number">5.1.1.</span> <span class="nav-text">age</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#priority"><span class="nav-number">5.1.2.</span> <span class="nav-text">priority</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exetime"><span class="nav-number">5.1.3.</span> <span class="nav-text">exetime</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#retries"><span class="nav-number">5.1.4.</span> <span class="nav-text">retries</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#itag"><span class="nav-number">5.1.5.</span> <span class="nav-text">itag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#auto-recrawl"><span class="nav-number">5.1.6.</span> <span class="nav-text">auto_recrawl</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#method"><span class="nav-number">5.1.7.</span> <span class="nav-text">method</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#params"><span class="nav-number">5.1.8.</span> <span class="nav-text">params</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#data"><span class="nav-number">5.1.9.</span> <span class="nav-text">data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#files"><span class="nav-number">5.1.10.</span> <span class="nav-text">files</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#user-agent"><span class="nav-number">5.1.11.</span> <span class="nav-text">user_agent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#headers"><span class="nav-number">5.1.12.</span> <span class="nav-text">headers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cookie"><span class="nav-number">5.1.13.</span> <span class="nav-text">cookie</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#connect-timeout"><span class="nav-number">5.1.14.</span> <span class="nav-text">connect_timeout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#timeout"><span class="nav-number">5.1.15.</span> <span class="nav-text">timeout</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#allow-redirects"><span class="nav-number">5.1.16.</span> <span class="nav-text">allow_redirects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fetch-type"><span class="nav-number">5.1.17.</span> <span class="nav-text">fetch_type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#save"><span class="nav-number">5.1.18.</span> <span class="nav-text">save</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Response"><span class="nav-number">5.2.</span> <span class="nav-text">Response</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-url"><span class="nav-number">5.2.1.</span> <span class="nav-text">Response.url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-text"><span class="nav-number">5.2.2.</span> <span class="nav-text">Response.text</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-content"><span class="nav-number">5.2.3.</span> <span class="nav-text">Response.content</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-doc"><span class="nav-number">5.2.4.</span> <span class="nav-text">Response.doc</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-etree"><span class="nav-number">5.2.5.</span> <span class="nav-text">Response.etree</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-json"><span class="nav-number">5.2.6.</span> <span class="nav-text">Response.json</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-status-code"><span class="nav-number">5.2.7.</span> <span class="nav-text">Response.status_code</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-orig-url"><span class="nav-number">5.2.8.</span> <span class="nav-text">Response.orig_url</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-headers"><span class="nav-number">5.2.9.</span> <span class="nav-text">Response.headers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-cookies"><span class="nav-number">5.2.10.</span> <span class="nav-text">Response.cookies</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-error"><span class="nav-number">5.2.11.</span> <span class="nav-text">Response.error</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-time"><span class="nav-number">5.2.12.</span> <span class="nav-text">Response.time</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-ok"><span class="nav-number">5.2.13.</span> <span class="nav-text">Response.ok</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-encoding"><span class="nav-number">5.2.14.</span> <span class="nav-text">Response.encoding</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-save"><span class="nav-number">5.2.15.</span> <span class="nav-text">Response.save</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-js-script-result"><span class="nav-number">5.2.16.</span> <span class="nav-text">Response.js_script_result</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Response-raise-for-status"><span class="nav-number">5.2.17.</span> <span class="nav-text">Response.raise_for_status()</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#catch-status-code-error"><span class="nav-number">5.3.</span> <span class="nav-text">@catch_status_code_error</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E7%AF%87"><span class="nav-number">6.</span> <span class="nav-text">原理篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#webui"><span class="nav-number">6.1.</span> <span class="nav-text">webui</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95"><span class="nav-number">6.2.</span> <span class="nav-text">令牌桶算法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#six"><span class="nav-number">6.3.</span> <span class="nav-text">six</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E8%B7%B5%E7%AF%87"><span class="nav-number">7.</span> <span class="nav-text">实践篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0"><span class="nav-number">7.1.</span> <span class="nav-text">常用函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%87%BD%E6%95%B0"><span class="nav-number">7.1.1.</span> <span class="nav-text">自定义函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8F%96%E5%B8%B8%E7%94%A8%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">抓取常用的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%BA%E8%83%BD%E5%9B%9E%E8%B0%83"><span class="nav-number">7.3.</span> <span class="nav-text">智能回调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B2%BE%E7%A1%AE%E5%88%86%E6%9E%90%E4%BB%BB%E5%8A%A1%E9%93%BE%E6%8E%A5"><span class="nav-number">7.4.</span> <span class="nav-text">精确分析任务链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%BF%94%E5%9B%9E%E5%80%BC-1"><span class="nav-number">7.5.</span> <span class="nav-text">多返回值</span></a></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2022/01/07/python/pyspider/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pyspider
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-01-07 18:10:07" itemprop="dateCreated datePublished" datetime="2022-01-07T18:10:07+00:00">2022-01-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-25 02:58:29" itemprop="dateModified" datetime="2023-01-25T02:58:29+00:00">2023-01-25</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>这是一个用Python写的爬虫框架，并以web服务的形式，提供了创建、编辑、运行、管理任务。整体的思路还是非常不错的。以前在ubuntu上安装过，因为依赖的存在，可能并不好安装。但是，有了docker，安装瞬间不成问题。</p>
<p>由于提供了web界面，所有的操作都可以在web操作，熟练后，对于常见的网站，20分钟内，就能编写好爬写任务，所以，还是非常不错的。</p>
<p>本文简述一下使用方式。</p>
<a id="more"></a>

<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><ul>
<li><p><a target="_blank" rel="noopener" href="http://docs.pyspider.org/en/latest/">http://docs.pyspider.org/en/latest/</a>    中文文档暂时没有找到</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/binux/pyspider">https://github.com/binux/pyspider</a></p>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker run  --rm  -itd   --name pyspider  -p <span class="token number">5000</span>:5000  saibaster/pyspider<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后在浏览器上，访问即可。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="资源文件"><a href="#资源文件" class="headerlink" title="资源文件"></a>资源文件</h3><p>居然使用了cdnjs的css、js资源文件，需要想办法绕过去。否则可能会缺少样式。如何解决，变成本地的元素，暂未想到。</p>
<p>下载资源脚本：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">curl</span> http://localhost:55235/ -o index.html
<span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">egrep</span>  -o <span class="token string">'cdnjs.cloudflare.com/ajax/libs/([^"]*?)'</span> index.html <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s#cdnjs.cloudflare.com/ajax/libs/##'</span><span class="token variable">`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token variable">$each</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">curdir</span><span class="token operator">=</span><span class="token variable">$&#123;each<span class="token operator">%</span><span class="token operator">/</span>*&#125;</span>
    <span class="token assign-left variable">filename</span><span class="token operator">=</span><span class="token variable">$&#123;each<span class="token operator">##</span>*<span class="token operator">/</span>&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -d curdir <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
        <span class="token function">mkdir</span> -p <span class="token string">"static/<span class="token variable">$curdir</span>"</span>
    <span class="token keyword">fi</span>
    <span class="token function">curl</span> -o <span class="token string">"static/<span class="token variable">$each</span>"</span> <span class="token string">"http://cdnjs.cloudflare.com/ajax/libs/<span class="token variable">$each</span>"</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>定制docker</p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM saibaster&#x2F;pyspider:1.29
COPY app.py &#x2F;opt&#x2F;pyspider&#x2F;pyspider&#x2F;webui&#x2F;app.py
ADD static.tar.gz  &#x2F;opt&#x2F;pyspider&#x2F;pyspider&#x2F;webui&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>构建</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker build -t pyspider   <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker run  --rm  -itd   --name pyspider  -p <span class="token number">5000</span>:5000  pyspider<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样，就解决了使用外部资源的问题。</p>
<h3 id="异常捕捉"><a href="#异常捕捉" class="headerlink" title="异常捕捉"></a>异常捕捉</h3><p>遇到了中文的url，因为它默认会处理所有的url，结果遇到中文的url直接失败了，抛出异常。虽然此异常，并不会影响整体的爬取，但是呢，却无法查清楚到底是哪些任务失败了，以及无法手动处理？（只能看到重试次数）</p>
<p>可能的结果是：导致数据爬取不完整……，这就tm太坑了吧？</p>
<p>貌似，retry的时候，可以看到。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h3><p>点新建，在右侧点编辑 代码。左侧上，点run，箭头控制，到那个层级的页面。在下面，follow中，处理具体的页面。比较好用的是web浏览，然后css选择器，会帮助自动选择。</p>
<h3 id="模板文件"><a href="#模板文件" class="headerlink" title="模板文件"></a>模板文件</h3><p>下面是给的样本文件，从<code>on_start</code>开始，编写一级级页面爬取的回调。除了框架的功能，python语言本身的功能，都是可以用的。如<code>re</code>等等。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span>
<span class="token comment"># -*- encoding: utf-8 -*-</span>
<span class="token comment"># Created on 2022-01-10 06:27:19</span>
<span class="token comment"># Project: scc</span>

<span class="token keyword">from</span> pyspider<span class="token punctuation">.</span>libs<span class="token punctuation">.</span>base_handler <span class="token keyword">import</span> <span class="token operator">*</span>


<span class="token keyword">class</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crawl_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token decorator annotation punctuation">@every</span><span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'__START_URL__'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>age<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> each <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'a[href^="http"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>priority<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">detail_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><h4 id="pyquery"><a href="#pyquery" class="headerlink" title="pyquery"></a>pyquery</h4><p>比较常用的如下，即在模版中常用的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> each <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'a[href^="http"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>xxx  <span class="token comment"># 其他数据</span>
    each<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 返回文本内容</span>
    each<span class="token punctuation">.</span>html<span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment"># 没有试过</span>
    each<span class="token punctuation">(</span><span class="token string">'td'</span><span class="token punctuation">)</span>    <span class="token comment"># 继续往下查找，</span>
    each<span class="token punctuation">(</span><span class="token string">'td'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 如返回节点</span>
    <span class="token punctuation">[</span>x<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> each<span class="token punctuation">(</span><span class="token string">'td'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>     <span class="token comment"># 继续遍历该节点</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>response.doc</code>是对pyquery(一种类似于jquery的库)的封装。可以非常方便的抽取出信息。</p>
<p>使用正则，匹配特定的url</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> each <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'a[href^="http"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">"http://www.imdb.com/title/tt\d+/$"</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="json"><a href="#json" class="headerlink" title="json"></a>json</h4><p>如果是直接请求接口文件，返回的是json数据，那么，可以使用下面的方法来解析。</p>
<p>返回的是dict对象</p>
<pre class="line-numbers language-none"><code class="language-none">response.json(&quot;字段&quot;)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="re"><a href="#re" class="headerlink" title="re"></a>re</h4><h4 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h4><p>解析js渲染的页面。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://www.twitch.tv/directory/game/Dota%202'</span><span class="token punctuation">,</span>
                   fetch_type<span class="token operator">=</span><span class="token string">'js'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
            <span class="token string">"channels"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
                <span class="token string">"title"</span><span class="token punctuation">:</span> x<span class="token punctuation">(</span><span class="token string">'.title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"viewers"</span><span class="token punctuation">:</span> x<span class="token punctuation">(</span><span class="token string">'.info'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contents<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> x<span class="token punctuation">(</span><span class="token string">'.info a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'.stream.item'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>使用js来模拟页面的滚动效果</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">class Handler<span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span>:
    def on_start<span class="token punctuation">(</span>self<span class="token punctuation">)</span>:
        self.crawl<span class="token punctuation">(</span><span class="token string">'http://www.pinterest.com/categories/popular/'</span>,
                   <span class="token assign-left variable">fetch_type</span><span class="token operator">=</span><span class="token string">'js'</span>, <span class="token assign-left variable">js_script</span><span class="token operator">=</span><span class="token string">""</span>"
                   <span class="token function-name function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                       window.scrollTo<span class="token punctuation">(</span><span class="token number">0</span>,document.body.scrollHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">&#125;</span>
                   <span class="token string">""</span>", <span class="token assign-left variable">callback</span><span class="token operator">=</span>self.index_page<span class="token punctuation">)</span>

    def index_page<span class="token punctuation">(</span>self, response<span class="token punctuation">)</span>:
        <span class="token builtin class-name">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token builtin class-name">:</span> response.url,
            <span class="token string">"images"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
                <span class="token string">"title"</span><span class="token builtin class-name">:</span> x<span class="token punctuation">(</span><span class="token string">'.richPinGridTitle'</span><span class="token punctuation">)</span>.text<span class="token punctuation">(</span><span class="token punctuation">)</span>,
                <span class="token string">"img"</span><span class="token builtin class-name">:</span> x<span class="token punctuation">(</span><span class="token string">'.pinImg'</span><span class="token punctuation">)</span>.attr<span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>,
                <span class="token string">"author"</span><span class="token builtin class-name">:</span> x<span class="token punctuation">(</span><span class="token string">'.creditName'</span><span class="token punctuation">)</span>.text<span class="token punctuation">(</span><span class="token punctuation">)</span>,
            <span class="token punctuation">&#125;</span> <span class="token keyword">for</span> <span class="token for-or-select variable">x</span> <span class="token keyword">in</span> response.doc<span class="token punctuation">(</span><span class="token string">'.item'</span><span class="token punctuation">)</span>.items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> x<span class="token punctuation">(</span><span class="token string">'.pinImg'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="多级页面"><a href="#多级页面" class="headerlink" title="多级页面"></a>多级页面</h3><h4 id="页面分类"><a href="#页面分类" class="headerlink" title="页面分类"></a>页面分类</h4><p>按它的设计，任务会从上一级、往下一级流转，但是呢，有的时候，是否能设置一个智能的分类，决定网哪个层级跳转？</p>
<p>下面 这个例子，很好的说明了，页面，往哪个回调流转，即，不要惯性认为，从某一级页面必须要流转到下一级页面。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> each <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'a[href^="http"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">"http://www.imdb.com/title/tt\d+/$"</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">)</span>   <span class="token comment"># 到下一级</span>
        self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'#right a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">)</span> <span class="token comment"># 继续</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有一种场景：</p>
<p>url一般都是有一定的规则的，我们可以根据url的格式，来决定，往哪个页面回调来处理。相当于，用<code>switch</code>来当个智能中转。</p>
<p>有的时候，也可以通过多增加一层，避免在最后结果页面上，再发起爬取任务。比如，那种左边是目录页面，右遍是内容。（相当于，一个页面，经过两个任务处理。)。</p>
<h4 id="变量传递"><a href="#变量传递" class="headerlink" title="变量传递"></a>变量传递</h4><p>从上级页面，能否往下级页面传递一些变量？这些变量貌似还不能放到类里面。即，数据是从多个页面获取到的？</p>
<p><strong>变量绑定在reponse对象的save属性上。</strong>具体用法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>priority<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>        
    <span class="token keyword">def</span> <span class="token function">index_page2</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> each <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'a[href^="http"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token operator">==</span> <span class="token string">'http://www.miibeian.gov.cn/'</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            <span class="token keyword">if</span> each<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            save <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"sheng"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"sheng"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"shi"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"shi"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"xian"</span><span class="token punctuation">:</span>each<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>          
            <span class="token punctuation">&#125;</span>
            <span class="token comment">#print(save)</span>
            self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page3<span class="token punctuation">,</span>save <span class="token operator">=</span>save<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重点：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 访问</span>
response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"sheng"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token comment"># 该接口，往下级页面传递</span>
self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page3<span class="token punctuation">,</span>save <span class="token operator">=</span>save<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="多返回值"><a href="#多返回值" class="headerlink" title="多返回值"></a>多返回值</h4><ul>
<li>最后页面返回多条数据</li>
</ul>
<p>最后的详情页面，默认的是return，能否yield？如果不能yield，那么能否设置一个空的下载任务，只负责解析？</p>
<p>官网有介绍：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>priority<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">detail_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 错误示范，导致辞职循环的数据，默认都是最后1条。</span>
        save <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"sheng"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"sheng"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"shi"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"shi"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"xian"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"xian"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"xiang"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"xiang"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> each <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'tr.villagetr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 应该在此处，新建对象处理。</span>
            cun_infos <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> each<span class="token punctuation">(</span><span class="token string">"td"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            save<span class="token punctuation">[</span><span class="token string">"cun_bm"</span><span class="token punctuation">]</span> <span class="token operator">=</span> cun_infos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            save<span class="token punctuation">[</span><span class="token string">"cun_type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> cun_infos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            save<span class="token punctuation">[</span><span class="token string">"cun_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> cun_infos<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>save<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> save<span class="token punctuation">,</span>url<span class="token operator">=</span><span class="token string">"%s#%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>url<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
            
    <span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> project<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> msg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>猜测：多返回值的时候，url应该是要重定义的，否则，保存的值，会被覆盖。</strong></p>
<p>使用for循环调用<code>self.send_message</code>方法，然后定义<code>on_message</code>方法，貌似，不定义，虽然也能跑，但是无法展示出数据。</p>
<p>官网说：As resultdb de-duplicate results by taskid(url), the latest will overwrite previous results.One workaround is using <code>send_message</code> API to make a <code>fake</code> taskid for each result.</p>
<ul>
<li>多个页面，都返回数据</li>
</ul>
<p>比如，有多个回调页面，然后呢，每个回调页面都</p>
<h3 id="可用变量"><a href="#可用变量" class="headerlink" title="可用变量"></a>可用变量</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>project_name
self<span class="token punctuation">.</span>project  <span class="token comment">#information about current project</span>
self<span class="token punctuation">.</span>response
self<span class="token punctuation">.</span>task<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="写数据"><a href="#写数据" class="headerlink" title="写数据"></a>写数据</h3><p>写数据，可以自己实现<code>on_result</code>方法</p>
<h4 id="二进制文件"><a href="#二进制文件" class="headerlink" title="二进制文件"></a>二进制文件</h4><p>比如要写二进制文件等等。直接写文件即可</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">response<span class="token punctuation">.</span>content  <span class="token comment"># 返回的内容。直接写文件即可</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<pre class="line-numbers language-python" data-language="python"><code class="language-python">on_result<span class="token punctuation">(</span>self<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><h4 id="结构图"><a href="#结构图" class="headerlink" title="结构图"></a>结构图</h4><p> <img src="pyspider.assets/pyspider-arch.png" alt="pyspider"> </p>
<h4 id="结构说明："><a href="#结构说明：" class="headerlink" title="结构说明："></a>结构说明：</h4><p>适合维护大量的抓取代码，即可以建不同的工程。每个工程的数据可能会更新，通过配置，页面能快速的更新。关于请求，可以是get、post等请求。</p>
<p>总体来说，它是一个工程化的东西。</p>
<p>每个部分都被称为它的一个组件。组件之间，通过消息队列来传递。并不是直接的调用。但是调度器，只有一个。</p>
<h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><h5 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h5><p>通过<code>self.crawl</code>接口来调用。还实现了令牌桶算法。用来控制并发流量等等。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cjsblog/p/9379516.html">令牌桶算法介绍</a>  具体参见后面：令牌桶算法</p>
<p>调度器，内部维护了一个任务队列。进入队列或者进入数据库中的任务，后续代码的更改，比如判断是否爬取这样的功能，后续都没有办法再控制了。</p>
<h5 id="下载器"><a href="#下载器" class="headerlink" title="下载器"></a>下载器</h5><p>抓取页面，然后然处理器来处理。支持dataURI ,还可以使用<code>Phantomjs </code>。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fsjohnhuang/p/3903688.html">DataURI</a></p>
<h5 id="处理器"><a href="#处理器" class="headerlink" title="处理器"></a>处理器</h5><p>负责处理数据。绑定了<code>PyQuery</code>工具，<code>response.doc</code>来调用。可以产出需要的数据，也可以产生新的任务，供下一轮处理。</p>
<h5 id="Result-Worker"><a href="#Result-Worker" class="headerlink" title="Result Worker"></a>Result Worker</h5><p>存数据</p>
<h5 id="WebUI"><a href="#WebUI" class="headerlink" title="WebUI"></a>WebUI</h5><p>web的前端页面。</p>
<h4 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h4><ul>
<li>点击开始时，运行脚本的<code>on_start</code>方法，该方法，会往调度器类产生任务。</li>
<li>调度器，调度任务，on_start产生的任务，也会像正常的任务一样被调度。</li>
<li>下载器，下载任务，并将结果返回给处理器。</li>
<li>处理器，会处理数据，并跟据情况，产生新的任务，并通过<code>self.crawl</code>接口，发送给调度器，任务完成后，会发消息给调度器，告知消息已经完成了。有返回结果，则通过<code>result_queue</code>队列，返回。</li>
<li>调度器，接收处理器发过来的新任务，判断，该任务是否需要重爬，如果需要，则按照优先级放到队列中。</li>
<li>处理器，会不停的处理，……</li>
</ul>
<h3 id="任务"><a href="#任务" class="headerlink" title="任务"></a>任务</h3><p>任务4种状态：成功、失败、激活中、bad（暂未用）</p>
<h4 id="新任务："><a href="#新任务：" class="headerlink" title="新任务："></a>新任务：</h4><p>exetime如果设置了，不到时间，不会运行 。</p>
<p>age或itag来判断是否是新任务</p>
<h4 id="任务重试："><a href="#任务重试：" class="headerlink" title="任务重试："></a>任务重试：</h4><p><code>retry_delay</code>跟<code>crawl_config</code>同级。定义，任务失败后，何时会再次触发。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">retry_delay <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token number">0</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token string">''</span><span class="token punctuation">:</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>默认，重试3次。</p>
<h4 id="删除任务"><a href="#删除任务" class="headerlink" title="删除任务"></a>删除任务</h4><p>如果发现运行的爬虫不合理，则可以更改规则，但是，已进入任务库的数据，则无法处理。故手动删库，如：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">delete FROM <span class="token string">"taskdb_taimeiti"</span> where url not like <span class="token string">"%tmtpost.com%"</span> and process like <span class="token string">'%index_page%'</span>  <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>但是，调度器内的任务，暂时没有想到方法删除。（依然会被调度）</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>配置可以囟到 <code>crawl_config</code>属性上，也可以，1、在定义回调函数的时候，2、使用注解来实现。3、还可以在<code>self.crawl(each.attr.href, callback=self.index_page3,age=age)</code>时，来定义。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crawl_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'headers'</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
            <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'GoogleBot'</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crawl_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'proxy'</span><span class="token punctuation">:</span> <span class="token string">'localhost:8080'</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="every-minutes-24-60"><a href="#every-minutes-24-60" class="headerlink" title="@every(minutes=24 * 60)"></a>@every(minutes=24 * 60)</h4><p>定义任务，多少小时，重新跑一遍。一般定义在<code> on_start</code>，函数上。</p>
<h4 id="config-age-10-24-60-60"><a href="#config-age-10-24-60-60" class="headerlink" title="@config(age=10 * 24 * 60 * 60)"></a>@config(age=10 * 24 * 60 * 60)</h4><p>定义页面多久重新，算过期。一个页面，可能已经爬取过了，下一次，再爬的时候，默认会忽略的。但是，过了age时间之后，才会重爬一次。</p>
<h3 id="config-priority-2"><a href="#config-priority-2" class="headerlink" title="@config(priority=2)"></a>@config(priority=2)</h3><p>定义优先级，优先爬取数值小的页面。</p>
<h4 id="rate-brust"><a href="#rate-brust" class="headerlink" title="rate/brust"></a>rate/brust</h4><p>rate定义1秒，大概取几次结果。如定义为1，则，每秒1个任务。如果<code>0.1</code>，每10秒1个任务。</p>
<p> <code>burst</code>  搞不太明白，看了原理后，大概相当于令牌桶的容量上面是多少，多了就会丢弃。</p>
<h3 id="任务处理"><a href="#任务处理" class="headerlink" title="任务处理"></a>任务处理</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pyspider<span class="token punctuation">.</span>database <span class="token keyword">import</span> connect_database
resultdb <span class="token operator">=</span> connect_database<span class="token punctuation">(</span><span class="token string">"&lt;your resutldb connection url>"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> project <span class="token keyword">in</span> resultdb<span class="token punctuation">.</span>projects<span class="token punctuation">:</span>
    <span class="token keyword">for</span> result <span class="token keyword">in</span> resultdb<span class="token punctuation">.</span>select<span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> result<span class="token punctuation">[</span><span class="token string">'taskid'</span><span class="token punctuation">]</span>
        <span class="token keyword">assert</span> result<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span>
        <span class="token keyword">assert</span> result<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h3 id="分布式"><a href="#分布式" class="headerlink" title="分布式"></a>分布式</h3><h3 id="访问加密"><a href="#访问加密" class="headerlink" title="访问加密"></a>访问加密</h3><p>如果服务部署在公网上，那么，还需要访问加密，并不能让人随便访问？简单的方式，增加一层nginx，然后让nginx来控制权限？或者，内置了安全访问配置如下：</p>
<p>启动如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pyspider  -c /opt/pyspider/data/config.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>配置的json</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"taskdb"</span><span class="token operator">:</span> <span class="token string">"mysql+taskdb://username:password@host:port/taskdb"</span><span class="token punctuation">,</span>
  <span class="token property">"projectdb"</span><span class="token operator">:</span> <span class="token string">"mysql+projectdb://username:password@host:port/projectdb"</span><span class="token punctuation">,</span>
  <span class="token property">"resultdb"</span><span class="token operator">:</span> <span class="token string">"mysql+resultdb://username:password@host:port/resultdb"</span><span class="token punctuation">,</span>
  <span class="token property">"message_queue"</span><span class="token operator">:</span> <span class="token string">"amqp://username:password@host:port/%2F"</span><span class="token punctuation">,</span>
  <span class="token property">"webui"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"some_name"</span><span class="token punctuation">,</span>
    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"some_passwd"</span><span class="token punctuation">,</span>
    <span class="token property">"need-auth"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="结束后，触发"><a href="#结束后，触发" class="headerlink" title="结束后，触发"></a>结束后，触发</h3><p>比如爬取结束后，想要触发消息。发钉钉通知等等。有些场景下，会触发。（一次性任务，任务结束。重复性任务，即every修饰的任务，每次结束都会触发。）</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">on_finished <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h3><h2 id="api"><a href="#api" class="headerlink" title="api"></a>api</h2><h3 id="self-crawl"><a href="#self-crawl" class="headerlink" title="self.crawl"></a>self.crawl</h3><p>至少是这样调用的。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">)</span>

<span class="token comment"># 多个url</span>
self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href <span class="token keyword">for</span> x <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'#right a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="age"><a href="#age" class="headerlink" title="age"></a>age</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>age<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="priority"><a href="#priority" class="headerlink" title="priority"></a>priority</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">
self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://www.example.org/233.html'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">,</span>
               priority<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="exetime"><a href="#exetime" class="headerlink" title="exetime"></a>exetime</h4><p>任务不会立即执行，会在制定的exetime到了之后，才会执行。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://www.example.org/'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
               exetime<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="retries"><a href="#retries" class="headerlink" title="retries"></a>retries</h4><p>默认重试次数为3次。</p>
<h4 id="itag"><a href="#itag" class="headerlink" title="itag"></a>itag</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'.item'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">.</span>url<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">,</span>
                   itag<span class="token operator">=</span>item<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.update-time'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>全部重爬一次。使用<code>itag</code>来标记一个版本。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crawl_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token string">'itag'</span><span class="token punctuation">:</span> <span class="token string">'v223'</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="auto-recrawl"><a href="#auto-recrawl" class="headerlink" title="auto_recrawl"></a>auto_recrawl</h4><p>默认false。开启的效果是：设置了age，在age到了之后，会自动的重爬页面。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://www.example.org/'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
               age<span class="token operator">=</span><span class="token number">5</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span> auto_recrawl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="method"><a href="#method" class="headerlink" title="method"></a>method</h4><p>请求方式</p>
<h4 id="params"><a href="#params" class="headerlink" title="params"></a>params</h4><p>请求参数，以下为两种请求效果一致。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
               params<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token string">'c'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/get?a=123&amp;b=c'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>callback<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="data"><a href="#data" class="headerlink" title="data"></a>data</h4><p>post的请求数据</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://httpbin.org/post'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
               method<span class="token operator">=</span><span class="token string">'POST'</span><span class="token punctuation">,</span> data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token string">'c'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="files"><a href="#files" class="headerlink" title="files"></a>files</h4><p>上传文件</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">&#123;</span>field<span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>filename<span class="token punctuation">:</span> <span class="token string">'content'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="user-agent"><a href="#user-agent" class="headerlink" title="user_agent"></a>user_agent</h4><p>用户 User-Agent</p>
<h4 id="headers"><a href="#headers" class="headerlink" title="headers"></a>headers</h4><p>请求头。</p>
<h4 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>url<span class="token punctuation">,</span>cookies<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"key"</span><span class="token punctuation">:</span> value<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="connect-timeout"><a href="#connect-timeout" class="headerlink" title="connect_timeout"></a>connect_timeout</h4><p>初始化链接超时。默认20秒。</p>
<h4 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h4><p>请求页面的最大时间。最大为120秒。</p>
<h4 id="allow-redirects"><a href="#allow-redirects" class="headerlink" title="allow_redirects"></a>allow_redirects</h4><p>是否允许重定向。默认 true，允许。</p>
<h4 id="fetch-type"><a href="#fetch-type" class="headerlink" title="fetch_type"></a>fetch_type</h4><p>设置为js，运行抓取运行js脚本</p>
<h4 id="save"><a href="#save" class="headerlink" title="save"></a>save</h4><p>多级页面数据传递</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'http://www.example.org/'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>callback<span class="token punctuation">,</span>
               save<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">123</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><p>Response对象的属性列表</p>
<h4 id="Response-url"><a href="#Response-url" class="headerlink" title="Response.url"></a>Response.url</h4><p>final URL.</p>
<h4 id="Response-text"><a href="#Response-text" class="headerlink" title="Response.text"></a>Response.text</h4><p>Content of response, in unicode.</p>
<p>if <code>Response.encoding</code> is None and <code>chardet</code> module is available, encoding of content will be guessed.</p>
<h4 id="Response-content"><a href="#Response-content" class="headerlink" title="Response.content"></a>Response.content</h4><p>Content of response, in bytes.</p>
<h4 id="Response-doc"><a href="#Response-doc" class="headerlink" title="Response.doc"></a>Response.doc</h4><p>A <a target="_blank" rel="noopener" href="https://pythonhosted.org/pyquery/">PyQuery</a> object of the response’s content. Links have made as absolute by default.</p>
<p>Refer to the documentation of PyQuery: <a target="_blank" rel="noopener" href="https://pythonhosted.org/pyquery/">https://pythonhosted.org/pyquery/</a></p>
<p>It’s important that I will repeat, refer to the documentation of PyQuery: <a target="_blank" rel="noopener" href="https://pythonhosted.org/pyquery/">https://pythonhosted.org/pyquery/</a></p>
<h4 id="Response-etree"><a href="#Response-etree" class="headerlink" title="Response.etree"></a>Response.etree</h4><p>A <a target="_blank" rel="noopener" href="http://lxml.de/">lxml</a> object of the response’s content.</p>
<h4 id="Response-json"><a href="#Response-json" class="headerlink" title="Response.json"></a>Response.json</h4><p>The JSON-encoded content of the response, if any.</p>
<h4 id="Response-status-code"><a href="#Response-status-code" class="headerlink" title="Response.status_code"></a>Response.status_code</h4><h4 id="Response-orig-url"><a href="#Response-orig-url" class="headerlink" title="Response.orig_url"></a>Response.orig_url</h4><p>If there is any redirection during the request, here is the url you just submit via <code>self.crawl</code>.</p>
<h4 id="Response-headers"><a href="#Response-headers" class="headerlink" title="Response.headers"></a>Response.headers</h4><p>A case insensitive dict holds the headers of response.</p>
<h4 id="Response-cookies"><a href="#Response-cookies" class="headerlink" title="Response.cookies"></a>Response.cookies</h4><h4 id="Response-error"><a href="#Response-error" class="headerlink" title="Response.error"></a>Response.error</h4><p>Messages when fetch error</p>
<h4 id="Response-time"><a href="#Response-time" class="headerlink" title="Response.time"></a>Response.time</h4><p>Time used during fetching.</p>
<h4 id="Response-ok"><a href="#Response-ok" class="headerlink" title="Response.ok"></a>Response.ok</h4><p>True if <code>status_code</code> is 200 and no error.</p>
<h4 id="Response-encoding"><a href="#Response-encoding" class="headerlink" title="Response.encoding"></a>Response.encoding</h4><p>Encoding of Response.content.</p>
<p>If Response.encoding is None, encoding will be guessed by header or content or <code>chardet</code>(if available).</p>
<p>Set encoding of content manually will overwrite the guessed encoding.</p>
<h4 id="Response-save"><a href="#Response-save" class="headerlink" title="Response.save"></a>Response.save</h4><p>The object saved by <a target="_blank" rel="noopener" href="http://docs.pyspider.org/en/latest/apis/self.crawl/#save"><code>self.crawl</code></a> API</p>
<h4 id="Response-js-script-result"><a href="#Response-js-script-result" class="headerlink" title="Response.js_script_result"></a>Response.js_script_result</h4><p>content returned by JS script</p>
<h4 id="Response-raise-for-status"><a href="#Response-raise-for-status" class="headerlink" title="Response.raise_for_status()"></a>Response.raise_for_status()</h4><p>Raise HTTPError if status code is not 200 or <code>Response.error</code> exists.</p>
<h3 id="catch-status-code-error"><a href="#catch-status-code-error" class="headerlink" title="@catch_status_code_error"></a>@catch_status_code_error</h3><p>正常是只处响应为200的请求，加上该装饰后，可以处理其他的请求。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token decorator annotation punctuation">@catch_status_code_error</span>  
<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 即使返回404，也会处理数据</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2 id="原理篇"><a href="#原理篇" class="headerlink" title="原理篇"></a>原理篇</h2><h3 id="webui"><a href="#webui" class="headerlink" title="webui"></a>webui</h3><p>webui整体架构，使用了flask+jinjia2模板引擎，负责界面操作，具体的数据的crud入库，具体需要控制任务的，实际上就通过rpc交给调度器来操作。</p>
<h3 id="令牌桶算法"><a href="#令牌桶算法" class="headerlink" title="令牌桶算法"></a>令牌桶算法</h3><p>算法可以从网上找到描述，但是，这里面实现的非常的简单。具体代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> threading <span class="token keyword">as</span> _threading
<span class="token keyword">except</span> ImportError<span class="token punctuation">:</span>
    <span class="token keyword">import</span> dummy_threading <span class="token keyword">as</span> _threading


<span class="token keyword">class</span> <span class="token class-name">Bucket</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token triple-quoted-string string">'''
    traffic flow control with token bucket
    '''</span>

    update_interval <span class="token operator">=</span> <span class="token number">30</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rate<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> burst<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>rate <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span>
        <span class="token keyword">if</span> burst <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>burst <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>rate<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>burst <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>burst<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mutex <span class="token operator">=</span> _threading<span class="token punctuation">.</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bucket <span class="token operator">=</span> self<span class="token punctuation">.</span>burst
        self<span class="token punctuation">.</span>last_update <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Get the number of tokens in bucket'''</span>
        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>bucket <span class="token operator">>=</span> self<span class="token punctuation">.</span>burst<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>last_update <span class="token operator">=</span> now
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>bucket
        bucket <span class="token operator">=</span> self<span class="token punctuation">.</span>rate <span class="token operator">*</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> self<span class="token punctuation">.</span>last_update<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> bucket <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>bucket <span class="token operator">+=</span> bucket
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>bucket <span class="token operator">></span> self<span class="token punctuation">.</span>burst<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>bucket <span class="token operator">=</span> self<span class="token punctuation">.</span>burst
            self<span class="token punctuation">.</span>last_update <span class="token operator">=</span> now
        self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>bucket

    <span class="token keyword">def</span> <span class="token function">set</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Set number of tokens in bucket'''</span>
        self<span class="token punctuation">.</span>bucket <span class="token operator">=</span> value

    <span class="token keyword">def</span> <span class="token function">desc</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Use value tokens'''</span>
        self<span class="token punctuation">.</span>bucket <span class="token operator">-=</span> value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用，使用时，<code>get</code>先拿到token，然后，确定有，然后才会去消费<code>desc</code></p>
<p>在任务队列中，如下使用。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TaskQueue</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''Get a task from queue when bucket available'''</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        now <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            task <span class="token operator">=</span> self<span class="token punctuation">.</span>priority_queue<span class="token punctuation">.</span>get_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>bucket<span class="token punctuation">.</span>desc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Queue<span class="token punctuation">.</span>Empty<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
        task<span class="token punctuation">.</span>exetime <span class="token operator">=</span> now <span class="token operator">+</span> self<span class="token punctuation">.</span>processing_timeout
        self<span class="token punctuation">.</span>processing<span class="token punctuation">.</span>put<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>mutex<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> task<span class="token punctuation">.</span>taskid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="six"><a href="#six" class="headerlink" title="six"></a>six</h3><p>以前见过这个库，在这个框架中，依然有six库的身影。那么，它是做什么的呢？</p>
<p>网上查看了下，原来是封装python2、python3差异的库。soga</p>
<h2 id="实践篇"><a href="#实践篇" class="headerlink" title="实践篇"></a>实践篇</h2><h3 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># 层层传递</span>
save <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"from_url"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"from_url"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> response<span class="token punctuation">.</span>save <span class="token keyword">else</span> <span class="token string">""</span> 
<span class="token punctuation">&#125;</span>
self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">,</span>save <span class="token operator">=</span> save<span class="token punctuation">)</span>

<span class="token comment"># 函数判断</span>
<span class="token keyword">if</span> each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'http://www.qishuxx.com/txt/'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

<span class="token comment"># 正则</span>
re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'https?://www\.starurl\.com/video/\d+.html'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
<span class="token comment"># 正则</span>
re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'https?://(www\.)?starurl\.com/video/\d+.html'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>
<span class="token comment">#域名判断</span>
re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'https?://(.*?\.)?starturl\.com/'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span>

<span class="token comment"># 域名判断</span>
url<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'tmtpost.com'</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span> <span class="token punctuation">:</span>

<span class="token comment"># 待做，域名解析、host解析，路由解析等等功能。</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>待做，save用一个函数生成。</p>
<h4 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">url <span class="token operator">=</span> <span class="token string">'starturl.com23:8000/jj'</span>

<span class="token keyword">def</span> <span class="token function">parse_url</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> url<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'http://'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> url<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        protocol <span class="token operator">=</span> <span class="token string">"http"</span>
    <span class="token keyword">elif</span> url<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'https://'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> url<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        protocol <span class="token operator">=</span> <span class="token string">"https"</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        protocol <span class="token operator">=</span> <span class="token string">"http"</span>
    pos <span class="token operator">=</span> url<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> pos <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        host <span class="token operator">=</span> url
        queryall <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        host <span class="token operator">=</span> url<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span>
        queryall <span class="token operator">=</span> url<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span>
    
    pos <span class="token operator">=</span> host<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pos <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        hostname <span class="token operator">=</span> host<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span>
        port <span class="token operator">=</span> host<span class="token punctuation">[</span>pos<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        hostname <span class="token operator">=</span> host
        port <span class="token operator">=</span> <span class="token number">80</span>
    pos <span class="token operator">=</span> queryall<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> pos <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        pathname <span class="token operator">=</span> queryall<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span>
        params <span class="token operator">=</span> queryall<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        pathname <span class="token operator">=</span> queryall<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        params <span class="token operator">=</span> <span class="token string">''</span>
    pos <span class="token operator">=</span> queryall<span class="token punctuation">.</span>rfind<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> pos <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
        anchor <span class="token operator">=</span> queryall<span class="token punctuation">[</span>pos<span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        anchor <span class="token operator">=</span><span class="token string">''</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"hostname"</span><span class="token punctuation">:</span>hostname<span class="token punctuation">,</span>
        <span class="token string">"host"</span><span class="token punctuation">:</span>host<span class="token punctuation">,</span>
        <span class="token string">"port"</span><span class="token punctuation">:</span>port<span class="token punctuation">,</span>
        <span class="token string">"protocol"</span><span class="token punctuation">:</span>protocol<span class="token punctuation">,</span>
        <span class="token string">"pathname"</span><span class="token punctuation">:</span>pathname<span class="token punctuation">,</span>
        <span class="token string">"params"</span><span class="token punctuation">:</span>params<span class="token punctuation">,</span>
        <span class="token string">"anchor"</span><span class="token punctuation">:</span>anchor
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="抓取常用的方式"><a href="#抓取常用的方式" class="headerlink" title="抓取常用的方式"></a>抓取常用的方式</h3><p>nth-child</p>
<p>对于无法区分的</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token string">"url_rar"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'li:nth-child(1)>.downButton'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
<span class="token string">"url_txt"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'li:nth-child(2)>.downButton'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token string">"book_info"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'li.small'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>

response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'li>em[class^="lstar"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>attr<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-python" data-language="python"><code class="language-python">posts_buoy <span class="token operator">=</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'.posts_buoy'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>prev<span class="token punctuation">(</span><span class="token punctuation">)</span>
        video <span class="token operator">=</span> <span class="token string">""</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> posts_buoy<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                video <span class="token operator">=</span> posts_buoy<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span>
            posts_buoy <span class="token operator">=</span> posts_buoy<span class="token punctuation">.</span>prev<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="智能回调"><a href="#智能回调" class="headerlink" title="智能回调"></a>智能回调</h3><p>在index_page层放一个<code>if elif elif</code>判断，用来判断，是否继续爬，或者定义一下爬取的策略，如age等等。但是，<code>each.attr.href</code>的链接，其实都是经过处理过的，默认都是以http开头，但是呢，也有外链，所以呢，需要根据情况来判断。避免爬到其他网。</p>
<p>需要注意的是，结果提取，也有两个回调，既针对了不同的页面，编写不同的提取规则。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>BaseHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    crawl_config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token decorator annotation punctuation">@every</span><span class="token punctuation">(</span>minutes<span class="token operator">=</span><span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">on_start</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span><span class="token string">'https://www.starurl.com/'</span><span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>age<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">index_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>    
        <span class="token keyword">for</span> each <span class="token keyword">in</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'a[href^="http"]'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            url <span class="token operator">=</span> each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href
            save <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"from_url"</span><span class="token punctuation">:</span>response<span class="token punctuation">.</span>save<span class="token punctuation">[</span><span class="token string">"from_url"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> response<span class="token punctuation">.</span>save <span class="token keyword">else</span> <span class="token string">""</span> 
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'https?://www\.starurl\.com/\d+.html'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>detail_page<span class="token punctuation">,</span>save <span class="token operator">=</span> save<span class="token punctuation">)</span>
            <span class="token keyword">elif</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">'https?://www\.starurl\.com/video/\d+.html'</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>video_page<span class="token punctuation">,</span>save <span class="token operator">=</span> save<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>crawl<span class="token punctuation">(</span>each<span class="token punctuation">.</span>attr<span class="token punctuation">.</span>href<span class="token punctuation">,</span> callback<span class="token operator">=</span>self<span class="token punctuation">.</span>index_page<span class="token punctuation">,</span>save <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"from_url"</span><span class="token punctuation">:</span>url<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>priority<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">detail_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
    <span class="token decorator annotation punctuation">@config</span><span class="token punctuation">(</span>priority<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">video_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="精确分析任务链接"><a href="#精确分析任务链接" class="headerlink" title="精确分析任务链接"></a>精确分析任务链接</h3><p>上面直接拿到所有的链接，然后进行爬取，太宽泛了。有的时候，需要精确的从指定的url分析出url。</p>
<pre class="line-numbers language-none"><code class="language-none">def index_page(self, response):
        for each in response.doc(&#39;.module-categories &gt; .module-content &gt; ul &gt; li [href^&#x3D;&quot;http&quot;]&#39;).items():<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="多返回值-1"><a href="#多返回值-1" class="headerlink" title="多返回值"></a>多返回值</h3><p>比如爬取的各层级的页面，都有要提取的信息，如果一般是使用<code>response.save</code>来传递，体现在最终的结果上，但是呢，也可以，不保存，因为这些数据，都放到task表中的，以后手动的从数据中库拿到这些数据。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">detail_page</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> each <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>doc<span class="token punctuation">(</span><span class="token string">'tr.villagetr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        save <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> response<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span>
        cun_infos <span class="token operator">=</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> each<span class="token punctuation">(</span><span class="token string">"td"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        save<span class="token punctuation">[</span><span class="token string">"cun_name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> cun_infos<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>send_message<span class="token punctuation">(</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> save<span class="token punctuation">,</span>url<span class="token operator">=</span><span class="token string">"%s#%s"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>url<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
           
<span class="token keyword">def</span> <span class="token function">on_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> project<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> msg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>








    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/python/" rel="tag"># python</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/01/06/mysql/%E7%B4%A2%E5%BC%95/" rel="prev" title="索引">
                  <i class="fa fa-chevron-left"></i> 索引
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/01/10/mysql/%E6%98%93%E9%94%99%E7%82%B9/" rel="next" title="Mysql易错总结">
                  Mysql易错总结 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">豫ICP备17029463号-1 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
