<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Pisces","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="资源 用gpss从kafka消费数据加载到greenplum gp官方使用gpss的例子 同上 GPkafka-Kafka数据导入GreenPlum infoq:GPkafka-Kafka 数据导入 GreenPlum 实践  总览 gpss 这个应该是个服务端，会开启etl服务。这个服务端，不必跟gp一个机器，也不必跟kdfka的server共享一个机器。故，分开部署。假想的场景是，我另布一个服">
<meta property="og:type" content="article">
<meta property="og:title" content="gpkafka">
<meta property="og:url" content="https://blog.chaofml.cn/2021/08/13/pg/gpkafka/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="资源 用gpss从kafka消费数据加载到greenplum gp官方使用gpss的例子 同上 GPkafka-Kafka数据导入GreenPlum infoq:GPkafka-Kafka 数据导入 GreenPlum 实践  总览 gpss 这个应该是个服务端，会开启etl服务。这个服务端，不必跟gp一个机器，也不必跟kdfka的server共享一个机器。故，分开部署。假想的场景是，我另布一个服">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-08-13T18:23:00.000Z">
<meta property="article:modified_time" content="2023-01-20T06:37:17.444Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="pg">
<meta property="article:tag" content="kafka">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.chaofml.cn/2021/08/13/pg/gpkafka/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>gpkafka | 超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B5%84%E6%BA%90"><span class="nav-number">1.</span> <span class="nav-text">资源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E8%A7%88"><span class="nav-number">2.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%86%E9%A2%91%E6%88%AA%E5%9B%BE-%E6%96%87%E5%AD%97%E8%A7%86%E9%A2%91%E5%86%85%E5%AE%B9"><span class="nav-number">3.</span> <span class="nav-text">视频截图+文字视频内容</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81gpkafka%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">3.1.</span> <span class="nav-text">一、gpkafka是什么?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81gpkafka%E5%AE%9E%E6%88%98"><span class="nav-number">3.2.</span> <span class="nav-text">四、gpkafka实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="nav-number">3.2.1.</span> <span class="nav-text">环境说明:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-number">4.</span> <span class="nav-text">官方文档</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#psscli%E5%B8%AE%E5%8A%A9%E6%96%87%E6%A1%A3"><span class="nav-number">4.1.</span> <span class="nav-text">psscli帮助文档</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gpkafka-v2-yaml"><span class="nav-number">4.2.</span> <span class="nav-text">gpkafka-v2.yaml</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E5%AE%9E%E6%88%98%E8%AE%B0%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">个人实战记录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8gpss"><span class="nav-number">5.1.</span> <span class="nav-text">启动gpss</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAkafka"><span class="nav-number">5.2.</span> <span class="nav-text">创建kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.2.1.</span> <span class="nav-text">搭建服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8"><span class="nav-number">5.2.2.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#text%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F"><span class="nav-number">5.3.</span> <span class="nav-text">text加载方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEyaml"><span class="nav-number">5.3.1.</span> <span class="nav-text">配置yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF"><span class="nav-number">5.3.2.</span> <span class="nav-text">错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="nav-number">5.3.3.</span> <span class="nav-text">任务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E9%80%81kafka%E6%95%B0%E6%8D%AE"><span class="nav-number">5.3.3.1.</span> <span class="nav-text">发送kafka数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gpsscli%E6%8E%A7%E5%88%B6%E4%BB%BB%E5%8A%A1"><span class="nav-number">5.3.3.2.</span> <span class="nav-text">gpsscli控制任务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#json%E5%8A%A0%E8%BD%BD"><span class="nav-number">5.4.</span> <span class="nav-text">json加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEyaml-1"><span class="nav-number">5.4.1.</span> <span class="nav-text">配置yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E7%9A%84%E8%A1%A8"><span class="nav-number">5.4.2.</span> <span class="nav-text">创建存储的表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86-1"><span class="nav-number">5.4.3.</span> <span class="nav-text">任务管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#csv%E5%85%A5%E5%BA%93"><span class="nav-number">5.5.</span> <span class="nav-text">csv入库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEyaml-2"><span class="nav-number">5.5.1.</span> <span class="nav-text">配置yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E7%9A%84%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-number">5.5.2.</span> <span class="nav-text">存储的表结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86-2"><span class="nav-number">5.5.3.</span> <span class="nav-text">任务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E9%80%81kafka%E6%95%B0%E6%8D%AE-1"><span class="nav-number">5.5.3.1.</span> <span class="nav-text">发送kafka数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gpsscli%E6%8E%A7%E5%88%B6%E4%BB%BB%E5%8A%A1-1"><span class="nav-number">5.5.3.2.</span> <span class="nav-text">gpsscli控制任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gpkfka"><span class="nav-number">5.5.3.3.</span> <span class="nav-text">gpkfka</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#avro-json"><span class="nav-number">5.6.</span> <span class="nav-text">avro json</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEyaml-3"><span class="nav-number">5.6.1.</span> <span class="nav-text">配置yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E7%9A%84%E8%A1%A8%E7%BB%93%E6%9E%84-1"><span class="nav-number">5.6.2.</span> <span class="nav-text">存储的表结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86-3"><span class="nav-number">5.6.3.</span> <span class="nav-text">任务管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%91%E9%80%81kafka%E6%95%B0%E6%8D%AE-2"><span class="nav-number">5.6.3.1.</span> <span class="nav-text">发送kafka数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gpsscli%E6%8E%A7%E5%88%B6%E4%BB%BB%E5%8A%A1-2"><span class="nav-number">5.6.3.2.</span> <span class="nav-text">gpsscli控制任务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gpkafka"><span class="nav-number">5.6.3.3.</span> <span class="nav-text">gpkafka</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%AA%E4%BA%BA%E6%B5%8B%E8%AF%95"><span class="nav-number">5.7.</span> <span class="nav-text">个人测试</span></a></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2021/08/13/pg/gpkafka/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          gpkafka
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-13 18:23:00" itemprop="dateCreated datePublished" datetime="2021-08-13T18:23:00+00:00">2021-08-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-20 06:37:17" itemprop="dateModified" datetime="2023-01-20T06:37:17+00:00">2023-01-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xueyubingsen/article/details/104520728">用gpss从kafka消费数据加载到greenplum</a></li>
<li><a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/streaming-server/1-3-3/kafka/loading.html">gp官方使用gpss的例子</a></li>
<li><a target="_blank" rel="noopener" href="https://learnku.com/articles/40988">同上</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/688ef6c27ad6">GPkafka-Kafka数据导入GreenPlum</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/rVQKlxrFbhhA4beKs756">infoq:GPkafka-Kafka 数据导入 GreenPlum 实践</a></li>
</ul>
<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><ul>
<li><p>gpss</p>
<p>这个应该是个服务端，会开启etl服务。这个服务端，不必跟gp一个机器，也不必跟kdfka的server共享一个机器。故，分开部署。假想的场景是，我另布一个服务在一台新的机器上，单独跑etl服务，然后呢，往gp中导数据。</p>
</li>
<li><p>gpsscli</p>
<p>这个是客户端，用来向gpss服务中，提交新的任务的。</p>
</li>
<li><p>gpkafka</p>
<p>这个功能貌似更强大。是gpss跟gpsscli的合体。只需要一次操作，就能提交任务。有点像gpload对gpdist的封装。用更少的操作获得更强大的功能。</p>
</li>
</ul>
<a id="more"></a>

<h1 id="视频截图-文字视频内容"><a href="#视频截图-文字视频内容" class="headerlink" title="视频截图+文字视频内容"></a>视频截图+文字视频内容</h1><h2 id="一、gpkafka是什么"><a href="#一、gpkafka是什么" class="headerlink" title="一、gpkafka是什么?"></a>一、gpkafka是什么?</h2><p>gpkafka是Greenplum数据库的一个组件，支持精准一次处理来自kafka的数据，基于Greenplum成熟的处理能力，可以支持–固定窗口、滑动窗口和会话窗口  –&lt;实时数据处理里的重要概念&gt;<br>的数据计算，适用于实时数据仓库及准实时数据处理，简单易用，容易入门和掌握。</p>
<p>https : //<a target="_blank" rel="noopener" href="http://www.jianshu.com/p/82a2bfccc796--%E9%87%8C%E9%9D%A2%E6%9C%89%E8%B0%B7%E6%AD%8C%E5%85%B3%E4%BA%8E%E6%B5%81%E5%A4%84%E7%90%86%E8%AE%BA%E6%96%87%E7%9A%84%E5%8E%9F%E6%96%87%E5%92%8C%E8%AF%91%E6%96%87%E3%80%82">www.jianshu.com/p/82a2bfccc796--里面有谷歌关于流处理论文的原文和译文。</a></p>
<p>二、实时数据处理的一些典型应用场景:</p>
<ul>
<li>电商与市场营销:数据报表、广告投放、实时大屏、流程监控、实时推荐、实时数仓##物联网（IOT）:传感器实时数据采集和显示，实时告警等</li>
<li>金融业:实时监控、实时估值、实时风控、实时报表、实时大屏、实时数仓等</li>
</ul>
<h2 id="四、gpkafka实战"><a href="#四、gpkafka实战" class="headerlink" title="四、gpkafka实战"></a>四、gpkafka实战</h2><h3 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明:"></a>环境说明:</h3><p>1)本次基于Greenplum 6.5 ,gpss 1.3.5,kafka_2.12-2.4.1.tgz,zookeeper 3.4.10（笔记本虚拟机)</p>
<p>2）创建测试的kafka topic</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kafka-topics.sh --create --zookeeper hadoop201:2181 --replication-factor <span class="token number">1</span> --partitions <span class="token number">3</span> --topic gpss_test<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>3）开启生产者客户端，并生产相应的数据（##在生产之前，先测试topic生产者是否正常##)<br>生产者生产数据(order_info.csv是一个伪造的客户订单表，总数据量为972万)</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kafka-console-producer.sh --broker-list hadoop201:9092 --topic gpss_test <span class="token operator">&lt;</span> order_info.csv<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>4）在gpdb集群上，消费来自kafka的数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment">## start gpss服务</span>
gpss gpsscfg_ex.json --log-dir ./gpsslogs <span class="token operator">&amp;</span>
<span class="token comment"># 查看当前的任务</span>
gpsscli list --all --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
<span class="token comment"># 提交任务</span>
gpsscli submit --name onders_merge --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span> ./gpkafka_merge.yaml
gpsscli submit --name orders_insert --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span> ./gpkafka_insert.yaml
gpsscli submit --name onders_update --gpss-host <span class="token number">10.10</span>.10.103 --gpsS-port <span class="token number">5019</span> ./gpkafka_update.yaml



<span class="token comment"># 再次查看任务</span>
gpsscli list --all --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
<span class="token comment"># 启动任务</span>
gpsscli start orders_merge --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
gpsscli start orders_update --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
gpsscli start orders_insert --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
<span class="token comment"># 停止任务</span>
gpsscli stop orders_merge --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
gpsscli stop orders_update --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
gpsscli stop orders_insert --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span>
<span class="token comment"># 任务状态</span>
gpsscli status orders_merge --gpss-host <span class="token number">10.10</span>.10.103 --gpss-port <span class="token number">5019</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5）同时实时对数据进行查询，如统计客户数量，统计订单金额。<br>生产系统==&gt;kafka ==&gt; Greenplum ==&gt;kafka ==&gt;业务系统（实现数据决策的闭环）。</p>
<h1 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h1><h2 id="psscli帮助文档"><a href="#psscli帮助文档" class="headerlink" title="psscli帮助文档"></a>psscli帮助文档</h2><pre class="line-numbers language-none"><code class="language-none">gpsscli provides subcommands to manage Greenplum Stream Server load jobs
and to view job status, progress, and history.

Usage:
  gpsscli [command]

Available Commands:
  convert     converts V1&#x2F;V2 style config yaml file to new style yaml file
  help        Help about any command
  list        List gpss jobs and status
  load        Load data from kafka into greenplum
  progress    progress loading data from kafka into greenplum
  remove      Remove job from stream server
  shadow      shadow your password using the shadow key in config or a default key
  start       Start loading data from kafka into greenplum
  status      Show GPSS job status
  stop        Stop a gpss job
  submit      Submit a job which loads data from kafka into greenplum
  wait        Wait a gpss job until stop
Flags:
      --config string      gpsscli JSON configuration file
      --gpss-host string   gpss host address (default &quot;127.0.0.1&quot;)
      --gpss-port string   gpss host port (default &quot;5000&quot;)
  -h, --help               help for gpsscli
  -l, --log-dir string     log directory, default is $HOME&#x2F;gpAdminLogs
      --no-check-ca        allow connections to gpss server without certs
      --verbose            enable debug log
      --version            version for gpsscli

Use &quot;gpsscli [command] --help&quot; for more information about a command.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="gpkafka-v2-yaml"><a href="#gpkafka-v2-yaml" class="headerlink" title="gpkafka-v2.yaml"></a>gpkafka-v2.yaml</h2><p><a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/streaming-server/1-3-3/kafka/gpkafka-yaml-v2.html">https://gpdb.docs.pivotal.io/streaming-server/1-3-3/kafka/gpkafka-yaml-v2.html</a></p>
<p>配置文件格式如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> db_name
<span class="token key atrule">USER</span><span class="token punctuation">:</span> user_name
<span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> password
<span class="token key atrule">HOST</span><span class="token punctuation">:</span> host
<span class="token key atrule">PORT</span><span class="token punctuation">:</span> greenplum_port
<span class="token key atrule">VERSION</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">KAFKA</span><span class="token punctuation">:</span>
   <span class="token key atrule">INPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span>
        <span class="token key atrule">BROKERS</span><span class="token punctuation">:</span> kafka_broker_host<span class="token punctuation">:</span>broker_port <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span>
        <span class="token key atrule">TOPIC</span><span class="token punctuation">:</span> kafka_topic
      <span class="token punctuation">[</span><span class="token key atrule">VALUE</span><span class="token punctuation">:</span>
        <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> column_name <span class="token punctuation">|</span> __IGNORED__ <span class="token punctuation">&#125;</span>
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> column_data_type
           <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span>
         <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> value_data_format
         <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">DELIMITED_OPTION</span><span class="token punctuation">:</span>
            <span class="token key atrule">DELIMITER</span><span class="token punctuation">:</span> delimiter_string<span class="token punctuation">]</span> <span class="token punctuation">|</span>
         <span class="token punctuation">[</span><span class="token key atrule">AVRO_OPTION</span><span class="token punctuation">:</span>
            <span class="token key atrule">SCHEMA_REGISTRY_ADDR</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//schemareg_host<span class="token punctuation">:</span>schemareg_port <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">|</span>
         <span class="token punctuation">[</span><span class="token key atrule">CUSTOM_OPTION</span><span class="token punctuation">:</span>
            <span class="token key atrule">NAME</span><span class="token punctuation">:</span> udf_name
            <span class="token key atrule">PARAMSTR</span><span class="token punctuation">:</span> udf_parameter_string<span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token key atrule">KEY</span><span class="token punctuation">:</span>
        <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> column_name <span class="token punctuation">|</span> __IGNORED__ <span class="token punctuation">&#125;</span>
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> column_data_type
           <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span>
         <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> key_data_format
         <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">DELIMITED_OPTION</span><span class="token punctuation">:</span>
            <span class="token key atrule">DELIMITER</span><span class="token punctuation">:</span> delimiter_string<span class="token punctuation">]</span> <span class="token punctuation">|</span>
         <span class="token punctuation">[</span><span class="token key atrule">AVRO_OPTION</span><span class="token punctuation">:</span>
            <span class="token key atrule">SCHEMA_REGISTRY_ADDR</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//schemareg_host<span class="token punctuation">:</span>schemareg_port <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">|</span>
         <span class="token punctuation">[</span><span class="token key atrule">CUSTOM_OPTION</span><span class="token punctuation">:</span>
            <span class="token key atrule">NAME</span><span class="token punctuation">:</span> udf_name
            <span class="token key atrule">PARAMSTR</span><span class="token punctuation">:</span> udf_parameter_string<span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token key atrule">FILTER</span><span class="token punctuation">:</span> filter_string<span class="token punctuation">]</span>
      <span class="token key atrule">ERROR_LIMIT</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> num_errors <span class="token punctuation">|</span> percentage_errors <span class="token punctuation">&#125;</span>
   <span class="token key atrule">OUTPUT</span><span class="token punctuation">:</span>
      <span class="token punctuation">[</span><span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> output_schema_name<span class="token punctuation">]</span>
      <span class="token key atrule">TABLE</span><span class="token punctuation">:</span> table_name
      <span class="token punctuation">[</span><span class="token key atrule">MODE</span><span class="token punctuation">:</span> mode<span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token key atrule">MATCH_COLUMNS</span><span class="token punctuation">:</span> 
         <span class="token punctuation">-</span> match_column_name
         <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token key atrule">UPDATE_COLUMNS</span><span class="token punctuation">:</span> 
         <span class="token punctuation">-</span> update_column_name
         <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token key atrule">UPDATE_CONDITION</span><span class="token punctuation">:</span> update_condition<span class="token punctuation">]</span>
      <span class="token punctuation">[</span><span class="token key atrule">MAPPING</span><span class="token punctuation">:</span> 
         <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> target_column_name
           <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> source_column_name <span class="token punctuation">|</span> expression <span class="token punctuation">&#125;</span> 
         <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span>
           <span class="token punctuation">|</span>
         <span class="token key atrule">target_column_name</span> <span class="token punctuation">:</span> <span class="token punctuation">&#123;</span> source_column_name <span class="token punctuation">|</span> expression <span class="token punctuation">&#125;</span>
         <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span> <span class="token punctuation">]</span>
   <span class="token punctuation">[</span><span class="token key atrule">METADATA</span><span class="token punctuation">:</span>
      <span class="token punctuation">[</span><span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> metadata_schema_name<span class="token punctuation">]</span><span class="token punctuation">]</span>
   <span class="token key atrule">COMMIT</span><span class="token punctuation">:</span>
      <span class="token key atrule">MAX_ROW</span><span class="token punctuation">:</span> num_rows
      <span class="token key atrule">MINIMAL_INTERVAL</span><span class="token punctuation">:</span> wait_time
   <span class="token punctuation">[</span><span class="token key atrule">POLL</span><span class="token punctuation">:</span>
      <span class="token key atrule">BATCHSIZE</span><span class="token punctuation">:</span> num_records
      <span class="token key atrule">TIMEOUT</span><span class="token punctuation">:</span> poll_time<span class="token punctuation">]</span>
   <span class="token punctuation">[</span><span class="token key atrule">TASK</span><span class="token punctuation">:</span>
      <span class="token key atrule">POST_BATCH_SQL</span><span class="token punctuation">:</span> udf_or_sql_to_run
      <span class="token key atrule">BATCH_INTERVAL</span><span class="token punctuation">:</span> num_batches<span class="token punctuation">]</span>
   <span class="token punctuation">[</span><span class="token key atrule">PROPERTIES</span><span class="token punctuation">:</span>
      <span class="token key atrule">kafka_property_name</span><span class="token punctuation">:</span> kafka_property_value
      <span class="token punctuation">[</span> <span class="token punctuation">...</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h1 id="个人实战记录"><a href="#个人实战记录" class="headerlink" title="个人实战记录"></a>个人实战记录</h1><h2 id="启动gpss"><a href="#启动gpss" class="headerlink" title="启动gpss"></a>启动gpss</h2><p>gpss4ic.json</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;
    &quot;ListenAddress&quot;: &#123;
        &quot;Host&quot;: &quot;&quot;,
        &quot;Port&quot;: 50007
    &#125;,
    &quot;Gpfdist&quot;: &#123;
        &quot;Host&quot;: &quot;&quot;,
        &quot;Port&quot;: 8319,
        &quot;ReuseTables&quot;: false
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">nohup</span> gpss gpss4ic.json <span class="token operator">></span> gpss_server.log <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动无任何报错</p>
<h2 id="创建kafka"><a href="#创建kafka" class="headerlink" title="创建kafka"></a>创建kafka</h2><h3 id="搭建服务"><a href="#搭建服务" class="headerlink" title="搭建服务"></a>搭建服务</h3><p>kafka服务端</p>
<blockquote>
<p>0.0.0.0:9092:9092 是因为机器默认是tcp6，主要是解决这个问题。</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">zookeeper</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.131.9.12<span class="token punctuation">:</span>5000/wurstmeister/zookeeper
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"0.0.0.0:2181:2181"</span>
  <span class="token key atrule">kafka</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> 10.131.9.12<span class="token punctuation">:</span>5000/wurstmeister/kafka
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> zookeeper <span class="token punctuation">]</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"0.0.0.0:9092:9092"</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">KAFKA_ADVERTISED_HOST_NAME</span><span class="token punctuation">:</span> 10.172.41.206
      <span class="token key atrule">KAFKA_ZOOKEEPER_CONNECT</span><span class="token punctuation">:</span> zookeeper<span class="token punctuation">:</span><span class="token number">2181</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：这里面有几个坑，可能设置了卷，所以，及时每次重新启动，之前旧的topic都还在。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 错误的配置，导致启动任务时，gsscli 无法正常start任务</span>
<span class="token key atrule">KAFKA_ADVERTISED_HOST_NAME</span><span class="token punctuation">:</span> 127.0.0.1  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">hostname</span> -I
docker-compose up -d
docker <span class="token builtin class-name">exec</span> -it kafka_kafka_1 <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>错误的命令方式。gpss_test</li>
</ul>
<blockquote>
<p>最好以<code>.</code>分隔不同的主题。</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kafka-topics.sh --create --topic gpss_test --partitions <span class="token number">4</span> --zookeeper kafka_zookeeper_1:2181 --replication-factor <span class="token number">1</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>提示</p>
<blockquote>
<p>WARNING: Due to limitations in metric names, topics with a period (‘.’) or underscore (‘_’) could collide. To avoid issues it is best to use either, but not both.</p>
</blockquote>
<ul>
<li>正确的方式</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kafka-topics.sh --create --topic gpsstest2 --partitions <span class="token number">4</span> --zookeeper kafka_zookeeper_1:2181 --replication-factor <span class="token number">1</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>这次没有警告信息。</p>
</blockquote>
<h2 id="text加载方式"><a href="#text加载方式" class="headerlink" title="text加载方式"></a>text加载方式</h2><h3 id="配置yaml"><a href="#配置yaml" class="headerlink" title="配置yaml"></a>配置yaml</h3><ol>
<li>加载以”|”分割的流数据的配置文件 kafka_testdata_delimited.yaml</li>
</ol>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> gpdb
<span class="token key atrule">USER</span><span class="token punctuation">:</span> gpadmin
<span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> changeme
<span class="token key atrule">HOST</span><span class="token punctuation">:</span> localhost
<span class="token key atrule">PORT</span><span class="token punctuation">:</span> <span class="token number">5432</span>
<span class="token key atrule">VERSION</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">KAFKA</span><span class="token punctuation">:</span>
   <span class="token key atrule">INPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span>
         <span class="token key atrule">BROKERS</span><span class="token punctuation">:</span> 10.172.41.206<span class="token punctuation">:</span><span class="token number">9092</span>
         <span class="token key atrule">TOPIC</span><span class="token punctuation">:</span> gpsstest2
      <span class="token key atrule">VALUE</span><span class="token punctuation">:</span>
         <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> tid
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> integer
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> tcode
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> varchar
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> tname
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> varchar
         <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> delimited
         <span class="token key atrule">DELIMITED_OPTION</span><span class="token punctuation">:</span>
           <span class="token key atrule">DELIMITER</span><span class="token punctuation">:</span> <span class="token string">"|"</span>
      <span class="token key atrule">ERROR_LIMIT</span><span class="token punctuation">:</span> <span class="token number">25</span>
   <span class="token key atrule">OUTPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> yunchou
      <span class="token key atrule">TABLE</span><span class="token punctuation">:</span> test_heap
   <span class="token key atrule">METADATA</span><span class="token punctuation">:</span>
      <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> yunchou
   <span class="token key atrule">COMMIT</span><span class="token punctuation">:</span>
      <span class="token key atrule">MINIMAL_INTERVAL</span><span class="token punctuation">:</span> <span class="token number">2000</span>
   <span class="token key atrule">POLL</span><span class="token punctuation">:</span>
      <span class="token key atrule">BATCHSIZE</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">TIMEOUT</span><span class="token punctuation">:</span> <span class="token number">3000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>说明</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># METADATA不知道什么意思   暂时跟上面一致</span>
 <span class="token key atrule">METADATA</span><span class="token punctuation">:</span>
   <span class="token comment">#SCHEMA: yunchou</span>
   <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> gpkafka_internal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><p>配置gp数据库中不存在的SCHEMA，会导致有如下错误：</p>
<blockquote>
<p>配置成已有的SCHEMA，问题可解决。</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">20210813:14:45:51 gpsscli:gpadmin:szc49030:113161-[ERROR]:-start job failed, err: rpc error: code &#x3D; Unknown desc &#x3D; initJob failed: InitJob: failed to create external table: &quot;gpkafka_internal&quot;.&quot;gpkafkaloadext_8f5ceb5aa8489a5a5e1bd22e1a932c2c&quot;, sql: CREATE EXTERNAL TABLE &quot;gpkafka_internal&quot;.&quot;gpkafkaloadext_8f5ceb5aa8489a5a5e1bd22e1a932c2c&quot;(tid integer, tcode varchar, tname varchar)
        LOCATION(&#39;gpfdist:&#x2F;&#x2F;szc49030:8319&#x2F;gpkafkaload&#x2F;%22gpkafka_internal%22.%22gpkafkaloadext_8f5ceb5aa8489a5a5e1bd22e1a932c2c%22&#39;)
        FORMAT &#39;CUSTOM&#39;(formatter&#x3D;&#39;delimited_in&#39;, delimiter&#x3D;&#39;|&#39;) LOG ERRORS SEGMENT REJECT LIMIT 25 ROWS: pq: schema &quot;gpkafka_internal&quot; does not exist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<p>kafka配置不正确，导致从kafka获得到的broker总是<code>127.0.0.1:9092</code></p>
<blockquote>
<p>重新部署kafka服务，问题得以解决。即：    KAFKA_ADVERTISED_HOST_NAME: 10.172.41.206</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">20210813:14:00:33 gpsscli:gpadmin:szc49030:104644-[ERROR]:-start job failed, err: rpc error: code &#x3D; Unknown desc &#x3D; initJob failed: InitJob: getPartitionsMetadata: connecting [127.0.0.1:9092] failed: dial tcp 127.0.0.1:9092: connect: connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p>依然无法解决的问题。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token number">20210813</span>:16:03:17 gpsscli:gpadmin:szc49030:129862-<span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span>:-start job failed, err: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> initJob failed: InitJob: getPartitionsMetadata: reader: kafkacsvdata fail to get kafka meta data: Local: Broker transport failure<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="任务管理"><a href="#任务管理" class="headerlink" title="任务管理"></a>任务管理</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># --gpss-host 启动的 gpss监听的地址   --gpss-port 50007端口 这说明 gpss不必运行在跟gp同一台机器上</span>

<span class="token comment"># 创建任务</span>
gpsscli submit --name kafkacsvdata --gpss-port <span class="token number">50007</span> --gpss-host localhost ./kafka_testdata_delimited.yaml
<span class="token comment"># 输出如下</span>
<span class="token comment"># 20210813:13:39:13 gpsscli:gpadmin:szc49030:100581-[INFO]:-JobID: adc3e38aea0a7a710a0ab5321d3f759e,JobName: kafkacsvdata</span>

<span class="token comment"># 查看任务</span>
<span class="token comment"># gpsscli list --all --gpss-port 50007 --gpss-host mdw</span>
gpsscli list --all --gpss-port <span class="token number">50007</span> --gpss-host localhost<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="发送kafka数据"><a href="#发送kafka数据" class="headerlink" title="发送kafka数据"></a>发送kafka数据</h4><p>创建文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">cat</span> <span class="token operator">></span> test_heap.csv <span class="token operator">&lt;&lt;</span>EOL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>内容</p>
<pre class="line-numbers language-none"><code class="language-none">1|aa|2002
1|bb|2003
1|cc|2004
1|dd|2005<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 发布  10.172.41.206:9092</span>
<span class="token comment">#kafka-console-producer.sh --topic=gpsstest --broker-list kafka_kafka_1:9092 &lt; test_heap.csv</span>
kafka-console-producer.sh --topic<span class="token operator">=</span>gpsstest2 --broker-list kafka_kafka_1:9092 <span class="token operator">&lt;</span> test_heap.csv
<span class="token comment"># 发布成功后  每条输出一个 > </span>

<span class="token comment"># 消费者查看 </span>
kafka-console-consumer.sh --bootstrap-server kafka_kafka_1:9092 --from-beginning --topic gpsstest
<span class="token comment"># 能查看到刚在的输入</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建表结构，没有表结构，貌似没有办法直接接收到消息</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token string">"yunchou"</span><span class="token punctuation">.</span><span class="token string">"test_heap"</span> <span class="token punctuation">(</span>
    tid <span class="token keyword">integer</span><span class="token punctuation">,</span>
    tcode <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    tname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>  <span class="token keyword">WITH</span> <span class="token punctuation">(</span>OIDS<span class="token operator">=</span><span class="token boolean">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="gpsscli控制任务"><a href="#gpsscli控制任务" class="headerlink" title="gpsscli控制任务"></a>gpsscli控制任务</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 启动任务</span>
gpsscli start kafkacsvdata --gpss-host localhost --gpss-port <span class="token number">50007</span>

<span class="token comment"># 停止任务</span>
gpsscli stop kafkacsvdata --gpss-host localhost --gpss-port <span class="token number">50007</span>

<span class="token comment"># 删除任务</span>
gpsscli  remove kafkacsvdata --gpss-port <span class="token number">50007</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="json加载"><a href="#json加载" class="headerlink" title="json加载"></a>json加载</h2><h3 id="配置yaml-1"><a href="#配置yaml-1" class="headerlink" title="配置yaml"></a>配置yaml</h3><p>问题，如何加载key。key也要入库。BROKERS多个之间，用英文逗号分隔。</p>
<p> kafka_testdata_json.yaml </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> gpdb
<span class="token key atrule">USER</span><span class="token punctuation">:</span> gpadmin
<span class="token key atrule">PASSWORD</span><span class="token punctuation">:</span> changeme
<span class="token key atrule">HOST</span><span class="token punctuation">:</span> localhost
<span class="token key atrule">PORT</span><span class="token punctuation">:</span> <span class="token number">5432</span>
<span class="token key atrule">VERSION</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">KAFKA</span><span class="token punctuation">:</span>
   <span class="token key atrule">INPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span>
         <span class="token key atrule">BROKERS</span><span class="token punctuation">:</span> 10.172.32.31<span class="token punctuation">:</span><span class="token number">1012</span><span class="token punctuation">,</span>10.172.32.32<span class="token punctuation">:</span><span class="token number">1012</span><span class="token punctuation">,</span>10.172.32.33<span class="token punctuation">:</span><span class="token number">1012</span>
         <span class="token key atrule">TOPIC</span><span class="token punctuation">:</span> ordercenter.reorganize.v2.order
      <span class="token key atrule">VALUE</span><span class="token punctuation">:</span>
        <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> jdata
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> json
        <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> json
      <span class="token key atrule">ERROR_LIMIT</span><span class="token punctuation">:</span> <span class="token number">25</span>
   <span class="token key atrule">OUTPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> yunchou
      <span class="token key atrule">TABLE</span><span class="token punctuation">:</span> test_order
      <span class="token key atrule">MAPPING</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> businessOrderId
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> (jdata<span class="token punctuation">-</span><span class="token punctuation">></span><span class="token punctuation">></span>'businessOrderId')<span class="token punctuation">:</span><span class="token punctuation">:</span>varchar
   <span class="token key atrule">METADATA</span><span class="token punctuation">:</span>
      <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> yunchou
   <span class="token key atrule">COMMIT</span><span class="token punctuation">:</span>
      <span class="token key atrule">MINIMAL_INTERVAL</span><span class="token punctuation">:</span> <span class="token number">2000</span>
   <span class="token key atrule">POLL</span><span class="token punctuation">:</span>
      <span class="token key atrule">BATCHSIZE</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">TIMEOUT</span><span class="token punctuation">:</span> <span class="token number">3000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="创建存储的表"><a href="#创建存储的表" class="headerlink" title="创建存储的表"></a>创建存储的表</h3><pre class="line-numbers language-none"><code class="language-none">CREATE TABLE &quot;yunchou&quot;.&quot;test_order&quot; (
    businessOrderId varchar(255)
)  WITH (OIDS&#x3D;FALSE);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="任务管理-1"><a href="#任务管理-1" class="headerlink" title="任务管理"></a>任务管理</h3><p>由于直接采用人的kafka，作为消费者接入，故省略了kafka的生产者过程。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">gpsscli submit --name kafkajsondata --gpss-port <span class="token number">50007</span> --gpss-host localhost ./kafka_testdata_json.yaml 


<span class="token comment"># 查看任务</span>
<span class="token comment"># gpsscli list --all --gpss-port 50007 --gpss-host mdw</span>
gpsscli list --all --gpss-port <span class="token number">50007</span> --gpss-host localhost

<span class="token comment"># 启动任务</span>
gpsscli start kafkajsondata --gpss-host localhost --gpss-port <span class="token number">50007</span>
gpsscli status kafkajsondata --gpss-host localhost --gpss-port <span class="token number">50007</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用别人搭建的，貌似一下就成功了。不知道为何。</p>
<h2 id="csv入库"><a href="#csv入库" class="headerlink" title="csv入库"></a>csv入库</h2><p><a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/streaming-server/1-3-3/kafka/load-from-kafka-example.html">load-from-kafka-example.html</a></p>
<h3 id="配置yaml-2"><a href="#配置yaml-2" class="headerlink" title="配置yaml"></a>配置yaml</h3><p> firstload_cfg.yaml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> gpdb
<span class="token key atrule">USER</span><span class="token punctuation">:</span> gpadmin
<span class="token key atrule">HOST</span><span class="token punctuation">:</span> localhost
<span class="token key atrule">PORT</span><span class="token punctuation">:</span> <span class="token number">5432</span>
<span class="token key atrule">KAFKA</span><span class="token punctuation">:</span>
   <span class="token key atrule">INPUT</span><span class="token punctuation">:</span>
     <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span>
        <span class="token key atrule">BROKERS</span><span class="token punctuation">:</span> 10.172.41.206<span class="token punctuation">:</span><span class="token number">9092</span>
        <span class="token key atrule">TOPIC</span><span class="token punctuation">:</span> topic_for_gpkafka
     <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> cust_id
          <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> int
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> __IGNORED__
          <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> int
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> expenses
          <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> decimal(9<span class="token punctuation">,</span>2)
     <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> csv
     <span class="token key atrule">ERROR_LIMIT</span><span class="token punctuation">:</span> <span class="token number">125</span>
   <span class="token key atrule">OUTPUT</span><span class="token punctuation">:</span>
     <span class="token key atrule">TABLE</span><span class="token punctuation">:</span> data_from_kafka
     <span class="token key atrule">MAPPING</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> customer_id
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> cust_id
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> expenses
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> expenses
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> tax_due
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> expenses * .0725
   <span class="token key atrule">COMMIT</span><span class="token punctuation">:</span>
     <span class="token key atrule">MINIMAL_INTERVAL</span><span class="token punctuation">:</span> <span class="token number">2000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在末尾增加了消费者的group.id，首先配置它认了，但是貌似没有起作用一样，服务端，它并没有查到该消费者，而且，gpss运行，插入的数据，并没有重复，难道它在客户端实现了维护数据的功能？</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">PROPERTIES</span><span class="token punctuation">:</span> 
  <span class="token key atrule">group.id</span><span class="token punctuation">:</span> yunchouhello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="存储的表结构"><a href="#存储的表结构" class="headerlink" title="存储的表结构"></a>存储的表结构</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">public</span><span class="token punctuation">.</span>data_from_kafka<span class="token punctuation">(</span> customer_id int8<span class="token punctuation">,</span> expenses <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           tax_due <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>如果表不存在，则报如下错误：</p>
<pre class="line-numbers language-none"><code class="language-none">20210816:14:34:16 gpsscli:gpadmin:szc49030:105471-[ERROR]:-start job failed, err: rpc error: code &#x3D; Unknown desc &#x3D; initJob failed: InitJob: pq: relation &quot;public.data_from_kafka&quot; does not exist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="任务管理-2"><a href="#任务管理-2" class="headerlink" title="任务管理"></a>任务管理</h3><h4 id="发送kafka数据-1"><a href="#发送kafka数据-1" class="headerlink" title="发送kafka数据"></a>发送kafka数据</h4><pre class="line-numbers language-none"><code class="language-none">cat &gt; sample_data.csv &lt;&lt;EOL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">&quot;1313131&quot;,&quot;12&quot;,&quot;1313.13&quot;
&quot;3535353&quot;,&quot;11&quot;,&quot;761.35&quot;
&quot;7979797&quot;,&quot;10&quot;,&quot;4489.00&quot;
&quot;7979797&quot;,&quot;11&quot;,&quot;18.72&quot;
&quot;3535353&quot;,&quot;10&quot;,&quot;6001.94&quot;
&quot;7979797&quot;,&quot;12&quot;,&quot;173.18&quot;
&quot;1313131&quot;,&quot;10&quot;,&quot;492.83&quot;
&quot;3535353&quot;,&quot;12&quot;,&quot;81.12&quot;
&quot;1313131&quot;,&quot;11&quot;,&quot;368.27&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker <span class="token builtin class-name">exec</span> -it kafka_kafka_1 <span class="token function">bash</span>

<span class="token comment"># 创建topic</span>
<span class="token comment"># kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1  --topic topic_for_gpkafka</span>
kafka-topics.sh --create --topic topic_for_gpkafka --partitions <span class="token number">1</span> --zookeeper kafka_zookeeper_1:2181 --replication-factor <span class="token number">1</span> 
    
<span class="token comment"># 发布数据</span>
kafka-console-producer.sh <span class="token punctuation">\</span>
    --broker-list <span class="token number">10.172</span>.41.206:9092 <span class="token punctuation">\</span>
    --topic topic_for_gpkafka <span class="token operator">&lt;</span> sample_data.csv

<span class="token comment"># 验证数据</span>
kafka-console-consumer.sh <span class="token punctuation">\</span>
    --bootstrap-server <span class="token number">10.172</span>.41.206:9092 --topic topic_for_gpkafka <span class="token punctuation">\</span>
    --from-beginning<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="gpsscli控制任务-1"><a href="#gpsscli控制任务-1" class="headerlink" title="gpsscli控制任务"></a>gpsscli控制任务</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">gpsscli submit --name topic_for_gpkafka --gpss-port <span class="token number">50007</span> --gpss-host localhost ./firstload_cfg.yaml
<span class="token comment"># 启动任务</span>
gpsscli start topic_for_gpkafka --gpss-host localhost --gpss-port <span class="token number">50007</span>

<span class="token comment"># 列出任务</span>
gpsscli list --all --gpss-port <span class="token number">50007</span> --gpss-host localhost

<span class="token comment"># 停止任务</span>
gpsscli stop topic_for_gpkafka --gpss-host localhost --gpss-port <span class="token number">50007</span>

<span class="token comment"># 删除任务</span>
gpsscli  remove topic_for_gpkafka --gpss-port <span class="token number">50007</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>启动任务正常大概有如下：</p>
<pre class="line-numbers language-none"><code class="language-none">20210816:14:36:27 gpsscli:gpadmin:szc49030:105944-[INFO]:-Job topic_for_gpkafka is started<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看，数据也能正常的入到kafka中。</p>
<h4 id="gpkfka"><a href="#gpkfka" class="headerlink" title="gpkfka"></a>gpkfka</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">gpkafka load  firstload_cfg.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>貌似不冲突，跟上面差不多，只不过会卡在一个界面上。</p>
<h2 id="avro-json"><a href="#avro-json" class="headerlink" title="avro json"></a>avro json</h2><p><a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/streaming-server/1-3-3/kafka/load-key-value-example.html">https://gpdb.docs.pivotal.io/streaming-server/1-3-3/kafka/load-key-value-example.html</a></p>
<h3 id="配置yaml-3"><a href="#配置yaml-3" class="headerlink" title="配置yaml"></a>配置yaml</h3><p>avrokvload_cfg.yaml </p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> gpdb
<span class="token key atrule">USER</span><span class="token punctuation">:</span> gpadmin
<span class="token key atrule">HOST</span><span class="token punctuation">:</span> localhost
<span class="token key atrule">PORT</span><span class="token punctuation">:</span> <span class="token number">5432</span>
<span class="token key atrule">VERSION</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">KAFKA</span><span class="token punctuation">:</span>
   <span class="token key atrule">INPUT</span><span class="token punctuation">:</span>
     <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span>
        <span class="token key atrule">BROKERS</span><span class="token punctuation">:</span> 10.172.41.206<span class="token punctuation">:</span><span class="token number">9092</span>
        <span class="token key atrule">TOPIC</span><span class="token punctuation">:</span> topic_avrokv
     <span class="token key atrule">VALUE</span><span class="token punctuation">:</span>
        <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> c1
            <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> json
        <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> avro
        <span class="token comment">#AVRO_OPTION:</span>
          <span class="token comment">#SCHEMA_REGISTRY_ADDR: http://localhost:8081</span>
     <span class="token key atrule">KEY</span><span class="token punctuation">:</span>
        <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> id
            <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> json
        <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> avro
        <span class="token comment">#AVRO_OPTION:</span>
          <span class="token comment">#SCHEMA_REGISTRY_ADDR: http://localhost:8081</span>
     <span class="token key atrule">ERROR_LIMIT</span><span class="token punctuation">:</span> <span class="token number">0</span>
   <span class="token key atrule">OUTPUT</span><span class="token punctuation">:</span>
     <span class="token key atrule">TABLE</span><span class="token punctuation">:</span> avrokv_from_kafka
     <span class="token key atrule">MAPPING</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> id
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> id
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> customer_id
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> (c1<span class="token punctuation">-</span><span class="token punctuation">></span><span class="token punctuation">></span>'cust_id')<span class="token punctuation">:</span><span class="token punctuation">:</span>int
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> year
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> (c1<span class="token punctuation">-</span><span class="token punctuation">></span><span class="token punctuation">></span>'year')<span class="token punctuation">:</span><span class="token punctuation">:</span>int
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> expenses
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> array(select json_array_elements(c1<span class="token punctuation">-</span><span class="token punctuation">></span>'expenses')<span class="token punctuation">:</span><span class="token punctuation">:</span>text<span class="token punctuation">:</span><span class="token punctuation">:</span>float)
   <span class="token key atrule">COMMIT</span><span class="token punctuation">:</span>
     <span class="token key atrule">MINIMAL_INTERVAL</span><span class="token punctuation">:</span> <span class="token number">2000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="存储的表结构-1"><a href="#存储的表结构-1" class="headerlink" title="存储的表结构"></a>存储的表结构</h3><pre class="line-numbers language-none"><code class="language-none">CREATE TABLE avrokv_from_kafka( id json, customer_id int, year int, expenses decimal(9,2)[] );<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="任务管理-3"><a href="#任务管理-3" class="headerlink" title="任务管理"></a>任务管理</h3><h4 id="发送kafka数据-2"><a href="#发送kafka数据-2" class="headerlink" title="发送kafka数据"></a>发送kafka数据</h4><p>注意，才此的数据格式，key跟value之间要包含一个tab键，下面的TAB要转换为真实的TAB。</p>
<pre class="line-numbers language-none"><code class="language-none">1 TAB &#123;&quot;cust_id&quot;:1313131, &quot;year&quot;:2012, &quot;expenses&quot;:[1313.13, 2424.24]&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意，下面的包含tab。</p>
<pre class="line-numbers language-none"><code class="language-none">1	&#123;&quot;cust_id&quot;:1313131, &quot;year&quot;:2012, &quot;expenses&quot;:[1313.13, 2424.24]&#125;
2	&#123;&quot;cust_id&quot;:3535353, &quot;year&quot;:2011, &quot;expenses&quot;:[761.35, 92.18, 14.41]&#125;
3	&#123;&quot;cust_id&quot;:7979797, &quot;year&quot;:2011, &quot;expenses&quot;:[4489.00]&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>发现压根儿没有<code>kafka-avro-console-producer</code>这一系列命令。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 创建主题</span>
kafka-topics.sh --create --topic topic_avrokv --partitions <span class="token number">1</span> --zookeeper kafka_zookeeper_1:2181 --replication-factor <span class="token number">1</span> 

<span class="token comment"># 为该主题创建scheme</span>
kafka-avro-console-producer <span class="token punctuation">\</span>
    --broker-list localhost:9092 <span class="token punctuation">\</span>
    --topic topic_avrokv <span class="token punctuation">\</span>
    --property parse.key<span class="token operator">=</span>true --property key.schema<span class="token operator">=</span><span class="token string">'&#123;"type" : "int", "name" : "id"&#125;'</span> <span class="token punctuation">\</span>
    --property value.schema<span class="token operator">=</span><span class="token string">'&#123; "type" : "record", "name" : "example_schema", "namespace" : "com.example", "fields" : [ &#123; "name" : "cust_id", "type" : "int", "doc" : "Id of the customer account" &#125;, &#123; "name" : "year", "type" : "int", "doc" : "year of expense" &#125;, &#123; "name" : "expenses", "type" : &#123;"type": "array", "items": "float"&#125;, "doc" : "Expenses for the year" &#125; ], "doc:" : "A basic schema for storing messages" &#125;'</span>
    
    
<span class="token comment"># 验证数据</span>
kafka-avro-console-consumer <span class="token punctuation">\</span>
    --bootstrap-server localhost:9092 --topic topic_avrokv <span class="token punctuation">\</span>
    --from-beginning --property print.key<span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="gpsscli控制任务-2"><a href="#gpsscli控制任务-2" class="headerlink" title="gpsscli控制任务"></a>gpsscli控制任务</h4><h4 id="gpkafka"><a href="#gpkafka" class="headerlink" title="gpkafka"></a>gpkafka</h4><pre class="line-numbers language-none"><code class="language-none">gpkafka load --quit-at-eof .&#x2F;avrokvload_cfg.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>







<h2 id="个人测试"><a href="#个人测试" class="headerlink" title="个人测试"></a>个人测试</h2><p>貌似这种没有办法直接存，难道要让我写存储过程？</p>
<p>简单的方式，原因将数据存入到数据库中，然后再写脚本，定时将数据select into 到表中。暂缓。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token property">"shipId"</span><span class="token operator">:</span><span class="token string">"5300010236284"</span><span class="token punctuation">,</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"0201"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>marked_ship_kafka.yaml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">DATABASE</span><span class="token punctuation">:</span> gpdb
<span class="token key atrule">USER</span><span class="token punctuation">:</span> gpadmin
<span class="token key atrule">HOST</span><span class="token punctuation">:</span> localhost
<span class="token key atrule">PORT</span><span class="token punctuation">:</span> <span class="token number">5432</span>
<span class="token key atrule">VERSION</span><span class="token punctuation">:</span> <span class="token number">2</span>
<span class="token key atrule">KAFKA</span><span class="token punctuation">:</span>
   <span class="token key atrule">INPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SOURCE</span><span class="token punctuation">:</span>
         <span class="token key atrule">BROKERS</span><span class="token punctuation">:</span> 10.172.32.30<span class="token punctuation">:</span><span class="token number">8090</span><span class="token punctuation">,</span>10.172.32.15<span class="token punctuation">:</span><span class="token number">8090</span><span class="token punctuation">,</span>10.172.32.14<span class="token punctuation">:</span><span class="token number">8090</span>
         <span class="token key atrule">TOPIC</span><span class="token punctuation">:</span> KAFKA<span class="token punctuation">-</span>INTERNAL<span class="token punctuation">-</span>MARKING<span class="token punctuation">-</span>TOPIC
      <span class="token key atrule">VALUE</span><span class="token punctuation">:</span>
        <span class="token key atrule">COLUMNS</span><span class="token punctuation">:</span>
           <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> jdata
             <span class="token key atrule">TYPE</span><span class="token punctuation">:</span> json
        <span class="token key atrule">FORMAT</span><span class="token punctuation">:</span> json
      <span class="token key atrule">ERROR_LIMIT</span><span class="token punctuation">:</span> <span class="token number">25</span>
   <span class="token key atrule">OUTPUT</span><span class="token punctuation">:</span>
      <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> yunchou
      <span class="token key atrule">TABLE</span><span class="token punctuation">:</span> marked_ship_kafka
      <span class="token key atrule">MAPPING</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> ship_id
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> (jdata<span class="token punctuation">-</span><span class="token punctuation">></span><span class="token punctuation">></span>'shipId')<span class="token punctuation">:</span><span class="token punctuation">:</span>varchar
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> ship_type
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> (jdata<span class="token punctuation">-</span><span class="token punctuation">></span><span class="token punctuation">></span>'type')<span class="token punctuation">:</span><span class="token punctuation">:</span>varchar
        <span class="token punctuation">-</span> <span class="token key atrule">NAME</span><span class="token punctuation">:</span> insert_time
          <span class="token key atrule">EXPRESSION</span><span class="token punctuation">:</span> now()
   <span class="token key atrule">METADATA</span><span class="token punctuation">:</span>
      <span class="token key atrule">SCHEMA</span><span class="token punctuation">:</span> yunchou
   <span class="token key atrule">COMMIT</span><span class="token punctuation">:</span>
      <span class="token key atrule">MINIMAL_INTERVAL</span><span class="token punctuation">:</span> <span class="token number">2000</span>
   <span class="token key atrule">POLL</span><span class="token punctuation">:</span>
      <span class="token key atrule">BATCHSIZE</span><span class="token punctuation">:</span> <span class="token number">100</span>
      <span class="token key atrule">TIMEOUT</span><span class="token punctuation">:</span> <span class="token number">3000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 运单打标，kafka源</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> yunchou<span class="token punctuation">.</span>marked_ship_kafka <span class="token punctuation">(</span>
    ship_id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ship_type <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    insert_time <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone
<span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>appendonly<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> compresslevel<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> orientation<span class="token operator">=</span><span class="token keyword">column</span><span class="token punctuation">,</span> compresstype<span class="token operator">=</span>zlib<span class="token punctuation">)</span>
<span class="token keyword">Distributed</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> range <span class="token punctuation">(</span>insert_time<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">PARTITION</span> pn <span class="token keyword">START</span> <span class="token punctuation">(</span><span class="token string">'2021-07-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token punctuation">(</span><span class="token string">'2023-01-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> EVERY <span class="token punctuation">(</span><span class="token string">'1 day'</span>::<span class="token keyword">interval</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">DEFAULT</span> <span class="token keyword">PARTITION</span> pdefault
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> yunchou<span class="token punctuation">.</span>marked_ship_kafka<span class="token punctuation">.</span>ship_id <span class="token operator">IS</span> <span class="token string">'运单号'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> yunchou<span class="token punctuation">.</span>marked_ship_kafka<span class="token punctuation">.</span>ship_type <span class="token operator">IS</span> <span class="token string">'运单标记'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMENT</span> <span class="token keyword">ON</span> <span class="token keyword">COLUMN</span> yunchou<span class="token punctuation">.</span>marked_ship_kafka<span class="token punctuation">.</span>insert_time <span class="token operator">IS</span> <span class="token string">'入库时间'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">gpsscli submit --name marked_ship_kafka --gpss-port <span class="token number">50007</span> --gpss-host localhost ./marked_ship_kafka.yaml
gpsscli start marked_ship_kafka --gpss-port <span class="token number">50007</span> --gpss-host localhost
gpsscli list --all  --gpss-port <span class="token number">50007</span> --gpss-host localhost<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/pg/" rel="tag"># pg</a>
              <a href="/tags/kafka/" rel="tag"># kafka</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/08/12/shell/su/" rel="prev" title="su">
                  <i class="fa fa-chevron-left"></i> su
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/08/18/shell/tcp%E5%B9%B6%E5%8F%91%E6%95%B0%E6%94%BB%E5%87%BB%E9%98%B2%E5%BE%A1shell%E8%84%9A%E6%9C%AC/" rel="next" title="tcp并发数攻击防御shell脚本">
                  tcp并发数攻击防御shell脚本 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">豫ICP备17029463号-1 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
