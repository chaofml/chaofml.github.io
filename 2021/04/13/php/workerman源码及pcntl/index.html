<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="pcntl中有关进程相关的知识。1、进程复制。2、进程运行的用户组、用户。3、设置进程运行时的用户组、用户。4、等待进程结束pcntl_wait。5、信号注册与触发。6、信号处理pcntl_signal_dispatch。7、设置session id。使进程脱离终端。posix_setsid。8、守护进程，复制一次、设置会话组长、再复制一次。9、信号可以用，但是想做及时性的东西，好像信号，又做不到">
<meta property="og:type" content="article">
<meta property="og:title" content="pcntl">
<meta property="og:url" content="https://blog.chaofml.cn/2021/04/13/php/workerman%E6%BA%90%E7%A0%81%E5%8F%8Apcntl/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="pcntl中有关进程相关的知识。1、进程复制。2、进程运行的用户组、用户。3、设置进程运行时的用户组、用户。4、等待进程结束pcntl_wait。5、信号注册与触发。6、信号处理pcntl_signal_dispatch。7、设置session id。使进程脱离终端。posix_setsid。8、守护进程，复制一次、设置会话组长、再复制一次。9、信号可以用，但是想做及时性的东西，好像信号，又做不到">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-13T17:10:54.000Z">
<meta property="article:modified_time" content="2023-01-19T08:26:41.608Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="php">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.chaofml.cn/2021/04/13/php/workerman%E6%BA%90%E7%A0%81%E5%8F%8Apcntl/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>pcntl | 超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#demo1"><span class="nav-number">1.</span> <span class="nav-text">demo1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo2"><span class="nav-number">2.</span> <span class="nav-text">demo2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo3"><span class="nav-number">3.</span> <span class="nav-text">demo3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo4"><span class="nav-number">4.</span> <span class="nav-text">demo4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo5"><span class="nav-number">5.</span> <span class="nav-text">demo5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo6"><span class="nav-number">6.</span> <span class="nav-text">demo6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo7"><span class="nav-number">7.</span> <span class="nav-text">demo7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo8"><span class="nav-number">8.</span> <span class="nav-text">demo8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo%E6%80%BB%E7%BB%93"><span class="nav-number">9.</span> <span class="nav-text">demo总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number"></span> <span class="nav-text">应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="nav-number">1.</span> <span class="nav-text">获取进程状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#workerman"><span class="nav-number"></span> <span class="nav-text">workerman</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#workerman%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7"><span class="nav-number">1.</span> <span class="nav-text">workerman进程监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TcpConnection"><span class="nav-number">2.</span> <span class="nav-text">TcpConnection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-number">4.</span> <span class="nav-text">进程间通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7"><span class="nav-number">5.</span> <span class="nav-text">信号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pidMap%E4%B8%8EidMap"><span class="nav-number">6.</span> <span class="nav-text">pidMap与idMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pidsToRestart"><span class="nav-number">7.</span> <span class="nav-text">_pidsToRestart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#workerman%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">workerman总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#other"><span class="nav-number"></span> <span class="nav-text">other</span></a></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2021/04/13/php/workerman%E6%BA%90%E7%A0%81%E5%8F%8Apcntl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pcntl
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-13 17:10:54" itemprop="dateCreated datePublished" datetime="2021-04-13T17:10:54+00:00">2021-04-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 08:26:41" itemprop="dateModified" datetime="2023-01-19T08:26:41+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>pcntl中有关进程相关的知识。1、进程复制。2、进程运行的用户组、用户。3、设置进程运行时的用户组、用户。4、等待进程结束pcntl_wait。5、信号注册与触发。6、信号处理pcntl_signal_dispatch。7、设置session id。使进程脱离终端。posix_setsid。8、守护进程，复制一次、设置会话组长、再复制一次。9、信号可以用，但是想做及时性的东西，好像信号，又做不到。</p>
<p>上面所有的，基本上都在posix跟pcntl两个扩展中。另外，重点讲一些与wokerman有关的东西。workerman的主要的功能：1、转化为守护进程。2、主进程对子进程的监控以及对信号的监听。3、关闭STDOUT等，改为写文件。4、子进程使用Libevent等，实现对socket的读写监听。5、同时，子进程也会监听主进程发号施令，并退出进程或重启进程。6、除此之外，posix、pcntl中一些常用的函数使用，设置进程title、设置运行的group、userid等等。7、统计功能，stauts跟connections，（主进程发信号，子进程将收集的信息写文件，主进程汇报），这一部分功能也很复杂。8、命令解析功能，对旧进程的控制，提供start、reload等命令（如nginx命令）。</p>
<a id="more"></a>



<h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$id</span> = <span class="string">&#x27;null&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span>&lt;<span class="number">100</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$i</span>==<span class="number">10</span>)&#123;</span><br><span class="line">        <span class="variable">$id</span> = pcntl_fork();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$id</span>: <span class="subst">$i</span>\n&quot;</span>;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 当$i=10的时候，开始进程复制，然后，此时开始分叉。这个时候，会同时输出$i两次。id = 0 为子进程，id&gt;0，则为父进程。id=-1,则说明进程复制失败。我们可以简单理解，对于父进程，需要拿到子进程的id。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ids</span> = [];</span><br><span class="line"><span class="variable">$pid</span> =<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span>&lt;<span class="number">10</span>;<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$i</span>==<span class="number">5</span>)&#123;</span><br><span class="line">        <span class="variable">$pid</span> = pcntl_fork();</span><br><span class="line">        <span class="comment">//mt_srand();   复制后，防止产生一样的随机数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$ids</span>[] = mt_rand(<span class="number">1</span>,<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$pid</span>  :&quot;</span>.join(<span class="string">&quot;,&quot;</span>,<span class="variable">$ids</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进程复制后，发现产生的随机数，居然是一模一样的？惊不惊喜？意不意外？添加<code>mt_rand</code>后发现，两个进程产生的序列号终于不一样了。（难过在wokerman中，要执行<code>mt_rand</code>跟<code>rand</code>函数。）</p>
<p>上述例子说明两个问题：1、父子进程，在复制后，子进程的全局变量与父进程已经是分离的，相当于复制了一份。（引用资源的除外）2、进程复制后，最好要重新播种随机化种子，否则，会产生一样的随机数。</p>
<h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pcntl_signal_dispatch();</span><br><span class="line">pcntl_signal_dispatch();</span><br><span class="line">pcntl_signal_dispatch();</span><br></pre></td></tr></table></figure>

<p>单独执行，好像并没有什么效果。程序也不会卡在调用处，即不会阻塞。其效果是，如果此时有信号，则转向处理信号。</p>
<h3 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//declare(&#x27;ticks=1&#x27;);  也会让堆积的信号，执行。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sig_handler</span>(<span class="params"><span class="variable">$signo</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$signo</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGUSR1: <span class="keyword">echo</span> <span class="string">&quot;SIGUSR1\n&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SIGUSR2: <span class="keyword">echo</span> <span class="string">&quot;SIGUSR2\n&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:      <span class="keyword">echo</span> <span class="string">&quot;unknow&quot;</span>;    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//安装信号触发器器</span></span><br><span class="line">pcntl_signal(SIGUSR1, <span class="string">&quot;sig_handler&quot;</span>);</span><br><span class="line">pcntl_signal(SIGUSR2, <span class="string">&quot;sig_handler&quot;</span>);</span><br><span class="line"><span class="comment">//向当前进程发送SIGUSR1信号</span></span><br><span class="line">posix_kill(posix_getpid(), SIGUSR1);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;111\n&quot;</span>;</span><br><span class="line">posix_kill(posix_getpid(), SIGUSR2);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;222\n&quot;</span>;</span><br><span class="line">sleep(<span class="number">3</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;333\n&quot;</span>;</span><br><span class="line">pcntl_signal_dispatch();</span><br><span class="line">pcntl_signal_dispatch();</span><br><span class="line">pcntl_signal_dispatch();</span><br></pre></td></tr></table></figure>

<p>pcntl_signal用来注册信号处理的回调。</p>
<p>posix_kill是用来发送信号。暂时这样假设，该函数只是投递消息到队列中，但是并不会直接执行该消息。而是等到进程在pcntl_signal_dispatch处，进程则开始处理堆积的信号，如果有，则处理，如果没有，则不会阻塞，执行到后面。</p>
<p>所以，可以观测上面代码的输出顺序。上面如果不执行<code>pcntl_signal_dispatch();</code>，则堆积的信号，进程退出也不会处理。</p>
<p>另外，在低版本的&lt;php5.4中，在代码开头处，添加如下，堆积的信号也会执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(<span class="string">&#x27;ticks=1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="demo4"><a href="#demo4" class="headerlink" title="demo4"></a>demo4</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    sleep(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;OK\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Stop\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    usleep(<span class="number">100000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//信号处理代码</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sig</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    pcntl_alarm(<span class="number">2</span>); <span class="comment">//设定超时后触发的信号</span></span><br><span class="line">    pcntl_signal(SIGALRM, <span class="string">&quot;sig&quot;</span>);</span><br><span class="line">    pcntl_signal_dispatch();</span><br><span class="line">    a();</span><br><span class="line">    pcntl_alarm(<span class="number">0</span>);</span><br><span class="line">&#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;timeout\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">b();</span><br><span class="line">a(); <span class="comment">//等待十秒后完成</span></span><br><span class="line">b();</span><br></pre></td></tr></table></figure>

<p>实在不太懂上面的代码的意义。</p>
<h3 id="demo5"><a href="#demo5" class="headerlink" title="demo5"></a>demo5</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sig</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;sig \n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pcntl_alarm(<span class="number">2</span>);</span><br><span class="line">pcntl_signal(SIGALRM, <span class="string">&quot;sig&quot;</span>);</span><br><span class="line">sleep(<span class="number">100</span>);</span><br><span class="line">pcntl_signal_dispatch();</span><br></pre></td></tr></table></figure>

<p>sleep(100);上面的代码，被阻塞到sleep处，但是，当2秒后有pcntl_alarm信号，然后转向处理pcntl_signal_dispatch，整个代码实际上执行2秒左右，就退出了。</p>
<h3 id="demo6"><a href="#demo6" class="headerlink" title="demo6"></a>demo6</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sig</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;sig \n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">pcntl_alarm(<span class="number">2</span>);</span><br><span class="line">pcntl_signal(SIGALRM, <span class="string">&quot;sig&quot;</span>);</span><br><span class="line">sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;wo shi da ying xiong &quot;</span>;   <span class="comment">//注意，后面的能输出。</span></span><br></pre></td></tr></table></figure>

<p>作为对比，我们这次没有写<code>pcntl_signal_dispatch</code>，发现2秒种退出后，什么也不执行。即，有信号时，则直接打断了sleep代码。</p>
<p>但是最后一句echo 能正常输出。</p>
<h3 id="demo7"><a href="#demo7" class="headerlink" title="demo7"></a>demo7</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">pcntl_alarm(<span class="number">2</span>);</span><br><span class="line">sleep(<span class="number">100</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;wo shi da ying xiong &quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这次，我们直接不注册任何信号处理，我们发现，2秒种后，程序直接退出了，后面的echo输出语句也没有输出。屏幕只输出<code>Alarm clock</code></p>
<p>对比发现，可能是因为，没有对信号进行处理，这是否就是类似于<code>ctrl+c</code>的退出信号一样？</p>
<h3 id="demo8"><a href="#demo8" class="headerlink" title="demo8"></a>demo8</h3><p>我们发现sleeph后，进程被阻塞在sleep语句，当收到信号后，手续的代码，都会陆续的执行并触发。另外，我们发现，及时删除<code>pcntl_signal_dispatch()</code>语句，没有啥区别，只是对信号少响应。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$i</span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$pid</span> = posix_getpid();</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$pid</span> .PHP_EOL;</span><br><span class="line"></span><br><span class="line">pcntl_signal(SIGUSR1, <span class="string">&quot;sig_handler&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sig_handler</span>(<span class="params"><span class="variable">$signo</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$signo</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGUSR1: <span class="keyword">echo</span> <span class="string">&quot;SIGUSR1\n&quot;</span>; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:      <span class="keyword">echo</span> <span class="string">&quot;unknow&quot;</span>;    <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">    sleep(<span class="number">3600</span>);</span><br><span class="line">    <span class="keyword">echo</span> ++<span class="variable">$i</span>.PHP_EOL;</span><br><span class="line">    pcntl_signal_dispatch();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;after signal dispatch&#x27;</span>.PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>脚本2</p>
<blockquote>
<p>php 脚本2.php  pid    ,其中pid是脚本1的pid。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">foreach</span>(range(<span class="number">1</span>,<span class="number">1000</span>) <span class="keyword">as</span> <span class="variable">$v</span>)&#123;</span><br><span class="line">    posix_kill(<span class="variable">$argv</span>[<span class="number">1</span>],SIGUSR1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现，如果频繁的发送信号（未加sleep)，脚本2，瞬间执行完成，而脚本1，可能只触发了一两次。也就是说没，并不是100%，都会执行的，可能多的信号，直接忽略了。</p>
<p>另外，如果脚本2发送<code>SIGUSR2</code>信号，由于未注册该信号，脚本1收到后，直接会退出进程。</p>
<h3 id="demo总结"><a href="#demo总结" class="headerlink" title="demo总结"></a>demo总结</h3><p>通过前面的demo例子，我们可以得到以下结论：进程可以注册要处理的信号，并选择在合适的时候，来处理堆积的信号，也可以选择不处理。收到未注册处理的信号，很可能会退出进程。收到信号，会打断阻塞的地方，执行后续的代码，如打断sleep、pcntl_wait($status, \WUNTRACED)等，使进程恢复执行。</p>
<p>但是，不能用信号来处理高频的事件，如1秒发送1000此信号，而进程可能就收到1、2次而已。</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="获取进程状态"><a href="#获取进程状态" class="headerlink" title="获取进程状态"></a>获取进程状态</h3><p>下面的方式，注册一个信号，并将程序的状态写到文件中。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// echo &#x27;\SIGINT&#x27;.SIGINT .PHP_EOL;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( PHP_OS===<span class="string">&#x27;Linux&#x27;</span>)&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">signal_status_data</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        file_put_contents(<span class="string">&#x27;tmp.txt&#x27;</span>,<span class="string">&#x27;signal_status_data&#x27;</span>,\FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">signal_exit</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">exit</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 停止</span></span><br><span class="line">    \pcntl_signal(\SIGINT, <span class="string">&#x27;signal_exit&#x27;</span>, <span class="literal">false</span>);  <span class="comment">//2</span></span><br><span class="line">    \pcntl_signal(\SIGTERM, <span class="string">&#x27;signal_exit&#x27;</span>, <span class="literal">false</span>);  <span class="comment">//15</span></span><br><span class="line">    <span class="comment">// 获取状态数据</span></span><br><span class="line">    \pcntl_signal(\SIGUSR1, <span class="string">&#x27;signal_status_data&#x27;</span>, <span class="literal">false</span>); <span class="comment">//10  </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    pcntl_signal_dispatch();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="workerman"><a href="#workerman" class="headerlink" title="workerman"></a>workerman</h2><p>为了简单起见，后面所有的分析都是基与Linux环境的，暂不考虑window系统。基于VERSION = ‘3.5.23’;。研究源码的顺序：</p>
<p>第1遍：先挑捡自己感兴趣的过程函数，重点分析。围绕特定的过程，比如：1、主进程是如何做进程监控的。2、信号问题。主、子进程如何安装信号。以及主进程是如何给子进程发信号。各自对信号的响应。3、全局状态维护，status是如何转变的。4、查找某个变量、函数的调用了。5、static变量、函数代表的是全局部分，属于框架部分，而非static修饰的属性、方法，则属于对象本身的，对象的任务，跟框架的任务显然不一样。</p>
<p>第2遍：按代码顺序，从上往下开始读。对于调用其他函数的代码，如果被调用的代码比较短或者调用几层，容易读，则全部读下去。看完后，接着从该位置，顺序往下读。</p>
<p>第3遍：运行代码，一边改，一边读？？？</p>
<p>第3遍：自己动手写，然后再回头看代码。</p>
<h3 id="workerman进程监控"><a href="#workerman进程监控" class="headerlink" title="workerman进程监控"></a>workerman进程监控</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">monitorWorkersForLinux</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$_status</span> = <span class="built_in">static</span>::STATUS_RUNNING;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// Calls signal handlers for pending signals.</span></span><br><span class="line">        \pcntl_signal_dispatch();</span><br><span class="line">        <span class="comment">// Suspends execution of the current process until a child has exited, or until a signal is delivered</span></span><br><span class="line">        <span class="variable">$status</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$pid</span>    = \pcntl_wait(<span class="variable">$status</span>, \WUNTRACED);</span><br><span class="line">        <span class="comment">// Calls signal handlers for pending signals again.</span></span><br><span class="line">        \pcntl_signal_dispatch();</span><br><span class="line">        <span class="comment">// If a child has already exited.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$pid</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Find out witch worker process exited.</span></span><br><span class="line">            <span class="comment">// Is still running state then fork a new worker process.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If shutdown state and all child processes exited then master process exit.</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$_status</span> === <span class="built_in">static</span>::STATUS_SHUTDOWN &amp;&amp; !<span class="built_in">static</span>::getAllWorkerPids()) &#123;</span><br><span class="line">            <span class="built_in">static</span>::exitAndClearAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是workerman中，进程监控的核心代码。master进程监控子进程的运行状态。进入无限循环，while(1)，利用<code>pcntl_wait</code>阻塞主进程，只没有子进程退出时，该函数会处于挂起状态，或者，当有新的信号来临，会打破挂起状态，转向执行<code>pcntl_signal_dispatch</code>信号处理。两者都会打破挂起的状态。</p>
<p>函数pcntl_wait的参数 <code>WUNTRACED</code>，会阻塞，<code>WNOHANG</code>不会阻塞，会立即结束。</p>
<p>上面，既然要接收的信号，看下注册的信号都是哪些？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 而installSignal只在runAll中调用，而且是在子进程复制之前，</span></span><br><span class="line"><span class="comment">// 也就是说，子进程复制之前，已经具备了响应下面的信号的基础。</span></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">installSignal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$_OS</span> !== \OS_TYPE_LINUX) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$signalHandler</span> = <span class="string">&#x27;\Workerman\Worker::signalHandler&#x27;</span>;</span><br><span class="line">        <span class="comment">// stop</span></span><br><span class="line">        \pcntl_signal(\SIGINT, <span class="variable">$signalHandler</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// graceful stop</span></span><br><span class="line">        \pcntl_signal(\SIGTERM, <span class="variable">$signalHandler</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// reload</span></span><br><span class="line">        \pcntl_signal(\SIGUSR1, <span class="variable">$signalHandler</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// graceful reload</span></span><br><span class="line">        \pcntl_signal(\SIGQUIT, <span class="variable">$signalHandler</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// status</span></span><br><span class="line">        \pcntl_signal(\SIGUSR2, <span class="variable">$signalHandler</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// connection status</span></span><br><span class="line">        \pcntl_signal(\SIGIO, <span class="variable">$signalHandler</span>, <span class="literal">false</span>);</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">        \pcntl_signal(\SIGPIPE, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>很显然，上面是注册了一些，命令行可用的参数。然后，观察<code>posix_kill</code>的调用情况。</p>
<p>我们发现：1、在<code>parseCommand</code>函数中，都是向master进程发信号。这也很容易理解，进程运行过程中，只有解析用户命令阶段，才会发送信号，给已经存在的老的master进程。</p>
<p>2、对于子进程发信号，主要在这两个函数中：<code>reload</code>，对每个子进程发送的是<code>SIGQUIT</code>、<code>SIGUSR1</code>信号，即重启信号；<code>stopAll</code>，对每个子进程发送的是<code>SIGTERM</code>、<code>SIGINT</code>信号，即停止信号。</p>
<p>当然，子进程注册响应信号的动作跟父进程不一样，<code>reinstallSignal</code>实际上，是为子进程设置信号的。而该函数是在run中调用，而run在<code>forkWorkersForWindows</code>、<code>forkOneWorkerForLinux</code>中调用。意图很明显，当复制一个子进程处理时，应该重新安装子进程的信号。</p>
<p>重点看子进程的任务：run</p>
<p>重新注册信号、添加onMessage、onWokerStart的处理。然后进入事件循环<code>loop</code>，这个会让所有的子进程卡到这一步，不会再往下执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略一些其他的。。。。</span></span><br><span class="line">    <span class="comment">// Reinstall signal.</span></span><br><span class="line">    <span class="built_in">static</span>::reinstallSignal();</span><br><span class="line">    <span class="comment">// Init Timer.</span></span><br><span class="line">    Timer::init(<span class="built_in">static</span>::<span class="variable">$globalEvent</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set an empty onMessage callback.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;onMessage)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;onMessage = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    \restore_error_handler();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Try to emit onWorkerStart callback.</span></span><br><span class="line">    <span class="comment">// Main loop.</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，看一下调用处<code>forkOneWorkerForLinux</code>，也正好说明，子进程会一直处于run阶段，如果真的结束了，那么也会直接抛出异常并exit。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$worker</span>-&gt;run();</span><br><span class="line"><span class="variable">$err</span> = <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;event-loop exited&#x27;</span>);</span><br><span class="line"><span class="built_in">static</span>::log(<span class="variable">$err</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">250</span>);</span><br></pre></td></tr></table></figure>

<p>那么，<code>installSignal</code>跟<code>reinstallSignal</code>的顺序，有没有什么讲究呢？按道理讲，在复制子进程后，主进程再安装主进程的信号，而子进程安装子进程的信号，不是更好吗？这样，就不用再取消安装信号这个过程。但是，我们知道，随着程序运行过程，子进程的数量可能随时不足，需要主进程复制一个出来，那么，此时还是要取消安装主进程的信号，安装子进程的信号，所以，为了消除不一致的处理，等待主进程稳定后，再复制，这样保证，复制出来的子进程的一致处理。</p>
<p>可是，我们看到<code>runAll</code>中，还有resetStd，按刚刚的理论，为啥不等resetStd之后再forkWorkers，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span>::forkWorkers();</span><br><span class="line"><span class="built_in">static</span>::resetStd();</span><br><span class="line"><span class="built_in">static</span>::monitorWorkers();</span><br></pre></td></tr></table></figure>

<p>何况<code>forkOneWorkerForLinux</code>中，也确实需要resetStd。（如果挪了位置，那么连判断也不需要了，转换为一致处理了？？？我怎么感觉都是我想的是对的？）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elseif</span> (<span class="number">0</span> === <span class="variable">$pid</span>) &#123;</span><br><span class="line">    \srand();</span><br><span class="line">    \mt_srand();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$worker</span>-&gt;reusePort) &#123;</span><br><span class="line">        <span class="variable">$worker</span>-&gt;listen();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$_status</span> === <span class="built_in">static</span>::STATUS_STARTING) &#123;</span><br><span class="line">        <span class="built_in">static</span>::resetStd();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//.......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>状态流转：</p>
<p>程序一直处于<code>STATUS_STARTING</code>状态，只有在<code>monitorWorkersForLinux</code>函数中，再转换为<code>STATUS_RUNNING</code>状态。</p>
<p>那么回顾一下，<code>reinstallSignal</code>是如何定义的？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">reinstallSignal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$_OS</span> !== \OS_TYPE_LINUX) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$signalHandler</span> = <span class="string">&#x27;\Workerman\Worker::signalHandler&#x27;</span>;</span><br><span class="line">    <span class="comment">// uninstall stop signal handler</span></span><br><span class="line">    \pcntl_signal(\SIGINT, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// uninstall graceful stop signal handler</span></span><br><span class="line">    \pcntl_signal(\SIGTERM, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// uninstall reload signal handler</span></span><br><span class="line">    \pcntl_signal(\SIGUSR1, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// uninstall graceful reload signal handler</span></span><br><span class="line">    \pcntl_signal(\SIGQUIT, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// uninstall status signal handler</span></span><br><span class="line">    \pcntl_signal(\SIGUSR2, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// uninstall connections status signal handler</span></span><br><span class="line">    \pcntl_signal(\SIGIO, \SIG_IGN, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// reinstall stop signal handler</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGINT, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br><span class="line">    <span class="comment">// reinstall graceful stop signal handler</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGTERM, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br><span class="line">    <span class="comment">// reinstall reload signal handler</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGUSR1, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br><span class="line">    <span class="comment">// reinstall graceful reload signal handler</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGQUIT, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br><span class="line">    <span class="comment">// reinstall status signal handler</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGUSR2, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br><span class="line">    <span class="comment">// reinstall connection status signal handler</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGIO, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>取消父进程定义的信号，然后使用<code>$globalEvent</code>来处理信号，而该变量是在run中定义的，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a global event loop.</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">static</span>::<span class="variable">$globalEvent</span>) &#123;</span><br><span class="line">    <span class="variable">$event_loop_class</span> = <span class="built_in">static</span>::getEventLoopName();</span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$globalEvent</span> = <span class="keyword">new</span> <span class="variable">$event_loop_class</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;resumeAccept();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>getEventLoopName</code>，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getEventLoopName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$eventLoopClass</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!\class_exists(<span class="string">&#x27;\Swoole\Event&#x27;</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="built_in">static</span>::<span class="variable">$_availableEventLoops</span>[<span class="string">&#x27;swoole&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$loop_name</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">static</span>::<span class="variable">$_availableEventLoops</span> <span class="keyword">as</span> <span class="variable">$name</span>=&gt;<span class="variable">$class</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (\extension_loaded(<span class="variable">$name</span>)) &#123;</span><br><span class="line">            <span class="variable">$loop_name</span> = <span class="variable">$name</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$loop_name</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (\interface_exists(<span class="string">&#x27;\React\EventLoop\LoopInterface&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="variable">$loop_name</span>) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;libevent&#x27;</span>:</span><br><span class="line">                    <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span> = <span class="string">&#x27;\Workerman\Events\React\ExtLibEventLoop&#x27;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;event&#x27;</span>:</span><br><span class="line">                    <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span> = <span class="string">&#x27;\Workerman\Events\React\ExtEventLoop&#x27;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span> :</span><br><span class="line">                    <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span> = <span class="string">&#x27;\Workerman\Events\React\StreamSelectLoop&#x27;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span> = <span class="built_in">static</span>::<span class="variable">$_availableEventLoops</span>[<span class="variable">$loop_name</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span> = \interface_exists(<span class="string">&#x27;\React\EventLoop\LoopInterface&#x27;</span>) ? <span class="string">&#x27;\Workerman\Events\React\StreamSelectLoop&#x27;</span> : <span class="string">&#x27;\Workerman\Events\Select&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static</span>::<span class="variable">$eventLoopClass</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而事件循环：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_availableEventLoops</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;libevent&#x27;</span> =&gt; <span class="string">&#x27;\Workerman\Events\Libevent&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;event&#x27;</span>    =&gt; <span class="string">&#x27;\Workerman\Events\Event&#x27;</span></span><br><span class="line">    <span class="comment">// Temporarily removed swoole because it is not stable enough  </span></span><br><span class="line">    <span class="comment">//&#x27;swoole&#x27;   =&gt; &#x27;\Workerman\Events\Swoole&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>大概就，上面两、三种。getEventLoopName会首先拦截，如果已经计算出来过<code>$eventLoopClass</code>值后，后续直接就返回了。<code>$globalEvent</code>大概是<code>\Workerman\Events\Libevent</code>、<code>\Workerman\Events\Event</code>等种的一个对象吧。</p>
<p>但看，注册信号：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGINT, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br></pre></td></tr></table></figure>

<p>第1个参数，不是fd吗？<code>SIGINT</code>如何能作为fd来使用呢？另外，</p>
<p>除了响应系统的信号，那么socket也是<code>$globalEvent</code>的主要任务。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pauseAccept</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$globalEvent</span> &amp;&amp; <span class="literal">false</span> === <span class="keyword">$this</span>-&gt;_pauseAccept &amp;&amp; <span class="keyword">$this</span>-&gt;_mainSocket) &#123;</span><br><span class="line">        <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;del(<span class="keyword">$this</span>-&gt;_mainSocket, EventInterface::EV_READ);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_pauseAccept = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resumeAccept</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// Register a listener to be notified when server socket is ready to read.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">static</span>::<span class="variable">$globalEvent</span> &amp;&amp; <span class="literal">true</span> === <span class="keyword">$this</span>-&gt;_pauseAccept &amp;&amp; <span class="keyword">$this</span>-&gt;_mainSocket) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;transport !== <span class="string">&#x27;udp&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_mainSocket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;acceptConnection&#x27;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_mainSocket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;acceptUdpConnection&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_pauseAccept = <span class="literal">false</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>$this-&gt;_pauseAccept</code>简单理解是，防重入的锁。</p>
<p>那么，后面可能就需要对Libevent这个库有些了解了。resumeAccept中，调用add方法，我们简单的理解，添加对socket但监控。如果<code>_mainSocket</code>有连接进入，则会触发读。</p>
<p>_mainSocket（有3处赋值）定义、赋值如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="variable">$_mainSocket</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// listen 方法中赋值</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;_mainSocket = \stream_socket_server(<span class="variable">$local_socket</span>, <span class="variable">$errno</span>, <span class="variable">$errmsg</span>, <span class="variable">$flags</span>, <span class="keyword">$this</span>-&gt;_context);</span><br></pre></td></tr></table></figure>

<p>从定义上看，<code>$_mainSocket</code>应该是属于woker对象的属性，而不是static全局共享的。该对象，是服务端的socket。</p>
<p>看Listen方法，核心就是创建<code>_mainSocket</code>，然后将<code>_mainSocket</code>设置成非阻塞模式，继而<code>resumeAccept</code>。单独挑出来这个过程，就容易理解了，非阻塞模式，利用<code>Libevent</code>来监视是否<code>_mainSocket</code>可读写。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">listen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_socketName) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Autoload.</span></span><br><span class="line">    Autoloader::setRootPath(<span class="keyword">$this</span>-&gt;_autoloadRootPath);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_mainSocket) &#123;</span><br><span class="line">        .......</span><br><span class="line">        <span class="comment">// Create an Internet or Unix domain server socket.</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;_mainSocket = \stream_socket_server(<span class="variable">$local_socket</span>, <span class="variable">$errno</span>, <span class="variable">$errmsg</span>, <span class="variable">$flags</span>, <span class="keyword">$this</span>-&gt;_context);</span><br><span class="line">        ......</span><br><span class="line">        <span class="comment">// Non blocking.</span></span><br><span class="line">        \stream_set_blocking(<span class="keyword">$this</span>-&gt;_mainSocket, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;resumeAccept();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么看下<code>listen</code>调用处（省略了其他语句）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWorkers</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$worker</span>-&gt;reusePort) &#123;</span><br><span class="line">        <span class="variable">$worker</span>-&gt;listen();  <span class="comment">//端口不能复用，则早早的调用listen</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">forkOneWorkerForLinux</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$worker</span>-&gt;reusePort) &#123;</span><br><span class="line">        <span class="variable">$worker</span>-&gt;listen(); <span class="comment">//端口能复用，则等到复制子进程的时候，开始。</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面过程，对于端口可复用，无碍乎，就是调用下面这句。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_mainSocket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;acceptConnection&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>上面是分析，反过来往上看，则是另外一种思路。</p>
<p>当有新的客户端连接时，则调用<code>acceptConnection</code>，多个进程可能同时收到该事间，所以有惊群效应。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">acceptConnection</span>(<span class="params"><span class="variable">$socket</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Accept a connection on server socket.</span></span><br><span class="line">    \set_error_handler(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;);</span><br><span class="line">    <span class="variable">$new_socket</span> = \stream_socket_accept(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="variable">$remote_address</span>);</span><br><span class="line">    \restore_error_handler();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Thundering herd.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$new_socket</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TcpConnection.</span></span><br><span class="line">    <span class="variable">$connection</span>                         = <span class="keyword">new</span> TcpConnection(<span class="variable">$new_socket</span>, <span class="variable">$remote_address</span>);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;connections[<span class="variable">$connection</span>-&gt;id] = <span class="variable">$connection</span>;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;worker                 = <span class="keyword">$this</span>;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;protocol               = <span class="keyword">$this</span>-&gt;protocol;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;transport              = <span class="keyword">$this</span>-&gt;transport;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;onMessage              = <span class="keyword">$this</span>-&gt;onMessage;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;onClose                = <span class="keyword">$this</span>-&gt;onClose;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;onError                = <span class="keyword">$this</span>-&gt;onError;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;onBufferDrain          = <span class="keyword">$this</span>-&gt;onBufferDrain;</span><br><span class="line">    <span class="variable">$connection</span>-&gt;onBufferFull           = <span class="keyword">$this</span>-&gt;onBufferFull;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to emit onConnect callback.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;onConnect) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            \call_user_func(<span class="keyword">$this</span>-&gt;onConnect, <span class="variable">$connection</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="built_in">static</span>::log(<span class="variable">$e</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Error</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">            <span class="built_in">static</span>::log(<span class="variable">$e</span>);</span><br><span class="line">            <span class="keyword">exit</span>(<span class="number">250</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有连接时，则为该连接创建一个TcpConnection，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$new_socket</span> = \stream_socket_accept(<span class="variable">$socket</span>, <span class="number">0</span>, <span class="variable">$remote_address</span>);</span><br><span class="line"><span class="variable">$connection</span> = <span class="keyword">new</span> TcpConnection(<span class="variable">$new_socket</span>,<span class="variable">$remote_address</span>);</span><br></pre></td></tr></table></figure>

<h3 id="TcpConnection"><a href="#TcpConnection" class="headerlink" title="TcpConnection"></a>TcpConnection</h3><p>我们细看一下<code>TcpConnection</code>，继承自<code>ConnectionInterface</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$socket</span>, <span class="variable">$remote_address</span> = <span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">    ++<span class="built_in">self</span>::<span class="variable">$statistics</span>[<span class="string">&#x27;connection_count&#x27;</span>];</span><br><span class="line">    <span class="keyword">$this</span>-&gt;id = <span class="keyword">$this</span>-&gt;_id = <span class="built_in">self</span>::<span class="variable">$_idRecorder</span>++;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">self</span>::<span class="variable">$_idRecorder</span> === \PHP_INT_MAX)&#123;</span><br><span class="line">        <span class="built_in">self</span>::<span class="variable">$_idRecorder</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_socket = <span class="variable">$socket</span>;</span><br><span class="line">    \stream_set_blocking(<span class="keyword">$this</span>-&gt;_socket, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// Compatible with hhvm</span></span><br><span class="line">    <span class="keyword">if</span> (\function_exists(<span class="string">&#x27;stream_set_read_buffer&#x27;</span>)) &#123;</span><br><span class="line">        \stream_set_read_buffer(<span class="keyword">$this</span>-&gt;_socket, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Worker::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;baseRead&#x27;</span>));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;maxSendBufferSize        = <span class="built_in">self</span>::<span class="variable">$defaultMaxSendBufferSize</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;maxPackageSize           = <span class="built_in">self</span>::<span class="variable">$defaultMaxPackageSize</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_remoteAddress           = <span class="variable">$remote_address</span>;</span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$connections</span>[<span class="keyword">$this</span>-&gt;id] = <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心依然：</p>
<blockquote>
<p>设置非阻塞，然后$globalEvent对象来负责当可读时，事件的通知。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\stream_set_blocking(<span class="keyword">$this</span>-&gt;_socket, <span class="number">0</span>);</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;baseRead&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>然后看该类，搜索<code>Worker::$globalEvent</code>大概有9处，而监听的消息是sockete的读写事件：<code>EventInterface::EV_READ</code>、<code>EventInterface::EV_WRITE</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__construct</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;baseRead&#x27;</span>));</span><br><span class="line"></span><br><span class="line">send</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_WRITE, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;baseWrite&#x27;</span>));  <span class="comment">//2处</span></span><br><span class="line"></span><br><span class="line">pauseRecv    <span class="comment">//当上传的时候，就暂停触发事间</span></span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;del(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_READ);</span><br><span class="line"></span><br><span class="line">resumeRecv</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;add(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_READ, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;baseRead&#x27;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">baseRead</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;add(<span class="variable">$socket</span>, EventInterface::EV_WRITE, <span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="string">&#x27;baseWrite&#x27;</span>));</span><br><span class="line"></span><br><span class="line">baseWrite</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;del(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_WRITE);</span><br><span class="line"></span><br><span class="line">destroy</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;del(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_READ);</span><br><span class="line">Worker::<span class="variable">$globalEvent</span>-&gt;del(<span class="keyword">$this</span>-&gt;_socket, EventInterface::EV_WRITE);</span><br></pre></td></tr></table></figure>

<p>其中，有两处调用pipe、close：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pipe</span>(<span class="params"><span class="built_in">self</span> <span class="variable">$dest</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$source</span>              = <span class="keyword">$this</span>;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;onMessage     = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$source</span>, <span class="variable">$data</span></span>) <span class="title">use</span> (<span class="params"><span class="variable">$dest</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$dest</span>-&gt;send(<span class="variable">$data</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;onClose       = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$source</span></span>) <span class="title">use</span> (<span class="params"><span class="variable">$dest</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$dest</span>-&gt;destroy();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable">$dest</span>-&gt;onBufferFull  = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$dest</span></span>) <span class="title">use</span> (<span class="params"><span class="variable">$source</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$source</span>-&gt;pauseRecv();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable">$dest</span>-&gt;onBufferDrain = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$dest</span></span>) <span class="title">use</span> (<span class="params"><span class="variable">$source</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$source</span>-&gt;resumeRecv();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>整个启动流程，实际上即<code>runAll</code>执行的流程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">runAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">static</span>::checkSapiEnv();</span><br><span class="line">    <span class="built_in">static</span>::init();</span><br><span class="line">    <span class="built_in">static</span>::lock();</span><br><span class="line">    <span class="built_in">static</span>::parseCommand();</span><br><span class="line">    <span class="built_in">static</span>::daemonize();</span><br><span class="line">    <span class="built_in">static</span>::initWorkers();</span><br><span class="line">    <span class="built_in">static</span>::installSignal();</span><br><span class="line">    <span class="built_in">static</span>::saveMasterPid();</span><br><span class="line">    <span class="built_in">static</span>::unlock();</span><br><span class="line">    <span class="built_in">static</span>::displayUI();</span><br><span class="line">    <span class="built_in">static</span>::forkWorkers();</span><br><span class="line">    <span class="built_in">static</span>::resetStd();</span><br><span class="line">    <span class="built_in">static</span>::monitorWorkers();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>workerman的代码有点难度，可能是因为woker中，即是一个对象，又是全局函数的容器，而且，还有命令行解析的代码。如果，将上述3者分开，获取代码可能更容易理解。</p>
<p>worker对象能干的事情况：</p>
<blockquote>
<p>sed -n “/ function /p” Worker.php  |grep -v “static”</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMainSocket</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setUserAndGroup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$socket_name</span> = <span class="string">&#x27;&#x27;</span>, <span class="keyword">array</span> <span class="variable">$context_option</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">listen</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">unlisten</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSocketAddress</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">pauseAccept</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">resumeAccept</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">getSocketName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">stop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">acceptConnection</span>(<span class="params"><span class="variable">$socket</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">function</span> <span class="title">acceptUdpConnection</span>(<span class="params"><span class="variable">$socket</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>worker本身作为容器，能干的事情：</p>
<blockquote>
<p>sed -n “/static function/p” Worker.php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">runAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">checkSapiEnv</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">init</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">lock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">unlock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">initWorkers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">reloadAllWorkers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getAllWorkers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getEventLoop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">initId</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getCurrentUser</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">displayUI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getUiColumns</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getSingleLineTotalLength</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">parseCommand</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">formatStatusData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">installSignal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">reinstallSignal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">signalHandler</span>(<span class="params"><span class="variable">$signal</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">daemonize</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">resetStd</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">saveMasterPid</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getEventLoopName</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getAllWorkerPids</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">forkWorkers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">forkWorkersForLinux</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">forkWorkersForWindows</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getStartFilesForWindows</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">forkOneWorkerForWindows</span>(<span class="params"><span class="variable">$start_file</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">checkWorkerStatusForWindows</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">forkOneWorkerForLinux</span>(<span class="params"><span class="built_in">self</span> <span class="variable">$worker</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getId</span>(<span class="params"><span class="variable">$worker_id</span>, <span class="variable">$pid</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">setProcessTitle</span>(<span class="params"><span class="variable">$title</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">monitorWorkers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">monitorWorkersForLinux</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">monitorWorkersForWindows</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">exitAndClearAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">reload</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">stopAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">checkIfChildRunning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getStatus</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getGracefulStop</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">writeStatisticsToStatusFile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">writeConnectionsStatisticsToStatusFile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">checkErrors</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="title">protected</span> <span class="title">static</span> <span class="title">function</span> <span class="title">getErrorType</span>(<span class="params"><span class="variable">$type</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">log</span>(<span class="params"><span class="variable">$msg</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">static</span> <span class="title">function</span> <span class="title">safeEcho</span>(<span class="params"><span class="variable">$msg</span>, <span class="variable">$decorated</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"><span class="title">private</span> <span class="title">static</span> <span class="title">function</span> <span class="title">outputStream</span>(<span class="params"><span class="variable">$stream</span> = <span class="literal">null</span></span>)</span></span><br></pre></td></tr></table></figure>

<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><p>作为一般的tcp的server，每个woker节点，并不太需要通信。而woker节点，主动跟master节点通信呢？汇包自身的状态呢？发现，它是用文件<code>_statisticsFile</code>来进行汇总各个节点的信息。信号+文件，汇报状态信息。</p>
<p>首先，查看<code>parseCommand</code>方法，当为<code>status</code>命令时，则执行：</p>
<blockquote>
<p>master进程</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span>::safeEcho(<span class="built_in">static</span>::formatStatusData());</span><br><span class="line">\posix_kill(<span class="variable">$master_pid</span>, SIGUSR2);</span><br><span class="line">\sleep(<span class="number">1</span>);</span><br><span class="line"><span class="built_in">static</span>::safeEcho(<span class="built_in">static</span>::formatStatusData());</span><br><span class="line"><span class="comment">//而formatStatusData 方法，就是格式化`_statisticsFile`中的内容并输出。</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>子进程</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">static</span>::<span class="variable">$globalEvent</span>-&gt;add(\SIGUSR2, EventInterface::EV_SIGNAL, <span class="variable">$signalHandler</span>);</span><br></pre></td></tr></table></figure>

<p>执行的动作：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> \SIGUSR2:</span><br><span class="line">    <span class="built_in">static</span>::writeStatisticsToStatusFile();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>而writeStatisticsToStatusFile，则执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\file_put_contents(<span class="built_in">static</span>::<span class="variable">$_statisticsFile</span>, <span class="variable">$worker_status_str</span>, \FILE_APPEND);</span><br></pre></td></tr></table></figure>

<p>写入到文件。所以，不用加锁了？</p>
<h3 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h3><p>对于进程，安装的信号有两种：主进程<code>installSignal</code>，子进程<code>reinstallSignal</code>（由于其是从主进程复制而来，所以需要先卸载主进程的消耗，然后再安装新的信号，只不过新的信号换成了$globalEvent，为何要用两种不同的方式，来接收信号呢？我猜测，子进程，主要用globalEvent-&gt;loop进行事件循环，<strong>如果不在loop中添加pcntl_signal_dispatch来处理，估计，信号得不到处理。</strong>）。</p>
<p>而对响应信号的处理函数，都统一由<code>$signalHandler = &#39;\Workerman\Worker::signalHandler&#39;;</code>来处理。所以，该函数内，需要区分，当前是何种进程。</p>
<p>具体的操作主要有以下四种，均要区分是主、子进程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stopAll</span><br><span class="line">reload</span><br><span class="line">writeStatisticsToStatusFile</span><br><span class="line">writeConnectionsStatisticsToStatusFile</span><br></pre></td></tr></table></figure>

<p>另外<code>_gracefulStop</code>类静态变量来区分，是否是优雅的停止或重启。那么，优雅的含义是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//reload函数中，如果_gracefulStop 为false，会额外执行下面一句</span></span><br><span class="line">Timer::add(<span class="built_in">static</span>::KILL_WORKER_TIMER_TIME, <span class="string">&#x27;\posix_kill&#x27;</span>, <span class="keyword">array</span>(<span class="variable">$one_worker_pid</span>, \SIGKILL), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//stopAll函数中，如果_gracefulStop 为false，会额外执行下面一句</span></span><br><span class="line">Timer::add(<span class="built_in">static</span>::KILL_WORKER_TIMER_TIME, <span class="string">&#x27;\posix_kill&#x27;</span>, <span class="keyword">array</span>(<span class="variable">$worker_pid</span>, \SIGKILL), <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//stop函数中强行断开连接</span></span><br><span class="line"><span class="comment">// Close all connections for the worker.</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">static</span>::<span class="variable">$_gracefulStop</span>) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;connections <span class="keyword">as</span> <span class="variable">$connection</span>) &#123;</span><br><span class="line">        <span class="variable">$connection</span>-&gt;close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="pidMap与idMap"><a href="#pidMap与idMap" class="headerlink" title="pidMap与idMap"></a>pidMap与idMap</h3><p>这两个概念，很容易混淆，而且数据结构也差不多，为啥要出现两个不同的id呢？<strong>记得以前一个大神说，少定义变量，多一个变量多增加一份新智负担。</strong></p>
<blockquote>
<p>这两个变量，都应该是在主进程中使用，而在子进程的复制的时候，提供给主进程，便于主进程来管理、调度，比如，woker是否缺了。而子进程应该不会用到这些变量。</p>
<p>但是，我在读源码过程中，通过追踪这些变量的调用、使用，发现，其实二者没有啥差别，比如：判断是否需要fork一个子进程，$_pidMap先用在forkWorkersForLinux方法中，利用isset是否定义，判断是否需要增加子进程。而 idMap 是pid为0，则应该新增进程，即数组中包含无效的pid。</p>
<p>所以，如果是我来优化，我肯定要删除idMap变量。原因：1、出现次数少，变量出现7次，出现在getId（被调用2次）、initId（被调用两次）等函数中。reload过程调用了initId？2、出现idMap的地方，基本上也出现了pid，而一些关键过程，还是利用pid。比如进程退出、等等。即关键的判断，还是用pidMap。</p>
<p>主进程中，保存子进程的信息，好像也不太多，比如进程的fork时间？？</p>
</blockquote>
<p>首先，先看定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * All worker processes pid.</span></span><br><span class="line"><span class="comment"> * The format is like this [worker_id=&gt;[pid=&gt;pid, pid=&gt;pid, ..], ..]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_pidMap</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mapping from PID to worker process ID.</span></span><br><span class="line"><span class="comment"> * The format is like this [worker_id=&gt;[0=&gt;$pid, 1=&gt;$pid, ..], ..].</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="variable">$_idMap</span> = <span class="keyword">array</span>();</span><br></pre></td></tr></table></figure>

<p>首先，从数据结构来看，而者差别并不是太大。区别在于 key，一个是进程id值，另外一个是进程id。</p>
<p>初始化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">initId</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">static</span>::<span class="variable">$_workers</span> <span class="keyword">as</span> <span class="variable">$worker_id</span> =&gt; <span class="variable">$worker</span>) &#123;</span><br><span class="line">        <span class="variable">$new_id_map</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$worker</span>-&gt;count = <span class="variable">$worker</span>-&gt;count &lt; <span class="number">1</span> ? <span class="number">1</span> : <span class="variable">$worker</span>-&gt;count;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$key</span> = <span class="number">0</span>; <span class="variable">$key</span> &lt; <span class="variable">$worker</span>-&gt;count; <span class="variable">$key</span>++) &#123;</span><br><span class="line">            <span class="variable">$new_id_map</span>[<span class="variable">$key</span>] = <span class="keyword">isset</span>(<span class="built_in">static</span>::<span class="variable">$_idMap</span>[<span class="variable">$worker_id</span>][<span class="variable">$key</span>]) ? <span class="built_in">static</span>::<span class="variable">$_idMap</span>[<span class="variable">$worker_id</span>][<span class="variable">$key</span>] : <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">static</span>::<span class="variable">$_idMap</span>[<span class="variable">$worker_id</span>] = <span class="variable">$new_id_map</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pid对象初始化的时候使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$socket_name</span> = <span class="string">&#x27;&#x27;</span>, <span class="keyword">array</span> <span class="variable">$context_option</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span>&#123;</span><br><span class="line"> 	<span class="built_in">static</span>::<span class="variable">$_pidMap</span>[<span class="keyword">$this</span>-&gt;workerId]  = <span class="keyword">array</span>();   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进程复制时，赋值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$pid</span> = \pcntl_fork();</span><br><span class="line"><span class="comment">// For master process.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$pid</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$_pidMap</span>[<span class="variable">$worker</span>-&gt;workerId][<span class="variable">$pid</span>] = <span class="variable">$pid</span>;</span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$_idMap</span>[<span class="variable">$worker</span>-&gt;workerId][<span class="variable">$id</span>]   = <span class="variable">$pid</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>标记进程可用，（销毁旧进程）：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clear process data.</span></span><br><span class="line"><span class="keyword">unset</span>(<span class="built_in">static</span>::<span class="variable">$_pidMap</span>[<span class="variable">$worker_id</span>][<span class="variable">$pid</span>]);</span><br><span class="line"><span class="comment">// Mark id is available.</span></span><br><span class="line"><span class="variable">$id</span>  = <span class="built_in">static</span>::getId(<span class="variable">$worker_id</span>, <span class="variable">$pid</span>);  </span><br><span class="line"><span class="built_in">static</span>::<span class="variable">$_idMap</span>[<span class="variable">$worker_id</span>][<span class="variable">$id</span>] = <span class="number">0</span>;   </span><br><span class="line"></span><br><span class="line"><span class="comment">//getId = \array_search($pid, static::$_idMap[$worker_id]);  </span></span><br></pre></td></tr></table></figure>

<p>利用该变量判断，是否要复制子进程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// forkOneWorkerForLinux</span></span><br><span class="line"><span class="comment">// Get available worker id.</span></span><br><span class="line"><span class="variable">$id</span> = <span class="built_in">static</span>::getId(<span class="variable">$worker</span>-&gt;workerId, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$id</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//forkWorkersForLinux</span></span><br><span class="line"><span class="keyword">while</span> (\count(<span class="built_in">static</span>::<span class="variable">$_pidMap</span>[<span class="variable">$worker</span>-&gt;workerId]) &lt; <span class="variable">$worker</span>-&gt;count) &#123;</span><br><span class="line">    <span class="built_in">static</span>::forkOneWorkerForLinux(<span class="variable">$worker</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检测子进程存活状态：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  flatten $_pidMap  拿到value值，相当于  array_walk...</span></span><br><span class="line"><span class="comment">//   有getAllWorkerPids，但又不用？？？</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkIfChildRunning</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">static</span>::<span class="variable">$_pidMap</span> <span class="keyword">as</span> <span class="variable">$worker_id</span> =&gt; <span class="variable">$worker_pid_array</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$worker_pid_array</span> <span class="keyword">as</span> <span class="variable">$pid</span> =&gt; <span class="variable">$worker_pid</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!\posix_kill(<span class="variable">$pid</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="built_in">static</span>::<span class="variable">$_pidMap</span>[<span class="variable">$worker_id</span>][<span class="variable">$pid</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，注意，子进程会清空<code>$_pidMap</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//forkOneWorkerForLinux</span></span><br><span class="line"><span class="keyword">elseif</span> (<span class="number">0</span> === <span class="variable">$pid</span>) &#123; <span class="comment">//子进程</span></span><br><span class="line">    <span class="built_in">static</span>::<span class="variable">$_pidMap</span>  = <span class="keyword">array</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="pidsToRestart"><a href="#pidsToRestart" class="headerlink" title="_pidsToRestart"></a>_pidsToRestart</h3><p>跟踪这个变量，大概发现，需要重启的时候，先一次将pids放到该变量中，并与reloadable进行求交集，然后，逐一重启该进程。</p>
<h3 id="workerman总结"><a href="#workerman总结" class="headerlink" title="workerman总结"></a>workerman总结</h3><p>感觉代码好像优雅，但是又感觉代码比较难度。见流程中的描述：workerman的代码有点难度…</p>
<p>pidMap跟idMap的共同使用，为啥要多一个变量？多一个变量，就增加一些心智负担……，除非他们有明显的不同作用，如果不是，那么为啥要用两个？</p>
<p>这些都是造成它看起来优雅，但是巨无霸，混合各种东西，难以理解？</p>
<p>反正，看完后的感觉，好像是懂了，但又好像没有懂？？？</p>
<h1 id="other"><a href="#other" class="headerlink" title="other"></a>other</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">感觉listen有点乱</span><br><span class="line">if ($worker-&gt;reusePort) &#123;</span><br><span class="line">    $worker-&gt;listen();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/php/" rel="tag"># php</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/04/09/js/webSql/" rel="prev" title="webSql">
                  <i class="fa fa-chevron-left"></i> webSql
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/04/23/shell/docker_shell/" rel="next" title="docker_shell">
                  docker_shell <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
