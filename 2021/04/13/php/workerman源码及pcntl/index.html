<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="pcntl中有关进程相关的知识。1、进程复制。2、进程运行的用户组、用户。3、设置进程运行时的用户组、用户。4、等待进程结束pcntl_wait。5、信号注册与触发。6、信号处理pcntl_signal_dispatch。7、设置session id。使进程脱离终端。posix_setsid。8、守护进程，复制一次、设置会话组长、再复制一次。9、信号可以用，但是想做及时性的东西，好像信号，又做不到">
<meta property="og:type" content="article">
<meta property="og:title" content="pcntl">
<meta property="og:url" content="https://blog.chaofml.cn/2021/04/13/php/workerman%E6%BA%90%E7%A0%81%E5%8F%8Apcntl/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="pcntl中有关进程相关的知识。1、进程复制。2、进程运行的用户组、用户。3、设置进程运行时的用户组、用户。4、等待进程结束pcntl_wait。5、信号注册与触发。6、信号处理pcntl_signal_dispatch。7、设置session id。使进程脱离终端。posix_setsid。8、守护进程，复制一次、设置会话组长、再复制一次。9、信号可以用，但是想做及时性的东西，好像信号，又做不到">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-13T17:10:54.000Z">
<meta property="article:modified_time" content="2023-01-20T05:51:58.015Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="php">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.chaofml.cn/2021/04/13/php/workerman%E6%BA%90%E7%A0%81%E5%8F%8Apcntl/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>pcntl | 超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#demo1"><span class="nav-number">1.</span> <span class="nav-text">demo1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo2"><span class="nav-number">2.</span> <span class="nav-text">demo2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo3"><span class="nav-number">3.</span> <span class="nav-text">demo3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo4"><span class="nav-number">4.</span> <span class="nav-text">demo4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo5"><span class="nav-number">5.</span> <span class="nav-text">demo5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo6"><span class="nav-number">6.</span> <span class="nav-text">demo6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo7"><span class="nav-number">7.</span> <span class="nav-text">demo7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo8"><span class="nav-number">8.</span> <span class="nav-text">demo8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#demo%E6%80%BB%E7%BB%93"><span class="nav-number">9.</span> <span class="nav-text">demo总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8"><span class="nav-number"></span> <span class="nav-text">应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81"><span class="nav-number">1.</span> <span class="nav-text">获取进程状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#workerman"><span class="nav-number"></span> <span class="nav-text">workerman</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#workerman%E8%BF%9B%E7%A8%8B%E7%9B%91%E6%8E%A7"><span class="nav-number">1.</span> <span class="nav-text">workerman进程监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TcpConnection"><span class="nav-number">2.</span> <span class="nav-text">TcpConnection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="nav-number">4.</span> <span class="nav-text">进程间通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E5%8F%B7"><span class="nav-number">5.</span> <span class="nav-text">信号</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pidMap%E4%B8%8EidMap"><span class="nav-number">6.</span> <span class="nav-text">pidMap与idMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pidsToRestart"><span class="nav-number">7.</span> <span class="nav-text">_pidsToRestart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#workerman%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">workerman总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#other"><span class="nav-number"></span> <span class="nav-text">other</span></a></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2021/04/13/php/workerman%E6%BA%90%E7%A0%81%E5%8F%8Apcntl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pcntl
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-13 17:10:54" itemprop="dateCreated datePublished" datetime="2021-04-13T17:10:54+00:00">2021-04-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-20 05:51:58" itemprop="dateModified" datetime="2023-01-20T05:51:58+00:00">2023-01-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>pcntl中有关进程相关的知识。1、进程复制。2、进程运行的用户组、用户。3、设置进程运行时的用户组、用户。4、等待进程结束pcntl_wait。5、信号注册与触发。6、信号处理pcntl_signal_dispatch。7、设置session id。使进程脱离终端。posix_setsid。8、守护进程，复制一次、设置会话组长、再复制一次。9、信号可以用，但是想做及时性的东西，好像信号，又做不到。</p>
<p>上面所有的，基本上都在posix跟pcntl两个扩展中。另外，重点讲一些与wokerman有关的东西。workerman的主要的功能：1、转化为守护进程。2、主进程对子进程的监控以及对信号的监听。3、关闭STDOUT等，改为写文件。4、子进程使用Libevent等，实现对socket的读写监听。5、同时，子进程也会监听主进程发号施令，并退出进程或重启进程。6、除此之外，posix、pcntl中一些常用的函数使用，设置进程title、设置运行的group、userid等等。7、统计功能，stauts跟connections，（主进程发信号，子进程将收集的信息写文件，主进程汇报），这一部分功能也很复杂。8、命令解析功能，对旧进程的控制，提供start、reload等命令（如nginx命令）。</p>
<a id="more"></a>



<h3 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'null'</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token variable">$id</span></span>: <span class="token interpolation"><span class="token variable">$i</span></span>\n"</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 当$i=10的时候，开始进程复制，然后，此时开始分叉。这个时候，会同时输出$i两次。id = 0 为子进程，id&gt;0，则为父进程。id=-1,则说明进程复制失败。我们可以简单理解，对于父进程，需要拿到子进程的id。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$ids</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$pid</span> <span class="token operator">=</span><span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">==</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//mt_srand();   复制后，防止产生一样的随机数</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$ids</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"<span class="token interpolation"><span class="token variable">$pid</span></span>  :"</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token double-quoted-string string">","</span><span class="token punctuation">,</span><span class="token variable">$ids</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">"\n"</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进程复制后，发现产生的随机数，居然是一模一样的？惊不惊喜？意不意外？添加<code>mt_rand</code>后发现，两个进程产生的序列号终于不一样了。（难过在wokerman中，要执行<code>mt_rand</code>跟<code>rand</code>函数。）</p>
<p>上述例子说明两个问题：1、父子进程，在复制后，子进程的全局变量与父进程已经是分离的，相当于复制了一份。（引用资源的除外）2、进程复制后，最好要重新播种随机化种子，否则，会产生一样的随机数。</p>
<h3 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>单独执行，好像并没有什么效果。程序也不会卡在调用处，即不会阻塞。其效果是，如果此时有信号，则转向处理信号。</p>
<h3 id="demo3"><a href="#demo3" class="headerlink" title="demo3"></a>demo3</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//declare('ticks=1');  也会让堆积的信号，执行。</span>
<span class="token keyword">function</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token constant">SIGUSR1</span><span class="token punctuation">:</span> <span class="token keyword">echo</span> <span class="token double-quoted-string string">"SIGUSR1\n"</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">SIGUSR2</span><span class="token punctuation">:</span> <span class="token keyword">echo</span> <span class="token double-quoted-string string">"SIGUSR2\n"</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>      <span class="token keyword">echo</span> <span class="token double-quoted-string string">"unknow"</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//安装信号触发器器</span>
<span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGUSR1</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"sig_handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGUSR2</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"sig_handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//向当前进程发送SIGUSR1信号</span>
<span class="token function">posix_kill</span><span class="token punctuation">(</span><span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SIGUSR1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">"111\n"</span><span class="token punctuation">;</span>
<span class="token function">posix_kill</span><span class="token punctuation">(</span><span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">SIGUSR2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">"222\n"</span><span class="token punctuation">;</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">"333\n"</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>pcntl_signal用来注册信号处理的回调。</p>
<p>posix_kill是用来发送信号。暂时这样假设，该函数只是投递消息到队列中，但是并不会直接执行该消息。而是等到进程在pcntl_signal_dispatch处，进程则开始处理堆积的信号，如果有，则处理，如果没有，则不会阻塞，执行到后面。</p>
<p>所以，可以观测上面代码的输出顺序。上面如果不执行<code>pcntl_signal_dispatch();</code>，则堆积的信号，进程退出也不会处理。</p>
<p>另外，在低版本的&lt;php5.4中，在代码开头处，添加如下，堆积的信号也会执行。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">declare</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ticks=1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="demo4"><a href="#demo4" class="headerlink" title="demo4"></a>demo4</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"OK\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"Stop\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//信号处理代码</span>
<span class="token keyword">function</span> <span class="token function">sig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">try</span><span class="token punctuation">&#123;</span>
    <span class="token function">pcntl_alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设定超时后触发的信号</span>
    <span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGALRM</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"sig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pcntl_alarm</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>Exception <span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"timeout\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待十秒后完成</span>
<span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实在不太懂上面的代码的意义。</p>
<h3 id="demo5"><a href="#demo5" class="headerlink" title="demo5"></a>demo5</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">sig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"sig \n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">pcntl_alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGALRM</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"sig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>sleep(100);上面的代码，被阻塞到sleep处，但是，当2秒后有pcntl_alarm信号，然后转向处理pcntl_signal_dispatch，整个代码实际上执行2秒左右，就退出了。</p>
<h3 id="demo6"><a href="#demo6" class="headerlink" title="demo6"></a>demo6</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function">sig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">echo</span> <span class="token double-quoted-string string">"sig \n"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">pcntl_alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGALRM</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"sig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">"wo shi da ying xiong "</span><span class="token punctuation">;</span>   <span class="token comment">//注意，后面的能输出。</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>作为对比，我们这次没有写<code>pcntl_signal_dispatch</code>，发现2秒种退出后，什么也不执行。即，有信号时，则直接打断了sleep代码。</p>
<p>但是最后一句echo 能正常输出。</p>
<h3 id="demo7"><a href="#demo7" class="headerlink" title="demo7"></a>demo7</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">pcntl_alarm</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token double-quoted-string string">"wo shi da ying xiong "</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这次，我们直接不注册任何信号处理，我们发现，2秒种后，程序直接退出了，后面的echo输出语句也没有输出。屏幕只输出<code>Alarm clock</code></p>
<p>对比发现，可能是因为，没有对信号进行处理，这是否就是类似于<code>ctrl+c</code>的退出信号一样？</p>
<h3 id="demo8"><a href="#demo8" class="headerlink" title="demo8"></a>demo8</h3><p>我们发现sleeph后，进程被阻塞在sleep语句，当收到信号后，手续的代码，都会陆续的执行并触发。另外，我们发现，及时删除<code>pcntl_signal_dispatch()</code>语句，没有啥区别，只是对信号少响应。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token variable">$pid</span> <span class="token operator">=</span> <span class="token function">posix_getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$pid</span> <span class="token punctuation">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>

<span class="token function">pcntl_signal</span><span class="token punctuation">(</span><span class="token constant">SIGUSR1</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">"sig_handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sig_handler</span><span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$signo</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token constant">SIGUSR1</span><span class="token punctuation">:</span> <span class="token keyword">echo</span> <span class="token double-quoted-string string">"SIGUSR1\n"</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>      <span class="token keyword">echo</span> <span class="token double-quoted-string string">"unknow"</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token operator">++</span><span class="token variable">$i</span><span class="token punctuation">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
    <span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token single-quoted-string string">'after signal dispatch'</span><span class="token punctuation">.</span><span class="token constant">PHP_EOL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>脚本2</p>
<blockquote>
<p>php 脚本2.php  pid    ,其中pid是脚本1的pid。</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">posix_kill</span><span class="token punctuation">(</span><span class="token variable">$argv</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token constant">SIGUSR1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们发现，如果频繁的发送信号（未加sleep)，脚本2，瞬间执行完成，而脚本1，可能只触发了一两次。也就是说没，并不是100%，都会执行的，可能多的信号，直接忽略了。</p>
<p>另外，如果脚本2发送<code>SIGUSR2</code>信号，由于未注册该信号，脚本1收到后，直接会退出进程。</p>
<h3 id="demo总结"><a href="#demo总结" class="headerlink" title="demo总结"></a>demo总结</h3><p>通过前面的demo例子，我们可以得到以下结论：进程可以注册要处理的信号，并选择在合适的时候，来处理堆积的信号，也可以选择不处理。收到未注册处理的信号，很可能会退出进程。收到信号，会打断阻塞的地方，执行后续的代码，如打断sleep、pcntl_wait($status, \WUNTRACED)等，使进程恢复执行。</p>
<p>但是，不能用信号来处理高频的事件，如1秒发送1000此信号，而进程可能就收到1、2次而已。</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="获取进程状态"><a href="#获取进程状态" class="headerlink" title="获取进程状态"></a>获取进程状态</h3><p>下面的方式，注册一个信号，并将程序的状态写到文件中。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// echo '\SIGINT'.SIGINT .PHP_EOL;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">PHP_OS</span><span class="token operator">===</span><span class="token single-quoted-string string">'Linux'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">function</span> <span class="token function">signal_status_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'tmp.txt'</span><span class="token punctuation">,</span><span class="token single-quoted-string string">'signal_status_data'</span><span class="token punctuation">,</span>\<span class="token package">FILE_APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">function</span> <span class="token function">signal_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">exit</span> <span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 停止</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGINT</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'signal_exit'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//2</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGTERM</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'signal_exit'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//15</span>
    <span class="token comment">// 获取状态数据</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR1</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'signal_status_data'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10  </span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="workerman"><a href="#workerman" class="headerlink" title="workerman"></a>workerman</h2><p>为了简单起见，后面所有的分析都是基与Linux环境的，暂不考虑window系统。基于VERSION = ‘3.5.23’;。研究源码的顺序：</p>
<p>第1遍：先挑捡自己感兴趣的过程函数，重点分析。围绕特定的过程，比如：1、主进程是如何做进程监控的。2、信号问题。主、子进程如何安装信号。以及主进程是如何给子进程发信号。各自对信号的响应。3、全局状态维护，status是如何转变的。4、查找某个变量、函数的调用了。5、static变量、函数代表的是全局部分，属于框架部分，而非static修饰的属性、方法，则属于对象本身的，对象的任务，跟框架的任务显然不一样。</p>
<p>第2遍：按代码顺序，从上往下开始读。对于调用其他函数的代码，如果被调用的代码比较短或者调用几层，容易读，则全部读下去。看完后，接着从该位置，顺序往下读。</p>
<p>第3遍：运行代码，一边改，一边读？？？</p>
<p>第3遍：自己动手写，然后再回头看代码。</p>
<h3 id="workerman进程监控"><a href="#workerman进程监控" class="headerlink" title="workerman进程监控"></a>workerman进程监控</h3><pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">monitorWorkersForLinux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_status</span> <span class="token operator">=</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">STATUS_RUNNING</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Calls signal handlers for pending signals.</span>
        \<span class="token package">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Suspends execution of the current process until a child has exited, or until a signal is delivered</span>
        <span class="token variable">$status</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token variable">$pid</span>    <span class="token operator">=</span> \<span class="token package">pcntl_wait</span><span class="token punctuation">(</span><span class="token variable">$status</span><span class="token punctuation">,</span> \<span class="token package">WUNTRACED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Calls signal handlers for pending signals again.</span>
        \<span class="token package">pcntl_signal_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// If a child has already exited.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// Find out witch worker process exited.</span>
            <span class="token comment">// Is still running state then fork a new worker process.</span>
        <span class="token punctuation">&#125;</span>
        <span class="token comment">// If shutdown state and all child processes exited then master process exit.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_status</span> <span class="token operator">===</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">STATUS_SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getAllWorkerPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">exitAndClearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面是workerman中，进程监控的核心代码。master进程监控子进程的运行状态。进入无限循环，while(1)，利用<code>pcntl_wait</code>阻塞主进程，只没有子进程退出时，该函数会处于挂起状态，或者，当有新的信号来临，会打破挂起状态，转向执行<code>pcntl_signal_dispatch</code>信号处理。两者都会打破挂起的状态。</p>
<p>函数pcntl_wait的参数 <code>WUNTRACED</code>，会阻塞，<code>WNOHANG</code>不会阻塞，会立即结束。</p>
<p>上面，既然要接收的信号，看下注册的信号都是哪些？</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// 而installSignal只在runAll中调用，而且是在子进程复制之前，</span>
<span class="token comment">// 也就是说，子进程复制之前，已经具备了响应下面的信号的基础。</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">installSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_OS</span> <span class="token operator">!==</span> \<span class="token package">OS_TYPE_LINUX</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$signalHandler</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'\Workerman\Worker::signalHandler'</span><span class="token punctuation">;</span>
        <span class="token comment">// stop</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGINT</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// graceful stop</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGTERM</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// reload</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR1</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// graceful reload</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGQUIT</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// status</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR2</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// connection status</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGIO</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ignore</span>
        \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGPIPE</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>很显然，上面是注册了一些，命令行可用的参数。然后，观察<code>posix_kill</code>的调用情况。</p>
<p>我们发现：1、在<code>parseCommand</code>函数中，都是向master进程发信号。这也很容易理解，进程运行过程中，只有解析用户命令阶段，才会发送信号，给已经存在的老的master进程。</p>
<p>2、对于子进程发信号，主要在这两个函数中：<code>reload</code>，对每个子进程发送的是<code>SIGQUIT</code>、<code>SIGUSR1</code>信号，即重启信号；<code>stopAll</code>，对每个子进程发送的是<code>SIGTERM</code>、<code>SIGINT</code>信号，即停止信号。</p>
<p>当然，子进程注册响应信号的动作跟父进程不一样，<code>reinstallSignal</code>实际上，是为子进程设置信号的。而该函数是在run中调用，而run在<code>forkWorkersForWindows</code>、<code>forkOneWorkerForLinux</code>中调用。意图很明显，当复制一个子进程处理时，应该重新安装子进程的信号。</p>
<p>重点看子进程的任务：run</p>
<p>重新注册信号、添加onMessage、onWokerStart的处理。然后进入事件循环<code>loop</code>，这个会让所有的子进程卡到这一步，不会再往下执行。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

    <span class="token comment">//省略一些其他的。。。。</span>
    <span class="token comment">// Reinstall signal.</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">reinstallSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Init Timer.</span>
    Timer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set an empty onMessage callback.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onMessage</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onMessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    \<span class="token package">restore_error_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Try to emit onWorkerStart callback.</span>
    <span class="token comment">// Main loop.</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么，看一下调用处<code>forkOneWorkerForLinux</code>，也正好说明，子进程会一直处于run阶段，如果真的结束了，那么也会直接抛出异常并exit。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$err</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'event-loop exited'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token variable">$err</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么，<code>installSignal</code>跟<code>reinstallSignal</code>的顺序，有没有什么讲究呢？按道理讲，在复制子进程后，主进程再安装主进程的信号，而子进程安装子进程的信号，不是更好吗？这样，就不用再取消安装信号这个过程。但是，我们知道，随着程序运行过程，子进程的数量可能随时不足，需要主进程复制一个出来，那么，此时还是要取消安装主进程的信号，安装子进程的信号，所以，为了消除不一致的处理，等待主进程稳定后，再复制，这样保证，复制出来的子进程的一致处理。</p>
<p>可是，我们看到<code>runAll</code>中，还有resetStd，按刚刚的理论，为啥不等resetStd之后再forkWorkers，</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forkWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">resetStd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">monitorWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>何况<code>forkOneWorkerForLinux</code>中，也确实需要resetStd。（如果挪了位置，那么连判断也不需要了，转换为一致处理了？？？我怎么感觉都是我想的是对的？）</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    \<span class="token package">srand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    \<span class="token package">mt_srand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">reusePort</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_status</span> <span class="token operator">===</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">STATUS_STARTING</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">resetStd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//.......</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>状态流转：</p>
<p>程序一直处于<code>STATUS_STARTING</code>状态，只有在<code>monitorWorkersForLinux</code>函数中，再转换为<code>STATUS_RUNNING</code>状态。</p>
<p>那么回顾一下，<code>reinstallSignal</code>是如何定义的？</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">reinstallSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_OS</span> <span class="token operator">!==</span> \<span class="token package">OS_TYPE_LINUX</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$signalHandler</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'\Workerman\Worker::signalHandler'</span><span class="token punctuation">;</span>
    <span class="token comment">// uninstall stop signal handler</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGINT</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// uninstall graceful stop signal handler</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGTERM</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// uninstall reload signal handler</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR1</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// uninstall graceful reload signal handler</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGQUIT</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// uninstall status signal handler</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR2</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// uninstall connections status signal handler</span>
    \<span class="token package">pcntl_signal</span><span class="token punctuation">(</span>\<span class="token package">SIGIO</span><span class="token punctuation">,</span> \<span class="token package">SIG_IGN</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// reinstall stop signal handler</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGINT</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// reinstall graceful stop signal handler</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGTERM</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// reinstall reload signal handler</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR1</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// reinstall graceful reload signal handler</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGQUIT</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// reinstall status signal handler</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR2</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// reinstall connection status signal handler</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGIO</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>取消父进程定义的信号，然后使用<code>$globalEvent</code>来处理信号，而该变量是在run中定义的，</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// Create a global event loop.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$event_loop_class</span> <span class="token operator">=</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getEventLoopName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token variable">$event_loop_class</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resumeAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而<code>getEventLoopName</code>，</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getEventLoopName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>\<span class="token package">class_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'\Swoole\Event'</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_availableEventLoops</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'swoole'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token variable">$loop_name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_availableEventLoops</span> <span class="token keyword">as</span> <span class="token variable">$name</span><span class="token operator">=</span><span class="token operator">></span><span class="token variable">$class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>\<span class="token package">extension_loaded</span><span class="token punctuation">(</span><span class="token variable">$name</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$loop_name</span> <span class="token operator">=</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$loop_name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>\<span class="token package">interface_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'\React\EventLoop\LoopInterface'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$loop_name</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">case</span> <span class="token single-quoted-string string">'libevent'</span><span class="token punctuation">:</span>
                    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'\Workerman\Events\React\ExtLibEventLoop'</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token single-quoted-string string">'event'</span><span class="token punctuation">:</span>
                    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'\Workerman\Events\React\ExtEventLoop'</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span> <span class="token punctuation">:</span>
                    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'\Workerman\Events\React\StreamSelectLoop'</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span> <span class="token operator">=</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_availableEventLoops</span><span class="token punctuation">[</span><span class="token variable">$loop_name</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span> <span class="token operator">=</span> \<span class="token package">interface_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'\React\EventLoop\LoopInterface'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token single-quoted-string string">'\Workerman\Events\React\StreamSelectLoop'</span> <span class="token punctuation">:</span> <span class="token single-quoted-string string">'\Workerman\Events\Select'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$eventLoopClass</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而事件循环：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token variable">$_availableEventLoops</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token single-quoted-string string">'libevent'</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'\Workerman\Events\Libevent'</span><span class="token punctuation">,</span>
    <span class="token single-quoted-string string">'event'</span>    <span class="token operator">=</span><span class="token operator">></span> <span class="token single-quoted-string string">'\Workerman\Events\Event'</span>
    <span class="token comment">// Temporarily removed swoole because it is not stable enough  </span>
    <span class="token comment">//'swoole'   => '\Workerman\Events\Swoole'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大概就，上面两、三种。getEventLoopName会首先拦截，如果已经计算出来过<code>$eventLoopClass</code>值后，后续直接就返回了。<code>$globalEvent</code>大概是<code>\Workerman\Events\Libevent</code>、<code>\Workerman\Events\Event</code>等种的一个对象吧。</p>
<p>但看，注册信号：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGINT</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>第1个参数，不是fd吗？<code>SIGINT</code>如何能作为fd来使用呢？另外，</p>
<p>除了响应系统的信号，那么socket也是<code>$globalEvent</code>的主要任务。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">pauseAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span> <span class="token operator">&amp;&amp;</span> <span class="token boolean constant">false</span> <span class="token operator">===</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_pauseAccept</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">del</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_pauseAccept</span> <span class="token operator">=</span> <span class="token boolean constant">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">resumeAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// Register a listener to be notified when server socket is ready to read.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span> <span class="token operator">&amp;&amp;</span> <span class="token boolean constant">true</span> <span class="token operator">===</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_pauseAccept</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">transport</span> <span class="token operator">!==</span> <span class="token single-quoted-string string">'udp'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'acceptConnection'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'acceptUdpConnection'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_pauseAccept</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>$this-&gt;_pauseAccept</code>简单理解是，防重入的锁。</p>
<p>那么，后面可能就需要对Libevent这个库有些了解了。resumeAccept中，调用add方法，我们简单的理解，添加对socket但监控。如果<code>_mainSocket</code>有连接进入，则会触发读。</p>
<p>_mainSocket（有3处赋值）定义、赋值如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token variable">$_mainSocket</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token comment">// listen 方法中赋值</span>
<span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span> <span class="token operator">=</span> \<span class="token package">stream_socket_server</span><span class="token punctuation">(</span><span class="token variable">$local_socket</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errmsg</span><span class="token punctuation">,</span> <span class="token variable">$flags</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_context</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>从定义上看，<code>$_mainSocket</code>应该是属于woker对象的属性，而不是static全局共享的。该对象，是服务端的socket。</p>
<p>看Listen方法，核心就是创建<code>_mainSocket</code>，然后将<code>_mainSocket</code>设置成非阻塞模式，继而<code>resumeAccept</code>。单独挑出来这个过程，就容易理解了，非阻塞模式，利用<code>Libevent</code>来监视是否<code>_mainSocket</code>可读写。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socketName</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Autoload.</span>
    Autoloader<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setRootPath</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_autoloadRootPath</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Create an Internet or Unix domain server socket.</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span> <span class="token operator">=</span> \<span class="token package">stream_socket_server</span><span class="token punctuation">(</span><span class="token variable">$local_socket</span><span class="token punctuation">,</span> <span class="token variable">$errno</span><span class="token punctuation">,</span> <span class="token variable">$errmsg</span><span class="token punctuation">,</span> <span class="token variable">$flags</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_context</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Non blocking.</span>
        \<span class="token package">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resumeAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么看下<code>listen</code>调用处（省略了其他语句）：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">initWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">reusePort</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//端口不能复用，则早早的调用listen</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">forkOneWorkerForLinux</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">reusePort</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//端口能复用，则等到复制子进程的时候，开始。</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面过程，对于端口可复用，无碍乎，就是调用下面这句。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_mainSocket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'acceptConnection'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上面是分析，反过来往上看，则是另外一种思路。</p>
<p>当有新的客户端连接时，则调用<code>acceptConnection</code>，多个进程可能同时收到该事间，所以有惊群效应。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">acceptConnection</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">// Accept a connection on server socket.</span>
    \<span class="token package">set_error_handler</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$new_socket</span> <span class="token operator">=</span> \<span class="token package">stream_socket_accept</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$remote_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    \<span class="token package">restore_error_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Thundering herd.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$new_socket</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// TcpConnection.</span>
    <span class="token variable">$connection</span>                         <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TcpConnection</span><span class="token punctuation">(</span><span class="token variable">$new_socket</span><span class="token punctuation">,</span> <span class="token variable">$remote_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">connections</span><span class="token punctuation">[</span><span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$connection</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">worker</span>                 <span class="token operator">=</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">protocol</span>               <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">protocol</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">transport</span>              <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">transport</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onMessage</span>              <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onMessage</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onClose</span>                <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onClose</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onError</span>                <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onError</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onBufferDrain</span>          <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onBufferDrain</span><span class="token punctuation">;</span>
    <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onBufferFull</span>           <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onBufferFull</span><span class="token punctuation">;</span>

    <span class="token comment">// Try to emit onConnect callback.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onConnect</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            \<span class="token package">call_user_func</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onConnect</span><span class="token punctuation">,</span> <span class="token variable">$connection</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>\<span class="token package">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>\<span class="token package">Error</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token variable">$e</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">exit</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当有连接时，则为该连接创建一个TcpConnection，</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$new_socket</span> <span class="token operator">=</span> \<span class="token package">stream_socket_accept</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">$remote_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$connection</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TcpConnection</span><span class="token punctuation">(</span><span class="token variable">$new_socket</span><span class="token punctuation">,</span><span class="token variable">$remote_address</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="TcpConnection"><a href="#TcpConnection" class="headerlink" title="TcpConnection"></a>TcpConnection</h3><p>我们细看一下<code>TcpConnection</code>，继承自<code>ConnectionInterface</code>。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">,</span> <span class="token variable">$remote_address</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token operator">++</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$statistics</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'connection_count'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_id</span> <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idRecorder</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idRecorder</span> <span class="token operator">===</span> \<span class="token package">PHP_INT_MAX</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idRecorder</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span> <span class="token operator">=</span> <span class="token variable">$socket</span><span class="token punctuation">;</span>
    \<span class="token package">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Compatible with hhvm</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>\<span class="token package">function_exists</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'stream_set_read_buffer'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        \<span class="token package">stream_set_read_buffer</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'baseRead'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">maxSendBufferSize</span>        <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$defaultMaxSendBufferSize</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">maxPackageSize</span>           <span class="token operator">=</span> self<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$defaultMaxPackageSize</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_remoteAddress</span>           <span class="token operator">=</span> <span class="token variable">$remote_address</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$connections</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>核心依然：</p>
<blockquote>
<p>设置非阻塞，然后$globalEvent对象来负责当可读时，事件的通知。</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">\<span class="token package">stream_set_blocking</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'baseRead'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后看该类，搜索<code>Worker::$globalEvent</code>大概有9处，而监听的消息是sockete的读写事件：<code>EventInterface::EV_READ</code>、<code>EventInterface::EV_WRITE</code>。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">__construct
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'baseRead'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

send
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_WRITE</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'baseWrite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//2处</span>

pauseRecv    <span class="token comment">//当上传的时候，就暂停触发事间</span>
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">del</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

resumeRecv
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'baseRead'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


baseRead
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_WRITE</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'baseWrite'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

baseWrite
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">del</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

destroy
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">del</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_READ</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Worker<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">del</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">_socket</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，有两处调用pipe、close：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">pipe</span><span class="token punctuation">(</span>self <span class="token variable">$dest</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token variable">$source</span>              <span class="token operator">=</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onMessage</span>     <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$source</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$dest</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$dest</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">send</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onClose</span>       <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$source</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$dest</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$dest</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token variable">$dest</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onBufferFull</span>  <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$dest</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$source</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">pauseRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token variable">$dest</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">onBufferDrain</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$dest</span><span class="token punctuation">)</span> <span class="token keyword">use</span> <span class="token punctuation">(</span><span class="token variable">$source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$source</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">resumeRecv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>整个启动流程，实际上即<code>runAll</code>执行的流程</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">runAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">checkSapiEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">parseCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">daemonize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">installSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">saveMasterPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">displayUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forkWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">resetStd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">monitorWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>workerman的代码有点难度，可能是因为woker中，即是一个对象，又是全局函数的容器，而且，还有命令行解析的代码。如果，将上述3者分开，获取代码可能更容易理解。</p>
<p>worker对象能干的事情况：</p>
<blockquote>
<p>sed -n “/ function /p” Worker.php  |grep -v “static”</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getMainSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">setUserAndGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$socket_name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$context_option</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">unlisten</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">parseSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">pauseAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">resumeAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getSocketName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">acceptConnection</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">acceptUdpConnection</span><span class="token punctuation">(</span><span class="token variable">$socket</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>worker本身作为容器，能干的事情：</p>
<blockquote>
<p>sed -n “/static function/p” Worker.php</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">runAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkSapiEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">initWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">reloadAllWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getAllWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">initId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">displayUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getUiColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getSingleLineTotalLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">parseCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">formatStatusData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">installSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">reinstallSignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">signalHandler</span><span class="token punctuation">(</span><span class="token variable">$signal</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">daemonize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">resetStd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">saveMasterPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getEventLoopName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getAllWorkerPids</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">forkWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">forkWorkersForLinux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">forkWorkersForWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getStartFilesForWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">forkOneWorkerForWindows</span><span class="token punctuation">(</span><span class="token variable">$start_file</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkWorkerStatusForWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">forkOneWorkerForLinux</span><span class="token punctuation">(</span>self <span class="token variable">$worker</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token variable">$worker_id</span><span class="token punctuation">,</span> <span class="token variable">$pid</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">setProcessTitle</span><span class="token punctuation">(</span><span class="token variable">$title</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">monitorWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">monitorWorkersForLinux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">monitorWorkersForWindows</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">exitAndClearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">stopAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkIfChildRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getGracefulStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">writeStatisticsToStatusFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">writeConnectionsStatisticsToStatusFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">getErrorType</span><span class="token punctuation">(</span><span class="token variable">$type</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">safeEcho</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">,</span> <span class="token variable">$decorated</span> <span class="token operator">=</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">outputStream</span><span class="token punctuation">(</span><span class="token variable">$stream</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><p>作为一般的tcp的server，每个woker节点，并不太需要通信。而woker节点，主动跟master节点通信呢？汇包自身的状态呢？发现，它是用文件<code>_statisticsFile</code>来进行汇总各个节点的信息。信号+文件，汇报状态信息。</p>
<p>首先，查看<code>parseCommand</code>方法，当为<code>status</code>命令时，则执行：</p>
<blockquote>
<p>master进程</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">safeEcho</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">formatStatusData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
\<span class="token package">posix_kill</span><span class="token punctuation">(</span><span class="token variable">$master_pid</span><span class="token punctuation">,</span> <span class="token constant">SIGUSR2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
\<span class="token package">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">safeEcho</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">formatStatusData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//而formatStatusData 方法，就是格式化`_statisticsFile`中的内容并输出。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>子进程</p>
</blockquote>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$globalEvent</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">add</span><span class="token punctuation">(</span>\<span class="token package">SIGUSR2</span><span class="token punctuation">,</span> EventInterface<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">EV_SIGNAL</span><span class="token punctuation">,</span> <span class="token variable">$signalHandler</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行的动作：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">case</span> \<span class="token package">SIGUSR2</span><span class="token punctuation">:</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">writeStatisticsToStatusFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>而writeStatisticsToStatusFile，则执行：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">\<span class="token package">file_put_contents</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_statisticsFile</span><span class="token punctuation">,</span> <span class="token variable">$worker_status_str</span><span class="token punctuation">,</span> \<span class="token package">FILE_APPEND</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>写入到文件。所以，不用加锁了？</p>
<h3 id="信号"><a href="#信号" class="headerlink" title="信号"></a>信号</h3><p>对于进程，安装的信号有两种：主进程<code>installSignal</code>，子进程<code>reinstallSignal</code>（由于其是从主进程复制而来，所以需要先卸载主进程的消耗，然后再安装新的信号，只不过新的信号换成了$globalEvent，为何要用两种不同的方式，来接收信号呢？我猜测，子进程，主要用globalEvent-&gt;loop进行事件循环，<strong>如果不在loop中添加pcntl_signal_dispatch来处理，估计，信号得不到处理。</strong>）。</p>
<p>而对响应信号的处理函数，都统一由<code>$signalHandler = &#39;\Workerman\Worker::signalHandler&#39;;</code>来处理。所以，该函数内，需要区分，当前是何种进程。</p>
<p>具体的操作主要有以下四种，均要区分是主、子进程。</p>
<pre class="line-numbers language-none"><code class="language-none">stopAll
reload
writeStatisticsToStatusFile
writeConnectionsStatisticsToStatusFile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外<code>_gracefulStop</code>类静态变量来区分，是否是优雅的停止或重启。那么，优雅的含义是：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">

<span class="token comment">//reload函数中，如果_gracefulStop 为false，会额外执行下面一句</span>
Timer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">KILL_WORKER_TIMER_TIME</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\posix_kill'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$one_worker_pid</span><span class="token punctuation">,</span> \<span class="token package">SIGKILL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//stopAll函数中，如果_gracefulStop 为false，会额外执行下面一句</span>
Timer<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token constant">KILL_WORKER_TIMER_TIME</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'\posix_kill'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$worker_pid</span><span class="token punctuation">,</span> \<span class="token package">SIGKILL</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//stop函数中强行断开连接</span>
<span class="token comment">// Close all connections for the worker.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_gracefulStop</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">connections</span> <span class="token keyword">as</span> <span class="token variable">$connection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$connection</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pidMap与idMap"><a href="#pidMap与idMap" class="headerlink" title="pidMap与idMap"></a>pidMap与idMap</h3><p>这两个概念，很容易混淆，而且数据结构也差不多，为啥要出现两个不同的id呢？<strong>记得以前一个大神说，少定义变量，多一个变量多增加一份新智负担。</strong></p>
<blockquote>
<p>这两个变量，都应该是在主进程中使用，而在子进程的复制的时候，提供给主进程，便于主进程来管理、调度，比如，woker是否缺了。而子进程应该不会用到这些变量。</p>
<p>但是，我在读源码过程中，通过追踪这些变量的调用、使用，发现，其实二者没有啥差别，比如：判断是否需要fork一个子进程，$_pidMap先用在forkWorkersForLinux方法中，利用isset是否定义，判断是否需要增加子进程。而 idMap 是pid为0，则应该新增进程，即数组中包含无效的pid。</p>
<p>所以，如果是我来优化，我肯定要删除idMap变量。原因：1、出现次数少，变量出现7次，出现在getId（被调用2次）、initId（被调用两次）等函数中。reload过程调用了initId？2、出现idMap的地方，基本上也出现了pid，而一些关键过程，还是利用pid。比如进程退出、等等。即关键的判断，还是用pidMap。</p>
<p>主进程中，保存子进程的信息，好像也不太多，比如进程的fork时间？？</p>
</blockquote>
<p>首先，先看定义：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * All worker processes pid.
 * The format is like this [worker_id=>[pid=>pid, pid=>pid, ..], ..]
 * @var array
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token variable">$_pidMap</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Mapping from PID to worker process ID.
 * The format is like this [worker_id=>[0=>$pid, 1=>$pid, ..], ..].
 * @var array
 */</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token variable">$_idMap</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先，从数据结构来看，而者差别并不是太大。区别在于 key，一个是进程id值，另外一个是进程id。</p>
<p>初始化：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">initId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_workers</span> <span class="token keyword">as</span> <span class="token variable">$worker_id</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$worker</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$new_id_map</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span> <span class="token operator">=</span> <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$key</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$key</span> <span class="token operator">&lt;</span> <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token punctuation">;</span> <span class="token variable">$key</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$new_id_map</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idMap</span><span class="token punctuation">[</span><span class="token variable">$worker_id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idMap</span><span class="token punctuation">[</span><span class="token variable">$worker_id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$key</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idMap</span><span class="token punctuation">[</span><span class="token variable">$worker_id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$new_id_map</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// pid对象初始化的时候使用</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$socket_name</span> <span class="token operator">=</span> <span class="token single-quoted-string string">''</span><span class="token punctuation">,</span> <span class="token keyword">array</span> <span class="token variable">$context_option</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 	<span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span><span class="token punctuation">[</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">workerId</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进程复制时，赋值</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token variable">$pid</span> <span class="token operator">=</span> \<span class="token package">pcntl_fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// For master process.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$pid</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span><span class="token punctuation">[</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">workerId</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$pid</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$pid</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idMap</span><span class="token punctuation">[</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">workerId</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$id</span><span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token variable">$pid</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>标记进程可用，（销毁旧进程）：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// Clear process data.</span>
<span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span><span class="token punctuation">[</span><span class="token variable">$worker_id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$pid</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Mark id is available.</span>
<span class="token variable">$id</span>  <span class="token operator">=</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token variable">$worker_id</span><span class="token punctuation">,</span> <span class="token variable">$pid</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_idMap</span><span class="token punctuation">[</span><span class="token variable">$worker_id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   

<span class="token comment">//getId = \array_search($pid, static::$_idMap[$worker_id]);  </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用该变量判断，是否要复制子进程：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">// forkOneWorkerForLinux</span>
<span class="token comment">// Get available worker id.</span>
<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">workerId</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$id</span> <span class="token operator">===</span> <span class="token boolean constant">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//forkWorkersForLinux</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>\<span class="token package">count</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span><span class="token punctuation">[</span><span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">workerId</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token variable">$worker</span><span class="token operator">-</span><span class="token operator">></span><span class="token property">count</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">forkOneWorkerForLinux</span><span class="token punctuation">(</span><span class="token variable">$worker</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>检测子进程存活状态：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//  flatten $_pidMap  拿到value值，相当于  array_walk...</span>
<span class="token comment">//   有getAllWorkerPids，但又不用？？？</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">checkIfChildRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span> <span class="token keyword">as</span> <span class="token variable">$worker_id</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$worker_pid_array</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$worker_pid_array</span> <span class="token keyword">as</span> <span class="token variable">$pid</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token variable">$worker_pid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>\<span class="token package">posix_kill</span><span class="token punctuation">(</span><span class="token variable">$pid</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span><span class="token punctuation">[</span><span class="token variable">$worker_id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token variable">$pid</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是，注意，子进程会清空<code>$_pidMap</code>：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">//forkOneWorkerForLinux</span>
<span class="token keyword">elseif</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">===</span> <span class="token variable">$pid</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">//子进程</span>
    <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token variable">$_pidMap</span>  <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pidsToRestart"><a href="#pidsToRestart" class="headerlink" title="_pidsToRestart"></a>_pidsToRestart</h3><p>跟踪这个变量，大概发现，需要重启的时候，先一次将pids放到该变量中，并与reloadable进行求交集，然后，逐一重启该进程。</p>
<h3 id="workerman总结"><a href="#workerman总结" class="headerlink" title="workerman总结"></a>workerman总结</h3><p>感觉代码好像优雅，但是又感觉代码比较难度。见流程中的描述：workerman的代码有点难度…</p>
<p>pidMap跟idMap的共同使用，为啥要多一个变量？多一个变量，就增加一些心智负担……，除非他们有明显的不同作用，如果不是，那么为啥要用两个？</p>
<p>这些都是造成它看起来优雅，但是巨无霸，混合各种东西，难以理解？</p>
<p>反正，看完后的感觉，好像是懂了，但又好像没有懂？？？</p>
<h1 id="other"><a href="#other" class="headerlink" title="other"></a>other</h1><pre class="line-numbers language-none"><code class="language-none">
感觉listen有点乱
if ($worker-&gt;reusePort) &#123;
    $worker-&gt;listen();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/php/" rel="tag"># php</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/04/09/js/webSql/" rel="prev" title="webSql">
                  <i class="fa fa-chevron-left"></i> webSql
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/04/23/shell/docker_shell/" rel="next" title="docker_shell">
                  docker_shell <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">豫ICP备17029463号-1 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
