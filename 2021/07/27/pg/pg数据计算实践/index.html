<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Muse","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="gp的一些操作sql进行记录，统计哪些sql的性能比较消耗性能。记录一下常见的操作方式。比如如何去重，去重在哪方面比较消耗性能。本来不是更多的的查询条件，会有更多的时间消耗。反而，因为条件，最终的时间会少一些。 利用联表，减少去重的数据量。 sql的各种子查询都能用联表来解决。sql其实也是典型的map、reduce这种。map，如对各种字段的各种运算，而reduce其实就是对数据进行分组、聚合。">
<meta property="og:type" content="article">
<meta property="og:title" content="pg数据计算实践">
<meta property="og:url" content="https://blog.chaofml.cn/2021/07/27/pg/pg%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%9E%E8%B7%B5/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="gp的一些操作sql进行记录，统计哪些sql的性能比较消耗性能。记录一下常见的操作方式。比如如何去重，去重在哪方面比较消耗性能。本来不是更多的的查询条件，会有更多的时间消耗。反而，因为条件，最终的时间会少一些。 利用联表，减少去重的数据量。 sql的各种子查询都能用联表来解决。sql其实也是典型的map、reduce这种。map，如对各种字段的各种运算，而reduce其实就是对数据进行分组、聚合。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-27T10:50:38.000Z">
<meta property="article:modified_time" content="2023-01-19T09:27:35.972Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="sql">
<meta property="article:tag" content="pg">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.chaofml.cn/2021/07/27/pg/pg%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%9E%E8%B7%B5/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>pg数据计算实践 | 超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%93%8D%E4%BD%9C"><span class="nav-number">1.</span> <span class="nav-text">操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DISTRIBUTED"><span class="nav-number">1.1.</span> <span class="nav-text">DISTRIBUTED</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E6%AC%A1%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.2.</span> <span class="nav-text">一次查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E8%A3%81%E5%89%AA%E5%88%86%E5%8C%BA"><span class="nav-number">1.3.</span> <span class="nav-text">时间裁剪分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E8%BE%83%E5%B7%AE%E9%9B%86"><span class="nav-number">1.4.</span> <span class="nav-text">比较差集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1%E6%95%B0%E6%8D%AE%E6%A0%B7%E6%9C%AC%E6%83%85%E5%86%B5"><span class="nav-number">1.5.</span> <span class="nav-text">统计数据样本情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1%E5%93%AA%E4%BA%9B%E9%87%8D%E5%A4%8D%E7%9A%84"><span class="nav-number">1.6.</span> <span class="nav-text">统计哪些重复的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%BB%E9%87%8D%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">1.7.</span> <span class="nav-text">去重的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%A4%8D%E8%AE%A1%E7%AE%97%E5%AD%97%E6%AE%B5"><span class="nav-number">1.8.</span> <span class="nav-text">重复计算字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E8%A1%A8%E5%8E%BB%E9%87%8D%E7%BB%9F%E8%AE%A1"><span class="nav-number">1.9.</span> <span class="nav-text">大表去重统计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E9%80%9F%E5%8E%BB%E9%87%8D"><span class="nav-number">1.10.</span> <span class="nav-text">快速去重</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1%E9%87%8D%E5%A4%8D"><span class="nav-number">1.11.</span> <span class="nav-text">统计重复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%B0%E5%9D%80%E8%A1%A8%E5%8E%BB%E9%87%8D"><span class="nav-number">1.12.</span> <span class="nav-text">地址表去重</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF"><span class="nav-number">1.12.1.</span> <span class="nav-text">场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4"><span class="nav-number">1.12.2.</span> <span class="nav-text">运行时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%80%BB%E9%87%8F"><span class="nav-number">1.12.3.</span> <span class="nav-text">数据总量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%811"><span class="nav-number">1.12.4.</span> <span class="nav-text">代码1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%812"><span class="nav-number">1.12.5.</span> <span class="nav-text">代码2</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%813"><span class="nav-number">1.12.6.</span> <span class="nav-text">代码3</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%814"><span class="nav-number">1.12.7.</span> <span class="nav-text">代码4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%815"><span class="nav-number">1.12.8.</span> <span class="nav-text">代码5</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%816"><span class="nav-number">1.12.9.</span> <span class="nav-text">代码6</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%817"><span class="nav-number">1.12.10.</span> <span class="nav-text">代码7</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%818"><span class="nav-number">1.12.11.</span> <span class="nav-text">代码8</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#i1%E5%80%9F%E5%8A%A9%E8%81%94%E8%A1%A8%E5%8E%BB%E9%87%8D"><span class="nav-number">1.13.</span> <span class="nav-text">i1借助联表去重</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%80%9F%E5%8A%A9in%E5%8E%BB%E9%87%8D"><span class="nav-number">1.14.</span> <span class="nav-text">借助in去重</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E8%8E%B7%E5%8F%96"><span class="nav-number">1.15.</span> <span class="nav-text">字段获取</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.15.1.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E9%87%8F"><span class="nav-number">1.15.2.</span> <span class="nav-text">0相关数据量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1%E5%8E%9F%E5%A7%8B%E5%8E%BB%E9%87%8D%E9%9C%80%E6%B1%82"><span class="nav-number">1.15.3.</span> <span class="nav-text">1原始去重需求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2%E5%87%8F%E5%B0%91%E5%AD%97%E6%AE%B5"><span class="nav-number">1.15.4.</span> <span class="nav-text">2减少字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3%E8%81%94%E8%A1%A8%E5%87%8F%E5%B0%91%E6%95%B0%E6%8D%AE%E9%87%8F"><span class="nav-number">1.15.5.</span> <span class="nav-text">3联表减少数据量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E6%AE%B5%E5%B0%91%EF%BC%8C%E6%97%B6%E9%97%B4%E5%BE%88%E5%BF%AB"><span class="nav-number">1.16.</span> <span class="nav-text">字段少，时间很快</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A5%87%E6%80%AA%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">1.17.</span> <span class="nav-text">奇怪的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E8%A1%A8%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">1.18.</span> <span class="nav-text">压缩表的影响</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E8%A1%A8"><span class="nav-number">1.18.1.</span> <span class="nav-text">压缩表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E8%A1%A8"><span class="nav-number">1.18.2.</span> <span class="nav-text">普通表</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE"><span class="nav-number">1.19.</span> <span class="nav-text">视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE%EF%BC%8C%E4%B8%80%E6%AC%A1%E8%AE%A1%E7%AE%97"><span class="nav-number">1.20.</span> <span class="nav-text">创建视图，一次计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#csv%E6%96%87%E4%BB%B6%E5%AF%BC%E5%85%A5%E6%A0%B8%E5%AF%B9"><span class="nav-number">1.21.</span> <span class="nav-text">csv文件导入核对</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#in-exists-join%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="nav-number">1.22.</span> <span class="nav-text">in&#x2F;exists&#x2F;join性能对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E6%9C%9F%E7%BB%9F%E8%AE%A1"><span class="nav-number">1.23.</span> <span class="nav-text">日期统计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%B6%E9%97%B4%E5%A4%A7%E6%A6%82%E7%BB%9F%E8%AE%A1"><span class="nav-number">1.24.</span> <span class="nav-text">时间大概统计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%9F%E8%AE%A1%E5%90%84%E4%B8%AA%E5%B1%82%E6%AC%A1%E7%9A%84%E6%95%B0%E9%87%8F"><span class="nav-number">1.25.</span> <span class="nav-text">统计各个层次的数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%BB%E9%87%8D%E6%9D%A1%E4%BB%B6"><span class="nav-number">1.26.</span> <span class="nav-text">去重条件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E6%AC%A1%E9%94%99%E8%AF%AF%E7%9A%84sql%EF%BC%8C%E6%9F%A5%E9%9D%9E%E5%88%86%E5%B8%83%E9%94%AE"><span class="nav-number">1.27.</span> <span class="nav-text">一次错误的sql，查非分布键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E7%BB%84%E7%9A%84%E8%AE%A1%E7%AE%97%E5%AD%97%E6%AE%B5"><span class="nav-number">1.28.</span> <span class="nav-text">分组的计算字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E7%8E%87"><span class="nav-number">1.29.</span> <span class="nav-text">压缩率</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE%EF%BC%8C%E4%BC%9A%E4%BA%A7%E7%94%9F%E4%BE%9D%E8%B5%96%EF%BC%8C%E5%AF%BC%E8%87%B4%E5%8E%9F%E6%9D%A5%E7%9A%84%E8%A1%A8%E6%97%A0%E6%B3%95%E7%9B%B4%E6%8E%A5%E5%88%A0%E9%99%A4"><span class="nav-number">1.30.</span> <span class="nav-text">创建视图，会产生依赖，导致原来的表无法直接删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%AB%E6%8F%8F%E8%BD%A8%E8%BF%B9%E9%97%AE%E9%A2%98"><span class="nav-number">1.31.</span> <span class="nav-text">扫描轨迹问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D"><span class="nav-number">1.32.</span> <span class="nav-text">正则匹配</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95in%E3%80%81%E8%B7%9F%E8%81%94%E8%A1%A8%E3%80%81python%E5%87%BD%E6%95%B0%E3%80%81sql%E5%87%BD%E6%95%B0%E7%9A%84%E5%B7%AE%E8%B7%9D"><span class="nav-number">1.33.</span> <span class="nav-text">测试in、跟联表、python函数、sql函数的差距</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#INNER-JOIN%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="nav-number">1.33.1.</span> <span class="nav-text">INNER JOIN的方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#in%E5%AD%90%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="nav-number">1.33.2.</span> <span class="nav-text">in子查询方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#in%EF%BC%8C%E4%BB%A3%E5%85%A5%E5%85%B7%E4%BD%93%E5%80%BC"><span class="nav-number">1.33.3.</span> <span class="nav-text">in，代入具体值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#python%E5%87%BD%E6%95%B0"><span class="nav-number">1.33.4.</span> <span class="nav-text">python函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A1%A8unnest-ARRAY"><span class="nav-number">1.34.</span> <span class="nav-text">自定义表unnest + ARRAY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case-not-null"><span class="nav-number">1.35.</span> <span class="nav-text">case not null</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E5%88%86%E7%BB%84%E7%99%BE%E5%88%86%E6%AF%94"><span class="nav-number">1.36.</span> <span class="nav-text">计算分组百分比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%AA%E7%B1%BB%E5%9E%8B%E6%97%A0%E6%B3%95%E5%85%A5%E5%BA%93"><span class="nav-number">1.37.</span> <span class="nav-text">伪类型无法入库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E5%89%8D%E7%BC%80"><span class="nav-number">1.38.</span> <span class="nav-text">分析前缀</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%8A%A0%E6%9D%A1%E4%BB%B6%E5%AD%97%E6%AE%B5%EF%BC%8C%E5%87%8F%E5%B0%91%E6%80%BB%E6%95%B0%EF%BC%8C%E6%8F%90%E9%80%9F"><span class="nav-number">1.39.</span> <span class="nav-text">增加条件字段，减少总数，提速</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%90%E6%9F%A5%E8%AF%A2%EF%BC%9Afield%E6%9F%A5%E8%AF%A2-%E2%80%93-from-%E5%AD%90%E6%9F%A5%E8%AF%A2%E2%80%93with%E4%B8%B4%E6%97%B6%E8%A1%A8"><span class="nav-number">1.40.</span> <span class="nav-text">子查询：field查询 – from 子查询–with临时表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#do-while"><span class="nav-number">1.41.</span> <span class="nav-text">do-while</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E4%BA%8B%E5%86%99%E7%9A%84%E4%BB%A3%E7%A0%81-select-into-count-distinct-case"><span class="nav-number">1.42.</span> <span class="nav-text">同事写的代码 select into + count(distinct case)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%B7%AF"><span class="nav-number">2.</span> <span class="nav-text">思路</span></a></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2021/07/27/pg/pg%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pg数据计算实践
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-27 10:50:38" itemprop="dateCreated datePublished" datetime="2021-07-27T10:50:38+00:00">2021-07-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-19 09:27:35" itemprop="dateModified" datetime="2023-01-19T09:27:35+00:00">2023-01-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>gp的一些操作sql进行记录，统计哪些sql的性能比较消耗性能。记录一下常见的操作方式。比如如何去重，去重在哪方面比较消耗性能。本来不是更多的的查询条件，会有更多的时间消耗。反而，因为条件，最终的时间会少一些。</p>
<p>利用联表，减少去重的数据量。</p>
<p>sql的各种子查询都能用联表来解决。sql其实也是典型的map、reduce这种。map，如对各种字段的各种运算，而reduce其实就是对数据进行分组、聚合。</p>
<a id="more"></a>

<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><h3 id="DISTRIBUTED"><a href="#DISTRIBUTED" class="headerlink" title="DISTRIBUTED"></a>DISTRIBUTED</h3><p>首先，原有的表，有DISTRIBUTED BY (ship_id)，根据特定的条件，将查询出的结果，另存到一张表内，查看时间影响。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_scan_qian;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_scan_qian <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            ship_id,</span><br><span class="line">            scan_site,</span><br><span class="line">            scan_emp,</span><br><span class="line">            ins_db_tm,</span><br><span class="line">            scan_tm,</span><br><span class="line">            scan_typ,</span><br><span class="line">            udf_1,</span><br><span class="line">            udf_4,</span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    ins_db_tm</span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tb_scan</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            ins_db_tm &gt;= <span class="string">&#x27;2021-07-09&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> ins_db_tm &lt; <span class="string">&#x27;2021-07-10&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> scan_typ = <span class="string">&#x27;10&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> rmk_id = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);  <span class="comment">-- 测试最后一句，有无分布对时间的影响</span></span><br></pre></td></tr></table></figure>

<p>有DISTRIBUTED</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 54062499</span><br><span class="line">Time: 23343.444 ms</span><br></pre></td></tr></table></figure>

<p>无DISTRIBUTED</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 54062499</span><br><span class="line">Time: 22795.694 ms</span><br></pre></td></tr></table></figure>

<p>貌似，没有什么影响。</p>
<h3 id="一次查询"><a href="#一次查询" class="headerlink" title="一次查询"></a>一次查询</h3><h3 id="时间裁剪分区"><a href="#时间裁剪分区" class="headerlink" title="时间裁剪分区"></a>时间裁剪分区</h3><p>以下均在一个按时间分区的表上，进行查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- 签收 1天时间内</span><br><span class="line">SELECT 54062499</span><br><span class="line">Time: 23343.444 ms</span><br><span class="line"></span><br><span class="line">-- 分发，10天时间内</span><br><span class="line">SELECT 515138696</span><br><span class="line">Time: 217047.224 ms</span><br><span class="line"></span><br><span class="line">-- 揽件，30天时间内</span><br><span class="line">SELECT 1630545559</span><br><span class="line">Time: 761096.137 ms</span><br></pre></td></tr></table></figure>

<p>大概是按量算出来的。</p>
<p>既然都是一张表，能否在一次计算内，完成呢？这样，来减少时间？</p>
<h3 id="比较差集"><a href="#比较差集" class="headerlink" title="比较差集"></a>比较差集</h3><p>用主键比较一次差集。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> test_scan_qian09 <span class="keyword">as</span> a  <span class="keyword">left</span> <span class="keyword">join</span> test_scan_qian <span class="keyword">as</span> b <span class="keyword">on</span> a.ship_id = b.ship_id <span class="keyword">where</span> b.ship_id <span class="keyword">is</span> <span class="literal">null</span> ; </span><br></pre></td></tr></table></figure>



<h3 id="统计数据样本情况"><a href="#统计数据样本情况" class="headerlink" title="统计数据样本情况"></a>统计数据样本情况</h3><p><code>sum(case when zyfifthyz is not null then 1 else 0 end) </code> 其实就是count(字段)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> zyfifthyz <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  zyfifthyz_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> rule5a <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  rule5a_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> zyfifthgj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  zyfifthgj_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> rule5b <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  rule5b_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> zyfifthdsd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  zyfifthdsd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> rule5c <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  rule5c_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfcalwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfcalwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfcalpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfcalpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfcalyz <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfcalyz_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfcalgj <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfcalgj_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfcaldsd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfcaldsd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> cnmdwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  cnmdwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> cnpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  cnpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> cnfifthcode <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  cnfifthcode_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmwlwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmwlwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmwlpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmwlpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmhisqcwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmhisqcwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmhisqcpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmhisqcpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sdmrgzdwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sdmrgzdwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sdmrgzdpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sdmrgzdpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sdmgjcrgzdwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sdmgjcrgzdwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sdmgjcrgzdpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sdmgjcrgzdpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sdmkeysdicpsfwwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sdmkeysdicpsfwwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sdmkeysdicpsfwpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sdmkeysdicpsfwpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfqccalwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfqccalwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> sfqccalpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  sfqccalpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmhisfcroadnumberwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmhisfcroadnumberwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmhisfcroadnumberpsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmhisfcroadnumberpsm_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmhisfcpoiwd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmhisfcpoiwd_cnt,</span><br><span class="line"><span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> edmhisfcpoipsm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span>  edmhisfcpoipsm_cnt</span><br><span class="line"><span class="keyword">from</span> test_alldata;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(ship_id),<span class="keyword">count</span>(<span class="keyword">distinct</span> ship_id)  <span class="keyword">from</span> addr_real  <span class="keyword">where</span> ldsj &gt;=<span class="string">&#x27;2021-7-10&#x27;</span> <span class="keyword">and</span> ldsj &lt; <span class="string">&#x27;2021-7-10&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">--  结果</span></span><br><span class="line">zyfifthyz_cnt             | 24260067</span><br><span class="line">rule5a_cnt                | 59316603</span><br><span class="line">zyfifthgj_cnt             | 10092057</span><br><span class="line">rule5b_cnt                | 59316603</span><br><span class="line">zyfifthdsd_cnt            | 21988239</span><br><span class="line">rule5c_cnt                | 59316603</span><br><span class="line">sfcalwd_cnt               | 40757859</span><br><span class="line">sfcalpsm_cnt              | 40757859</span><br><span class="line">sfcalyz_cnt               | 8530955</span><br><span class="line">sfcalgj_cnt               | 2099311</span><br><span class="line">sfcaldsd_cnt              | 6041209</span><br><span class="line">cnmdwd_cnt                | 21258103</span><br><span class="line">cnpsm_cnt                 | 20862872</span><br><span class="line">cnfifthcode_cnt           | 3772426</span><br><span class="line">edmwlwd_cnt               | 17365571</span><br><span class="line">edmwlpsm_cnt              | 17365571</span><br><span class="line">edmhisqcwd_cnt            | 44155107</span><br><span class="line">edmhisqcpsm_cnt           | 44155107</span><br><span class="line">sdmrgzdwd_cnt             | 0</span><br><span class="line">sdmrgzdpsm_cnt            | 0</span><br><span class="line">sdmgjcrgzdwd_cnt          | 213877</span><br><span class="line">sdmgjcrgzdpsm_cnt         | 49756</span><br><span class="line">sdmkeysdicpsfwwd_cnt      | 16013344</span><br><span class="line">sdmkeysdicpsfwpsm_cnt     | 15912223</span><br><span class="line">sfqccalwd_cnt             | 0</span><br><span class="line">sfqccalpsm_cnt            | 0</span><br><span class="line">edmhisfcroadnumberwd_cnt  | 14759277</span><br><span class="line">edmhisfcroadnumberpsm_cnt | 14759277</span><br><span class="line">edmhisfcpoiwd_cnt         | 46548511</span><br><span class="line">edmhisfcpoipsm_cnt        | 46548511</span><br></pre></td></tr></table></figure>

<h3 id="统计哪些重复的"><a href="#统计哪些重复的" class="headerlink" title="统计哪些重复的"></a>统计哪些重复的</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_alldata_20210710 <span class="keyword">where</span> ship_id <span class="keyword">in</span> (<span class="keyword">select</span> ship_id <span class="keyword">from</span>  test_alldata_20210710 <span class="keyword">group</span> <span class="keyword">by</span> ship_id <span class="keyword">having</span> <span class="keyword">count</span>(ship_id) &gt; <span class="number">1</span> <span class="keyword">limit</span> <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者自联表？？</span></span><br></pre></td></tr></table></figure>



<h3 id="去重的方式"><a href="#去重的方式" class="headerlink" title="去重的方式"></a>去重的方式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select distinct on() * from sometable order by</span><br></pre></td></tr></table></figure>

<p>大概的意思是，on的字段，作为分组的依据 ,取哪1条，根据 order by的顺序来，取第1条。</p>
<h3 id="重复计算字段"><a href="#重复计算字段" class="headerlink" title="重复计算字段"></a>重复计算字段</h3><p>一般的解法，都是用子查询等，将查询的结果，则重新select 一次。</p>
<p><a target="_blank" rel="noopener" href="http://cn.voidcc.com/question/p-tvmbteju-s.html">http://cn.voidcc.com/question/p-tvmbteju-s.html</a></p>
<p>在select的字段，如何直接引用这些字段呢？在mysql中倒是可以直接引用。语法如下：</p>
<blockquote>
<p>大概用<code>@var:=  表达式</code> 的形式，为表量复制，然后使用<code>@var</code>来直接引用变量。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>  @b := <span class="keyword">UPPER</span>(hostname) <span class="keyword">as</span> b ,<span class="keyword">SUBSTR</span>(@b,<span class="number">1</span>,<span class="number">3</span>) <span class="keyword">as</span> c <span class="keyword">from</span> access_log <span class="keyword">limit</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 另一种用法</span></span><br><span class="line"><span class="keyword">set</span> @hello =<span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> @hello;</span><br></pre></td></tr></table></figure>

<p>但是，gp中是否有类似的语法？测试了，貌似不行。</p>
<h3 id="大表去重统计"><a href="#大表去重统计" class="headerlink" title="大表去重统计"></a>大表去重统计</h3><p>对1个大表的字段进行去重统计，性能如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">select count(recv_addr) from tu_doc_info;                           </span><br><span class="line">-[ RECORD 1 ]------</span><br><span class="line">count | 28018141557</span><br><span class="line">Time: 4371634.524 ms</span><br><span class="line"></span><br><span class="line">select count(1) from (select 1 from tu_doc_info group by recv_addr) as t;       </span><br><span class="line">-[ RECORD 1 ]-----</span><br><span class="line">count | 3898994670</span><br><span class="line"></span><br><span class="line">Time: 29168870.915 ms</span><br></pre></td></tr></table></figure>

<p>其他，尝试统计mysql中的一个分区表，大概2000万多条，耗时20~30秒左右。</p>
<h3 id="快速去重"><a href="#快速去重" class="headerlink" title="快速去重"></a>快速去重</h3><p>比如recv_addr这个字段，取md5后，另存到一张表。然后呢，再group by或distinct不知道性能如何？</p>
<h3 id="统计重复"><a href="#统计重复" class="headerlink" title="统计重复"></a>统计重复</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--  这样的去重效率比直接distinct的效率高一些，结果一致的</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> ydwr_base_salesman_sorting <span class="keyword">group</span> <span class="keyword">by</span> branch_code ,salesman_id ) <span class="keyword">as</span> f;</span><br><span class="line"><span class="comment">-- 统计总数</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> ydwr_base_salesman_sorting;</span><br><span class="line"><span class="comment">-- 统计重复的数据有哪些</span></span><br><span class="line"><span class="keyword">select</span> branch_code,salesman_id <span class="keyword">from</span> ydwr_base_salesman_sorting <span class="keyword">group</span> <span class="keyword">by</span> branch_code ,salesman_id <span class="keyword">having</span> <span class="keyword">count</span>(<span class="number">1</span>) &gt; <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将上一部的结果，代入到这一步，联表查看，具体是哪些记录</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ydwr_base_salesman_sorting <span class="keyword">as</span> a <span class="keyword">right</span> <span class="keyword">join</span> (<span class="keyword">select</span> branch_code,salesman_id <span class="keyword">from</span> ydwr_base_salesman_sorting <span class="keyword">group</span> <span class="keyword">by</span> branch_code ,salesman_id <span class="keyword">having</span> <span class="keyword">count</span>(<span class="number">1</span>) &gt; <span class="number">1</span>) <span class="keyword">as</span> b</span><br><span class="line"><span class="keyword">on</span> a.branch_code = b.branch_code <span class="keyword">and</span> a.salesman_id = b.salesman_id;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 貌似开窗函数也能满足，但是，如何同时取做到 2个字段同时聚合呢？</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> ydwr_base_salesman_sorting ;</span><br></pre></td></tr></table></figure>



<h3 id="地址表去重"><a href="#地址表去重" class="headerlink" title="地址表去重"></a>地址表去重</h3><p>抽取数据，难免会遇到去重问题，到底是先去重，还是先联表求接？计算字段，到底是先计算，还是放到总后计算，或者在中间去完重再计算？</p>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>test_scan_qian是最终联表的主角，所以呢，在去重的时候，先利用其去重。</p>
<p>addr_real_uniq是目标表，是希望得到去重的数据，方便在最终的时候，进行联表查询。</p>
<p>本身并不一定需要<code>test_scan_qian</code>联表去重，但是呢，不用的话，数据量太大了，增加条件，减少数据量，正好，最后联表的时候，数据量也小一些。</p>
<h4 id="运行时间"><a href="#运行时间" class="headerlink" title="运行时间"></a>运行时间</h4><p>代码1单独的提取数据，没有去重，貌似数据量大。故时间比较长。</p>
<p>代码2跟代码1相比，本来是打算联表减少数据量的，但是用的是<code>LEFT JOIN</code>，而不是<code>RIGHT JOIN</code>，查找的数据总量没有减少，还增加了运算时间。</p>
<p>代码3跟代码2相比，采用了<code>RIGHT JOIN</code>，故数落量减少，总时间减到2/3</p>
<p>代码4跟代码3总体差不多，但是条件，由on 改到 where里面，时间反而减少了（不科学），估计都用到了分区裁剪吧。</p>
<blockquote>
<p>条件到底是写在on里面  还是写到 where里面，在联很多表的时候，写到on里面，貌似更方便里面。</p>
</blockquote>
<p>代码5跟代码4，联表方式发生了变化，<code>RIGHT JOIN</code>  改成了<code>INNER JOIN</code>。</p>
<p>代码6，使用了<code>FROM A,B WHERE A B</code>的形式。</p>
<p>关于执行耗时，其实大体上都差不多，可能写出的sql，引擎会整理，可能是殊途同归。</p>
<p>代码7、8是在代码5的基础上，减少运算条件，比如最外层的去重、开窗，就剩下单纯的联表的消耗呢。结果发现，并没有在时间上有提升，而数据量有增加。<strong>这说明什么，增加条件，也需并不会增加运行时间。</strong>所以呢，减少联表，最后再去重（假设重复的数据并不多），也需速度会提升。</p>
<p><strong>减少扫描次数、减少联表次数</strong></p>
<h4 id="数据总量"><a href="#数据总量" class="headerlink" title="数据总量"></a>数据总量</h4><p>代码1、代码2一样，代码3、4、5、6差不多。但是代码3却多出1条？？为啥？</p>
<p>耗时相关：数据总量、字段数。</p>
<h4 id="代码1"><a href="#代码1" class="headerlink" title="代码1"></a>代码1</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- a7地址去重</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        *,</span><br><span class="line">        <span class="comment">-- CAINIAO&gt;YDEC&gt;JD&gt;PDD&gt;BM&gt;YJ&gt;PDDGJ&gt;其他&gt;OOS_NON_ELE,OOS&gt;PC_REAL_NAME_NON_LEL,PC_REAL_NAME&gt;COD</span></span><br><span class="line">        <span class="comment">-- as ldsj_val,</span></span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real</span><br><span class="line">    <span class="keyword">WHERE</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">where</span> rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 549681179</span><br><span class="line">Time: 1484293.820 ms</span><br></pre></td></tr></table></figure>



<h4 id="代码2"><a href="#代码2" class="headerlink" title="代码2"></a>代码2</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*,</span><br><span class="line">        <span class="comment">-- CAINIAO&gt;YDEC&gt;JD&gt;PDD&gt;BM&gt;YJ&gt;PDDGJ&gt;其他&gt;OOS_NON_ELE,OOS&gt;PC_REAL_NAME_NON_LEL,PC_REAL_NAME&gt;COD</span></span><br><span class="line">        <span class="comment">-- as ldsj_val,</span></span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">on</span> a.tm = q.ship_id</span><br><span class="line">    <span class="keyword">WHERE</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">where</span> rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>上面联表方式错了，（RIGHT JOIN），数据没有少，还增加了运算时间，故时间更旧。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 549681179</span><br><span class="line">Time: 1606665.073 ms</span><br></pre></td></tr></table></figure>

<h4 id="代码3"><a href="#代码3" class="headerlink" title="代码3"></a>代码3</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*,</span><br><span class="line">        <span class="comment">-- CAINIAO&gt;YDEC&gt;JD&gt;PDD&gt;BM&gt;YJ&gt;PDDGJ&gt;其他&gt;OOS_NON_ELE,OOS&gt;PC_REAL_NAME_NON_LEL,PC_REAL_NAME&gt;COD</span></span><br><span class="line">        <span class="comment">-- as ldsj_val,</span></span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">on</span> a.tm = q.ship_id <span class="keyword">and</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">where</span> rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 48430255</span><br><span class="line">Time: 524957.187 ms</span><br></pre></td></tr></table></figure>

<h4 id="代码4"><a href="#代码4" class="headerlink" title="代码4"></a>代码4</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*,</span><br><span class="line">        <span class="comment">-- CAINIAO&gt;YDEC&gt;JD&gt;PDD&gt;BM&gt;YJ&gt;PDDGJ&gt;其他&gt;OOS_NON_ELE,OOS&gt;PC_REAL_NAME_NON_LEL,PC_REAL_NAME&gt;COD</span></span><br><span class="line">        <span class="comment">-- as ldsj_val,</span></span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">on</span> a.tm = q.ship_id </span><br><span class="line">    <span class="keyword">where</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">where</span> rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 48430254</span><br><span class="line">Time: 487740.310 ms</span><br></pre></td></tr></table></figure>



<h4 id="代码5"><a href="#代码5" class="headerlink" title="代码5"></a>代码5</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*,</span><br><span class="line">        <span class="comment">-- CAINIAO&gt;YDEC&gt;JD&gt;PDD&gt;BM&gt;YJ&gt;PDDGJ&gt;其他&gt;OOS_NON_ELE,OOS&gt;PC_REAL_NAME_NON_LEL,PC_REAL_NAME&gt;COD</span></span><br><span class="line">        <span class="comment">-- as ldsj_val,</span></span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">on</span> a.tm = q.ship_id </span><br><span class="line">    <span class="keyword">where</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">where</span> rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 48430254</span><br><span class="line">Time: 480104.767 ms</span><br></pre></td></tr></table></figure>

<h4 id="代码6"><a href="#代码6" class="headerlink" title="代码6"></a>代码6</h4><p>更换了from形式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">*</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*,</span><br><span class="line">        <span class="comment">-- CAINIAO&gt;YDEC&gt;JD&gt;PDD&gt;BM&gt;YJ&gt;PDDGJ&gt;其他&gt;OOS_NON_ELE,OOS&gt;PC_REAL_NAME_NON_LEL,PC_REAL_NAME&gt;COD</span></span><br><span class="line">        <span class="comment">-- as ldsj_val,</span></span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a,test_scan_qian <span class="keyword">as</span> q</span><br><span class="line">    <span class="comment">-- 更换联表的条件</span></span><br><span class="line">    <span class="keyword">where</span> a.tm = q.ship_id <span class="keyword">and</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line">) t</span><br><span class="line"><span class="keyword">where</span> rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 48430254</span><br><span class="line">Time: 473906.605 ms</span><br></pre></td></tr></table></figure>



<h4 id="代码7"><a href="#代码7" class="headerlink" title="代码7"></a>代码7</h4><p>对比代码5</p>
<p>去掉外层的去重试试，看看内部的耗时。</p>
<p>开窗后，去重的where并不怎么消耗时间，相差不大。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq2;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq2 <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*,</span><br><span class="line">        ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">            <span class="keyword">PARTITION</span> <span class="keyword">BY</span> tm</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                <span class="keyword">case</span> </span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;CAINIAO&#x27;</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YDEC&#x27;</span> <span class="keyword">then</span> <span class="number">2</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;JD&#x27;</span> <span class="keyword">then</span> <span class="number">3</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDD&#x27;</span> <span class="keyword">then</span> <span class="number">4</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;BM&#x27;</span> <span class="keyword">then</span> <span class="number">5</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;YJ&#x27;</span> <span class="keyword">then</span> <span class="number">6</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PDDGJ&#x27;</span> <span class="keyword">then</span> <span class="number">7</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;其他&#x27;</span> <span class="keyword">then</span> <span class="number">8</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS_NON_ELE&#x27;</span> <span class="keyword">then</span> <span class="number">9</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;OOS&#x27;</span> <span class="keyword">then</span> <span class="number">10</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME_NON_LEL&#x27;</span> <span class="keyword">then</span> <span class="number">11</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;PC_REAL_NAME&#x27;</span> <span class="keyword">then</span> <span class="number">12</span></span><br><span class="line">                <span class="keyword">when</span>  ldly = <span class="string">&#x27;COD&#x27;</span> <span class="keyword">then</span> <span class="number">13</span></span><br><span class="line">                <span class="keyword">else</span>  <span class="number">14</span></span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">ASC</span>,ldsj <span class="keyword">desc</span></span><br><span class="line">        ) <span class="keyword">AS</span> rn</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">on</span> a.tm = q.ship_id </span><br><span class="line">    <span class="keyword">where</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 55299456</span><br><span class="line">Time: 476894.489 ms</span><br></pre></td></tr></table></figure>

<h4 id="代码8"><a href="#代码8" class="headerlink" title="代码8"></a>代码8</h4><p>再去掉开窗函数，看看耗时。纯粹的看联表的耗时。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> addr_real_uniq2;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> addr_real_uniq2 <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        a.*</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        addr_real <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">on</span> a.tm = q.ship_id </span><br><span class="line">    <span class="keyword">where</span> ldsj &gt;= <span class="string">&#x27;2021-08-15 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 55299456</span><br><span class="line">Time: 470603.757 ms</span><br></pre></td></tr></table></figure>





<h3 id="i1借助联表去重"><a href="#i1借助联表去重" class="headerlink" title="i1借助联表去重"></a>i1借助联表去重</h3><p>联一下主表，主表是主要的数据源。</p>
<blockquote>
<p>下面其实表达的就是内部连接，但是写得比较啰嗦。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> i1_order_unqi;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> i1_order_unqi <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            i.*, </span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> i.ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                batch_time <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            i1_order <span class="keyword">as</span> i</span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">ON</span> q.ship_id = i.ship_id <span class="keyword">and</span> i.batch_time &gt;= <span class="string">&#x27;&lt;?=dt(&#x27;</span><span class="number">-7</span> <span class="keyword">day</span><span class="string">&#x27;)?&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">WHERE</span> q.ship_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">    ) t</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>

<p>傻了</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RIGHT JOIN test_scan_qian as q ON q.ship_id = i.ship_id and i.batch_time &gt;= &#x27;&lt;?=dt(&#x27;-7 day&#x27;)?&gt;&#x27;</span><br></pre></td></tr></table></figure>

<p>发现还是错的，其实是<code>INNER JOIN</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INNER JOIN test_scan_qian as q ON q.ship_id = i.ship_id and i.batch_time &gt;= &#x27;&lt;?=dt(&#x27;-7 day&#x27;)?&gt;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="借助in去重"><a href="#借助in去重" class="headerlink" title="借助in去重"></a>借助in去重</h3><p>省略了建表语句，最终结果都是按ship_id分布存储到数据库中，作为中间结果。</p>
<blockquote>
<p>优化后，数据量减少到1/135，时间缩减了快10倍。效果非常的明显。此时，并没有纠结in/join/exists的小表驱动问题。</p>
</blockquote>
<ul>
<li>优化后</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  ship_id,string_agg(ship_type,<span class="string">&#x27;|&#x27;</span>) <span class="keyword">as</span> ship_type <span class="keyword">from</span> (<span class="keyword">select</span> ship_id,ship_type <span class="keyword">from</span> marked_ship </span><br><span class="line"><span class="keyword">where</span> ship_id <span class="keyword">in</span> (<span class="keyword">select</span> ship_id <span class="keyword">from</span> test_scan_qian ) <span class="comment">-- 增加了这句</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> ship_id,ship_type ) <span class="keyword">as</span> f <span class="keyword">group</span> <span class="keyword">by</span>  ship_id</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">10724200</span></span><br><span class="line"><span class="number">156777</span> <span class="built_in">Time</span>: <span class="number">62214.511</span> ms</span><br></pre></td></tr></table></figure>

<ul>
<li>优化前</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  ship_id,string_agg(ship_type,<span class="string">&#x27;|&#x27;</span>) <span class="keyword">as</span> ship_type <span class="keyword">from</span> (<span class="keyword">select</span> ship_id,ship_type <span class="keyword">from</span> marked_ship <span class="keyword">group</span> <span class="keyword">by</span> ship_id,ship_type ) <span class="keyword">as</span> f <span class="keyword">group</span> <span class="keyword">by</span>  ship_id</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1357038779</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">524996.890</span> ms</span><br></pre></td></tr></table></figure>



<h3 id="字段获取"><a href="#字段获取" class="headerlink" title="字段获取"></a>字段获取</h3><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>减少字段，能提升速度，但是不明显。比如900秒，到800秒。但是，通过联表（<code>INNER JOIN</code>，减少总量），减少到200秒左右。</p>
<h4 id="0相关数据量"><a href="#0相关数据量" class="headerlink" title="0相关数据量"></a>0相关数据量</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test_scan_qian;</span><br><span class="line">  count   </span><br><span class="line"><span class="comment">----------</span></span><br><span class="line"> 50196784</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="keyword">select</span> <span class="keyword">max</span>(store_time),<span class="keyword">min</span>(store_time) <span class="keyword">from</span> test_doc;</span><br><span class="line">         max         |         min         </span><br><span class="line"><span class="comment">---------------------+---------------------</span></span><br><span class="line"> 2021-08-26 23:49:52 | 2021-07-24 03:29:29</span><br></pre></td></tr></table></figure>



<h4 id="1原始去重需求"><a href="#1原始去重需求" class="headerlink" title="1原始去重需求"></a>1原始去重需求</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_doc;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_doc <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            d.doc_sn,</span><br><span class="line">            d.doc_src,</span><br><span class="line">            d.store_time,</span><br><span class="line">            d.recv_prov,</span><br><span class="line">            d.recv_city,</span><br><span class="line">            d.recv_ctry,</span><br><span class="line">            d.recv_addr,</span><br><span class="line">            d.send_prov,</span><br><span class="line">            d.send_city,</span><br><span class="line">            d.send_ctry,</span><br><span class="line">            d.send_addr,</span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> doc_sn</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    dtime <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tu_doc_info <span class="keyword">AS</span> d</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            dtime &gt;= <span class="string">&#x27;2021-07-27 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> dtime &lt; <span class="string">&#x27;2021-08-27 00:00:00&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (doc_sn);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1531072496</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">937538.918</span> ms</span><br></pre></td></tr></table></figure>



<h4 id="2减少字段"><a href="#2减少字段" class="headerlink" title="2减少字段"></a>2减少字段</h4><p>减少字段，确实能减少时间消耗。但是，提升比率不是特别的高。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_doc;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_doc <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            d.doc_sn,</span><br><span class="line">            d.doc_src,</span><br><span class="line">            d.store_time,</span><br><span class="line">            d.recv_prov,</span><br><span class="line">            d.recv_city,</span><br><span class="line">            d.recv_ctry,</span><br><span class="line">            d.recv_addr,</span><br><span class="line">            <span class="comment">-- d.send_prov,</span></span><br><span class="line">            <span class="comment">-- d.send_city,</span></span><br><span class="line">            <span class="comment">-- d.send_ctry,</span></span><br><span class="line">            <span class="comment">-- d.send_addr,</span></span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> doc_sn</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    dtime <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tu_doc_info <span class="keyword">AS</span> d</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            dtime &gt;= <span class="string">&#x27;2021-07-27 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> dtime &lt; <span class="string">&#x27;2021-08-27 00:00:00&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (doc_sn);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1531072496</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">833351.744</span> ms</span><br></pre></td></tr></table></figure>



<h4 id="3联表减少数据量"><a href="#3联表减少数据量" class="headerlink" title="3联表减少数据量"></a>3联表减少数据量</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_doc;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_doc <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            d.doc_sn,</span><br><span class="line">            d.doc_src,</span><br><span class="line">            d.store_time,</span><br><span class="line">            d.recv_prov,</span><br><span class="line">            d.recv_city,</span><br><span class="line">            d.recv_ctry,</span><br><span class="line">            d.recv_addr,</span><br><span class="line">            d.send_prov,</span><br><span class="line">            d.send_city,</span><br><span class="line">            d.send_ctry,</span><br><span class="line">            d.send_addr,</span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> doc_sn</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    dtime <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tu_doc_info <span class="keyword">AS</span> d</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">ON</span> q.ship_id = d.doc_sn</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            dtime &gt;= <span class="string">&#x27;2021-07-27 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> dtime &lt; <span class="string">&#x27;2021-08-27 00:00:00&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (doc_sn);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">50106931</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">221289.113</span> ms</span><br></pre></td></tr></table></figure>

<h3 id="字段少，时间很快"><a href="#字段少，时间很快" class="headerlink" title="字段少，时间很快"></a>字段少，时间很快</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">-- 集包信息,tm可能是大包号、运单号</span><br><span class="line">DROP TABLE IF EXISTS test_jibao;</span><br><span class="line">CREATE TABLE test_jibao WITH (</span><br><span class="line">    APPENDONLY &#x3D; TRUE,</span><br><span class="line">    COMPRESSLEVEL &#x3D; 5,</span><br><span class="line">    ORIENTATION &#x3D; COLUMN,</span><br><span class="line">    COMPRESSTYPE &#x3D; ZLIB</span><br><span class="line">) AS SELECT</span><br><span class="line">    *</span><br><span class="line">FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">            case when j.grp_ship_id is not null then j.grp_ship_id else a.ship_id end as tm,  -- 确定装卸车查找的 号（大包号优先于运单号）</span><br><span class="line">            a.ship_id,</span><br><span class="line">            j.grp_ship_id AS pac_id, --大包号</span><br><span class="line">            j.scan_tm AS pac_time,</span><br><span class="line">            j.scan_site AS pac_sitecode, </span><br><span class="line">            CASE</span><br><span class="line">            WHEN j.scan_typ IN (&#39;3&#39;, &#39;03&#39;) THEN</span><br><span class="line">                &#39;分拨集包&#39;</span><br><span class="line">            WHEN j.scan_typ IN (&#39;5&#39;, &#39;05&#39;) THEN</span><br><span class="line">                &#39;网点集包&#39;</span><br><span class="line">            END AS pac_class,</span><br><span class="line">            ROW_NUMBER () OVER (</span><br><span class="line">                PARTITION BY j.ship_id</span><br><span class="line">                ORDER BY</span><br><span class="line">                    j.ins_db_tm DESC</span><br><span class="line">            ) AS rn</span><br><span class="line">        FROM</span><br><span class="line">            test_scan_qian as a</span><br><span class="line">        LEFT JOIN tb_scan as j on j.ship_id &#x3D; a.ship_id</span><br><span class="line">        WHERE</span><br><span class="line">            j.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;</span><br><span class="line">        AND j.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;</span><br><span class="line">        AND j.scan_typ in (&#39;3&#39;,&#39;03&#39;,&#39;5&#39;,&#39;05&#39;)</span><br><span class="line">    ) AS T</span><br><span class="line">WHERE</span><br><span class="line">    T.rn &#x3D; 1</span><br><span class="line">DISTRIBUTED BY (tm);</span><br></pre></td></tr></table></figure>

<p>时间短的有点不敢相信</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 37564347</span><br><span class="line">Time: 67449.129 ms</span><br></pre></td></tr></table></figure>



<h3 id="奇怪的问题"><a href="#奇怪的问题" class="headerlink" title="奇怪的问题"></a>奇怪的问题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">-- 装97、卸96车信息</span><br><span class="line">DROP TABLE IF EXISTS test_zhuangxie;</span><br><span class="line">CREATE TABLE test_zhuangxie WITH (</span><br><span class="line">    APPENDONLY &#x3D; TRUE,</span><br><span class="line">    COMPRESSLEVEL &#x3D; 5,</span><br><span class="line">    ORIENTATION &#x3D; COLUMN,</span><br><span class="line">    COMPRESSTYPE &#x3D; ZLIB</span><br><span class="line">) AS SELECT</span><br><span class="line">    *</span><br><span class="line">FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">            a.*,</span><br><span class="line">            z.scan_site AS sffb_id,  -- 始发分拨</span><br><span class="line">            x.scan_site AS mdfb_id,  -- 目的站点</span><br><span class="line">            ROW_NUMBER () OVER (</span><br><span class="line">                PARTITION BY a.ship_id</span><br><span class="line">                ORDER BY</span><br><span class="line">                    z.ins_db_tm ASC, -- 装车取最早</span><br><span class="line">                    x.ins_db_tm DESC -- 卸车取最晚</span><br><span class="line">            ) AS rn1</span><br><span class="line">        FROM</span><br><span class="line">            test_jibao as a</span><br><span class="line">        LEFT JOIN tb_scan as z on z.ship_id &#x3D; a.ship_id   -- 装车</span><br><span class="line">        LEFT JOIN tb_scan as x on x.ship_id &#x3D; a.ship_id   -- 卸车</span><br><span class="line">        WHERE</span><br><span class="line">            z.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;</span><br><span class="line">        AND z.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;</span><br><span class="line">        AND z.scan_typ &#x3D; &#39;97&#39;</span><br><span class="line">        AND x.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;</span><br><span class="line">        AND x.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;</span><br><span class="line">        AND x.scan_typ &#x3D; &#39;96&#39;</span><br><span class="line">    ) AS T</span><br><span class="line">WHERE</span><br><span class="line">    T.rn1 &#x3D; 1</span><br><span class="line">DISTRIBUTED BY (tm);</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT 57880</span><br><span class="line">Time: 149169.754 ms</span><br><span class="line">develop&#x3D;# select count(*) from test_jibao ;                                                                                                                                                                </span><br><span class="line">  count   </span><br><span class="line">----------</span><br><span class="line"> 37564347</span><br></pre></td></tr></table></figure>

<p>居然，过滤掉很多数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS test_zhuangxie;</span><br><span class="line">CREATE TABLE test_zhuangxie WITH (</span><br><span class="line">    APPENDONLY &#x3D; TRUE,</span><br><span class="line">    COMPRESSLEVEL &#x3D; 5,</span><br><span class="line">    ORIENTATION &#x3D; COLUMN,</span><br><span class="line">    COMPRESSTYPE &#x3D; ZLIB</span><br><span class="line">) AS SELECT</span><br><span class="line">    *</span><br><span class="line">FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">            a.*,</span><br><span class="line">            z.scan_site AS sffb_id,  -- 始发分拨</span><br><span class="line">            x.scan_site AS mdfb_id,  -- 目的站点</span><br><span class="line">            ROW_NUMBER () OVER (</span><br><span class="line">                PARTITION BY a.ship_id</span><br><span class="line">                ORDER BY</span><br><span class="line">                    z.ins_db_tm ASC, -- 装车取最早</span><br><span class="line">                    x.ins_db_tm DESC -- 卸车取最晚</span><br><span class="line">            ) AS rn1</span><br><span class="line">        FROM</span><br><span class="line">            test_jibao as a</span><br><span class="line">        LEFT JOIN tb_scan as z on z.ship_id &#x3D; a.ship_id   -- 装车</span><br><span class="line">            AND z.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;</span><br><span class="line">            AND z.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;</span><br><span class="line">            AND z.scan_typ &#x3D; &#39;97&#39;</span><br><span class="line">        LEFT JOIN tb_scan as x on x.ship_id &#x3D; a.ship_id   -- 卸车</span><br><span class="line">            AND x.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;</span><br><span class="line">            AND x.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;</span><br><span class="line">            AND x.scan_typ &#x3D; &#39;96&#39;</span><br><span class="line">    ) AS T</span><br><span class="line">WHERE</span><br><span class="line">    T.rn1 &#x3D; 1</span><br><span class="line">DISTRIBUTED BY (tm);</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 37564347</span><br><span class="line">Time: 100181.922 ms</span><br></pre></td></tr></table></figure>



<h3 id="压缩表的影响"><a href="#压缩表的影响" class="headerlink" title="压缩表的影响"></a>压缩表的影响</h3><p>压缩表的好处是，由于压缩，体积减少，能减少磁盘io，另外，列存储，非常适合数仓这种类型。</p>
<p>实验证明，写到压缩表内，并不会增加消耗的时间。</p>
<h4 id="压缩表"><a href="#压缩表" class="headerlink" title="压缩表"></a>压缩表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_scan_fen;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_scan_fen <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    ship_id,</span><br><span class="line">    scan_site,</span><br><span class="line">    <span class="comment">-- scan_emp,字段更换为  delv_emp</span></span><br><span class="line">    delv_emp,</span><br><span class="line">    scan_tm,</span><br><span class="line">    rmk_inf,</span><br><span class="line">    <span class="comment">-- 备注派送码</span></span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">    <span class="keyword">WHEN</span> rmk_inf SIMILAR <span class="keyword">to</span> <span class="string">&#x27;[a-zA-Z0-9]&#123;2&#125;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        rmk_inf</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> mark_code,</span><br><span class="line">    <span class="comment">-- 备注派送码是否为机动,是否XYWZ开头</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">when</span>  <span class="keyword">CHAR_LENGTH</span> (rmk_inf) = <span class="number">2</span> <span class="keyword">and</span> (<span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;X&#x27;</span> <span class="keyword">or</span> <span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;Y&#x27;</span> <span class="keyword">or</span> <span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;W&#x27;</span> <span class="keyword">or</span> <span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;Z&#x27;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> is_var_code</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            ship_id,</span><br><span class="line">            scan_site,</span><br><span class="line">            <span class="comment">--  scan_emp,</span></span><br><span class="line">            delv_emp,</span><br><span class="line">            scan_tm,</span><br><span class="line">            rmk_inf,</span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    scan_tm <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tb_scan</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            ins_db_tm &gt;= <span class="string">&#x27;2021-08-17 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> ins_db_tm &lt; <span class="string">&#x27;2021-08-27 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> scan_typ = <span class="string">&#x27;24&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">483512499</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">217465.246</span> ms</span><br></pre></td></tr></table></figure>



<h4 id="普通表"><a href="#普通表" class="headerlink" title="普通表"></a>普通表</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_scan_fen;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_scan_fen <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    ship_id,</span><br><span class="line">    scan_site,</span><br><span class="line">    <span class="comment">-- scan_emp,字段更换为  delv_emp</span></span><br><span class="line">    delv_emp,</span><br><span class="line">    scan_tm,</span><br><span class="line">    rmk_inf,</span><br><span class="line">    <span class="comment">-- 备注派送码</span></span><br><span class="line">    <span class="keyword">CASE</span></span><br><span class="line">    <span class="keyword">WHEN</span> rmk_inf SIMILAR <span class="keyword">to</span> <span class="string">&#x27;[a-zA-Z0-9]&#123;2&#125;&#x27;</span> <span class="keyword">THEN</span></span><br><span class="line">        rmk_inf</span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">AS</span> mark_code,</span><br><span class="line">    <span class="comment">-- 备注派送码是否为机动,是否XYWZ开头</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">when</span>  <span class="keyword">CHAR_LENGTH</span> (rmk_inf) = <span class="number">2</span> <span class="keyword">and</span> (<span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;X&#x27;</span> <span class="keyword">or</span> <span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;Y&#x27;</span> <span class="keyword">or</span> <span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;W&#x27;</span> <span class="keyword">or</span> <span class="keyword">left</span>(<span class="keyword">upper</span>(rmk_inf),<span class="number">1</span>)=<span class="string">&#x27;Z&#x27;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> is_var_code</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            ship_id,</span><br><span class="line">            scan_site,</span><br><span class="line">            <span class="comment">--  scan_emp,</span></span><br><span class="line">            delv_emp,</span><br><span class="line">            scan_tm,</span><br><span class="line">            rmk_inf,</span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    scan_tm <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tb_scan</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            ins_db_tm &gt;= <span class="string">&#x27;2021-08-17 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> ins_db_tm &lt; <span class="string">&#x27;2021-08-27 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> scan_typ = <span class="string">&#x27;24&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">483512499</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">209393.916</span> ms</span><br></pre></td></tr></table></figure>



<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_scan_fen;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>EsRROR:  “test_scan_fen” is not a view<br>HINT:  Use DROP TABLE to remove a table, DROP EXTERNAL TABLE if external, or DROP FOREIGN TABLE if foreign.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW test_scan_fen AS SELECT</span><br></pre></td></tr></table></figure>

<blockquote>
<p>relation “test_scan_fen” already exists</p>
</blockquote>
<p>通过上面的例子发现，其实视图，跟表有点像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW IF EXISTS test_scan_fen;</span><br><span class="line">CREATE VIEW test_scan_fen AS</span><br><span class="line">SELECT</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>创建视图很快。只是存储了sql。并不会实际执行。</p>
<h3 id="创建视图，一次计算"><a href="#创建视图，一次计算" class="headerlink" title="创建视图，一次计算"></a>创建视图，一次计算</h3><p>具体见<code>sql/table_job.sql</code>、<code>sql/view_job.sql</code>。</p>
<p>视图约占 77%，速度有提升，但是貌似并不大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">test_scan_qian;   改为view</span><br><span class="line">test_scan_fen;    改为view</span><br><span class="line">test_scan_lan;    改为view</span><br><span class="line">test_doc;         改为view</span><br><span class="line">test_scan_doc;    不变，输出表格。</span><br></pre></td></tr></table></figure>

<p>视图方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 50196784</span><br><span class="line">Time: 1717532.500 ms</span><br></pre></td></tr></table></figure>

<p>直接计算方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">16：12开始  至 16：50  大概38分钟。</span><br><span class="line"></span><br><span class="line">2208822</span><br><span class="line"></span><br><span class="line">SELECT 50196784</span><br><span class="line">Time: 39995.549 ms</span><br><span class="line">psql:&#x2F;yd&#x2F;table_job.sql:49: NOTICE:  table &quot;test_scan_fen&quot; does not exist, skipping</span><br><span class="line">DROP TABLE</span><br><span class="line">Time: 0.843 ms</span><br><span class="line">SELECT 483512499</span><br><span class="line">Time: 248721.958 ms</span><br><span class="line">psql:&#x2F;yd&#x2F;table_job.sql:102: NOTICE:  table &quot;test_scan_lan&quot; does not exist, skipping</span><br><span class="line">DROP TABLE</span><br><span class="line">Time: 0.731 ms</span><br><span class="line">SELECT 1506757081</span><br><span class="line">Time: 700615.860 ms</span><br><span class="line">psql:&#x2F;yd&#x2F;table_job.sql:135: NOTICE:  table &quot;test_doc&quot; does not exist, skipping</span><br><span class="line">DROP TABLE</span><br><span class="line">Time: 0.663 ms</span><br><span class="line">SELECT 1531072496</span><br><span class="line">Time: 1022834.503 ms</span><br><span class="line">DROP TABLE</span><br><span class="line">Time: 24.487 ms</span><br><span class="line">SELECT 50196784</span><br><span class="line">Time: 196633.527 ms</span><br></pre></td></tr></table></figure>



<h3 id="csv文件导入核对"><a href="#csv文件导入核对" class="headerlink" title="csv文件导入核对"></a>csv文件导入核对</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看此时的文件占用</span></span><br><span class="line">du -sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看总行数，导出的cvs文件，是pdo.fetch-&gt;fputcsv直接写的,没有表头，但是有最后的空行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 该方法并不一定总是很准，误差可能来源与，字段中如过有空行，可能会被误识别</span></span><br><span class="line">cat marked_ship_20210*|wc -l  </span><br></pre></td></tr></table></figure>

<p>psql操作</p>
<blockquote>
<p>查看总条数是否一致，查看1条记录是否正常</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> marked_ship <span class="keyword">where</span> insert_db_date &gt;= <span class="string">&#x27;2021-07-11&#x27;</span> <span class="keyword">limit</span> <span class="number">1</span>; </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> marked_ship <span class="keyword">where</span> insert_db_date &gt;= <span class="string">&#x27;2021-07-11&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p>核对一致，则可删除文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -f marked_ship_20210* </span><br><span class="line">du -sh</span><br></pre></td></tr></table></figure>



<h3 id="in-exists-join性能对比"><a href="#in-exists-join性能对比" class="headerlink" title="in/exists/join性能对比"></a>in/exists/join性能对比</h3><p>test_scan_qian 大表，大概5000万数据。</p>
<p>i1_record 相当来讲是个小表，但是重复的数据比较多。20310127</p>
<ul>
<li><p>join</p>
<p>据说，一般能用子查询的，都能换成join方式</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> i1_record_unqi;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> i1_record_unqi <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            i.*, </span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> i.ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                batch_time <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            i1_record <span class="keyword">as</span> i</span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">as</span> q <span class="keyword">ON</span> q.ship_id = i.ship_id <span class="keyword">and</span> i.batch_time &gt;= <span class="string">&#x27;2021-08-23&#x27;</span></span><br><span class="line">        <span class="keyword">WHERE</span> q.ship_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">    ) t</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT 11620<br>Time: 48267.562 ms</p>
</blockquote>
<ul>
<li>in</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> i1_record_unqi;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> i1_record_unqi <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            i.*, </span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> i.ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                batch_time <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            i1_record <span class="keyword">as</span> i</span><br><span class="line">        <span class="keyword">where</span> i.batch_time &gt;= <span class="string">&#x27;2021-08-23&#x27;</span></span><br><span class="line">            <span class="keyword">and</span> ship_id <span class="keyword">in</span> (<span class="keyword">select</span> ship_id <span class="keyword">from</span> test_scan_qian )</span><br><span class="line">    ) t</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT 11620<br>Time: 50033.728 ms</p>
</blockquote>
<ul>
<li>exists</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> i1_record_unqi;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> i1_record_unqi <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            i.*, </span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> i.ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                batch_time <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            i1_record <span class="keyword">as</span> i</span><br><span class="line">        <span class="keyword">where</span> i.batch_time &gt;= <span class="string">&#x27;2021-08-23&#x27;</span></span><br><span class="line">            <span class="keyword">and</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> test_scan_qian <span class="keyword">where</span> ship_id = i.ship_id )</span><br><span class="line">    ) t</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>SELECT 11620<br>Time: 51298.095 ms</p>
</blockquote>
<p>备注：有的时候，添加条件，反而速度还快一点。如去掉下面的where条件，速度反而还慢一些。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        LEFT JOIN test_scan_qian as q ON q.ship_id = i.ship_id and i.batch_time &gt;= &#x27;2021-08-23&#x27;</span><br><span class="line">        <span class="comment">-- WHERE q.ship_id IS NOT NULL</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1971098</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">62557.812</span> ms</span><br></pre></td></tr></table></figure>



<p>扩展：发现除了前面3种语法，还有其他类型的子查询。</p>
<p>子查询1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> (</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    a.*,</span><br><span class="line">    ( <span class="keyword">select</span> aid <span class="keyword">from</span> b <span class="keyword">where</span> b.aid=a.id <span class="keyword">limit</span> <span class="number">1</span>) <span class="keyword">as</span> aid </span><br><span class="line">  <span class="keyword">from</span> a</span><br><span class="line">) <span class="keyword">as</span> t</span><br><span class="line"><span class="keyword">where</span> t.aid <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>子查询2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> a <span class="keyword">where</span> (<span class="keyword">select</span> aid <span class="keyword">from</span> b <span class="keyword">where</span> b.aid=a.id <span class="keyword">limit</span> <span class="number">1</span>) <span class="keyword">is</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>





<h3 id="日期统计"><a href="#日期统计" class="headerlink" title="日期统计"></a>日期统计</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> to_char(store_time::<span class="built_in">timestamp</span>,<span class="string">&#x27;YYYY-MM-DD&#x27;</span>),<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> test_doc <span class="keyword">group</span> <span class="keyword">by</span> to_char(store_time::<span class="built_in">timestamp</span>,<span class="string">&#x27;YYYY-MM-DD&#x27;</span>) <span class="keyword">order</span> <span class="keyword">by</span> to_char(store_time::<span class="built_in">timestamp</span>,<span class="string">&#x27;YYYY-MM-DD&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 简写</span></span><br><span class="line"><span class="keyword">select</span> to_char(store_time::<span class="built_in">timestamp</span>,<span class="string">&#x27;YYYY-MM-DD&#x27;</span>),<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> test_doc <span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 不知道为什么，自己总喜欢写成嵌套的形式    可能数据量太小，耗时跟上面两种差不多。</span></span><br><span class="line"><span class="keyword">select</span> dt,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> (<span class="keyword">select</span> to_char(store_time::<span class="built_in">timestamp</span>,<span class="string">&#x27;YYYY-MM-DD&#x27;</span>) <span class="keyword">as</span> dt <span class="keyword">from</span> test_doc) t <span class="keyword">group</span> <span class="keyword">by</span> dt;</span><br></pre></td></tr></table></figure>



<h3 id="时间大概统计"><a href="#时间大概统计" class="headerlink" title="时间大概统计"></a>时间大概统计</h3><p>分发：200多秒，取5亿数据，并取出6个字段，并完成计算字段，去重。（+联表条件，能降到94秒）</p>
<p>签收：600秒，取15亿数据，大致取4个字段。并完成去重。</p>
<p>（增加联表条件，时间降到一半）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 55019979</span><br><span class="line">Time: 227152.571 ms</span><br></pre></td></tr></table></figure>

<p>录单：960秒，取15亿数据。</p>
<p>（增加联表条件，时间降到1/4，说明扫描耗时，但是取字段更耗时。）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 55351804</span><br><span class="line">Time: 236165.105 ms</span><br></pre></td></tr></table></figure>

<p>这样，几个大表再联合的时候，源数据量少了很多，估计联表也快不少。</p>
<p>三表联合，由200秒，降低到到1/4。（有两张表同时从15亿降到了0.5亿的水平）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT 55415034</span><br><span class="line">Time: 48538.021 ms</span><br></pre></td></tr></table></figure>

<p>其实，再次优化，能将多表的扫描过程，最好一次完成，估计时间会降低，但是如何实现？自己写函数？增加索引？自己写复杂的联合sql？</p>
<p>所以，目标数据5000万左右，如果中间数据超过这个数很多倍，那么，就是有问题。都能使用联表的方式，降低中间的输出总量。</p>
<h3 id="统计各个层次的数量"><a href="#统计各个层次的数量" class="headerlink" title="统计各个层次的数量"></a>统计各个层次的数量</h3><p>其实，下面可以直接用普通的取整之类的运算符，来解决。如果按0.01精度来分区，那岂不是还要写上一100个<code>when</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">case</span> </span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid = <span class="string">&#x27;&#x27;</span> <span class="keyword">then</span> <span class="number">-1</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">1.1</span> <span class="keyword">then</span> <span class="number">1.1</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">1</span> <span class="keyword">then</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.9</span> <span class="keyword">then</span> <span class="number">0.9</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.8</span> <span class="keyword">then</span> <span class="number">0.8</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.7</span> <span class="keyword">then</span> <span class="number">0.7</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.6</span> <span class="keyword">then</span> <span class="number">0.6</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.5</span> <span class="keyword">then</span> <span class="number">0.5</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.4</span> <span class="keyword">then</span> <span class="number">0.4</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.3</span> <span class="keyword">then</span> <span class="number">0.3</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.2</span> <span class="keyword">then</span> <span class="number">0.2</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0.1</span> <span class="keyword">then</span> <span class="number">0.1</span></span><br><span class="line">    <span class="keyword">when</span> i1l_ftconfid::<span class="built_in">numeric</span> &gt;= <span class="number">0</span> <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    <span class="number">-1</span></span><br><span class="line"> <span class="keyword">end</span> <span class="keyword">as</span> possible</span><br><span class="line">,<span class="keyword">count</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">from</span> test_data_uniq_20210831 </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>本来想进一步增加百分比的信息，但是，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> possible,cnt,(cnt::<span class="built_in">numeric</span>)/(<span class="keyword">sum</span>(cnt))::<span class="built_in">numeric</span> <span class="keyword">from</span> </span><br><span class="line">( 上面的语句 ) t  ;</span><br></pre></td></tr></table></figure>

<p>报错信息如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">column &quot;t.possible&quot; must appear in the GROUP BY clause or be used in an aggregate function</span><br><span class="line">LINE 1: <span class="keyword">select</span> possible,cnt,cnt::<span class="built_in">numeric</span>,<span class="keyword">sum</span>(cnt) <span class="keyword">from</span> </span><br></pre></td></tr></table></figure>

<p>原因：就是因为增加了聚集函数sum，就报错。不知道到为何。</p>
<h3 id="去重条件"><a href="#去重条件" class="headerlink" title="去重条件"></a>去重条件</h3><p>最开始写的sql如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 集包信息,tm可能是大包号、运单号</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_jibao;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_jibao <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            <span class="keyword">case</span> <span class="keyword">when</span> j.grp_ship_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> j.grp_ship_id <span class="keyword">else</span> a.ship_id <span class="keyword">end</span> <span class="keyword">as</span> tm,  <span class="comment">-- 确定装卸车查找的 号（大包号优先于运单号）</span></span><br><span class="line">            a.ship_id,</span><br><span class="line">            j.grp_ship_id <span class="keyword">AS</span> pac_id, <span class="comment">--大包号</span></span><br><span class="line">            j.scan_tm <span class="keyword">AS</span> pac_time,</span><br><span class="line">            j.scan_site <span class="keyword">AS</span> pac_sitecode, </span><br><span class="line">            <span class="keyword">CASE</span></span><br><span class="line">            <span class="keyword">WHEN</span> j.scan_typ <span class="keyword">IN</span> (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;03&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">                <span class="string">&#x27;分拨集包&#x27;</span></span><br><span class="line">            <span class="keyword">WHEN</span> j.scan_typ <span class="keyword">IN</span> (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;05&#x27;</span>) <span class="keyword">THEN</span></span><br><span class="line">                <span class="string">&#x27;网点集包&#x27;</span></span><br><span class="line">            <span class="keyword">END</span> <span class="keyword">AS</span> pac_class,</span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> j.ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    j.ins_db_tm <span class="keyword">DESC</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            test_scan_qian <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tb_scan <span class="keyword">as</span> j <span class="keyword">on</span> j.ship_id = a.ship_id</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            j.ins_db_tm &gt;= <span class="string">&#x27;2021-08-26 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> j.ins_db_tm &lt; <span class="string">&#x27;2021-09-05 00:00:00&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> j.scan_typ <span class="keyword">in</span> (<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;03&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;05&#x27;</span>)</span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 装97、卸96车信息</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_zhuangxie;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_zhuangxie <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            a.*,</span><br><span class="line">            z.scan_site <span class="keyword">AS</span> sffb_id,  <span class="comment">-- 始发分拨</span></span><br><span class="line">            x.scan_site <span class="keyword">AS</span> mdfb_id,  <span class="comment">-- 目的站点</span></span><br><span class="line">            ROW_NUMBER () <span class="keyword">OVER</span> (</span><br><span class="line">                <span class="keyword">PARTITION</span> <span class="keyword">BY</span> a.ship_id</span><br><span class="line">                <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">                    z.ins_db_tm <span class="keyword">ASC</span>, <span class="comment">-- 装车取最早</span></span><br><span class="line">                    x.ins_db_tm <span class="keyword">DESC</span> <span class="comment">-- 卸车取最晚</span></span><br><span class="line">            ) <span class="keyword">AS</span> rn1</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            test_jibao <span class="keyword">as</span> a</span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tb_scan <span class="keyword">as</span> z <span class="keyword">on</span> z.ship_id = a.ship_id   <span class="comment">-- 装车</span></span><br><span class="line">            <span class="keyword">AND</span> z.ins_db_tm &gt;= <span class="string">&#x27;2021-08-26 00:00:00&#x27;</span></span><br><span class="line">            <span class="keyword">AND</span> z.ins_db_tm &lt; <span class="string">&#x27;2021-09-05 00:00:00&#x27;</span></span><br><span class="line">            <span class="keyword">AND</span> z.scan_typ = <span class="string">&#x27;97&#x27;</span></span><br><span class="line">        <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> tb_scan <span class="keyword">as</span> x <span class="keyword">on</span> x.ship_id = a.ship_id   <span class="comment">-- 卸车</span></span><br><span class="line">            <span class="keyword">AND</span> x.ins_db_tm &gt;= <span class="string">&#x27;2021-08-26 00:00:00&#x27;</span></span><br><span class="line">            <span class="keyword">AND</span> x.ins_db_tm &lt; <span class="string">&#x27;2021-09-05 00:00:00&#x27;</span></span><br><span class="line">            <span class="keyword">AND</span> x.scan_typ = <span class="string">&#x27;96&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    T.rn1 = <span class="number">1</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (tm);</span><br></pre></td></tr></table></figure>

<p>上面主表<code>test_scan_qian</code>结果过滤，数据变少了，跟最开始写的有出入。而且经过运算后的，<code>tm</code>，可能有重复，下一次联表的时候，可能也不好弄。</p>
<p>主表qian没有重复，但是呢，优先用大包号、其次是运单号，去联，集包信息的表，（而集包信息，本身也可能会有重复，所以呢，第一步，先让集包信息唯一），假设，集包信息已经唯一呢，那么，此时，再用qian按前面的条件去联集包信息，只是联表的字段，可能不确定。假设qian的联表字段已经确定，那么，势必会有qian的联表字段重复的情形。所以，确定的顺序是：</p>
<ul>
<li>集包先单独去重</li>
<li>计算qian的联表字段，并按联表字段，重分布。</li>
<li>将集包跟 新签 进行联表。</li>
<li>将上述联表后的结果，重新按qian的主键，来处理。</li>
</ul>
<p>减少步骤的方式是，动态计算联表字段。尽量每一步，处理各自的逻辑。比如，先去重，而不是联表后，再去重，这样可能导致结果跟预期不一样。</p>
<p>换一种思路，qian表，有大包号按大包处理，没有打包，则按运单处理，然后呢，</p>
<h3 id="一次错误的sql，查非分布键"><a href="#一次错误的sql，查非分布键" class="headerlink" title="一次错误的sql，查非分布键"></a>一次错误的sql，查非分布键</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">develop-# ship_id,</span><br><span class="line">develop-# grp_ship_id,</span><br><span class="line">develop-# rmk_id,</span><br><span class="line">develop-# rmk_inf,</span><br><span class="line">develop-# scan_site,</span><br><span class="line">develop-# fst_scan_site,</span><br><span class="line">develop-# pre_scan_site,</span><br><span class="line">develop-# nxt_scan_site,</span><br><span class="line">develop-# scan_typ,</span><br><span class="line">develop-# scan_tm,</span><br><span class="line">develop-# ins_db_tm</span><br><span class="line">develop-# from tb_scan </span><br><span class="line">develop-# where ins_db_tm &gt;&#x3D;&#39;2021-09-01&#39; and ins_db_tm &lt; &#39;2021-09-06&#39; and ship_id &#x3D; &#39;1202767564898&#39; or grp_ship_id &#x3D; &#39;9401966434871&#39;</span><br><span class="line">develop-# order by ins_db_tm;</span><br><span class="line">^CCancel request sent</span><br><span class="line">ERROR:  canceling statement due to user request</span><br><span class="line">Time: 434568.440 ms</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">select </span><br><span class="line">ship_id,</span><br><span class="line">grp_ship_id,</span><br><span class="line">rmk_id,</span><br><span class="line">rmk_inf,</span><br><span class="line">scan_site,</span><br><span class="line">fst_scan_site,</span><br><span class="line">pre_scan_site,</span><br><span class="line">nxt_scan_site,</span><br><span class="line">scan_typ,</span><br><span class="line">scan_tm,</span><br><span class="line">ins_db_tm</span><br><span class="line">from tb_scan </span><br><span class="line">where ins_db_tm &gt;&#x3D;&#39;2021-09-01&#39; and ins_db_tm &lt; &#39;2021-09-06&#39; and ship_id in (&#39;1202767564898&#39;,&#39;9401966434871&#39;)</span><br><span class="line">order by ins_db_tm;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Time: 36705.112 ms</span><br></pre></td></tr></table></figure>

<p>差别非常的明显，查询分布键，非常的快，但是如果增加了非分布键，则出奇的慢。（猜测）</p>
<p>以下的主键，存在计算字段，相当于查询了非分布键，但是性能也还好。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    *</span><br><span class="line">FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT</span><br><span class="line">            a.*,</span><br><span class="line">            z.scan_site AS sffb_id,  -- 始发分拨</span><br><span class="line">            x.scan_site AS mdfb_id,  -- 目的站点</span><br><span class="line">            ROW_NUMBER () OVER (</span><br><span class="line">                PARTITION BY a.ship_id</span><br><span class="line">                ORDER BY</span><br><span class="line">                    z.ins_db_tm ASC, -- 装车取最早</span><br><span class="line">                    x.ins_db_tm DESC -- 卸车取最晚</span><br><span class="line">            ) AS rn1</span><br><span class="line">        FROM</span><br><span class="line">            test_jibao as a</span><br><span class="line">        LEFT JOIN tb_scan as z on z.ship_id &#x3D; (case when a.pac_id is not null then a.pac_id else a.ship_id end )   -- 装车</span><br><span class="line">            AND z.ins_db_tm &gt;&#x3D; &#39;2021-08-26 00:00:00&#39;</span><br><span class="line">            AND z.ins_db_tm &lt; &#39;2021-09-06 00:00:00&#39;</span><br><span class="line">            AND z.scan_typ &#x3D; &#39;97&#39;</span><br><span class="line">        LEFT JOIN tb_scan as x on x.ship_id &#x3D; (case when a.pac_id is not null then a.pac_id else a.ship_id end )   -- 卸车</span><br><span class="line">            AND x.ins_db_tm &gt;&#x3D; &#39;2021-08-26 00:00:00&#39;</span><br><span class="line">            AND x.ins_db_tm &lt; &#39;2021-09-06 00:00:00&#39;</span><br><span class="line">            AND x.scan_typ &#x3D; &#39;96&#39;</span><br><span class="line">    ) AS T</span><br><span class="line">WHERE</span><br><span class="line">    T.rn1 &#x3D; 1</span><br></pre></td></tr></table></figure>



<h3 id="分组的计算字段"><a href="#分组的计算字段" class="headerlink" title="分组的计算字段"></a>分组的计算字段</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pac_pre,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> test_zhuangxie <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">substring</span>(pac_id <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">2</span>) pac_pre;</span><br></pre></td></tr></table></figure>

<p>正确的使用引用字段：</p>
<blockquote>
<p>gp下可以正常用。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">substring</span>(pac_id <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">2</span>) <span class="keyword">as</span> pac_pre,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> test_zhuangxie <span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 写字段名也是可以的</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">substring</span>(pac_id <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">2</span>) <span class="keyword">as</span> pac_pre,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> test_zhuangxie <span class="keyword">group</span> <span class="keyword">by</span> pac_pre <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>



<p>clickhouse 却能这样用？？？？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    deploy,</span><br><span class="line">    fullurl,</span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">as</span> <span class="keyword">count</span></span><br><span class="line"><span class="keyword">FROM</span> ncompaas6rows</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> temp_target_ip <span class="keyword">ON</span> ncompaas6rows.dest_ip == temp_target_ip.ip <span class="keyword">AND</span> ncompaas6rows.dest_port == temp_target_ip.port</span><br><span class="line"><span class="keyword">WHERE</span> temp_target_ip.ip != <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">replaceRegexpOne(</span><br><span class="line">    replaceRegexpOne(<span class="string">&#x27;http://&#x27;</span> || hostname || <span class="keyword">url</span>, <span class="string">&#x27;[?&amp;].*$&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;/\\d&#123;&#123;11,15&#125;&#125;($|/.*$)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> fullurl,</span><br><span class="line">deploy <span class="keyword">AS</span> deploy</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">    deploy <span class="keyword">ASC</span>,</span><br><span class="line">    <span class="keyword">count</span> <span class="keyword">DESC</span></span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<h3 id="压缩率"><a href="#压缩率" class="headerlink" title="压缩率"></a>压缩率</h3><p>大概3.3倍的压缩率。</p>
<blockquote>
<p>下面select命令用在分区表上，好像并不行。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 37GB 5000万</span></span><br><span class="line"><span class="keyword">select</span> pg_size_pretty(pg_relation_size(<span class="string">&#x27;public.test_data_uniq_20210907&#x27;</span>));</span><br><span class="line"><span class="comment">-- 123G</span></span><br><span class="line">ls -lh  导出的csv文件</span><br></pre></td></tr></table></figure>



<h3 id="创建视图，会产生依赖，导致原来的表无法直接删除"><a href="#创建视图，会产生依赖，导致原来的表无法直接删除" class="headerlink" title="创建视图，会产生依赖，导致原来的表无法直接删除"></a>创建视图，会产生依赖，导致原来的表无法直接删除</h3><p>直接使用drop table 无法删除掉。注意……</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psql:fetch.sql:14: ERROR:  cannot drop append only columnar table test_scan_qian because other objects depend on it</span><br><span class="line">DETAIL:  view mytestss2_view depends on append only columnar table test_scan_qian</span><br><span class="line">HINT:  Use DROP ... CASCADE to drop the dependent objects too.</span><br></pre></td></tr></table></figure>



<h3 id="扫描轨迹问题"><a href="#扫描轨迹问题" class="headerlink" title="扫描轨迹问题"></a>扫描轨迹问题</h3><ul>
<li>分拨</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create table test_fenbo as select mc,bm,lb from gs where bm  in (select distinct zzz from wdzzz_cw );</span><br></pre></td></tr></table></figure>

<ul>
<li>查1天的数据，数据量虽然不多，但是呢，时间慢</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_guiji;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_guiji <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">)  <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            a.ship_id,</span><br><span class="line">            a.scan_site</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tb_scan <span class="keyword">AS</span> a</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">AS</span> q <span class="keyword">ON</span> q.ship_id = a.ship_id</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_fenbo <span class="keyword">AS</span> f <span class="keyword">ON</span> f.bm::<span class="built_in">text</span> = a.scan_site</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            a.ins_db_tm &gt;= <span class="string">&#x27;2021-09-15&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> a.ins_db_tm &lt; <span class="string">&#x27;2021-09-16&#x27;</span></span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">56093895</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">194421.786</span> ms</span><br></pre></td></tr></table></figure>

<ul>
<li>查10天的数据，范围变长了，但是呢，增加了另外一个类型字段来过滤，即，不需要联表，就能过滤掉数据。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_guiji2;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_guiji2 <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">)  <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            a.ship_id,</span><br><span class="line">            a.scan_site</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tb_scan <span class="keyword">AS</span> a</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">AS</span> q <span class="keyword">ON</span> q.ship_id = a.ship_id</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_fenbo <span class="keyword">AS</span> f <span class="keyword">ON</span> f.bm::<span class="built_in">text</span> = a.scan_site</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            a.ins_db_tm &gt;= <span class="string">&#x27;2021-09-05&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> a.ins_db_tm &lt; <span class="string">&#x27;2021-09-16&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> a.scan_typ <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="string">&#x27;24&#x27;</span>)</span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">155809387</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">277863.165</span> ms</span><br></pre></td></tr></table></figure>
<ul>
<li>增加到30天，再测试。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_guiji2;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_guiji2 <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">)  <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">        <span class="keyword">SELECT</span></span><br><span class="line">            a.ship_id,</span><br><span class="line">            a.scan_site</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            tb_scan <span class="keyword">AS</span> a</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">AS</span> q <span class="keyword">ON</span> q.ship_id = a.ship_id</span><br><span class="line">        <span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_fenbo <span class="keyword">AS</span> f <span class="keyword">ON</span> f.bm::<span class="built_in">text</span> = a.scan_site</span><br><span class="line">        <span class="keyword">WHERE</span></span><br><span class="line">            a.ins_db_tm &gt;= <span class="string">&#x27;2021-08-15&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> a.ins_db_tm &lt; <span class="string">&#x27;2021-09-16&#x27;</span></span><br><span class="line">        <span class="keyword">AND</span> a.scan_typ <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="string">&#x27;24&#x27;</span>)</span><br><span class="line">    ) <span class="keyword">AS</span> T</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>
<p>时间增加3倍，估计3倍时间<br>实际上并没有。这个时间，还算能接受。但是不清楚数据质量怎样。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">156105801</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">467436.559</span> ms</span><br></pre></td></tr></table></figure>

<h3 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h3><ul>
<li>简单的中文测试</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> test_ch(addr <span class="built_in">text</span>) <span class="keyword">RETURNS</span> <span class="built_in">text</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;河南&#x27;</span></span><br><span class="line">$$<span class="keyword">LANGUAGE</span> plpythonu;</span><br><span class="line"><span class="keyword">select</span> test_ch(<span class="string">&#x27;1&#x27;</span>) ;</span><br></pre></td></tr></table></figure>

<ul>
<li>python正则测试</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> test_ch(addr <span class="built_in">text</span>) <span class="keyword">RETURNS</span> <span class="built_in">text</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">pat = re.compile(<span class="string">&#x27;.&#123;1,5&#125;省&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sch = pat.search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">$$<span class="keyword">LANGUAGE</span> plpythonu;</span><br></pre></td></tr></table></figure>

<p>发现并不行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> test_ch(<span class="string">&#x27;河南&#x27;</span>) ;</span><br><span class="line"><span class="keyword">select</span> test_ch(<span class="string">&#x27;湖南省&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>正则测试 -  观察组1</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> parse_addr(addr <span class="built_in">text</span>) <span class="keyword">RETURNS</span> <span class="built_in">text</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;pattn&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> GD:</span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line">    pattn =[]</span><br><span class="line">    pattn.append( re.compile(<span class="string">&#x27;(.*省)(.*市)(.*区)&#x27;</span>))</span><br><span class="line">    pattn.append( re.compile(<span class="string">&#x27;(.*省)(.*市)(.*县)&#x27;</span>))</span><br><span class="line">    pattn.append( re.compile(<span class="string">&#x27;(.*省)(.*市)(.*市)&#x27;</span>))</span><br><span class="line">    GD[<span class="string">&#x27;pattn&#x27;</span>] = pattn</span><br><span class="line">pat = GD[<span class="string">&#x27;pattn&#x27;</span>]</span><br><span class="line">sch = pat[<span class="number">0</span>].search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line">sch = pat[<span class="number">1</span>].search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line">sch = pat[<span class="number">2</span>].search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">$$<span class="keyword">LANGUAGE</span> plpythonu;</span><br></pre></td></tr></table></figure>

<p>导入函数，所有的观察组都使用下面的方式，来进行计算。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_parse_addr;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_parse_addr <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span> doc_sn,recv_addr, parse_addr(recv_addr) <span class="keyword">from</span> tu_doc_info <span class="keyword">where</span> dtime &gt;= <span class="string">&#x27;2021-09-16&#x27;</span> <span class="keyword">and</span> dtime &lt; <span class="string">&#x27;2021-09-17&#x27;</span> <span class="keyword">and</span> recv_addr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (doc_sn);</span><br></pre></td></tr></table></figure>

<p>注意：recv_addr is not null，目的是：防止调用时，null的错误</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">80780849</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">58160.892</span> ms</span><br></pre></td></tr></table></figure>

<p>貌似性能还可以，即python参与运算，貌似不太会拖慢性能。</p>
<ul>
<li>正则测试 -  观察组2</li>
</ul>
<p>取消贪婪匹配模式，因为不支持  .{1,5}语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> parse_addr(addr <span class="built_in">text</span>) <span class="keyword">RETURNS</span> <span class="built_in">text</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;pattn&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> GD:</span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line">    pattn =[]</span><br><span class="line">    pattn.append( re.compile(<span class="string">&#x27;(.*?省)(.*?市)(.*?区)&#x27;</span>))</span><br><span class="line">    pattn.append( re.compile(<span class="string">&#x27;(.*?省)(.*?市)(.*?县)&#x27;</span>))</span><br><span class="line">    pattn.append( re.compile(<span class="string">&#x27;(.*?省)(.*?市)(.*?市)&#x27;</span>))</span><br><span class="line">    GD[<span class="string">&#x27;pattn&#x27;</span>] = pattn</span><br><span class="line">pat = GD[<span class="string">&#x27;pattn&#x27;</span>]</span><br><span class="line">sch = pat[<span class="number">0</span>].search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line">sch = pat[<span class="number">1</span>].search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line">sch = pat[<span class="number">2</span>].search(addr)  <span class="comment"># search</span></span><br><span class="line"><span class="keyword">if</span> sch <span class="keyword">and</span> sch.group(<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">return</span> sch.group(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">$$<span class="keyword">LANGUAGE</span> plpythonu;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 一样的测试语句</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">80780849</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">165485.472</span> ms</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第二遍</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">80780849</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">161170.369</span> ms</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 第三遍再复测原来的脚本，说明函数的功能……</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">80780849</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">62675.341</span> ms</span><br></pre></td></tr></table></figure>

<p>貌似，正则对整个结果影响还是挺大的。</p>
<h3 id="测试in、跟联表、python函数、sql函数的差距"><a href="#测试in、跟联表、python函数、sql函数的差距" class="headerlink" title="测试in、跟联表、python函数、sql函数的差距"></a>测试in、跟联表、python函数、sql函数的差距</h3><p>结论：使用in、INNER JOIN这种反查询，效率成本差不多。因为in的子查询非常小。python在量非常大的情况下，效率低不少。非必要，不用。最奇葩的是，具体值放入到 in 内，居然总量不对，时间还长……。故，sql可能更擅长做联表这种运算。</p>
<ul>
<li>基础，先准备相关的数据。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_guiji_view;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_fenbo;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_fenbo <span class="keyword">AS</span> <span class="keyword">SELECT</span></span><br><span class="line">    mc,</span><br><span class="line">    bm::<span class="built_in">text</span> <span class="keyword">as</span> bm,</span><br><span class="line">    lb</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    gs</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    bm <span class="keyword">IN</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> zzz <span class="keyword">FROM</span> wdzzz_cw</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (bm);</span><br></pre></td></tr></table></figure>

<h4 id="INNER-JOIN的方式"><a href="#INNER-JOIN的方式" class="headerlink" title="INNER JOIN的方式"></a>INNER JOIN的方式</h4><blockquote>
<p>联的是一张小表</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tmp_guiji;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_guiji <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.ship_id,</span><br><span class="line">    a.scan_site,</span><br><span class="line">    a.ins_db_tm</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    tb_scan <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">AS</span> q <span class="keyword">ON</span> q.ship_id = a.ship_id</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_fenbo <span class="keyword">AS</span> f <span class="keyword">ON</span> f.bm = a.scan_site</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.ins_db_tm &gt;= <span class="string">&#x27;2021-08-18 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> a.ins_db_tm &lt; <span class="string">&#x27;2021-09-18 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> a.scan_typ <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="string">&#x27;24&#x27;</span>)</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">156322459</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">328684.450</span> ms</span><br></pre></td></tr></table></figure>

<h4 id="in子查询方式"><a href="#in子查询方式" class="headerlink" title="in子查询方式"></a>in子查询方式</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tmp_guiji;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_guiji <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.ship_id,</span><br><span class="line">    a.scan_site,</span><br><span class="line">    a.ins_db_tm</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    tb_scan <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">AS</span> q <span class="keyword">ON</span> q.ship_id = a.ship_id</span><br><span class="line"> </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.ins_db_tm &gt;= <span class="string">&#x27;2021-08-18 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> a.ins_db_tm &lt; <span class="string">&#x27;2021-09-18 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> a.scan_typ <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="string">&#x27;24&#x27;</span>)</span><br><span class="line"><span class="keyword">AND</span> a.scan_site <span class="keyword">IN</span> (<span class="keyword">SELECT</span> bm <span class="keyword">FROM</span> test_fenbo)</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">156322459</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">321444.458</span> ms</span><br></pre></td></tr></table></figure>

<h4 id="in，代入具体值"><a href="#in，代入具体值" class="headerlink" title="in，代入具体值"></a>in，代入具体值</h4><p>求解代入值的时候，使用<code>select string_agg(bm,&#39;#&#39;) from test_fenbo;</code>，然后自己手工再替换<code>#</code>为<code>&#39;,&#39;</code>，为啥要这么麻烦呢？是因为转义的原因……</p>
<p>其实我感觉，应该性能是差不多，如果比之前查多了，那就说明，in用的是数组遍历。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> tmp_guiji;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_guiji <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    a.ship_id,</span><br><span class="line">    a.scan_site,</span><br><span class="line">    a.ins_db_tm</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    tb_scan <span class="keyword">AS</span> a</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> test_scan_qian <span class="keyword">AS</span> q <span class="keyword">ON</span> q.ship_id = a.ship_id</span><br><span class="line"> </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    a.ins_db_tm &gt;= <span class="string">&#x27;2021-08-18 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> a.ins_db_tm &lt; <span class="string">&#x27;2021-09-18 00:00:00&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> a.scan_typ <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&#x27;10&#x27;</span>,<span class="string">&#x27;14&#x27;</span>,<span class="string">&#x27;24&#x27;</span>)</span><br><span class="line"><span class="keyword">AND</span> a.scan_site <span class="keyword">IN</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>


<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">149342271</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">362041.943</span> ms</span><br></pre></td></tr></table></figure>



<h4 id="python函数"><a href="#python函数" class="headerlink" title="python函数"></a>python函数</h4><p>虽然选择处理的数据有1.5亿，但是呢，总量是有120亿左右。也就是说，要频繁的调用这么多次，故，调用成为瓶颈，</p>
<p>在量少的时候，可能因为有写操作或者其他，其时间成本显示不出来。测试过python匹配3个正则，5000万的量，贪婪匹配60秒、非贪婪匹配160秒，当然，re是否是c实现的，暂时未知。</p>
<p>结论：python可用，但是还是要考虑量的问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 调用的时候用  is_fenbo 来判断</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> is_fenbo(bm <span class="built_in">text</span>) <span class="keyword">RETURNS</span> <span class="built_in">bool</span> <span class="keyword">AS</span> $$</span><br><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;fenbo&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> GD:</span><br><span class="line">    fenbo = &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    GD[<span class="string">&#x27;fenbo&#x27;</span>] = fenbo</span><br><span class="line"><span class="keyword">mapping</span> = GD[<span class="string">&#x27;fenbo&#x27;</span>]</span><br><span class="line"><span class="keyword">return</span> bm <span class="keyword">in</span> <span class="keyword">mapping</span> </span><br><span class="line">$$<span class="keyword">LANGUAGE</span> plpythonu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> is_fenbo(<span class="string">&#x27;461001&#x27;</span>) ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">156322459</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">886813.411</span> ms</span><br></pre></td></tr></table></figure>

<p>至于要不要用pg/plsql来实现函数计算，其实，发现也没有必要。估计性能也不好。</p>
<h3 id="自定义表unnest-ARRAY"><a href="#自定义表unnest-ARRAY" class="headerlink" title="自定义表unnest + ARRAY"></a>自定义表unnest + ARRAY</h3><p>通过 unnest + ARRAY 模式，定义一张虚拟的表。然后从这个表内，筛选数据。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bm IN (</span><br><span class="line">        <span class="comment">--# SELECT DISTINCT zzz FROM wdzzz_cw</span></span><br><span class="line">        <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> zzz <span class="keyword">FROM</span> wdzzz_cw  <span class="keyword">union</span> </span><br><span class="line">        <span class="keyword">SELECT</span> zzz <span class="keyword">FROM</span> <span class="keyword">unnest</span>((<span class="built_in">ARRAY</span>[<span class="number">528455</span>,<span class="number">518000</span>])::<span class="built_in">int</span>[]) <span class="keyword">as</span> zzz</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h3 id="case-not-null"><a href="#case-not-null" class="headerlink" title="case not null"></a>case not null</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">table</span> mydemo1 (<span class="keyword">id</span> <span class="built_in">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mydemo1 <span class="keyword">VALUES</span> (<span class="number">1</span>),(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 错误   不能将id提前   not null 不行  is not null 也行</span></span><br><span class="line"><span class="keyword">select</span>  <span class="keyword">case</span> <span class="keyword">id</span> <span class="keyword">when</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="keyword">id</span> <span class="keyword">else</span> <span class="number">100</span> <span class="keyword">end</span> <span class="keyword">as</span> myid <span class="keyword">from</span> mydemo1;</span><br><span class="line"><span class="comment">-- 正确</span></span><br><span class="line"><span class="keyword">select</span>  <span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">id</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="keyword">id</span> <span class="keyword">else</span> <span class="number">100</span> <span class="keyword">end</span> <span class="keyword">as</span> myid <span class="keyword">from</span> mydemo1;</span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">case when gj.sffb_id is not null then gj.sffb_id else zx.sffb_id <span class="keyword">end</span> <span class="keyword">as</span> sffb_id,</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> gj.sffb_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> gj.sffb_name <span class="keyword">else</span> zx.sffb_name <span class="keyword">end</span> <span class="keyword">as</span> sffb_name,</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> gj.mdfb_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> gj.mdfb_id <span class="keyword">else</span> zx.mdfb_id <span class="keyword">end</span> <span class="keyword">as</span> mdfb_id,</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> gj.mdfb_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">then</span> gj.mdfb_name <span class="keyword">else</span> zx.mdfb_name <span class="keyword">end</span> <span class="keyword">as</span> mdfb_name,</span><br></pre></td></tr></table></figure>





<h3 id="计算分组百分比"><a href="#计算分组百分比" class="headerlink" title="计算分组百分比"></a>计算分组百分比</h3><p>本来主要的想法是，先计算出分组情况。<code>select mycat,count(*) as cnt from mytable group by 1 ;</code>然后在此结果上，再嵌套一层，算出总数，及百分比。<code>select *,cnt/sum(cnt) as percent from (上一步结果) f</code>，但是sum无法直接出现在非聚合查询上。……</p>
<p>总数，运用（关联）子查询</p>
<ul>
<li>关联子查询</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    rmk_id,</span><br><span class="line">    <span class="keyword">COUNT</span> (*) <span class="keyword">AS</span> cnt,</span><br><span class="line">    <span class="keyword">round</span>(</span><br><span class="line">        (</span><br><span class="line">            (<span class="keyword">COUNT</span>(*)) :: <span class="built_in">DECIMAL</span> / (</span><br><span class="line">                <span class="keyword">SELECT</span></span><br><span class="line">                    <span class="keyword">COUNT</span> (*)</span><br><span class="line">                <span class="keyword">FROM</span></span><br><span class="line">                    test_data_uniq_20210922</span><br><span class="line">            )</span><br><span class="line">        ) * <span class="number">100</span>,</span><br><span class="line">        <span class="number">2</span></span><br><span class="line">    ) <span class="keyword">AS</span> <span class="keyword">percent</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    test_data_uniq_20210922</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    rmk_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    cnt <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>另一种方式</p>
<p>准备条件，先研究如下用法。</p>
<blockquote>
<p>over的含义，应该是在分组查询最后的结果上处理，如果没有分组，那么over，即在原始数据上处理。而查询中，已有group了，那么，在select的字段上，使用窗口函数，那么,针对的应该是分组后的结果。</p>
</blockquote>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    rmk_id,</span><br><span class="line">    <span class="keyword">COUNT</span> (*) <span class="keyword">AS</span> cnt,</span><br><span class="line">    <span class="comment">-- 下面即是总数</span></span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">count</span>(*)) <span class="keyword">over</span>() ,</span><br><span class="line">    <span class="comment">-- 下面输出的是分组的总数，即分了多少组</span></span><br><span class="line">    <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">over</span>() </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    test_data_uniq_20210922</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    rmk_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    cnt <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>计算百分比</p>
<blockquote>
<p>性能方面，跟关联子查询，没有区别。如果有求和总数的除0异常，还需要用case when来处理。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    rmk_id,</span><br><span class="line">    <span class="keyword">COUNT</span> (*) <span class="keyword">AS</span> cnt,</span><br><span class="line">    <span class="keyword">round</span>(<span class="keyword">count</span>(*)::<span class="built_in">decimal</span> * <span class="number">100</span>/<span class="keyword">sum</span>(<span class="keyword">count</span>(*)) <span class="keyword">over</span>(), <span class="number">2</span>) <span class="keyword">AS</span> <span class="keyword">percent</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="number">2</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>多个字段时，如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    rmk_id,</span><br><span class="line">    a7_ldly,</span><br><span class="line">    <span class="keyword">COUNT</span> (*) <span class="keyword">AS</span> cnt,</span><br><span class="line">    <span class="keyword">round</span>(<span class="keyword">count</span>(*)::<span class="built_in">decimal</span> * <span class="number">100</span>/<span class="keyword">sum</span>(<span class="keyword">count</span>(*)) <span class="keyword">over</span>(), <span class="number">2</span>) <span class="keyword">AS</span> <span class="keyword">percent</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    mytable</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="number">3</span> <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p>除此之外，还能使用with提前计算出结果。但是，貌似，效果差不多。</p>
<h3 id="伪类型无法入库"><a href="#伪类型无法入库" class="headerlink" title="伪类型无法入库"></a>伪类型无法入库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> gj <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    ship_id,</span><br><span class="line">    <span class="keyword">max</span>(ins_db_tm),</span><br><span class="line">    <span class="keyword">min</span>(ins_db_tm),</span><br><span class="line">    array_agg(<span class="keyword">row</span>(</span><br><span class="line">            grp_ship_id,</span><br><span class="line">            scan_site,</span><br><span class="line">            scan_emp,</span><br><span class="line">            ins_db_tm,</span><br><span class="line">            scan_tm,</span><br><span class="line">            delv_emp,</span><br><span class="line">            scan_typ</span><br><span class="line">        ) <span class="keyword">order</span> <span class="keyword">by</span> ins_db_tm </span><br><span class="line">    )</span><br><span class="line"><span class="keyword">from</span> tb_scan <span class="keyword">where</span> ins_db_tm &gt;=<span class="string">&#x27;2021-08-26&#x27;</span> <span class="keyword">and</span> ins_db_tm &lt; <span class="string">&#x27;2021-09-26&#x27;</span> </span><br><span class="line"><span class="keyword">and</span> ship_id <span class="keyword">in</span> (<span class="keyword">select</span> ship_id <span class="keyword">from</span> test_scan_qian)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> ship_id</span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br></pre></td></tr></table></figure>



<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR:  column &quot;array_agg&quot; has pseudo-type record[]</span><br></pre></td></tr></table></figure>



<h3 id="分析前缀"><a href="#分析前缀" class="headerlink" title="分析前缀"></a>分析前缀</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="keyword">SUBSTRING</span> (grp_ship_id <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">FOR</span> <span class="number">2</span>) <span class="keyword">AS</span> pre,</span><br><span class="line">	<span class="keyword">COUNT</span> (<span class="number">1</span>) <span class="keyword">AS</span> cnt</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	tb_scan</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	ins_db_tm &gt;= <span class="string">&#x27;2021-08-20&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> ins_db_tm &lt; <span class="string">&#x27;2021-09-27&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> grp_ship_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">	<span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	<span class="number">2</span>;</span><br></pre></td></tr></table></figure>





<h3 id="增加条件字段，减少总数，提速"><a href="#增加条件字段，减少总数，提速" class="headerlink" title="增加条件字段，减少总数，提速"></a>增加条件字段，减少总数，提速</h3><p>没有过滤，需要写的记录比较多。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_qianshou_package;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_qianshou_package <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> ship_id,grp_ship_id <span class="keyword">from</span> test_qianshou_guiji <span class="keyword">group</span> <span class="keyword">by</span> ship_id,grp_ship_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">127765499</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">23501.989</span> ms</span><br></pre></td></tr></table></figure>

<p>增加过滤条件。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> test_qianshou_package;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_qianshou_package <span class="keyword">WITH</span> (</span><br><span class="line">    APPENDONLY = <span class="literal">TRUE</span>,</span><br><span class="line">    COMPRESSLEVEL = <span class="number">5</span>,</span><br><span class="line">    ORIENTATION = <span class="keyword">COLUMN</span>,</span><br><span class="line">    COMPRESSTYPE = ZLIB</span><br><span class="line">) <span class="keyword">AS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> ship_id,grp_ship_id <span class="keyword">from</span> test_qianshou_guiji <span class="keyword">where</span> grp_ship_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">group</span> <span class="keyword">by</span> ship_id,grp_ship_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">DISTRIBUTED</span> <span class="keyword">BY</span> (ship_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">67652643</span></span><br><span class="line"><span class="built_in">Time</span>: <span class="number">10959.580</span> ms</span><br></pre></td></tr></table></figure>



<p>上面结果对比，总量减少一半，总时间减少一半，感觉很大的可能是，系统卡在写的性能上面。也说明，在入库的时候，可以提前增加一些计算字段，来作为过滤条件、或着分区条件，来避免大表关联的时候的性能消耗。</p>
<h3 id="子查询：field查询-–-from-子查询–with临时表"><a href="#子查询：field查询-–-from-子查询–with临时表" class="headerlink" title="子查询：field查询 – from 子查询–with临时表"></a>子查询：field查询 – from 子查询–with临时表</h3><p>from子查询</p>
<blockquote>
<p>这个算是比较常规的想法，之所以用from子查询，是因为from子查询内部，进行了聚集计算，而反是非聚集计算的字段，都不能参与select后的字段，故，放到from子查询内，注意，此时的条件，是放到子查询内部的，这样，算是提前剪枝，而内部的排序，一般是没有用处的，但是因为有limit计算，故还是需要order by的运算。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> gs.mc <span class="keyword">as</span> scan_name ,a.*</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> scan_site,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> tb_scan </span><br><span class="line">    <span class="keyword">where</span> ins_db_tm &gt;=<span class="string">&#x27;2021-10-18&#x27;</span> <span class="keyword">and</span> ins_db_tm &lt; <span class="string">&#x27;2021-10-19&#x27;</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> scan_site</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span>  cnt <span class="keyword">limit</span> <span class="number">100</span> </span><br><span class="line">)  a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> gs <span class="keyword">on</span> gs.bm::<span class="built_in">text</span> = a.scan_site;</span><br></pre></td></tr></table></figure>



<p>select 的计算字段</p>
<blockquote>
<p>这种方式，不需要子查询，外部表驱动内部表，进行查询，写起来更简单一些，而，我之前不太擅长这种写发。</p>
<p>注意，scan_name字段，因为关联的字段，其实是参与了聚集运算，故不会重复。（对性能有提升作用？）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  (<span class="keyword">select</span> mc <span class="keyword">from</span> gs <span class="keyword">where</span> bm::<span class="built_in">text</span> = a.scan_site ) <span class="keyword">as</span> scan_name,scan_site,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> tb_scan <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> ins_db_tm &gt;=<span class="string">&#x27;2021-10-18&#x27;</span> <span class="keyword">and</span> ins_db_tm &lt; <span class="string">&#x27;2021-10-19&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> scan_site</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span>  cnt <span class="keyword">limit</span> <span class="number">100</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>with临时表</p>
<blockquote>
<p>突然想起来，还有这种方式。能避免from子查询等。 </p>
<p>with临时表的方式，通常能代替from子查询方式，而且通过观察下面的sql，其实发现，跟from子查询，非常的相似。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> a <span class="keyword">as</span> (</span><br><span class="line">    <span class="keyword">select</span> scan_site,<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt <span class="keyword">from</span> tb_scan </span><br><span class="line">    <span class="keyword">where</span> ins_db_tm &gt;=<span class="string">&#x27;2021-10-18&#x27;</span> <span class="keyword">and</span> ins_db_tm &lt; <span class="string">&#x27;2021-10-19&#x27;</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> scan_site</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span>  cnt <span class="keyword">limit</span> <span class="number">100</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> gs.mc <span class="keyword">as</span> scan_name,a.* <span class="keyword">from</span> a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> gs <span class="keyword">on</span> gs.bm::<span class="built_in">text</span> = a.scan_site;</span><br></pre></td></tr></table></figure>

<p>疑问：针对with的临时表查询，如果有多个临时表的查询，是否，<em>后面的临时表能用上前面的临时表的查询结果</em>呢？简单测试，是可行的。那么，我有个非常大胆的想法，是否能将之前的所有的查询，都用临时表的方式呢处理呢？这样，真的相当于“1条sql”，完成了整个取数任务。</p>
<p>with临时表，能解决很多，嵌套查询的问题。</p>
<p><strong>总结：</strong></p>
<p>上面二者的性能差不多，整体运行时间都在65秒左右，下面的，略微快了几秒而已。</p>
<h3 id="do-while"><a href="#do-while" class="headerlink" title="do-while"></a>do-while</h3><ul>
<li>分组</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--  查1天</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> tm),<span class="keyword">count</span>(tm) <span class="keyword">from</span> addr_real  <span class="keyword">where</span> ldsj &gt;=<span class="string">&#x27;2021-10-19&#x27;</span> <span class="keyword">and</span>  ldsj &lt; <span class="string">&#x27;2021-10-20&#x27;</span> <span class="keyword">and</span> tm <span class="keyword">like</span> <span class="string">&#x27;317%&#x27;</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查n天</span></span><br><span class="line"><span class="keyword">select</span> to_char(ldsj,<span class="string">&#x27;YYYY-MM-DD&#x27;</span>) <span class="keyword">as</span> <span class="keyword">day</span>, <span class="keyword">count</span>(<span class="keyword">distinct</span> tm) <span class="keyword">as</span> distinct_cnt,<span class="keyword">count</span>(tm) <span class="keyword">as</span> cnt <span class="keyword">from</span> addr_real  <span class="keyword">where</span> ldsj &gt;=<span class="string">&#x27;2021-10-01&#x27;</span> <span class="keyword">and</span> tm <span class="keyword">like</span> <span class="string">&#x27;317%&#x27;</span>  <span class="keyword">group</span> <span class="keyword">by</span> <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<p>如上的查询，使用了分组，其实即按分区来分组，感觉n条命令来执行，可能效果更快一些。或者说，group by的时候，尽量使用分组的名称作为条件。</p>
<p>但是呢，不想用for，貌似也能使用子查询。</p>
<ul>
<li>子查询的思路。</li>
</ul>
<blockquote>
<p>下面能写，貌似感觉效率不高。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> (<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span> tm) <span class="keyword">from</span> addr_real <span class="keyword">where</span> 条件 ) <span class="keyword">from</span> 日期列表 <span class="keyword">as</span> a</span><br></pre></td></tr></table></figure>

<ul>
<li>直接写do-loop循环</li>
</ul>
<p>扩展：</p>
<blockquote>
<p>如果想实现数据，按天进行分组并联表呢？ do–loop,子查询，还是？</p>
</blockquote>
<h3 id="同事写的代码-select-into-count-distinct-case"><a href="#同事写的代码-select-into-count-distinct-case" class="headerlink" title="同事写的代码 select into + count(distinct case)"></a>同事写的代码 select into + count(distinct case)</h3><p>下面的代码，有点的意料，如果是我的话，我可能是<code>insert into table from (select * from table1 union all select * from table2 ...) f</code>这种思路。</p>
<p>下面居然还能这样写？select into  第一个表后，后面直接跟其他的表。（select into 的语法我是知道的，但是直接union all使用，第一次遇到）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">into</span> cyf_etl_dta_202110242526</span><br><span class="line"><span class="keyword">from</span> cyf_etl_dta_20211024</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> cyf_etl_dta_20211025</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> cyf_etl_dta_20211026</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>count的几种方式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">Dtime::<span class="built_in">DATE</span> <span class="keyword">as</span> <span class="built_in">date</span>,</span><br><span class="line"><span class="keyword">min</span>(Dtime) <span class="keyword">as</span> min_date,</span><br><span class="line"><span class="keyword">max</span>(Dtime) <span class="keyword">as</span> max_date,</span><br><span class="line"><span class="keyword">count</span>(*), </span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> Doc_Sn) <span class="keyword">as</span> ttl,<span class="comment">--整体</span></span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">case</span> <span class="keyword">when</span> Doc_Src <span class="keyword">in</span> (<span class="string">&#x27;cainiao&#x27;</span>) <span class="keyword">then</span> Doc_Sn <span class="keyword">end</span>) <span class="keyword">as</span> cainiao, <span class="comment">--菜鸟</span></span><br><span class="line"><span class="keyword">count</span>(<span class="keyword">distinct</span> <span class="keyword">case</span> <span class="keyword">when</span> Doc_Src <span class="keyword">in</span> (<span class="string">&#x27;cainiao&#x27;</span>) <span class="keyword">then</span> Doc_Sn <span class="keyword">end</span>) <span class="keyword">as</span> cainiao <span class="comment">--菜鸟</span></span><br><span class="line"><span class="keyword">from</span> tu_doc_info</span><br><span class="line"><span class="keyword">where</span> Dtime&gt;=<span class="string">&#x27;2021-10-24&#x27;</span> <span class="keyword">and</span> Dtime&lt;<span class="string">&#x27;2021-10-27&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> Dtime::<span class="built_in">DATE</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> Dtime::<span class="built_in">DATE</span></span><br></pre></td></tr></table></figure>

<p>除此之外，</p>
<p>sum( case when 条件 then 1 esle 0 end )</p>
<p>count(条件  or  null)   ,如 count(sex = ‘男’ or null)</p>
<p>上面即为计算的几种方式。</p>
<p>上面的count 的计算字段  居然还能<code>distinct + case when</code> ,真没有想这么多</p>
<p>看来sql的语法，可以写这么复杂，只是自己不敢这么搭配而已。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>扫描表，按类型分为，揽件、分发、签收。故，该张表，虽然是一张表，但是可以拆分出多张表。另外，每种，都要取最早、或最晚的那条。然后还要1个月之内的数据。</p>
<p>优化方式，从最简单的到复杂，感觉有以下几种。</p>
<ul>
<li><p>建立索引</p>
</li>
<li><p>直接先取出多天的唯一记录。主要是方便多天的取值</p>
</li>
<li><p>优化sql，之前是每条都取唯一，这次，取唯一的时候，在联表的时候操作？是否能提速？</p>
</li>
<li><p>分区优化，（distribute 主键 ）+ （分区  主键），暂时不考虑时间，先将所有的运单处理完？</p>
</li>
<li><p>gp的json，先将多条的数据，都转换成主键，然后避免3次取表？</p>
</li>
<li><p>自定义函数优化。即一次扫描全表，组装出一个运单的揽、分、签？</p>
</li>
<li><p>提前计算好，揽、签、收的1~2个月数据。</p>
<p>每次计算最值，范围是滚动的，比如1个月。那么，能否滚动的计算出最值？ 在原有的1个月的数据上，按窗口滑动的形式处理？</p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/sql/" rel="tag"># sql</a>
              <a href="/tags/pg/" rel="tag"># pg</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/23/redis/redis_csv/" rel="prev" title="redis_csv.php">
                  <i class="fa fa-chevron-left"></i> redis_csv.php
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/27/shell/awk%E6%AD%A3%E5%88%99/" rel="next" title="awk正则">
                  awk正则 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
