<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>pg数据计算实践 | 超凡魔力</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="gp的一些操作sql进行记录，统计哪些sql的性能比较消耗性能。记录一下常见的操作方式。比如如何去重，去重在哪方面比较消耗性能。本来不是更多的的查询条件，会有更多的时间消耗。反而，因为条件，最终的时间会少一些。 利用联表，减少去重的数据量。 sql的各种子查询都能用联表来解决。sql其实也是典型的map、reduce这种。map，如对各种字段的各种运算，而reduce其实就是对数据进行分组、聚合。">
<meta property="og:type" content="article">
<meta property="og:title" content="pg数据计算实践">
<meta property="og:url" content="https://blog.chaofml.cn/2021/07/27/pg/pg%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%9E%E8%B7%B5/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="gp的一些操作sql进行记录，统计哪些sql的性能比较消耗性能。记录一下常见的操作方式。比如如何去重，去重在哪方面比较消耗性能。本来不是更多的的查询条件，会有更多的时间消耗。反而，因为条件，最终的时间会少一些。 利用联表，减少去重的数据量。 sql的各种子查询都能用联表来解决。sql其实也是典型的map、reduce这种。map，如对各种字段的各种运算，而reduce其实就是对数据进行分组、聚合。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-07-27T10:50:38.000Z">
<meta property="article:modified_time" content="2023-01-20T08:15:40.088Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="sql">
<meta property="article:tag" content="pg">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="超凡魔力" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">超凡魔力</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.chaofml.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-pg/pg数据计算实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/27/pg/pg%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time datetime="2021-07-27T10:50:38.000Z" itemprop="datePublished">2021-07-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      pg数据计算实践
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>gp的一些操作sql进行记录，统计哪些sql的性能比较消耗性能。记录一下常见的操作方式。比如如何去重，去重在哪方面比较消耗性能。本来不是更多的的查询条件，会有更多的时间消耗。反而，因为条件，最终的时间会少一些。</p>
<p>利用联表，减少去重的数据量。</p>
<p>sql的各种子查询都能用联表来解决。sql其实也是典型的map、reduce这种。map，如对各种字段的各种运算，而reduce其实就是对数据进行分组、聚合。</p>
<a id="more"></a>

<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><h3 id="DISTRIBUTED"><a href="#DISTRIBUTED" class="headerlink" title="DISTRIBUTED"></a>DISTRIBUTED</h3><p>首先，原有的表，有DISTRIBUTED BY (ship_id)，根据特定的条件，将查询出的结果，另存到一张表内，查看时间影响。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_scan_qian<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_scan_qian <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            ship_id<span class="token punctuation">,</span>
            scan_site<span class="token punctuation">,</span>
            scan_emp<span class="token punctuation">,</span>
            ins_db_tm<span class="token punctuation">,</span>
            scan_tm<span class="token punctuation">,</span>
            scan_typ<span class="token punctuation">,</span>
            udf_1<span class="token punctuation">,</span>
            udf_4<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    ins_db_tm
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tb_scan
        <span class="token keyword">WHERE</span>
            ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-07-09'</span>
        <span class="token operator">AND</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-07-10'</span>
        <span class="token operator">AND</span> scan_typ <span class="token operator">=</span> <span class="token string">'10'</span>
        <span class="token operator">AND</span> rmk_id <span class="token operator">=</span> <span class="token string">'1'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- 测试最后一句，有无分布对时间的影响</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有DISTRIBUTED</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 54062499
Time: 23343.444 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>无DISTRIBUTED</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 54062499
Time: 22795.694 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>貌似，没有什么影响。</p>
<h3 id="一次查询"><a href="#一次查询" class="headerlink" title="一次查询"></a>一次查询</h3><h3 id="时间裁剪分区"><a href="#时间裁剪分区" class="headerlink" title="时间裁剪分区"></a>时间裁剪分区</h3><p>以下均在一个按时间分区的表上，进行查询。</p>
<pre class="line-numbers language-none"><code class="language-none">-- 签收 1天时间内
SELECT 54062499
Time: 23343.444 ms

-- 分发，10天时间内
SELECT 515138696
Time: 217047.224 ms

-- 揽件，30天时间内
SELECT 1630545559
Time: 761096.137 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>大概是按量算出来的。</p>
<p>既然都是一张表，能否在一次计算内，完成呢？这样，来减少时间？</p>
<h3 id="比较差集"><a href="#比较差集" class="headerlink" title="比较差集"></a>比较差集</h3><p>用主键比较一次差集。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_scan_qian09 <span class="token keyword">as</span> a  <span class="token keyword">left</span> <span class="token keyword">join</span> test_scan_qian <span class="token keyword">as</span> b <span class="token keyword">on</span> a<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> b<span class="token punctuation">.</span>ship_id <span class="token keyword">where</span> b<span class="token punctuation">.</span>ship_id <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="统计数据样本情况"><a href="#统计数据样本情况" class="headerlink" title="统计数据样本情况"></a>统计数据样本情况</h3><p><code>sum(case when zyfifthyz is not null then 1 else 0 end) </code> 其实就是count(字段)</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> 
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> zyfifthyz <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  zyfifthyz_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> rule5a <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  rule5a_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> zyfifthgj <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  zyfifthgj_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> rule5b <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  rule5b_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> zyfifthdsd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  zyfifthdsd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> rule5c <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  rule5c_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfcalwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfcalwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfcalpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfcalpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfcalyz <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfcalyz_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfcalgj <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfcalgj_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfcaldsd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfcaldsd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> cnmdwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  cnmdwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> cnpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  cnpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> cnfifthcode <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  cnfifthcode_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmwlwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmwlwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmwlpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmwlpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmhisqcwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmhisqcwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmhisqcpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmhisqcpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sdmrgzdwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sdmrgzdwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sdmrgzdpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sdmrgzdpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sdmgjcrgzdwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sdmgjcrgzdwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sdmgjcrgzdpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sdmgjcrgzdpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sdmkeysdicpsfwwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sdmkeysdicpsfwwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sdmkeysdicpsfwpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sdmkeysdicpsfwpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfqccalwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfqccalwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> sfqccalpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  sfqccalpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmhisfcroadnumberwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmhisfcroadnumberwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmhisfcroadnumberpsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmhisfcroadnumberpsm_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmhisfcpoiwd <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmhisfcpoiwd_cnt<span class="token punctuation">,</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> edmhisfcpoipsm <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span>  edmhisfcpoipsm_cnt
<span class="token keyword">from</span> test_alldata<span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> ship_id<span class="token punctuation">)</span>  <span class="token keyword">from</span> addr_real  <span class="token keyword">where</span> ldsj <span class="token operator">>=</span><span class="token string">'2021-7-10'</span> <span class="token operator">and</span> ldsj <span class="token operator">&lt;</span> <span class="token string">'2021-7-10'</span><span class="token punctuation">;</span>

<span class="token comment">--  结果</span>
zyfifthyz_cnt             <span class="token operator">|</span> <span class="token number">24260067</span>
rule5a_cnt                <span class="token operator">|</span> <span class="token number">59316603</span>
zyfifthgj_cnt             <span class="token operator">|</span> <span class="token number">10092057</span>
rule5b_cnt                <span class="token operator">|</span> <span class="token number">59316603</span>
zyfifthdsd_cnt            <span class="token operator">|</span> <span class="token number">21988239</span>
rule5c_cnt                <span class="token operator">|</span> <span class="token number">59316603</span>
sfcalwd_cnt               <span class="token operator">|</span> <span class="token number">40757859</span>
sfcalpsm_cnt              <span class="token operator">|</span> <span class="token number">40757859</span>
sfcalyz_cnt               <span class="token operator">|</span> <span class="token number">8530955</span>
sfcalgj_cnt               <span class="token operator">|</span> <span class="token number">2099311</span>
sfcaldsd_cnt              <span class="token operator">|</span> <span class="token number">6041209</span>
cnmdwd_cnt                <span class="token operator">|</span> <span class="token number">21258103</span>
cnpsm_cnt                 <span class="token operator">|</span> <span class="token number">20862872</span>
cnfifthcode_cnt           <span class="token operator">|</span> <span class="token number">3772426</span>
edmwlwd_cnt               <span class="token operator">|</span> <span class="token number">17365571</span>
edmwlpsm_cnt              <span class="token operator">|</span> <span class="token number">17365571</span>
edmhisqcwd_cnt            <span class="token operator">|</span> <span class="token number">44155107</span>
edmhisqcpsm_cnt           <span class="token operator">|</span> <span class="token number">44155107</span>
sdmrgzdwd_cnt             <span class="token operator">|</span> <span class="token number">0</span>
sdmrgzdpsm_cnt            <span class="token operator">|</span> <span class="token number">0</span>
sdmgjcrgzdwd_cnt          <span class="token operator">|</span> <span class="token number">213877</span>
sdmgjcrgzdpsm_cnt         <span class="token operator">|</span> <span class="token number">49756</span>
sdmkeysdicpsfwwd_cnt      <span class="token operator">|</span> <span class="token number">16013344</span>
sdmkeysdicpsfwpsm_cnt     <span class="token operator">|</span> <span class="token number">15912223</span>
sfqccalwd_cnt             <span class="token operator">|</span> <span class="token number">0</span>
sfqccalpsm_cnt            <span class="token operator">|</span> <span class="token number">0</span>
edmhisfcroadnumberwd_cnt  <span class="token operator">|</span> <span class="token number">14759277</span>
edmhisfcroadnumberpsm_cnt <span class="token operator">|</span> <span class="token number">14759277</span>
edmhisfcpoiwd_cnt         <span class="token operator">|</span> <span class="token number">46548511</span>
edmhisfcpoipsm_cnt        <span class="token operator">|</span> <span class="token number">46548511</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="统计哪些重复的"><a href="#统计哪些重复的" class="headerlink" title="统计哪些重复的"></a>统计哪些重复的</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_alldata_20210710 <span class="token keyword">where</span> ship_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id <span class="token keyword">from</span>  test_alldata_20210710 <span class="token keyword">group</span> <span class="token keyword">by</span> ship_id <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 或者自联表？？</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="去重的方式"><a href="#去重的方式" class="headerlink" title="去重的方式"></a>去重的方式</h3><pre class="line-numbers language-none"><code class="language-none">select distinct on() * from sometable order by<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>大概的意思是，on的字段，作为分组的依据 ,取哪1条，根据 order by的顺序来，取第1条。</p>
<h3 id="重复计算字段"><a href="#重复计算字段" class="headerlink" title="重复计算字段"></a>重复计算字段</h3><p>一般的解法，都是用子查询等，将查询的结果，则重新select 一次。</p>
<p><a target="_blank" rel="noopener" href="http://cn.voidcc.com/question/p-tvmbteju-s.html">http://cn.voidcc.com/question/p-tvmbteju-s.html</a></p>
<p>在select的字段，如何直接引用这些字段呢？在mysql中倒是可以直接引用。语法如下：</p>
<blockquote>
<p>大概用<code>@var:=  表达式</code> 的形式，为表量复制，然后使用<code>@var</code>来直接引用变量。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>  <span class="token variable">@b</span> :<span class="token operator">=</span> UPPER<span class="token punctuation">(</span>hostname<span class="token punctuation">)</span> <span class="token keyword">as</span> b <span class="token punctuation">,</span>SUBSTR<span class="token punctuation">(</span><span class="token variable">@b</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c <span class="token keyword">from</span> access_log <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">-- 另一种用法</span>
<span class="token keyword">set</span> <span class="token variable">@hello</span> <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token variable">@hello</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是，gp中是否有类似的语法？测试了，貌似不行。</p>
<h3 id="大表去重统计"><a href="#大表去重统计" class="headerlink" title="大表去重统计"></a>大表去重统计</h3><p>对1个大表的字段进行去重统计，性能如下：</p>
<pre class="line-numbers language-sqlite" data-language="sqlite"><code class="language-sqlite">select count(recv_addr) from tu_doc_info;                           
-[ RECORD 1 ]------
count | 28018141557
Time: 4371634.524 ms

select count(1) from (select 1 from tu_doc_info group by recv_addr) as t;       
-[ RECORD 1 ]-----
count | 3898994670

Time: 29168870.915 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其他，尝试统计mysql中的一个分区表，大概2000万多条，耗时20~30秒左右。</p>
<h3 id="快速去重"><a href="#快速去重" class="headerlink" title="快速去重"></a>快速去重</h3><p>比如recv_addr这个字段，取md5后，另存到一张表。然后呢，再group by或distinct不知道性能如何？</p>
<h3 id="统计重复"><a href="#统计重复" class="headerlink" title="统计重复"></a>统计重复</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--  这样的去重效率比直接distinct的效率高一些，结果一致的</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> ydwr_base_salesman_sorting <span class="token keyword">group</span> <span class="token keyword">by</span> branch_code <span class="token punctuation">,</span>salesman_id <span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">;</span>
<span class="token comment">-- 统计总数</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> ydwr_base_salesman_sorting<span class="token punctuation">;</span>
<span class="token comment">-- 统计重复的数据有哪些</span>
<span class="token keyword">select</span> branch_code<span class="token punctuation">,</span>salesman_id <span class="token keyword">from</span> ydwr_base_salesman_sorting <span class="token keyword">group</span> <span class="token keyword">by</span> branch_code <span class="token punctuation">,</span>salesman_id <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span> <span class="token punctuation">;</span>

<span class="token comment">-- 将上一部的结果，代入到这一步，联表查看，具体是哪些记录</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydwr_base_salesman_sorting <span class="token keyword">as</span> a <span class="token keyword">right</span> <span class="token keyword">join</span> <span class="token punctuation">(</span><span class="token keyword">select</span> branch_code<span class="token punctuation">,</span>salesman_id <span class="token keyword">from</span> ydwr_base_salesman_sorting <span class="token keyword">group</span> <span class="token keyword">by</span> branch_code <span class="token punctuation">,</span>salesman_id <span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> b
<span class="token keyword">on</span> a<span class="token punctuation">.</span>branch_code <span class="token operator">=</span> b<span class="token punctuation">.</span>branch_code <span class="token operator">and</span> a<span class="token punctuation">.</span>salesman_id <span class="token operator">=</span> b<span class="token punctuation">.</span>salesman_id<span class="token punctuation">;</span>

<span class="token comment">-- 貌似开窗函数也能满足，但是，如何同时取做到 2个字段同时聚合呢？</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ydwr_base_salesman_sorting <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="地址表去重"><a href="#地址表去重" class="headerlink" title="地址表去重"></a>地址表去重</h3><p>抽取数据，难免会遇到去重问题，到底是先去重，还是先联表求接？计算字段，到底是先计算，还是放到总后计算，或者在中间去完重再计算？</p>
<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>test_scan_qian是最终联表的主角，所以呢，在去重的时候，先利用其去重。</p>
<p>addr_real_uniq是目标表，是希望得到去重的数据，方便在最终的时候，进行联表查询。</p>
<p>本身并不一定需要<code>test_scan_qian</code>联表去重，但是呢，不用的话，数据量太大了，增加条件，减少数据量，正好，最后联表的时候，数据量也小一些。</p>
<h4 id="运行时间"><a href="#运行时间" class="headerlink" title="运行时间"></a>运行时间</h4><p>代码1单独的提取数据，没有去重，貌似数据量大。故时间比较长。</p>
<p>代码2跟代码1相比，本来是打算联表减少数据量的，但是用的是<code>LEFT JOIN</code>，而不是<code>RIGHT JOIN</code>，查找的数据总量没有减少，还增加了运算时间。</p>
<p>代码3跟代码2相比，采用了<code>RIGHT JOIN</code>，故数落量减少，总时间减到2/3</p>
<p>代码4跟代码3总体差不多，但是条件，由on 改到 where里面，时间反而减少了（不科学），估计都用到了分区裁剪吧。</p>
<blockquote>
<p>条件到底是写在on里面  还是写到 where里面，在联很多表的时候，写到on里面，貌似更方便里面。</p>
</blockquote>
<p>代码5跟代码4，联表方式发生了变化，<code>RIGHT JOIN</code>  改成了<code>INNER JOIN</code>。</p>
<p>代码6，使用了<code>FROM A,B WHERE A B</code>的形式。</p>
<p>关于执行耗时，其实大体上都差不多，可能写出的sql，引擎会整理，可能是殊途同归。</p>
<p>代码7、8是在代码5的基础上，减少运算条件，比如最外层的去重、开窗，就剩下单纯的联表的消耗呢。结果发现，并没有在时间上有提升，而数据量有增加。<strong>这说明什么，增加条件，也需并不会增加运行时间。</strong>所以呢，减少联表，最后再去重（假设重复的数据并不多），也需速度会提升。</p>
<p><strong>减少扫描次数、减少联表次数</strong></p>
<h4 id="数据总量"><a href="#数据总量" class="headerlink" title="数据总量"></a>数据总量</h4><p>代码1、代码2一样，代码3、4、5、6差不多。但是代码3却多出1条？？为啥？</p>
<p>耗时相关：数据总量、字段数。</p>
<h4 id="代码1"><a href="#代码1" class="headerlink" title="代码1"></a>代码1</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- a7地址去重</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> 
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token operator">*</span><span class="token punctuation">,</span>
        <span class="token comment">-- CAINIAO>YDEC>JD>PDD>BM>YJ>PDDGJ>其他>OOS_NON_ELE,OOS>PC_REAL_NAME_NON_LEL,PC_REAL_NAME>COD</span>
        <span class="token comment">-- as ldsj_val,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real
    <span class="token keyword">WHERE</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 549681179
Time: 1484293.820 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="代码2"><a href="#代码2" class="headerlink" title="代码2"></a>代码2</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> 
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        <span class="token comment">-- CAINIAO>YDEC>JD>PDD>BM>YJ>PDDGJ>其他>OOS_NON_ELE,OOS>PC_REAL_NAME_NON_LEL,PC_REAL_NAME>COD</span>
        <span class="token comment">-- as ldsj_val,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a
    <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">on</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id
    <span class="token keyword">WHERE</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面联表方式错了，（RIGHT JOIN），数据没有少，还增加了运算时间，故时间更旧。</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 549681179
Time: 1606665.073 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="代码3"><a href="#代码3" class="headerlink" title="代码3"></a>代码3</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> 
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        <span class="token comment">-- CAINIAO>YDEC>JD>PDD>BM>YJ>PDDGJ>其他>OOS_NON_ELE,OOS>PC_REAL_NAME_NON_LEL,PC_REAL_NAME>COD</span>
        <span class="token comment">-- as ldsj_val,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a
    <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">on</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 48430255
Time: 524957.187 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="代码4"><a href="#代码4" class="headerlink" title="代码4"></a>代码4</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> 
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        <span class="token comment">-- CAINIAO>YDEC>JD>PDD>BM>YJ>PDDGJ>其他>OOS_NON_ELE,OOS>PC_REAL_NAME_NON_LEL,PC_REAL_NAME>COD</span>
        <span class="token comment">-- as ldsj_val,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a
    <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">on</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id 
    <span class="token keyword">where</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">SELECT 48430254
Time: 487740.310 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="代码5"><a href="#代码5" class="headerlink" title="代码5"></a>代码5</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> 
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        <span class="token comment">-- CAINIAO>YDEC>JD>PDD>BM>YJ>PDDGJ>其他>OOS_NON_ELE,OOS>PC_REAL_NAME_NON_LEL,PC_REAL_NAME>COD</span>
        <span class="token comment">-- as ldsj_val,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">on</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id 
    <span class="token keyword">where</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 48430254
Time: 480104.767 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="代码6"><a href="#代码6" class="headerlink" title="代码6"></a>代码6</h4><p>更换了from形式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> 
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        <span class="token comment">-- CAINIAO>YDEC>JD>PDD>BM>YJ>PDDGJ>其他>OOS_NON_ELE,OOS>PC_REAL_NAME_NON_LEL,PC_REAL_NAME>COD</span>
        <span class="token comment">-- as ldsj_val,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a<span class="token punctuation">,</span>test_scan_qian <span class="token keyword">as</span> q
    <span class="token comment">-- 更换联表的条件</span>
    <span class="token keyword">where</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 48430254
Time: 473906.605 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="代码7"><a href="#代码7" class="headerlink" title="代码7"></a>代码7</h4><p>对比代码5</p>
<p>去掉外层的去重试试，看看内部的耗时。</p>
<p>开窗后，去重的where并不怎么消耗时间，相差不大。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq2 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> tm
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">on</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id 
    <span class="token keyword">where</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-none"><code class="language-none">SELECT 55299456
Time: 476894.489 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="代码8"><a href="#代码8" class="headerlink" title="代码8"></a>代码8</h4><p>再去掉开窗函数，看看耗时。纯粹的看联表的耗时。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> addr_real_uniq2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> addr_real_uniq2 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
    <span class="token keyword">select</span>
        a<span class="token punctuation">.</span><span class="token operator">*</span>
    <span class="token keyword">FROM</span>
        addr_real <span class="token keyword">as</span> a
    <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">on</span> a<span class="token punctuation">.</span>tm <span class="token operator">=</span> q<span class="token punctuation">.</span>ship_id 
    <span class="token keyword">where</span> ldsj <span class="token operator">>=</span> <span class="token string">'2021-08-15 00:00:00'</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 55299456
Time: 470603.757 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>





<h3 id="i1借助联表去重"><a href="#i1借助联表去重" class="headerlink" title="i1借助联表去重"></a>i1借助联表去重</h3><p>联一下主表，主表是主要的数据源。</p>
<blockquote>
<p>下面其实表达的就是内部连接，但是写得比较啰嗦。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> i1_order_unqi<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> i1_order_unqi <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            i<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> 
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> i<span class="token punctuation">.</span>ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                batch_time <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            i1_order <span class="token keyword">as</span> i
        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> i<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'&lt;?=dt('</span><span class="token operator">-</span><span class="token number">7</span> <span class="token keyword">day</span><span class="token string">')?>'</span>
        <span class="token keyword">WHERE</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
    <span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>傻了</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> i<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'&lt;?=dt('</span><span class="token operator">-</span><span class="token number">7</span> <span class="token keyword">day</span><span class="token string">')?>'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>发现还是错的，其实是<code>INNER JOIN</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> i<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'&lt;?=dt('</span><span class="token operator">-</span><span class="token number">7</span> <span class="token keyword">day</span><span class="token string">')?>'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="借助in去重"><a href="#借助in去重" class="headerlink" title="借助in去重"></a>借助in去重</h3><p>省略了建表语句，最终结果都是按ship_id分布存储到数据库中，作为中间结果。</p>
<blockquote>
<p>优化后，数据量减少到1/135，时间缩减了快10倍。效果非常的明显。此时，并没有纠结in/join/exists的小表驱动问题。</p>
</blockquote>
<ul>
<li>优化后</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span>  ship_id<span class="token punctuation">,</span>string_agg<span class="token punctuation">(</span>ship_type<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ship_type <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id<span class="token punctuation">,</span>ship_type <span class="token keyword">from</span> marked_ship 
<span class="token keyword">where</span> ship_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id <span class="token keyword">from</span> test_scan_qian <span class="token punctuation">)</span> <span class="token comment">-- 增加了这句</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> ship_id<span class="token punctuation">,</span>ship_type <span class="token punctuation">)</span> <span class="token keyword">as</span> f <span class="token keyword">group</span> <span class="token keyword">by</span>  ship_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">10724200</span>
<span class="token number">156777</span> <span class="token keyword">Time</span>: <span class="token number">62214.511</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>优化前</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span>  ship_id<span class="token punctuation">,</span>string_agg<span class="token punctuation">(</span>ship_type<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ship_type <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id<span class="token punctuation">,</span>ship_type <span class="token keyword">from</span> marked_ship <span class="token keyword">group</span> <span class="token keyword">by</span> ship_id<span class="token punctuation">,</span>ship_type <span class="token punctuation">)</span> <span class="token keyword">as</span> f <span class="token keyword">group</span> <span class="token keyword">by</span>  ship_id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">1357038779</span>
<span class="token keyword">Time</span>: <span class="token number">524996.890</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="字段获取"><a href="#字段获取" class="headerlink" title="字段获取"></a>字段获取</h3><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>减少字段，能提升速度，但是不明显。比如900秒，到800秒。但是，通过联表（<code>INNER JOIN</code>，减少总量），减少到200秒左右。</p>
<h4 id="0相关数据量"><a href="#0相关数据量" class="headerlink" title="0相关数据量"></a>0相关数据量</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_scan_qian<span class="token punctuation">;</span>
  count   
<span class="token comment">----------</span>
 <span class="token number">50196784</span>
 
 
 <span class="token keyword">select</span> <span class="token function">max</span><span class="token punctuation">(</span>store_time<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">min</span><span class="token punctuation">(</span>store_time<span class="token punctuation">)</span> <span class="token keyword">from</span> test_doc<span class="token punctuation">;</span>
         max         <span class="token operator">|</span>         min         
<span class="token comment">---------------------+---------------------</span>
 <span class="token number">2021</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">26</span> <span class="token number">23</span>:<span class="token number">49</span>:<span class="token number">52</span> <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">24</span> <span class="token number">03</span>:<span class="token number">29</span>:<span class="token number">29</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="1原始去重需求"><a href="#1原始去重需求" class="headerlink" title="1原始去重需求"></a>1原始去重需求</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_doc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_doc <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            d<span class="token punctuation">.</span>doc_sn<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>doc_src<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>store_time<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_prov<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_city<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_ctry<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_addr<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_prov<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_city<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_ctry<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_addr<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> doc_sn
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    dtime <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tu_doc_info <span class="token keyword">AS</span> d
        <span class="token keyword">WHERE</span>
            dtime <span class="token operator">>=</span> <span class="token string">'2021-07-27 00:00:00'</span>
        <span class="token operator">AND</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-08-27 00:00:00'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">1531072496</span>
<span class="token keyword">Time</span>: <span class="token number">937538.918</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="2减少字段"><a href="#2减少字段" class="headerlink" title="2减少字段"></a>2减少字段</h4><p>减少字段，确实能减少时间消耗。但是，提升比率不是特别的高。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_doc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_doc <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            d<span class="token punctuation">.</span>doc_sn<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>doc_src<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>store_time<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_prov<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_city<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_ctry<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_addr<span class="token punctuation">,</span>
            <span class="token comment">-- d.send_prov,</span>
            <span class="token comment">-- d.send_city,</span>
            <span class="token comment">-- d.send_ctry,</span>
            <span class="token comment">-- d.send_addr,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> doc_sn
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    dtime <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tu_doc_info <span class="token keyword">AS</span> d
        <span class="token keyword">WHERE</span>
            dtime <span class="token operator">>=</span> <span class="token string">'2021-07-27 00:00:00'</span>
        <span class="token operator">AND</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-08-27 00:00:00'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">1531072496</span>
<span class="token keyword">Time</span>: <span class="token number">833351.744</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="3联表减少数据量"><a href="#3联表减少数据量" class="headerlink" title="3联表减少数据量"></a>3联表减少数据量</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_doc<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_doc <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            d<span class="token punctuation">.</span>doc_sn<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>doc_src<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>store_time<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_prov<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_city<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_ctry<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>recv_addr<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_prov<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_city<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_ctry<span class="token punctuation">,</span>
            d<span class="token punctuation">.</span>send_addr<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> doc_sn
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    dtime <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tu_doc_info <span class="token keyword">AS</span> d
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> d<span class="token punctuation">.</span>doc_sn
        <span class="token keyword">WHERE</span>
            dtime <span class="token operator">>=</span> <span class="token string">'2021-07-27 00:00:00'</span>
        <span class="token operator">AND</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-08-27 00:00:00'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">50106931</span>
<span class="token keyword">Time</span>: <span class="token number">221289.113</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="字段少，时间很快"><a href="#字段少，时间很快" class="headerlink" title="字段少，时间很快"></a>字段少，时间很快</h3><pre class="line-numbers language-none"><code class="language-none">-- 集包信息,tm可能是大包号、运单号
DROP TABLE IF EXISTS test_jibao;
CREATE TABLE test_jibao WITH (
    APPENDONLY &#x3D; TRUE,
    COMPRESSLEVEL &#x3D; 5,
    ORIENTATION &#x3D; COLUMN,
    COMPRESSTYPE &#x3D; ZLIB
) AS SELECT
    *
FROM
    (
        SELECT
            case when j.grp_ship_id is not null then j.grp_ship_id else a.ship_id end as tm,  -- 确定装卸车查找的 号（大包号优先于运单号）
            a.ship_id,
            j.grp_ship_id AS pac_id, --大包号
            j.scan_tm AS pac_time,
            j.scan_site AS pac_sitecode, 
            CASE
            WHEN j.scan_typ IN (&#39;3&#39;, &#39;03&#39;) THEN
                &#39;分拨集包&#39;
            WHEN j.scan_typ IN (&#39;5&#39;, &#39;05&#39;) THEN
                &#39;网点集包&#39;
            END AS pac_class,
            ROW_NUMBER () OVER (
                PARTITION BY j.ship_id
                ORDER BY
                    j.ins_db_tm DESC
            ) AS rn
        FROM
            test_scan_qian as a
        LEFT JOIN tb_scan as j on j.ship_id &#x3D; a.ship_id
        WHERE
            j.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;
        AND j.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;
        AND j.scan_typ in (&#39;3&#39;,&#39;03&#39;,&#39;5&#39;,&#39;05&#39;)
    ) AS T
WHERE
    T.rn &#x3D; 1
DISTRIBUTED BY (tm);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>时间短的有点不敢相信</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 37564347
Time: 67449.129 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="奇怪的问题"><a href="#奇怪的问题" class="headerlink" title="奇怪的问题"></a>奇怪的问题</h3><pre class="line-numbers language-none"><code class="language-none">-- 装97、卸96车信息
DROP TABLE IF EXISTS test_zhuangxie;
CREATE TABLE test_zhuangxie WITH (
    APPENDONLY &#x3D; TRUE,
    COMPRESSLEVEL &#x3D; 5,
    ORIENTATION &#x3D; COLUMN,
    COMPRESSTYPE &#x3D; ZLIB
) AS SELECT
    *
FROM
    (
        SELECT
            a.*,
            z.scan_site AS sffb_id,  -- 始发分拨
            x.scan_site AS mdfb_id,  -- 目的站点
            ROW_NUMBER () OVER (
                PARTITION BY a.ship_id
                ORDER BY
                    z.ins_db_tm ASC, -- 装车取最早
                    x.ins_db_tm DESC -- 卸车取最晚
            ) AS rn1
        FROM
            test_jibao as a
        LEFT JOIN tb_scan as z on z.ship_id &#x3D; a.ship_id   -- 装车
        LEFT JOIN tb_scan as x on x.ship_id &#x3D; a.ship_id   -- 卸车
        WHERE
            z.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;
        AND z.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;
        AND z.scan_typ &#x3D; &#39;97&#39;
        AND x.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;
        AND x.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;
        AND x.scan_typ &#x3D; &#39;96&#39;
    ) AS T
WHERE
    T.rn1 &#x3D; 1
DISTRIBUTED BY (tm);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 57880
Time: 149169.754 ms
develop&#x3D;# select count(*) from test_jibao ;                                                                                                                                                                
  count   
----------
 37564347<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>居然，过滤掉很多数据。</p>
<pre class="line-numbers language-none"><code class="language-none">DROP TABLE IF EXISTS test_zhuangxie;
CREATE TABLE test_zhuangxie WITH (
    APPENDONLY &#x3D; TRUE,
    COMPRESSLEVEL &#x3D; 5,
    ORIENTATION &#x3D; COLUMN,
    COMPRESSTYPE &#x3D; ZLIB
) AS SELECT
    *
FROM
    (
        SELECT
            a.*,
            z.scan_site AS sffb_id,  -- 始发分拨
            x.scan_site AS mdfb_id,  -- 目的站点
            ROW_NUMBER () OVER (
                PARTITION BY a.ship_id
                ORDER BY
                    z.ins_db_tm ASC, -- 装车取最早
                    x.ins_db_tm DESC -- 卸车取最晚
            ) AS rn1
        FROM
            test_jibao as a
        LEFT JOIN tb_scan as z on z.ship_id &#x3D; a.ship_id   -- 装车
            AND z.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;
            AND z.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;
            AND z.scan_typ &#x3D; &#39;97&#39;
        LEFT JOIN tb_scan as x on x.ship_id &#x3D; a.ship_id   -- 卸车
            AND x.ins_db_tm &gt;&#x3D; &#39;2021-08-23 00:00:00&#39;
            AND x.ins_db_tm &lt; &#39;2021-09-02 00:00:00&#39;
            AND x.scan_typ &#x3D; &#39;96&#39;
    ) AS T
WHERE
    T.rn1 &#x3D; 1
DISTRIBUTED BY (tm);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">SELECT 37564347
Time: 100181.922 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="压缩表的影响"><a href="#压缩表的影响" class="headerlink" title="压缩表的影响"></a>压缩表的影响</h3><p>压缩表的好处是，由于压缩，体积减少，能减少磁盘io，另外，列存储，非常适合数仓这种类型。</p>
<p>实验证明，写到压缩表内，并不会增加消耗的时间。</p>
<h4 id="压缩表"><a href="#压缩表" class="headerlink" title="压缩表"></a>压缩表</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_scan_fen<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_scan_fen <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    ship_id<span class="token punctuation">,</span>
    scan_site<span class="token punctuation">,</span>
    <span class="token comment">-- scan_emp,字段更换为  delv_emp</span>
    delv_emp<span class="token punctuation">,</span>
    scan_tm<span class="token punctuation">,</span>
    rmk_inf<span class="token punctuation">,</span>
    <span class="token comment">-- 备注派送码</span>
    <span class="token keyword">CASE</span>
    <span class="token keyword">WHEN</span> rmk_inf SIMILAR <span class="token keyword">to</span> <span class="token string">'[a-zA-Z0-9]&#123;2&#125;'</span> <span class="token keyword">THEN</span>
        rmk_inf
    <span class="token keyword">ELSE</span>
        <span class="token boolean">null</span>
    <span class="token keyword">END</span> <span class="token keyword">AS</span> mark_code<span class="token punctuation">,</span>
    <span class="token comment">-- 备注派送码是否为机动,是否XYWZ开头</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span>  CHAR_LENGTH <span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'X'</span> <span class="token operator">or</span> <span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'Y'</span> <span class="token operator">or</span> <span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'W'</span> <span class="token operator">or</span> <span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'Z'</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        <span class="token number">1</span>
    <span class="token keyword">else</span> 
        <span class="token number">0</span>
    <span class="token keyword">end</span> <span class="token keyword">as</span> is_var_code
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            ship_id<span class="token punctuation">,</span>
            scan_site<span class="token punctuation">,</span>
            <span class="token comment">--  scan_emp,</span>
            delv_emp<span class="token punctuation">,</span>
            scan_tm<span class="token punctuation">,</span>
            rmk_inf<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    scan_tm <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tb_scan
        <span class="token keyword">WHERE</span>
            ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-17 00:00:00'</span>
        <span class="token operator">AND</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-08-27 00:00:00'</span>
        <span class="token operator">AND</span> scan_typ <span class="token operator">=</span> <span class="token string">'24'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">483512499</span>
<span class="token keyword">Time</span>: <span class="token number">217465.246</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="普通表"><a href="#普通表" class="headerlink" title="普通表"></a>普通表</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_scan_fen<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_scan_fen <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
    ship_id<span class="token punctuation">,</span>
    scan_site<span class="token punctuation">,</span>
    <span class="token comment">-- scan_emp,字段更换为  delv_emp</span>
    delv_emp<span class="token punctuation">,</span>
    scan_tm<span class="token punctuation">,</span>
    rmk_inf<span class="token punctuation">,</span>
    <span class="token comment">-- 备注派送码</span>
    <span class="token keyword">CASE</span>
    <span class="token keyword">WHEN</span> rmk_inf SIMILAR <span class="token keyword">to</span> <span class="token string">'[a-zA-Z0-9]&#123;2&#125;'</span> <span class="token keyword">THEN</span>
        rmk_inf
    <span class="token keyword">ELSE</span>
        <span class="token boolean">null</span>
    <span class="token keyword">END</span> <span class="token keyword">AS</span> mark_code<span class="token punctuation">,</span>
    <span class="token comment">-- 备注派送码是否为机动,是否XYWZ开头</span>
    <span class="token keyword">case</span> <span class="token keyword">when</span>  CHAR_LENGTH <span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">and</span> <span class="token punctuation">(</span><span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'X'</span> <span class="token operator">or</span> <span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'Y'</span> <span class="token operator">or</span> <span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'W'</span> <span class="token operator">or</span> <span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'Z'</span><span class="token punctuation">)</span> <span class="token keyword">then</span>
        <span class="token number">1</span>
    <span class="token keyword">else</span> 
        <span class="token number">0</span>
    <span class="token keyword">end</span> <span class="token keyword">as</span> is_var_code
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            ship_id<span class="token punctuation">,</span>
            scan_site<span class="token punctuation">,</span>
            <span class="token comment">--  scan_emp,</span>
            delv_emp<span class="token punctuation">,</span>
            scan_tm<span class="token punctuation">,</span>
            rmk_inf<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    scan_tm <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tb_scan
        <span class="token keyword">WHERE</span>
            ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-17 00:00:00'</span>
        <span class="token operator">AND</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-08-27 00:00:00'</span>
        <span class="token operator">AND</span> scan_typ <span class="token operator">=</span> <span class="token string">'24'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">483512499</span>
<span class="token keyword">Time</span>: <span class="token number">209393.916</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_scan_fen<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>EsRROR:  “test_scan_fen” is not a view<br>HINT:  Use DROP TABLE to remove a table, DROP EXTERNAL TABLE if external, or DROP FOREIGN TABLE if foreign.</p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">CREATE VIEW test_scan_fen AS SELECT<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>relation “test_scan_fen” already exists</p>
</blockquote>
<p>通过上面的例子发现，其实视图，跟表有点像。</p>
<pre class="line-numbers language-none"><code class="language-none">DROP VIEW IF EXISTS test_scan_fen;
CREATE VIEW test_scan_fen AS
SELECT
   ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建视图很快。只是存储了sql。并不会实际执行。</p>
<h3 id="创建视图，一次计算"><a href="#创建视图，一次计算" class="headerlink" title="创建视图，一次计算"></a>创建视图，一次计算</h3><p>具体见<code>sql/table_job.sql</code>、<code>sql/view_job.sql</code>。</p>
<p>视图约占 77%，速度有提升，但是貌似并不大。</p>
<pre class="line-numbers language-none"><code class="language-none">test_scan_qian;   改为view
test_scan_fen;    改为view
test_scan_lan;    改为view
test_doc;         改为view
test_scan_doc;    不变，输出表格。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>视图方式</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 50196784
Time: 1717532.500 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>直接计算方式。</p>
<pre class="line-numbers language-none"><code class="language-none">16：12开始  至 16：50  大概38分钟。

2208822

SELECT 50196784
Time: 39995.549 ms
psql:&#x2F;yd&#x2F;table_job.sql:49: NOTICE:  table &quot;test_scan_fen&quot; does not exist, skipping
DROP TABLE
Time: 0.843 ms
SELECT 483512499
Time: 248721.958 ms
psql:&#x2F;yd&#x2F;table_job.sql:102: NOTICE:  table &quot;test_scan_lan&quot; does not exist, skipping
DROP TABLE
Time: 0.731 ms
SELECT 1506757081
Time: 700615.860 ms
psql:&#x2F;yd&#x2F;table_job.sql:135: NOTICE:  table &quot;test_doc&quot; does not exist, skipping
DROP TABLE
Time: 0.663 ms
SELECT 1531072496
Time: 1022834.503 ms
DROP TABLE
Time: 24.487 ms
SELECT 50196784
Time: 196633.527 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="csv文件导入核对"><a href="#csv文件导入核对" class="headerlink" title="csv文件导入核对"></a>csv文件导入核对</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 查看此时的文件占用</span>
<span class="token function">du</span> -sh
<span class="token comment"># 查看总行数，导出的cvs文件，是pdo.fetch->fputcsv直接写的,没有表头，但是有最后的空行</span>
<span class="token comment"># 该方法并不一定总是很准，误差可能来源与，字段中如过有空行，可能会被误识别</span>
<span class="token function">cat</span> marked_ship_20210*<span class="token operator">|</span><span class="token function">wc</span> -l  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>psql操作</p>
<blockquote>
<p>查看总条数是否一致，查看1条记录是否正常</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> marked_ship <span class="token keyword">where</span> insert_db_date <span class="token operator">>=</span> <span class="token string">'2021-07-11'</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> marked_ship <span class="token keyword">where</span> insert_db_date <span class="token operator">>=</span> <span class="token string">'2021-07-11'</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>核对一致，则可删除文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">rm</span> -f marked_ship_20210* 
<span class="token function">du</span> -sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="in-exists-join性能对比"><a href="#in-exists-join性能对比" class="headerlink" title="in/exists/join性能对比"></a>in/exists/join性能对比</h3><p>test_scan_qian 大表，大概5000万数据。</p>
<p>i1_record 相当来讲是个小表，但是重复的数据比较多。20310127</p>
<ul>
<li><p>join</p>
<p>据说，一般能用子查询的，都能换成join方式</p>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> i1_record_unqi<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> i1_record_unqi <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            i<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> 
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> i<span class="token punctuation">.</span>ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                batch_time <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            i1_record <span class="token keyword">as</span> i
        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> i<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'2021-08-23'</span>
        <span class="token keyword">WHERE</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
    <span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>SELECT 11620<br>Time: 48267.562 ms</p>
</blockquote>
<ul>
<li>in</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> i1_record_unqi<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> i1_record_unqi <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            i<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> 
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> i<span class="token punctuation">.</span>ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                batch_time <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            i1_record <span class="token keyword">as</span> i
        <span class="token keyword">where</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'2021-08-23'</span>
            <span class="token operator">and</span> ship_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id <span class="token keyword">from</span> test_scan_qian <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>SELECT 11620<br>Time: 50033.728 ms</p>
</blockquote>
<ul>
<li>exists</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> i1_record_unqi<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> i1_record_unqi <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            i<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> 
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> i<span class="token punctuation">.</span>ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                batch_time <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            i1_record <span class="token keyword">as</span> i
        <span class="token keyword">where</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'2021-08-23'</span>
            <span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> <span class="token keyword">from</span> test_scan_qian <span class="token keyword">where</span> ship_id <span class="token operator">=</span> i<span class="token punctuation">.</span>ship_id <span class="token punctuation">)</span>
    <span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>SELECT 11620<br>Time: 51298.095 ms</p>
</blockquote>
<p>备注：有的时候，添加条件，反而速度还快一点。如去掉下面的where条件，速度反而还慢一些。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">as</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> i<span class="token punctuation">.</span>ship_id <span class="token operator">and</span> i<span class="token punctuation">.</span>batch_time <span class="token operator">>=</span> <span class="token string">'2021-08-23'</span>
        <span class="token comment">-- WHERE q.ship_id IS NOT NULL</span>
        
<span class="token keyword">SELECT</span> <span class="token number">1971098</span>
<span class="token keyword">Time</span>: <span class="token number">62557.812</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>扩展：发现除了前面3种语法，还有其他类型的子查询。</p>
<p>子查询1</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span>
    a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span> <span class="token keyword">select</span> aid <span class="token keyword">from</span> b <span class="token keyword">where</span> b<span class="token punctuation">.</span>aid<span class="token operator">=</span>a<span class="token punctuation">.</span>id <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> aid 
  <span class="token keyword">from</span> a
<span class="token punctuation">)</span> <span class="token keyword">as</span> t
<span class="token keyword">where</span> t<span class="token punctuation">.</span>aid <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>子查询2：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> a <span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token keyword">select</span> aid <span class="token keyword">from</span> b <span class="token keyword">where</span> b<span class="token punctuation">.</span>aid<span class="token operator">=</span>a<span class="token punctuation">.</span>id <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">is</span> <span class="token boolean">null</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<h3 id="日期统计"><a href="#日期统计" class="headerlink" title="日期统计"></a>日期统计</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> to_char<span class="token punctuation">(</span>store_time::<span class="token keyword">timestamp</span><span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_doc <span class="token keyword">group</span> <span class="token keyword">by</span> to_char<span class="token punctuation">(</span>store_time::<span class="token keyword">timestamp</span><span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> to_char<span class="token punctuation">(</span>store_time::<span class="token keyword">timestamp</span><span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 简写</span>
<span class="token keyword">select</span> to_char<span class="token punctuation">(</span>store_time::<span class="token keyword">timestamp</span><span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_doc <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- 不知道为什么，自己总喜欢写成嵌套的形式    可能数据量太小，耗时跟上面两种差不多。</span>
<span class="token keyword">select</span> dt<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> to_char<span class="token punctuation">(</span>store_time::<span class="token keyword">timestamp</span><span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dt <span class="token keyword">from</span> test_doc<span class="token punctuation">)</span> t <span class="token keyword">group</span> <span class="token keyword">by</span> dt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="时间大概统计"><a href="#时间大概统计" class="headerlink" title="时间大概统计"></a>时间大概统计</h3><p>分发：200多秒，取5亿数据，并取出6个字段，并完成计算字段，去重。（+联表条件，能降到94秒）</p>
<p>签收：600秒，取15亿数据，大致取4个字段。并完成去重。</p>
<p>（增加联表条件，时间降到一半）</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 55019979
Time: 227152.571 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>录单：960秒，取15亿数据。</p>
<p>（增加联表条件，时间降到1/4，说明扫描耗时，但是取字段更耗时。）</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 55351804
Time: 236165.105 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样，几个大表再联合的时候，源数据量少了很多，估计联表也快不少。</p>
<p>三表联合，由200秒，降低到到1/4。（有两张表同时从15亿降到了0.5亿的水平）</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 55415034
Time: 48538.021 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>其实，再次优化，能将多表的扫描过程，最好一次完成，估计时间会降低，但是如何实现？自己写函数？增加索引？自己写复杂的联合sql？</p>
<p>所以，目标数据5000万左右，如果中间数据超过这个数很多倍，那么，就是有问题。都能使用联表的方式，降低中间的输出总量。</p>
<h3 id="统计各个层次的数量"><a href="#统计各个层次的数量" class="headerlink" title="统计各个层次的数量"></a>统计各个层次的数量</h3><p>其实，下面可以直接用普通的取整之类的运算符，来解决。如果按0.01精度来分区，那岂不是还要写上一100个<code>when</code>。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">case</span> 
    <span class="token keyword">when</span> i1l_ftconfid <span class="token operator">=</span> <span class="token string">''</span> <span class="token keyword">then</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">1.1</span> <span class="token keyword">then</span> <span class="token number">1.1</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token number">1</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.9</span> <span class="token keyword">then</span> <span class="token number">0.9</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.8</span> <span class="token keyword">then</span> <span class="token number">0.8</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.7</span> <span class="token keyword">then</span> <span class="token number">0.7</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.6</span> <span class="token keyword">then</span> <span class="token number">0.6</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.5</span> <span class="token keyword">then</span> <span class="token number">0.5</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.4</span> <span class="token keyword">then</span> <span class="token number">0.4</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.3</span> <span class="token keyword">then</span> <span class="token number">0.3</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.2</span> <span class="token keyword">then</span> <span class="token number">0.2</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0.1</span> <span class="token keyword">then</span> <span class="token number">0.1</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token keyword">then</span> <span class="token number">0</span>
    <span class="token keyword">else</span> 
    <span class="token operator">-</span><span class="token number">1</span>
 <span class="token keyword">end</span> <span class="token keyword">as</span> possible
<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> test_data_uniq_20210831 
<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本来想进一步增加百分比的信息，但是，如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> possible<span class="token punctuation">,</span>cnt<span class="token punctuation">,</span><span class="token punctuation">(</span>cnt::<span class="token keyword">numeric</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">)</span>::<span class="token keyword">numeric</span> <span class="token keyword">from</span> 
<span class="token punctuation">(</span> 上面的语句 <span class="token punctuation">)</span> t  <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>报错信息如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">column</span> <span class="token string">"t.possible"</span> must appear <span class="token operator">in</span> the <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> clause <span class="token operator">or</span> be used <span class="token operator">in</span> an aggregate <span class="token keyword">function</span>
LINE <span class="token number">1</span>: <span class="token keyword">select</span> possible<span class="token punctuation">,</span>cnt<span class="token punctuation">,</span>cnt::<span class="token keyword">numeric</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span> <span class="token keyword">from</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>原因：就是因为增加了聚集函数sum，就报错。不知道到为何。</p>
<h3 id="去重条件"><a href="#去重条件" class="headerlink" title="去重条件"></a>去重条件</h3><p>最开始写的sql如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 集包信息,tm可能是大包号、运单号</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_jibao<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_jibao <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            <span class="token keyword">case</span> <span class="token keyword">when</span> j<span class="token punctuation">.</span>grp_ship_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> j<span class="token punctuation">.</span>grp_ship_id <span class="token keyword">else</span> a<span class="token punctuation">.</span>ship_id <span class="token keyword">end</span> <span class="token keyword">as</span> tm<span class="token punctuation">,</span>  <span class="token comment">-- 确定装卸车查找的 号（大包号优先于运单号）</span>
            a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
            j<span class="token punctuation">.</span>grp_ship_id <span class="token keyword">AS</span> pac_id<span class="token punctuation">,</span> <span class="token comment">--大包号</span>
            j<span class="token punctuation">.</span>scan_tm <span class="token keyword">AS</span> pac_time<span class="token punctuation">,</span>
            j<span class="token punctuation">.</span>scan_site <span class="token keyword">AS</span> pac_sitecode<span class="token punctuation">,</span> 
            <span class="token keyword">CASE</span>
            <span class="token keyword">WHEN</span> j<span class="token punctuation">.</span>scan_typ <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span> <span class="token string">'03'</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
                <span class="token string">'分拨集包'</span>
            <span class="token keyword">WHEN</span> j<span class="token punctuation">.</span>scan_typ <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'5'</span><span class="token punctuation">,</span> <span class="token string">'05'</span><span class="token punctuation">)</span> <span class="token keyword">THEN</span>
                <span class="token string">'网点集包'</span>
            <span class="token keyword">END</span> <span class="token keyword">AS</span> pac_class<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> j<span class="token punctuation">.</span>ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    j<span class="token punctuation">.</span>ins_db_tm <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            test_scan_qian <span class="token keyword">as</span> a
        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tb_scan <span class="token keyword">as</span> j <span class="token keyword">on</span> j<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
        <span class="token keyword">WHERE</span>
            j<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-26 00:00:00'</span>
        <span class="token operator">AND</span> j<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-05 00:00:00'</span>
        <span class="token operator">AND</span> j<span class="token punctuation">.</span>scan_typ <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">,</span><span class="token string">'03'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">,</span><span class="token string">'05'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>





<span class="token comment">-- 装97、卸96车信息</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_zhuangxie<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_zhuangxie <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span>
            z<span class="token punctuation">.</span>scan_site <span class="token keyword">AS</span> sffb_id<span class="token punctuation">,</span>  <span class="token comment">-- 始发分拨</span>
            x<span class="token punctuation">.</span>scan_site <span class="token keyword">AS</span> mdfb_id<span class="token punctuation">,</span>  <span class="token comment">-- 目的站点</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> a<span class="token punctuation">.</span>ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    z<span class="token punctuation">.</span>ins_db_tm <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token comment">-- 装车取最早</span>
                    x<span class="token punctuation">.</span>ins_db_tm <span class="token keyword">DESC</span> <span class="token comment">-- 卸车取最晚</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn1
        <span class="token keyword">FROM</span>
            test_jibao <span class="token keyword">as</span> a
        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tb_scan <span class="token keyword">as</span> z <span class="token keyword">on</span> z<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id   <span class="token comment">-- 装车</span>
            <span class="token operator">AND</span> z<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-26 00:00:00'</span>
            <span class="token operator">AND</span> z<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-05 00:00:00'</span>
            <span class="token operator">AND</span> z<span class="token punctuation">.</span>scan_typ <span class="token operator">=</span> <span class="token string">'97'</span>
        <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> tb_scan <span class="token keyword">as</span> x <span class="token keyword">on</span> x<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id   <span class="token comment">-- 卸车</span>
            <span class="token operator">AND</span> x<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-26 00:00:00'</span>
            <span class="token operator">AND</span> x<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-05 00:00:00'</span>
            <span class="token operator">AND</span> x<span class="token punctuation">.</span>scan_typ <span class="token operator">=</span> <span class="token string">'96'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T<span class="token punctuation">.</span>rn1 <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面主表<code>test_scan_qian</code>结果过滤，数据变少了，跟最开始写的有出入。而且经过运算后的，<code>tm</code>，可能有重复，下一次联表的时候，可能也不好弄。</p>
<p>主表qian没有重复，但是呢，优先用大包号、其次是运单号，去联，集包信息的表，（而集包信息，本身也可能会有重复，所以呢，第一步，先让集包信息唯一），假设，集包信息已经唯一呢，那么，此时，再用qian按前面的条件去联集包信息，只是联表的字段，可能不确定。假设qian的联表字段已经确定，那么，势必会有qian的联表字段重复的情形。所以，确定的顺序是：</p>
<ul>
<li>集包先单独去重</li>
<li>计算qian的联表字段，并按联表字段，重分布。</li>
<li>将集包跟 新签 进行联表。</li>
<li>将上述联表后的结果，重新按qian的主键，来处理。</li>
</ul>
<p>减少步骤的方式是，动态计算联表字段。尽量每一步，处理各自的逻辑。比如，先去重，而不是联表后，再去重，这样可能导致结果跟预期不一样。</p>
<p>换一种思路，qian表，有大包号按大包处理，没有打包，则按运单处理，然后呢，</p>
<h3 id="一次错误的sql，查非分布键"><a href="#一次错误的sql，查非分布键" class="headerlink" title="一次错误的sql，查非分布键"></a>一次错误的sql，查非分布键</h3><pre class="line-numbers language-none"><code class="language-none">select 
develop-# ship_id,
develop-# grp_ship_id,
develop-# rmk_id,
develop-# rmk_inf,
develop-# scan_site,
develop-# fst_scan_site,
develop-# pre_scan_site,
develop-# nxt_scan_site,
develop-# scan_typ,
develop-# scan_tm,
develop-# ins_db_tm
develop-# from tb_scan 
develop-# where ins_db_tm &gt;&#x3D;&#39;2021-09-01&#39; and ins_db_tm &lt; &#39;2021-09-06&#39; and ship_id &#x3D; &#39;1202767564898&#39; or grp_ship_id &#x3D; &#39;9401966434871&#39;
develop-# order by ins_db_tm;
^CCancel request sent
ERROR:  canceling statement due to user request
Time: 434568.440 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">select 
ship_id,
grp_ship_id,
rmk_id,
rmk_inf,
scan_site,
fst_scan_site,
pre_scan_site,
nxt_scan_site,
scan_typ,
scan_tm,
ins_db_tm
from tb_scan 
where ins_db_tm &gt;&#x3D;&#39;2021-09-01&#39; and ins_db_tm &lt; &#39;2021-09-06&#39; and ship_id in (&#39;1202767564898&#39;,&#39;9401966434871&#39;)
order by ins_db_tm;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-none"><code class="language-none">Time: 36705.112 ms<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>差别非常的明显，查询分布键，非常的快，但是如果增加了非分布键，则出奇的慢。（猜测）</p>
<p>以下的主键，存在计算字段，相当于查询了非分布键，但是性能也还好。</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT
    *
FROM
    (
        SELECT
            a.*,
            z.scan_site AS sffb_id,  -- 始发分拨
            x.scan_site AS mdfb_id,  -- 目的站点
            ROW_NUMBER () OVER (
                PARTITION BY a.ship_id
                ORDER BY
                    z.ins_db_tm ASC, -- 装车取最早
                    x.ins_db_tm DESC -- 卸车取最晚
            ) AS rn1
        FROM
            test_jibao as a
        LEFT JOIN tb_scan as z on z.ship_id &#x3D; (case when a.pac_id is not null then a.pac_id else a.ship_id end )   -- 装车
            AND z.ins_db_tm &gt;&#x3D; &#39;2021-08-26 00:00:00&#39;
            AND z.ins_db_tm &lt; &#39;2021-09-06 00:00:00&#39;
            AND z.scan_typ &#x3D; &#39;97&#39;
        LEFT JOIN tb_scan as x on x.ship_id &#x3D; (case when a.pac_id is not null then a.pac_id else a.ship_id end )   -- 卸车
            AND x.ins_db_tm &gt;&#x3D; &#39;2021-08-26 00:00:00&#39;
            AND x.ins_db_tm &lt; &#39;2021-09-06 00:00:00&#39;
            AND x.scan_typ &#x3D; &#39;96&#39;
    ) AS T
WHERE
    T.rn1 &#x3D; 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="分组的计算字段"><a href="#分组的计算字段" class="headerlink" title="分组的计算字段"></a>分组的计算字段</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> pac_pre<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_zhuangxie <span class="token keyword">group</span> <span class="token keyword">by</span> substring<span class="token punctuation">(</span>pac_id <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">2</span><span class="token punctuation">)</span> pac_pre<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>正确的使用引用字段：</p>
<blockquote>
<p>gp下可以正常用。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> substring<span class="token punctuation">(</span>pac_id <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pac_pre<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> test_zhuangxie <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">-- 写字段名也是可以的</span>
<span class="token keyword">select</span> substring<span class="token punctuation">(</span>pac_id <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pac_pre<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> test_zhuangxie <span class="token keyword">group</span> <span class="token keyword">by</span> pac_pre <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<p>clickhouse 却能这样用？？？？</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    deploy<span class="token punctuation">,</span>
    fullurl<span class="token punctuation">,</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> count
<span class="token keyword">FROM</span> ncompaas6rows
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> temp_target_ip <span class="token keyword">ON</span> ncompaas6rows<span class="token punctuation">.</span>dest_ip <span class="token operator">=</span><span class="token operator">=</span> temp_target_ip<span class="token punctuation">.</span>ip <span class="token operator">AND</span> ncompaas6rows<span class="token punctuation">.</span>dest_port <span class="token operator">=</span><span class="token operator">=</span> temp_target_ip<span class="token punctuation">.</span>port
<span class="token keyword">WHERE</span> temp_target_ip<span class="token punctuation">.</span>ip <span class="token operator">!=</span> <span class="token string">''</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
replaceRegexpOne<span class="token punctuation">(</span>
    replaceRegexpOne<span class="token punctuation">(</span><span class="token string">'http://'</span> <span class="token operator">||</span> hostname <span class="token operator">||</span> url<span class="token punctuation">,</span> <span class="token string">'[?&amp;].*$'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'/\\d&#123;&#123;11,15&#125;&#125;($|/.*$)'</span><span class="token punctuation">,</span>
    <span class="token string">''</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> fullurl<span class="token punctuation">,</span>
deploy <span class="token keyword">AS</span> deploy
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 
    deploy <span class="token keyword">ASC</span><span class="token punctuation">,</span>
    count <span class="token keyword">DESC</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="压缩率"><a href="#压缩率" class="headerlink" title="压缩率"></a>压缩率</h3><p>大概3.3倍的压缩率。</p>
<blockquote>
<p>下面select命令用在分区表上，好像并不行。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 37GB 5000万</span>
<span class="token keyword">select</span> pg_size_pretty<span class="token punctuation">(</span>pg_relation_size<span class="token punctuation">(</span><span class="token string">'public.test_data_uniq_20210907'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 123G</span>
ls <span class="token operator">-</span>lh  导出的csv文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="创建视图，会产生依赖，导致原来的表无法直接删除"><a href="#创建视图，会产生依赖，导致原来的表无法直接删除" class="headerlink" title="创建视图，会产生依赖，导致原来的表无法直接删除"></a>创建视图，会产生依赖，导致原来的表无法直接删除</h3><p>直接使用drop table 无法删除掉。注意……</p>
<pre class="line-numbers language-none"><code class="language-none">psql:fetch.sql:14: ERROR:  cannot drop append only columnar table test_scan_qian because other objects depend on it
DETAIL:  view mytestss2_view depends on append only columnar table test_scan_qian
HINT:  Use DROP ... CASCADE to drop the dependent objects too.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="扫描轨迹问题"><a href="#扫描轨迹问题" class="headerlink" title="扫描轨迹问题"></a>扫描轨迹问题</h3><ul>
<li>分拨</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">create table test_fenbo as select mc,bm,lb from gs where bm  in (select distinct zzz from wdzzz_cw );<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>查1天的数据，数据量虽然不多，但是呢，时间慢</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_guiji<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_guiji <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span>  <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>scan_site
        <span class="token keyword">FROM</span>
            tb_scan <span class="token keyword">AS</span> a
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">AS</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_fenbo <span class="token keyword">AS</span> f <span class="token keyword">ON</span> f<span class="token punctuation">.</span>bm::<span class="token keyword">text</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site
        <span class="token keyword">WHERE</span>
            a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-09-15'</span>
        <span class="token operator">AND</span> a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-16'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">56093895</span>
<span class="token keyword">Time</span>: <span class="token number">194421.786</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>查10天的数据，范围变长了，但是呢，增加了另外一个类型字段来过滤，即，不需要联表，就能过滤掉数据。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_guiji2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_guiji2 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span>  <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>scan_site
        <span class="token keyword">FROM</span>
            tb_scan <span class="token keyword">AS</span> a
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">AS</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_fenbo <span class="token keyword">AS</span> f <span class="token keyword">ON</span> f<span class="token punctuation">.</span>bm::<span class="token keyword">text</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site
        <span class="token keyword">WHERE</span>
            a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-09-05'</span>
        <span class="token operator">AND</span> a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-16'</span>
        <span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_typ <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span><span class="token string">'14'</span><span class="token punctuation">,</span><span class="token string">'24'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">155809387</span>
<span class="token keyword">Time</span>: <span class="token number">277863.165</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>增加到30天，再测试。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_guiji2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_guiji2 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span>  <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
            a<span class="token punctuation">.</span>scan_site
        <span class="token keyword">FROM</span>
            tb_scan <span class="token keyword">AS</span> a
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">AS</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
        <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_fenbo <span class="token keyword">AS</span> f <span class="token keyword">ON</span> f<span class="token punctuation">.</span>bm::<span class="token keyword">text</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site
        <span class="token keyword">WHERE</span>
            a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-15'</span>
        <span class="token operator">AND</span> a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-16'</span>
        <span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_typ <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span><span class="token string">'14'</span><span class="token punctuation">,</span><span class="token string">'24'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>时间增加3倍，估计3倍时间<br>实际上并没有。这个时间，还算能接受。但是不清楚数据质量怎样。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">156105801</span>
<span class="token keyword">Time</span>: <span class="token number">467436.559</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h3><ul>
<li>简单的中文测试</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> test_ch<span class="token punctuation">(</span>addr <span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> $$
<span class="token keyword">return</span> <span class="token string">'河南'</span>
$$<span class="token keyword">LANGUAGE</span> plpythonu<span class="token punctuation">;</span>
<span class="token keyword">select</span> test_ch<span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>python正则测试</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> test_ch<span class="token punctuation">(</span>addr <span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> $$
<span class="token keyword">import</span> re
pat <span class="token operator">=</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'.&#123;1,5&#125;省'</span><span class="token punctuation">)</span>

sch <span class="token operator">=</span> pat<span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token string">''</span>
$$<span class="token keyword">LANGUAGE</span> plpythonu<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>发现并不行</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> test_ch<span class="token punctuation">(</span><span class="token string">'河南'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">select</span> test_ch<span class="token punctuation">(</span><span class="token string">'湖南省'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>正则测试 -  观察组1</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> parse_addr<span class="token punctuation">(</span>addr <span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> $$
<span class="token comment">#coding=utf-8</span>
<span class="token keyword">if</span> <span class="token string">'pattn'</span> <span class="token operator">not</span> <span class="token operator">in</span> GD:
    <span class="token keyword">import</span> re
    pattn <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    pattn<span class="token punctuation">.</span>append<span class="token punctuation">(</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'(.*省)(.*市)(.*区)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pattn<span class="token punctuation">.</span>append<span class="token punctuation">(</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'(.*省)(.*市)(.*县)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pattn<span class="token punctuation">.</span>append<span class="token punctuation">(</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'(.*省)(.*市)(.*市)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    GD<span class="token punctuation">[</span><span class="token string">'pattn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pattn
pat <span class="token operator">=</span> GD<span class="token punctuation">[</span><span class="token string">'pattn'</span><span class="token punctuation">]</span>
sch <span class="token operator">=</span> pat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
sch <span class="token operator">=</span> pat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
sch <span class="token operator">=</span> pat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token string">''</span>
$$<span class="token keyword">LANGUAGE</span> plpythonu<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>导入函数，所有的观察组都使用下面的方式，来进行计算。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_parse_addr<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_parse_addr <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> doc_sn<span class="token punctuation">,</span>recv_addr<span class="token punctuation">,</span> parse_addr<span class="token punctuation">(</span>recv_addr<span class="token punctuation">)</span> <span class="token keyword">from</span> tu_doc_info <span class="token keyword">where</span> dtime <span class="token operator">>=</span> <span class="token string">'2021-09-16'</span> <span class="token operator">and</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-09-17'</span> <span class="token operator">and</span> recv_addr <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>注意：recv_addr is not null，目的是：防止调用时，null的错误</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">80780849</span>
<span class="token keyword">Time</span>: <span class="token number">58160.892</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>貌似性能还可以，即python参与运算，貌似不太会拖慢性能。</p>
<ul>
<li>正则测试 -  观察组2</li>
</ul>
<p>取消贪婪匹配模式，因为不支持  .{1,5}语法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> parse_addr<span class="token punctuation">(</span>addr <span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">text</span> <span class="token keyword">AS</span> $$
<span class="token comment">#coding=utf-8</span>
<span class="token keyword">if</span> <span class="token string">'pattn'</span> <span class="token operator">not</span> <span class="token operator">in</span> GD:
    <span class="token keyword">import</span> re
    pattn <span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    pattn<span class="token punctuation">.</span>append<span class="token punctuation">(</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'(.*?省)(.*?市)(.*?区)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pattn<span class="token punctuation">.</span>append<span class="token punctuation">(</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'(.*?省)(.*?市)(.*?县)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    pattn<span class="token punctuation">.</span>append<span class="token punctuation">(</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'(.*?省)(.*?市)(.*?市)'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    GD<span class="token punctuation">[</span><span class="token string">'pattn'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pattn
pat <span class="token operator">=</span> GD<span class="token punctuation">[</span><span class="token string">'pattn'</span><span class="token punctuation">]</span>
sch <span class="token operator">=</span> pat<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
sch <span class="token operator">=</span> pat<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
sch <span class="token operator">=</span> pat<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>search<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># search</span>
<span class="token keyword">if</span> sch <span class="token operator">and</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>:
    <span class="token keyword">return</span> sch<span class="token punctuation">.</span><span class="token keyword">group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token string">''</span>
$$<span class="token keyword">LANGUAGE</span> plpythonu<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>结果：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 一样的测试语句</span>

<span class="token keyword">SELECT</span> <span class="token number">80780849</span>
<span class="token keyword">Time</span>: <span class="token number">165485.472</span> ms

<span class="token comment">-- 第二遍</span>
<span class="token keyword">SELECT</span> <span class="token number">80780849</span>
<span class="token keyword">Time</span>: <span class="token number">161170.369</span> ms

<span class="token comment">-- 第三遍再复测原来的脚本，说明函数的功能……</span>
<span class="token keyword">SELECT</span> <span class="token number">80780849</span>
<span class="token keyword">Time</span>: <span class="token number">62675.341</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>貌似，正则对整个结果影响还是挺大的。</p>
<h3 id="测试in、跟联表、python函数、sql函数的差距"><a href="#测试in、跟联表、python函数、sql函数的差距" class="headerlink" title="测试in、跟联表、python函数、sql函数的差距"></a>测试in、跟联表、python函数、sql函数的差距</h3><p>结论：使用in、INNER JOIN这种反查询，效率成本差不多。因为in的子查询非常小。python在量非常大的情况下，效率低不少。非必要，不用。最奇葩的是，具体值放入到 in 内，居然总量不对，时间还长……。故，sql可能更擅长做联表这种运算。</p>
<ul>
<li>基础，先准备相关的数据。</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_guiji_view<span class="token punctuation">;</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_fenbo<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_fenbo <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    mc<span class="token punctuation">,</span>
    bm::<span class="token keyword">text</span> <span class="token keyword">as</span> bm<span class="token punctuation">,</span>
    lb
<span class="token keyword">FROM</span>
    gs
<span class="token keyword">WHERE</span>
    bm <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> zzz <span class="token keyword">FROM</span> wdzzz_cw
    <span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="INNER-JOIN的方式"><a href="#INNER-JOIN的方式" class="headerlink" title="INNER JOIN的方式"></a>INNER JOIN的方式</h4><blockquote>
<p>联的是一张小表</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> tmp_guiji<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tmp_guiji <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
    a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>scan_site<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>ins_db_tm
<span class="token keyword">FROM</span>
    tb_scan <span class="token keyword">AS</span> a
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">AS</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_fenbo <span class="token keyword">AS</span> f <span class="token keyword">ON</span> f<span class="token punctuation">.</span>bm <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site
<span class="token keyword">WHERE</span>
    a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-18 00:00:00'</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-18 00:00:00'</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_typ <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span><span class="token string">'14'</span><span class="token punctuation">,</span><span class="token string">'24'</span><span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">156322459</span>
<span class="token keyword">Time</span>: <span class="token number">328684.450</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="in子查询方式"><a href="#in子查询方式" class="headerlink" title="in子查询方式"></a>in子查询方式</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> tmp_guiji<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tmp_guiji <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
    a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>scan_site<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>ins_db_tm
<span class="token keyword">FROM</span>
    tb_scan <span class="token keyword">AS</span> a
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">AS</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
 
<span class="token keyword">WHERE</span>
    a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-18 00:00:00'</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-18 00:00:00'</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_typ <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span><span class="token string">'14'</span><span class="token punctuation">,</span><span class="token string">'24'</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_site <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> bm <span class="token keyword">FROM</span> test_fenbo<span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">156322459</span>
<span class="token keyword">Time</span>: <span class="token number">321444.458</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="in，代入具体值"><a href="#in，代入具体值" class="headerlink" title="in，代入具体值"></a>in，代入具体值</h4><p>求解代入值的时候，使用<code>select string_agg(bm,&#39;#&#39;) from test_fenbo;</code>，然后自己手工再替换<code>#</code>为<code>&#39;,&#39;</code>，为啥要这么麻烦呢？是因为转义的原因……</p>
<p>其实我感觉，应该性能是差不多，如果比之前查多了，那就说明，in用的是数组遍历。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> tmp_guiji<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tmp_guiji <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
    a<span class="token punctuation">.</span>ship_id<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>scan_site<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>ins_db_tm
<span class="token keyword">FROM</span>
    tb_scan <span class="token keyword">AS</span> a
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> test_scan_qian <span class="token keyword">AS</span> q <span class="token keyword">ON</span> q<span class="token punctuation">.</span>ship_id <span class="token operator">=</span> a<span class="token punctuation">.</span>ship_id
 
<span class="token keyword">WHERE</span>
    a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-18 00:00:00'</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-18 00:00:00'</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_typ <span class="token operator">not</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'10'</span><span class="token punctuation">,</span><span class="token string">'14'</span><span class="token punctuation">,</span><span class="token string">'24'</span><span class="token punctuation">)</span>
<span class="token operator">AND</span> a<span class="token punctuation">.</span>scan_site <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">149342271</span>
<span class="token keyword">Time</span>: <span class="token number">362041.943</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h4 id="python函数"><a href="#python函数" class="headerlink" title="python函数"></a>python函数</h4><p>虽然选择处理的数据有1.5亿，但是呢，总量是有120亿左右。也就是说，要频繁的调用这么多次，故，调用成为瓶颈，</p>
<p>在量少的时候，可能因为有写操作或者其他，其时间成本显示不出来。测试过python匹配3个正则，5000万的量，贪婪匹配60秒、非贪婪匹配160秒，当然，re是否是c实现的，暂时未知。</p>
<p>结论：python可用，但是还是要考虑量的问题。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 调用的时候用  is_fenbo 来判断</span>

<span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">FUNCTION</span> is_fenbo<span class="token punctuation">(</span>bm <span class="token keyword">text</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">bool</span> <span class="token keyword">AS</span> $$
<span class="token comment">#coding=utf-8</span>
<span class="token keyword">if</span> <span class="token string">'fenbo'</span> <span class="token operator">not</span> <span class="token operator">in</span> GD:
    fenbo <span class="token operator">=</span> &#123;
    &#125;
    GD<span class="token punctuation">[</span><span class="token string">'fenbo'</span><span class="token punctuation">]</span> <span class="token operator">=</span> fenbo
mapping <span class="token operator">=</span> GD<span class="token punctuation">[</span><span class="token string">'fenbo'</span><span class="token punctuation">]</span>
<span class="token keyword">return</span> bm <span class="token operator">in</span> mapping 
$$<span class="token keyword">LANGUAGE</span> plpythonu<span class="token punctuation">;</span>

<span class="token keyword">select</span> is_fenbo<span class="token punctuation">(</span><span class="token string">'461001'</span><span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token number">156322459</span>
<span class="token keyword">Time</span>: <span class="token number">886813.411</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>至于要不要用pg/plsql来实现函数计算，其实，发现也没有必要。估计性能也不好。</p>
<h3 id="自定义表unnest-ARRAY"><a href="#自定义表unnest-ARRAY" class="headerlink" title="自定义表unnest + ARRAY"></a>自定义表unnest + ARRAY</h3><p>通过 unnest + ARRAY 模式，定义一张虚拟的表。然后从这个表内，筛选数据。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">bm <span class="token operator">IN</span> <span class="token punctuation">(</span>
        <span class="token comment">--# SELECT DISTINCT zzz FROM wdzzz_cw</span>
        <span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> zzz <span class="token keyword">FROM</span> wdzzz_cw  <span class="token keyword">union</span> 
        <span class="token keyword">SELECT</span> zzz <span class="token keyword">FROM</span> unnest<span class="token punctuation">(</span><span class="token punctuation">(</span>ARRAY<span class="token punctuation">[</span><span class="token number">528455</span><span class="token punctuation">,</span><span class="token number">518000</span><span class="token punctuation">]</span><span class="token punctuation">)</span>::<span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> zzz
    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="case-not-null"><a href="#case-not-null" class="headerlink" title="case not null"></a>case not null</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">table</span> mydemo1 <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> mydemo1 <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 错误   不能将id提前   not null 不行  is not null 也行</span>
<span class="token keyword">select</span>  <span class="token keyword">case</span> id <span class="token keyword">when</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> id <span class="token keyword">else</span> <span class="token number">100</span> <span class="token keyword">end</span> <span class="token keyword">as</span> myid <span class="token keyword">from</span> mydemo1<span class="token punctuation">;</span>
<span class="token comment">-- 正确</span>
<span class="token keyword">select</span>  <span class="token keyword">case</span> <span class="token keyword">when</span> id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> id <span class="token keyword">else</span> <span class="token number">100</span> <span class="token keyword">end</span> <span class="token keyword">as</span> myid <span class="token keyword">from</span> mydemo1<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>例子</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">case</span> <span class="token keyword">when</span> gj<span class="token punctuation">.</span>sffb_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> gj<span class="token punctuation">.</span>sffb_id <span class="token keyword">else</span> zx<span class="token punctuation">.</span>sffb_id <span class="token keyword">end</span> <span class="token keyword">as</span> sffb_id<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> gj<span class="token punctuation">.</span>sffb_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> gj<span class="token punctuation">.</span>sffb_name <span class="token keyword">else</span> zx<span class="token punctuation">.</span>sffb_name <span class="token keyword">end</span> <span class="token keyword">as</span> sffb_name<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> gj<span class="token punctuation">.</span>mdfb_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> gj<span class="token punctuation">.</span>mdfb_id <span class="token keyword">else</span> zx<span class="token punctuation">.</span>mdfb_id <span class="token keyword">end</span> <span class="token keyword">as</span> mdfb_id<span class="token punctuation">,</span>
<span class="token keyword">case</span> <span class="token keyword">when</span> gj<span class="token punctuation">.</span>mdfb_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">then</span> gj<span class="token punctuation">.</span>mdfb_name <span class="token keyword">else</span> zx<span class="token punctuation">.</span>mdfb_name <span class="token keyword">end</span> <span class="token keyword">as</span> mdfb_name<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="计算分组百分比"><a href="#计算分组百分比" class="headerlink" title="计算分组百分比"></a>计算分组百分比</h3><p>本来主要的想法是，先计算出分组情况。<code>select mycat,count(*) as cnt from mytable group by 1 ;</code>然后在此结果上，再嵌套一层，算出总数，及百分比。<code>select *,cnt/sum(cnt) as percent from (上一步结果) f</code>，但是sum无法直接出现在非聚合查询上。……</p>
<p>总数，运用（关联）子查询</p>
<ul>
<li>关联子查询</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    rmk_id<span class="token punctuation">,</span>
    <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt<span class="token punctuation">,</span>
    <span class="token function">round</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> :: <span class="token keyword">DECIMAL</span> <span class="token operator">/</span> <span class="token punctuation">(</span>
                <span class="token keyword">SELECT</span>
                    <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
                <span class="token keyword">FROM</span>
                    test_data_uniq_20210922
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token number">2</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">percent</span>
<span class="token keyword">FROM</span>
    test_data_uniq_20210922
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    rmk_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    cnt <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><p>另一种方式</p>
<p>准备条件，先研究如下用法。</p>
<blockquote>
<p>over的含义，应该是在分组查询最后的结果上处理，如果没有分组，那么over，即在原始数据上处理。而查询中，已有group了，那么，在select的字段上，使用窗口函数，那么,针对的应该是分组后的结果。</p>
</blockquote>
</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    rmk_id<span class="token punctuation">,</span>
    <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt<span class="token punctuation">,</span>
    <span class="token comment">-- 下面即是总数</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>
    <span class="token comment">-- 下面输出的是分组的总数，即分了多少组</span>
    <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span>
    test_data_uniq_20210922
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    rmk_id
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    cnt <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>计算百分比</p>
<blockquote>
<p>性能方面，跟关联子查询，没有区别。如果有求和总数的除0异常，还需要用case when来处理。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    rmk_id<span class="token punctuation">,</span>
    <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt<span class="token punctuation">,</span>
    <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>::<span class="token keyword">decimal</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">percent</span>
<span class="token keyword">FROM</span>
    mytable
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    <span class="token number">2</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>多个字段时，如下</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    rmk_id<span class="token punctuation">,</span>
    a7_ldly<span class="token punctuation">,</span>
    <span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt<span class="token punctuation">,</span>
    <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>::<span class="token keyword">decimal</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">percent</span>
<span class="token keyword">FROM</span>
    mytable
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
    <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    <span class="token number">3</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>除此之外，还能使用with提前计算出结果。但是，貌似，效果差不多。</p>
<h3 id="伪类型无法入库"><a href="#伪类型无法入库" class="headerlink" title="伪类型无法入库"></a>伪类型无法入库</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> gj <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span>
    ship_id<span class="token punctuation">,</span>
    <span class="token function">max</span><span class="token punctuation">(</span>ins_db_tm<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">min</span><span class="token punctuation">(</span>ins_db_tm<span class="token punctuation">)</span><span class="token punctuation">,</span>
    array_agg<span class="token punctuation">(</span><span class="token keyword">row</span><span class="token punctuation">(</span>
            grp_ship_id<span class="token punctuation">,</span>
            scan_site<span class="token punctuation">,</span>
            scan_emp<span class="token punctuation">,</span>
            ins_db_tm<span class="token punctuation">,</span>
            scan_tm<span class="token punctuation">,</span>
            delv_emp<span class="token punctuation">,</span>
            scan_typ
        <span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> ins_db_tm 
    <span class="token punctuation">)</span>
<span class="token keyword">from</span> tb_scan <span class="token keyword">where</span> ins_db_tm <span class="token operator">>=</span><span class="token string">'2021-08-26'</span> <span class="token operator">and</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-26'</span> 
<span class="token operator">and</span> ship_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id <span class="token keyword">from</span> test_scan_qian<span class="token punctuation">)</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> ship_id
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">ERROR:  <span class="token keyword">column</span> <span class="token string">"array_agg"</span> has pseudo<span class="token operator">-</span><span class="token keyword">type</span> record<span class="token punctuation">[</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="分析前缀"><a href="#分析前缀" class="headerlink" title="分析前缀"></a>分析前缀</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	SUBSTRING <span class="token punctuation">(</span>grp_ship_id <span class="token keyword">FROM</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> pre<span class="token punctuation">,</span>
	<span class="token function">COUNT</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt
<span class="token keyword">FROM</span>
	tb_scan
<span class="token keyword">WHERE</span>
	ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-08-20'</span>
<span class="token operator">AND</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-09-27'</span>
<span class="token operator">AND</span> grp_ship_id <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>
	<span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
	<span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="增加条件字段，减少总数，提速"><a href="#增加条件字段，减少总数，提速" class="headerlink" title="增加条件字段，减少总数，提速"></a>增加条件字段，减少总数，提速</h3><p>没有过滤，需要写的记录比较多。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_qianshou_package<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_qianshou_package <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span>

<span class="token keyword">select</span> ship_id<span class="token punctuation">,</span>grp_ship_id <span class="token keyword">from</span> test_qianshou_guiji <span class="token keyword">group</span> <span class="token keyword">by</span> ship_id<span class="token punctuation">,</span>grp_ship_id

<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token number">127765499</span>
<span class="token keyword">Time</span>: <span class="token number">23501.989</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>增加过滤条件。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_qianshou_package<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_qianshou_package <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span>

<span class="token keyword">select</span> ship_id<span class="token punctuation">,</span>grp_ship_id <span class="token keyword">from</span> test_qianshou_guiji <span class="token keyword">where</span> grp_ship_id <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">group</span> <span class="token keyword">by</span> ship_id<span class="token punctuation">,</span>grp_ship_id

<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SELECT</span> <span class="token number">67652643</span>
<span class="token keyword">Time</span>: <span class="token number">10959.580</span> ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>上面结果对比，总量减少一半，总时间减少一半，感觉很大的可能是，系统卡在写的性能上面。也说明，在入库的时候，可以提前增加一些计算字段，来作为过滤条件、或着分区条件，来避免大表关联的时候的性能消耗。</p>
<h3 id="子查询：field查询-–-from-子查询–with临时表"><a href="#子查询：field查询-–-from-子查询–with临时表" class="headerlink" title="子查询：field查询 – from 子查询–with临时表"></a>子查询：field查询 – from 子查询–with临时表</h3><p>from子查询</p>
<blockquote>
<p>这个算是比较常规的想法，之所以用from子查询，是因为from子查询内部，进行了聚集计算，而反是非聚集计算的字段，都不能参与select后的字段，故，放到from子查询内，注意，此时的条件，是放到子查询内部的，这样，算是提前剪枝，而内部的排序，一般是没有用处的，但是因为有limit计算，故还是需要order by的运算。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> gs<span class="token punctuation">.</span>mc <span class="token keyword">as</span> scan_name <span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">from</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> scan_site<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> tb_scan 
    <span class="token keyword">where</span> ins_db_tm <span class="token operator">>=</span><span class="token string">'2021-10-18'</span> <span class="token operator">and</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-10-19'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> scan_site
    <span class="token keyword">order</span> <span class="token keyword">by</span>  cnt <span class="token keyword">limit</span> <span class="token number">100</span> 
<span class="token punctuation">)</span>  a
<span class="token keyword">left</span> <span class="token keyword">join</span> gs <span class="token keyword">on</span> gs<span class="token punctuation">.</span>bm::<span class="token keyword">text</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>select 的计算字段</p>
<blockquote>
<p>这种方式，不需要子查询，外部表驱动内部表，进行查询，写起来更简单一些，而，我之前不太擅长这种写发。</p>
<p>注意，scan_name字段，因为关联的字段，其实是参与了聚集运算，故不会重复。（对性能有提升作用？）</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span>  <span class="token punctuation">(</span><span class="token keyword">select</span> mc <span class="token keyword">from</span> gs <span class="token keyword">where</span> bm::<span class="token keyword">text</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site <span class="token punctuation">)</span> <span class="token keyword">as</span> scan_name<span class="token punctuation">,</span>scan_site<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> tb_scan <span class="token keyword">as</span> a
<span class="token keyword">where</span> ins_db_tm <span class="token operator">>=</span><span class="token string">'2021-10-18'</span> <span class="token operator">and</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-10-19'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> scan_site
<span class="token keyword">order</span> <span class="token keyword">by</span>  cnt <span class="token keyword">limit</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>with临时表</p>
<blockquote>
<p>突然想起来，还有这种方式。能避免from子查询等。 </p>
<p>with临时表的方式，通常能代替from子查询方式，而且通过观察下面的sql，其实发现，跟from子查询，非常的相似。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">with</span> a <span class="token keyword">as</span> <span class="token punctuation">(</span>
    <span class="token keyword">select</span> scan_site<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> tb_scan 
    <span class="token keyword">where</span> ins_db_tm <span class="token operator">>=</span><span class="token string">'2021-10-18'</span> <span class="token operator">and</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-10-19'</span>
    <span class="token keyword">group</span> <span class="token keyword">by</span> scan_site
    <span class="token keyword">order</span> <span class="token keyword">by</span>  cnt <span class="token keyword">limit</span> <span class="token number">100</span>
<span class="token punctuation">)</span>
<span class="token keyword">select</span> gs<span class="token punctuation">.</span>mc <span class="token keyword">as</span> scan_name<span class="token punctuation">,</span>a<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> a
<span class="token keyword">left</span> <span class="token keyword">join</span> gs <span class="token keyword">on</span> gs<span class="token punctuation">.</span>bm::<span class="token keyword">text</span> <span class="token operator">=</span> a<span class="token punctuation">.</span>scan_site<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>疑问：针对with的临时表查询，如果有多个临时表的查询，是否，<em>后面的临时表能用上前面的临时表的查询结果</em>呢？简单测试，是可行的。那么，我有个非常大胆的想法，是否能将之前的所有的查询，都用临时表的方式呢处理呢？这样，真的相当于“1条sql”，完成了整个取数任务。</p>
<p>with临时表，能解决很多，嵌套查询的问题。</p>
<p><strong>总结：</strong></p>
<p>上面二者的性能差不多，整体运行时间都在65秒左右，下面的，略微快了几秒而已。</p>
<h3 id="do-while"><a href="#do-while" class="headerlink" title="do-while"></a>do-while</h3><ul>
<li>分组</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--  查1天</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> tm<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span> <span class="token keyword">from</span> addr_real  <span class="token keyword">where</span> ldsj <span class="token operator">>=</span><span class="token string">'2021-10-19'</span> <span class="token operator">and</span>  ldsj <span class="token operator">&lt;</span> <span class="token string">'2021-10-20'</span> <span class="token operator">and</span> tm <span class="token operator">like</span> <span class="token string">'317%'</span> <span class="token punctuation">;</span>

<span class="token comment">-- 查n天</span>
<span class="token keyword">select</span> to_char<span class="token punctuation">(</span>ldsj<span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">day</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> tm<span class="token punctuation">)</span> <span class="token keyword">as</span> distinct_cnt<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> addr_real  <span class="token keyword">where</span> ldsj <span class="token operator">>=</span><span class="token string">'2021-10-01'</span> <span class="token operator">and</span> tm <span class="token operator">like</span> <span class="token string">'317%'</span>  <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token number">1</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>如上的查询，使用了分组，其实即按分区来分组，感觉n条命令来执行，可能效果更快一些。或者说，group by的时候，尽量使用分组的名称作为条件。</p>
<p>但是呢，不想用for，貌似也能使用子查询。</p>
<ul>
<li>子查询的思路。</li>
</ul>
<blockquote>
<p>下面能写，貌似感觉效率不高。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> tm<span class="token punctuation">)</span> <span class="token keyword">from</span> addr_real <span class="token keyword">where</span> 条件 <span class="token punctuation">)</span> <span class="token keyword">from</span> 日期列表 <span class="token keyword">as</span> a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>直接写do-loop循环</li>
</ul>
<p>扩展：</p>
<blockquote>
<p>如果想实现数据，按天进行分组并联表呢？ do–loop,子查询，还是？</p>
</blockquote>
<h3 id="同事写的代码-select-into-count-distinct-case"><a href="#同事写的代码-select-into-count-distinct-case" class="headerlink" title="同事写的代码 select into + count(distinct case)"></a>同事写的代码 select into + count(distinct case)</h3><p>下面的代码，有点的意料，如果是我的话，我可能是<code>insert into table from (select * from table1 union all select * from table2 ...) f</code>这种思路。</p>
<p>下面居然还能这样写？select into  第一个表后，后面直接跟其他的表。（select into 的语法我是知道的，但是直接union all使用，第一次遇到）</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> cyf_etl_dta_202110242526
<span class="token keyword">from</span> cyf_etl_dta_20211024
<span class="token keyword">union</span> <span class="token keyword">all</span> 
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cyf_etl_dta_20211025
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cyf_etl_dta_20211026
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>count的几种方式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> 
Dtime::<span class="token keyword">DATE</span> <span class="token keyword">as</span> <span class="token keyword">date</span><span class="token punctuation">,</span>
<span class="token function">min</span><span class="token punctuation">(</span>Dtime<span class="token punctuation">)</span> <span class="token keyword">as</span> min_date<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span>Dtime<span class="token punctuation">)</span> <span class="token keyword">as</span> max_date<span class="token punctuation">,</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> Doc_Sn<span class="token punctuation">)</span> <span class="token keyword">as</span> ttl<span class="token punctuation">,</span><span class="token comment">--整体</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> Doc_Src <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cainiao'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> Doc_Sn <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cainiao<span class="token punctuation">,</span> <span class="token comment">--菜鸟</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> <span class="token keyword">case</span> <span class="token keyword">when</span> Doc_Src <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'cainiao'</span><span class="token punctuation">)</span> <span class="token keyword">then</span> Doc_Sn <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cainiao <span class="token comment">--菜鸟</span>
<span class="token keyword">from</span> tu_doc_info
<span class="token keyword">where</span> Dtime<span class="token operator">>=</span><span class="token string">'2021-10-24'</span> <span class="token operator">and</span> Dtime<span class="token operator">&lt;</span><span class="token string">'2021-10-27'</span>
<span class="token keyword">group</span> <span class="token keyword">by</span> Dtime::<span class="token keyword">DATE</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> Dtime::<span class="token keyword">DATE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>除此之外，</p>
<p>sum( case when 条件 then 1 esle 0 end )</p>
<p>count(条件  or  null)   ,如 count(sex = ‘男’ or null)</p>
<p>上面即为计算的几种方式。</p>
<p>上面的count 的计算字段  居然还能<code>distinct + case when</code> ,真没有想这么多</p>
<p>看来sql的语法，可以写这么复杂，只是自己不敢这么搭配而已。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>扫描表，按类型分为，揽件、分发、签收。故，该张表，虽然是一张表，但是可以拆分出多张表。另外，每种，都要取最早、或最晚的那条。然后还要1个月之内的数据。</p>
<p>优化方式，从最简单的到复杂，感觉有以下几种。</p>
<ul>
<li><p>建立索引</p>
</li>
<li><p>直接先取出多天的唯一记录。主要是方便多天的取值</p>
</li>
<li><p>优化sql，之前是每条都取唯一，这次，取唯一的时候，在联表的时候操作？是否能提速？</p>
</li>
<li><p>分区优化，（distribute 主键 ）+ （分区  主键），暂时不考虑时间，先将所有的运单处理完？</p>
</li>
<li><p>gp的json，先将多条的数据，都转换成主键，然后避免3次取表？</p>
</li>
<li><p>自定义函数优化。即一次扫描全表，组装出一个运单的揽、分、签？</p>
</li>
<li><p>提前计算好，揽、签、收的1~2个月数据。</p>
<p>每次计算最值，范围是滚动的，比如1个月。那么，能否滚动的计算出最值？ 在原有的1个月的数据上，按窗口滑动的形式处理？</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.chaofml.cn/2021/07/27/pg/pg%E6%95%B0%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%9E%E8%B7%B5/" data-id="cld48zeph00qa11o0hnma63hx" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pg/" rel="tag">pg</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/07/27/shell/awk%E6%AD%A3%E5%88%99/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          awk正则
        
      </div>
    </a>
  
  
    <a href="/2021/07/23/redis/redis_csv/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">redis_csv.php</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/%E6%B8%85%E7%90%86/">清理</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-tools/">python - tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AD%A3%E5%88%99/">正则</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/shell/">shell</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">-shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkinsfile/" rel="tag">Jenkinsfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">K8s学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apache/" rel="tag">apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/array/" rel="tag">array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/" rel="tag">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bs4/" rel="tag">bs4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/celery/" rel="tag">celery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chmod/" rel="tag">chmod</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chown/" rel="tag">chown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/conf/" rel="tag">conf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/copy/" rel="tag">copy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csv/" rel="tag">csv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cygwin/" rel="tag">cygwin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/db/" rel="tag">db</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/" rel="tag">default</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-php/" rel="tag">docker php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-weblogic/" rel="tag">docker weblogic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/emoji/" rel="tag">emoji</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es/" rel="tag">es</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ext/" rel="tag">ext</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/extjs/" rel="tag">extjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/for/" rel="tag">for</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gp/" rel="tag">gp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/greenplum/" rel="tag">greenplum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gzip/" rel="tag">gzip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/host/" rel="tag">host</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ingore/" rel="tag">ingore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/install/" rel="tag">install</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/" rel="tag">json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ldap/" rel="tag">ldap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lua/" rel="tag">lua</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lxml/" rel="tag">lxml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/md5/" rel="tag">md5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openapi/" rel="tag">openapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/" rel="tag">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/" rel="tag">other</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pdo/" rel="tag">pdo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pg/" rel="tag">pg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-%E6%89%A9%E5%B1%95/" rel="tag">php 扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-%E6%8F%92%E4%BB%B6/" rel="tag">php 插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pip/" rel="tag">pip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgre/" rel="tag">postgre</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rancher/" rel="tag">rancher</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/requests/" rel="tag">requests</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/restful-api/" rel="tag">restful api</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/session/" rel="tag">session</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socat/" rel="tag">socat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/split/" rel="tag">split</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/" rel="tag">sqlite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/static/" rel="tag">static</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tar/" rel="tag">tar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/think/" rel="tag">think</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tmux/" rel="tag">tmux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/underscope/" rel="tag">underscope</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vb/" rel="tag">vb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue3/" rel="tag">vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yum/" rel="tag">yum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1/" rel="tag">业务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA/" rel="tag">个人</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/" rel="tag">分区表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5/" rel="tag">同步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E8%A3%85/" rel="tag">安装</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%BC%E8%88%AA/" rel="tag">导航</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8C%85/" rel="tag">打包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E6%9D%BF/" rel="tag">模板</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A9%BA%E6%A0%BC/" rel="tag">空格</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" rel="tag">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%AD%E6%B3%95/" rel="tag">语法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9B%E7%A8%8B/" rel="tag">进程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/shell/" style="font-size: 10px;">-shell</a> <a href="/tags/Jenkinsfile/" style="font-size: 10px;">Jenkinsfile</a> <a href="/tags/K8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">K8s学习笔记</a> <a href="/tags/apache/" style="font-size: 10px;">apache</a> <a href="/tags/array/" style="font-size: 10px;">array</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/bs4/" style="font-size: 10px;">bs4</a> <a href="/tags/c/" style="font-size: 10px;">c</a> <a href="/tags/celery/" style="font-size: 10px;">celery</a> <a href="/tags/chmod/" style="font-size: 10px;">chmod</a> <a href="/tags/chown/" style="font-size: 10px;">chown</a> <a href="/tags/conf/" style="font-size: 10px;">conf</a> <a href="/tags/copy/" style="font-size: 10px;">copy</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/csv/" style="font-size: 12.31px;">csv</a> <a href="/tags/cygwin/" style="font-size: 10px;">cygwin</a> <a href="/tags/db/" style="font-size: 10px;">db</a> <a href="/tags/default/" style="font-size: 13.85px;">default</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/docker/" style="font-size: 18.46px;">docker</a> <a href="/tags/docker-php/" style="font-size: 10px;">docker php</a> <a href="/tags/docker-weblogic/" style="font-size: 10px;">docker weblogic</a> <a href="/tags/emoji/" style="font-size: 10px;">emoji</a> <a href="/tags/es/" style="font-size: 10px;">es</a> <a href="/tags/ext/" style="font-size: 10px;">ext</a> <a href="/tags/extjs/" style="font-size: 11.54px;">extjs</a> <a href="/tags/for/" style="font-size: 10.77px;">for</a> <a href="/tags/git/" style="font-size: 11.54px;">git</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/gp/" style="font-size: 10.77px;">gp</a> <a href="/tags/greenplum/" style="font-size: 11.54px;">greenplum</a> <a href="/tags/gzip/" style="font-size: 10px;">gzip</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/host/" style="font-size: 10px;">host</a> <a href="/tags/ingore/" style="font-size: 10px;">ingore</a> <a href="/tags/install/" style="font-size: 10.77px;">install</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/java/" style="font-size: 10.77px;">java</a> <a href="/tags/js/" style="font-size: 15.38px;">js</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/k8s/" style="font-size: 12.31px;">k8s</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/ldap/" style="font-size: 10px;">ldap</a> <a href="/tags/linux/" style="font-size: 12.31px;">linux</a> <a href="/tags/lua/" style="font-size: 10px;">lua</a> <a href="/tags/lxml/" style="font-size: 10px;">lxml</a> <a href="/tags/md5/" style="font-size: 10px;">md5</a> <a href="/tags/mysql/" style="font-size: 14.62px;">mysql</a> <a href="/tags/nginx/" style="font-size: 13.85px;">nginx</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/openapi/" style="font-size: 10px;">openapi</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/other/" style="font-size: 13.85px;">other</a> <a href="/tags/pdo/" style="font-size: 10px;">pdo</a> <a href="/tags/pg/" style="font-size: 17.69px;">pg</a> <a href="/tags/php/" style="font-size: 16.92px;">php</a> <a href="/tags/php-%E6%89%A9%E5%B1%95/" style="font-size: 10px;">php 扩展</a> <a href="/tags/php-%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">php 插件</a> <a href="/tags/pip/" style="font-size: 10.77px;">pip</a> <a href="/tags/postgre/" style="font-size: 10px;">postgre</a> <a href="/tags/postgresql/" style="font-size: 11.54px;">postgresql</a> <a href="/tags/python/" style="font-size: 19.23px;">python</a> <a href="/tags/rancher/" style="font-size: 10px;">rancher</a> <a href="/tags/redis/" style="font-size: 13.85px;">redis</a> <a href="/tags/requests/" style="font-size: 10px;">requests</a> <a href="/tags/restful-api/" style="font-size: 10.77px;">restful api</a> <a href="/tags/session/" style="font-size: 10px;">session</a> <a href="/tags/shell/" style="font-size: 20px;">shell</a> <a href="/tags/socat/" style="font-size: 10px;">socat</a> <a href="/tags/split/" style="font-size: 10px;">split</a> <a href="/tags/sql/" style="font-size: 16.15px;">sql</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/ssh/" style="font-size: 11.54px;">ssh</a> <a href="/tags/static/" style="font-size: 10px;">static</a> <a href="/tags/tar/" style="font-size: 10.77px;">tar</a> <a href="/tags/think/" style="font-size: 10px;">think</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/underscope/" style="font-size: 10px;">underscope</a> <a href="/tags/vb/" style="font-size: 10px;">vb</a> <a href="/tags/vim/" style="font-size: 10.77px;">vim</a> <a href="/tags/vue/" style="font-size: 11.54px;">vue</a> <a href="/tags/vue3/" style="font-size: 10px;">vue3</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/yum/" style="font-size: 10px;">yum</a> <a href="/tags/%E4%B8%9A%E5%8A%A1/" style="font-size: 10px;">业务</a> <a href="/tags/%E4%B8%AA%E4%BA%BA/" style="font-size: 10px;">个人</a> <a href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/" style="font-size: 10px;">分区表</a> <a href="/tags/%E5%90%8C%E6%AD%A5/" style="font-size: 10px;">同步</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 13.08px;">大数据</a> <a href="/tags/%E5%AE%89%E8%A3%85/" style="font-size: 10px;">安装</a> <a href="/tags/%E5%AF%BC%E8%88%AA/" style="font-size: 10px;">导航</a> <a href="/tags/%E6%89%93%E5%8C%85/" style="font-size: 10px;">打包</a> <a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 10px;">模板</a> <a href="/tags/%E7%A9%BA%E6%A0%BC/" style="font-size: 10px;">空格</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">编程语言</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%AF%AD%E6%B3%95/" style="font-size: 10px;">语法</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 19.23px;">转载</a> <a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 10px;">进程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/20/pg/%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E5%88%B0%E5%88%86%E5%8C%BA/">数据插入到分区</a>
          </li>
        
          <li>
            <a href="/2022/10/09/shell/%E6%AD%A3%E5%88%99/">常用的正则表达式</a>
          </li>
        
          <li>
            <a href="/2022/09/22/other/%E8%BF%9C%E7%A8%8B%E5%8A%9E%E5%85%AC/">远程办公</a>
          </li>
        
          <li>
            <a href="/2022/09/20/apache/%E5%8E%8B%E6%B5%8B/">压测</a>
          </li>
        
          <li>
            <a href="/2022/09/14/shell/%E5%8E%8B%E7%BC%A9%E3%80%81%E8%A7%A3%E5%8E%8B/">压缩、解压</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 chaofml<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>