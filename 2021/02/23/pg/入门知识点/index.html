<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>入门知识点 | 超凡魔力</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="postgresql 是另外一个与mysql类似的数据库系统，在sql上面，有很多跟mysql用法都类似，但是区别还是有的。下面专门记载一些有别与mysql的知识点，和一些基础的入门知识点。本文文章非常的长，基本上一些零散的知识点，都记录在本文中。本文可以看作一篇大杂汇，或者，简单的参考手册。">
<meta property="og:type" content="article">
<meta property="og:title" content="入门知识点">
<meta property="og:url" content="https://blog.chaofml.cn/2021/02/23/pg/%E5%85%A5%E9%97%A8%E7%9F%A5%E8%AF%86%E7%82%B9/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="postgresql 是另外一个与mysql类似的数据库系统，在sql上面，有很多跟mysql用法都类似，但是区别还是有的。下面专门记载一些有别与mysql的知识点，和一些基础的入门知识点。本文文章非常的长，基本上一些零散的知识点，都记录在本文中。本文可以看作一篇大杂汇，或者，简单的参考手册。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-02-23T13:56:41.000Z">
<meta property="article:modified_time" content="2023-01-20T08:15:40.086Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="sql">
<meta property="article:tag" content="gp">
<meta property="article:tag" content="postgre">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="超凡魔力" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">超凡魔力</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.chaofml.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-pg/入门知识点" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/23/pg/%E5%85%A5%E9%97%A8%E7%9F%A5%E8%AF%86%E7%82%B9/" class="article-date">
  <time datetime="2021-02-23T13:56:41.000Z" itemprop="datePublished">2021-02-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      入门知识点
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>postgresql 是另外一个与mysql类似的数据库系统，在sql上面，有很多跟mysql用法都类似，但是区别还是有的。下面专门记载一些有别与mysql的知识点，和一些基础的入门知识点。本文文章非常的长，基本上一些零散的知识点，都记录在本文中。本文可以看作一篇大杂汇，或者，简单的参考手册。</p>
<a id="more"></a>

<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>按学习到一定程度后，重新对各资源排序。</p>
<ul>
<li><p>《深入浅出PostgreSQL》</p>
</li>
<li><p>《GreenPlum:从大数据战略到实现》</p>
</li>
<li><p>《Greenplum企业应用实战》</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://postgres.cn/docs/13/">官方的手册postgresql</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/6-2/ref_guide/sql_commands/CREATE_TABLE_AS.html#topic1">greenplum官网，标准sql的格式</a></p>
</li>
</ul>
<p>其次才是：</p>
<ul>
<li><p>德哥的blog   </p>
<p><a target="_blank" rel="noopener" href="https://billtian.github.io/digoal.blog/">https://billtian.github.io/digoal.blog/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.php.cn/manual/view/20340.html">https://www.php.cn/manual/view/20340.html</a></p>
</li>
<li><p>其他，搜索引擎。</p>
</li>
<li><p>一个私人博客，不确定是否有用   <a target="_blank" rel="noopener" href="https://postgres.fun/">https://postgres.fun/</a>   </p>
</li>
<li><p>gp手册  <a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/510/ref_guide/sql_commands/CREATE_TABLE.html">https://gpdb.docs.pivotal.io/510/ref_guide/sql_commands/CREATE_TABLE.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://gpdb.docs.pivotal.io/6-2/main/index.html">https://gpdb.docs.pivotal.io/6-2/main/index.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.lidihuo.com/postgresql/postgresql-index.html">https://www.lidihuo.com/postgresql/postgresql-index.html</a></p>
</li>
</ul>
<p>对上面的资源，简单的总结一下，对于如何写计算sql，了解如何计算的，需要掌握的postgresql知识远超过GreenPlum。对于运维、导数据等一些特性，则需要看后者。官方的postgresql，非常的nice，有助于写复杂的sql，并用上特性。</p>
<p>至于后面德哥的博客，一开始比较看重，后来发现，其实并不重要，或者说从中得到的启发很少，还是从正规途径获取知识比较重要，德哥的博客，仅适合在拔高的时候，偶尔启发一下，因为感觉不够系统性。</p>
<h3 id="其他资源"><a href="#其他资源" class="headerlink" title="其他资源"></a>其他资源</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/timssd/p/10212940.html">https://www.cnblogs.com/timssd/p/10212940.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jb51.net/list/list_224_1.htm">脚本之家pg有关文章</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xabc3000/article/details/7644129">Greenplum 日常维护手册 (汇总、点评、备查)</a></p>
</li>
</ul>
<h3 id="待看"><a href="#待看" class="headerlink" title="待看"></a>待看</h3><ul>
<li><a target="_blank" rel="noopener" href="http://blog.itpub.net/7551038/viewspace-614198/">http://blog.itpub.net/7551038/viewspace-614198/</a></li>
</ul>
<h2 id="零碎知识点"><a href="#零碎知识点" class="headerlink" title="零碎知识点"></a>零碎知识点</h2><p>字段名用双引号来标识。如下：</p>
<blockquote>
<p>sqlite3同样，而mysql是使用`符号。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">"id"</span><span class="token punctuation">,</span><span class="token string">"csv"</span><span class="token punctuation">,</span><span class="token string">"exec_status"</span> <span class="token keyword">from</span> td_csv_logs<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>函数名，也可以加上双引号（也可省略）。</p>
<h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nanshanjushi/p/11336687.html">https://www.cnblogs.com/nanshanjushi/p/11336687.html</a></p>
<h3 id="创建表结构"><a href="#创建表结构" class="headerlink" title="创建表结构"></a>创建表结构</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> td_csv_logs
<span class="token punctuation">(</span>
    id bigserial<span class="token punctuation">,</span>
    csv <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    exec_status <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    create_time <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">,</span>
    update_time <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone
<span class="token punctuation">)</span>
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    OIDS <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span>
    appendonly<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> COMPRESSTYPE<span class="token operator">=</span>quicklz<span class="token punctuation">,</span>orientation<span class="token operator">=</span><span class="token keyword">column</span>
<span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>说明：</p>
<ul>
<li>OIDS 是否生成抽象的id </li>
<li>appendonly 压缩表</li>
<li>COMPRESSTYPE压缩程度。1-9，一般为5。</li>
<li>orientation</li>
</ul>
<h3 id="查看数据库、表结构等"><a href="#查看数据库、表结构等" class="headerlink" title="查看数据库、表结构等"></a>查看数据库、表结构等</h3><p>1、相当与mysql的show databases;</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> datname <span class="token keyword">from</span> pg_database<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2、相当于mysql的show tables;</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">=</span> <span class="token string">'public'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>public 是默认的schema的名字</p>
<p>3、相当与mysql的describe table_name;</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> column_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">columns</span> <span class="token keyword">WHERE</span> table_name <span class="token operator">=</span><span class="token string">'table_name'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>‘table_name’是要查询的表的名字</p>
<p>psql中的快速查看：</p>
<pre class="line-numbers language-none"><code class="language-none">\d    # 查看有哪些表
\d  table*   # 查看具体的表结构 * 表示模糊匹配，如果没有，则表示精确匹配<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h3 id="切换"><a href="#切换" class="headerlink" title="切换"></a>切换</h3><p>psql用法</p>
<pre class="line-numbers language-none"><code class="language-none">\c database<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="查看建表语句"><a href="#查看建表语句" class="headerlink" title="查看建表语句"></a>查看建表语句</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nami/p/4112339.html">https://www.cnblogs.com/nami/p/4112339.html</a></p>
<h3 id="查看表占用空间"><a href="#查看表占用空间" class="headerlink" title="查看表占用空间"></a>查看表占用空间</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> pg_size_pretty<span class="token punctuation">(</span>pg_total_relation_size<span class="token punctuation">(</span><span class="token string">'表'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">select</span> pg_size_pretty<span class="token punctuation">(</span>pg_relation_size<span class="token punctuation">(</span><span class="token string">'schema.tablename'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> pg_size_pretty<span class="token punctuation">(</span>pg_database_size<span class="token punctuation">(</span>'databasename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="查看分布"><a href="#查看分布" class="headerlink" title="查看分布"></a>查看分布</h3><p>查看greenplum库各个节点数据的分布情况</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> gp_segment_id<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> table_name <span class="token keyword">group</span> <span class="token keyword">by</span> gp_segment_id<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gobird/p/3632547.html">https://www.cnblogs.com/gobird/p/3632547.html</a></p>
<h3 id="分区倾斜"><a href="#分区倾斜" class="headerlink" title="分区倾斜"></a>分区倾斜</h3><p>由于分区表的名称可以使用<code>*</code>来匹配，如下<code>table_name*</code>来匹配分区表名，查看每个分区大概占了多大空间。</p>
<pre class="line-numbers language-cmd" data-language="cmd"><code class="language-cmd">\dt+ table_name*<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="多级分区"><a href="#多级分区" class="headerlink" title="多级分区"></a>多级分区</h3><p><a target="_blank" rel="noopener" href="https://postgres.fun/20190716101600.html">https://postgres.fun/20190716101600.html</a></p>
<p>分区表，能跟正常表一样，进行大多数的操作。我们可以清空某个分区表，能删除掉。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 建表时候的分区设置部分 </span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>appendonly<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> compresslevel<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> orientation<span class="token operator">=</span><span class="token keyword">column</span><span class="token punctuation">,</span> compresstype<span class="token operator">=</span>zlib<span class="token punctuation">)</span>
<span class="token keyword">Distributed</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>分布键<span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> range <span class="token punctuation">(</span>分区时间字段<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">PARTITION</span> pn <span class="token keyword">START</span> <span class="token punctuation">(</span><span class="token string">'2020-06-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token punctuation">(</span><span class="token string">'2023-01-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> EVERY <span class="token punctuation">(</span><span class="token string">'1 day'</span>::<span class="token keyword">interval</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">DEFAULT</span> <span class="token keyword">PARTITION</span> pdefault
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询某个分区的数据量</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">from</span> table_1_prt_pn_31<span class="token punctuation">;</span>

<span class="token comment">-- 清空某个分区的数据，执行效率很快。</span>
<span class="token keyword">truncate</span> tu_doc_info_1_prt_pn_31<span class="token punctuation">;</span>
<span class="token comment">-- 另外删除</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分区表的名称规则：<code>原表名_1_prt_pn_序列号</code>   ，其中pn是自己设置的。</p>
<p>思考题：</p>
<p>上面方式建立的分区，如何知道数据在哪个分区？如何知道要操作的时间段是哪个分区？笨的方法如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">\dt<span class="token operator">+</span> i1_order<span class="token operator">*</span><span class="token punctuation">;</span>   <span class="token comment">-- 查看每个分区的使用情况，找到一个貌似比较小的分区。</span>
<span class="token comment">-- 查看该分区的数据</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> i1_order_1_prt_pn_26 <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token comment">--  清空分区。</span>
<span class="token keyword">truncate</span> <span class="token keyword">table</span> i1_order_1_prt_pn_26<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的貌似能写成一个脚本。自动的来操作，或者写成一个函数？</p>
<p>更简单的方式如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> tableoid<span class="token punctuation">,</span><span class="token operator">*</span> <span class="token keyword">from</span> i1_record <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> tableoid::regclass<span class="token punctuation">,</span><span class="token operator">*</span> <span class="token keyword">from</span> i1_record <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>另外还有的特殊字段：</p>
<pre class="line-numbers language-none"><code class="language-none">ctid, tableoid,gp_segment_id<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="查看分区"><a href="#查看分区" class="headerlink" title="查看分区"></a>查看分区</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> tablename<span class="token punctuation">,</span>partitiontablename<span class="token punctuation">,</span>partitionrank<span class="token punctuation">,</span>partitionlevel<span class="token punctuation">,</span>partitionrangestart<span class="token punctuation">,</span>partitionrangeend <span class="token keyword">from</span> pg_partitions <span class="token keyword">where</span> tablename<span class="token operator">=</span><span class="token string">'表'</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> pg_partitions <span class="token keyword">where</span> tablename<span class="token operator">=</span><span class="token string">'表'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>解决如何查找数据属于哪个分区。</p>
<p>查看分区所在的文件分区</p>
<pre class="line-numbers language-none"><code class="language-none">select pg_relation_filepath(&#39;分区表名&#39;);

 pg_relation_filepath 
----------------------
 base&#x2F;16384&#x2F;30155<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>base表示所使用的表空间是系统默认表空间（pg_default），16384是表所属数据库（postgres）的OID。可以使用“oid2name”命令查看数据库OID对应的数据库名和所属表空间名。</p>
<h3 id="psql使用"><a href="#psql使用" class="headerlink" title="psql使用"></a>psql使用</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yulinlewis/p/9404112.html">https://www.cnblogs.com/yulinlewis/p/9404112.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/my-blogs-for-everone/p/10226473.html">https://www.cnblogs.com/my-blogs-for-everone/p/10226473.html</a></p>
<p>连接数据库：</p>
<pre class="line-numbers language-none"><code class="language-none">psql -h localhost -U gpadmin -d develop<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数说明</p>
<ul>
<li>-h 连接的数据库ip，hostname的缩写</li>
<li>-p 指定端口。</li>
<li>-U 用户名，即账号的Username。</li>
<li>-d 数据库名称</li>
</ul>
<p>执行命令：</p>
<p>如果只想执行一条命令而已，使用<code>-c</code>，示例见导入数据.</p>
<p>对于要执行的sql，要添加上分号，表示语句输入完成。然后psql才会输出内容。</p>
<p>控制台的其他命令：</p>
<pre class="line-numbers language-none"><code class="language-none">\password: 设置密码
\q：退出查询 
\h：查看SQL命令的解释，比如\h select。
\?：查看psql命令列表。
\l：列出所有数据库。
\c [database_name]：连接其他数据库。
\d：列出当前数据库的所有表格。
\d [table_name]：列出某一张表格的结构。
\d+
\dS+   tablename*; 查看所有分区
\dt+
\du：列出所有用户。
\e：打开文本编辑器。
\conninfo：列出当前数据库和连接的信息。

\i   执行sql文件
\dt 显示表
\dtS 显示系统表
\dg or 	\du 显示角色
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>恢复数据  psql exampledb &lt; exampledb.sql </p>
<p>执行批量的sql语句：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">psql -h localhost -U gpadmin -d develop -f count.sql
<span class="token comment">#其中count.sql是多条要执行的命令。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>增加快捷访问的别名</p>
<p>修改 vim ~/.bashrc 的内容。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">alias</span> <span class="token assign-left variable">pgsql</span><span class="token operator">=</span><span class="token string">'psql -h localhost -U gpadmin -d develop '</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="psql执行sql"><a href="#psql执行sql" class="headerlink" title="psql执行sql"></a>psql执行sql</h3><p>根据psql本身提供的命令行参数，<code>-c</code>只执行1条命令,<code>-f</code>执行一个文件内容,如，取数任务中的sql。其实，除了以上两种方式，还隐藏第3种方式，即交互方式执行。示例如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token assign-left variable">LIMIT</span><span class="token operator">=</span><span class="token number">2</span>
psql -h localhost -U gpadmin -d develop <span class="token operator">&lt;&lt;</span> <span class="token string">EOL
<span class="token entity" title="\t">\t</span>iming on
select ship_id  from tb_scan limit <span class="token variable">$LIMIT</span>;
-- 还可以有其他的操作等
select doc_sn form tu_doc_info limit <span class="token variable">$LIMIT</span>;

EOL</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>LIMIT本身是shell中的变量，然后呢，在交互模式下，被heredoc解释为变量的真实值。在操作过程中，我们还可以取shell的调用参数作为值。</p>
<p>这太tm方便了，有木有！！！</p>
<p>但是，注意坑，即结尾的<code>EOL</code>，末尾不能多空格，等其他符号。</p>
<p>由此，我可以想象，mysql等交试工具  也是可以的。</p>
<h3 id="查询耗时"><a href="#查询耗时" class="headerlink" title="查询耗时"></a>查询耗时</h3><p>psql模式</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">\timing <span class="token keyword">on</span>

会显示每条<span class="token keyword">sql</span>语句的执行时间

不再使用时：
\timing <span class="token keyword">off</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>方式2</p>
<p>explain select count(*) from  你的表; </p>
<p>方法3：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">psql -d develop -f fetch.sql
<span class="token comment"># 或者</span>
<span class="token punctuation">\</span>i /yd/fetch.sql
<span class="token comment"># 而fetch.sql 里面增加下面一句。</span>
<span class="token punctuation">\</span>timing on<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="输出内容"><a href="#输出内容" class="headerlink" title="输出内容"></a>输出内容</h3><p>指定输出的位置。两个<code>\o</code>之间的内容会被输出到文件中。跟<code>\i</code>参数，正好是相对的。</p>
<pre class="line-numbers language-none"><code class="language-none">develop&#x3D;# \o &#x2F;yd&#x2F;hello.txt
develop&#x3D;# select &#39;20210901&#39;::date;
Time: 1.332 ms
develop&#x3D;# \o<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/alianbog/p/5621660.html">https://www.cnblogs.com/alianbog/p/5621660.html</a></p>
<p>连接的时候，需要指定要访问的数据库。</p>
<blockquote>
<p>如果未使用<code>-d</code>来指定，那么默认数据库名与登录用户名同名。   待考证。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">psql <span class="token operator">-</span>d  develop   <span class="token operator">-</span>h  localhost   <span class="token operator">-</span>U gpadmin  <span class="token operator">-</span>p <span class="token number">5432</span>  <span class="token operator">-</span>c <span class="token string">"\copy td_ci (ci) from /tmp/bm_order_data_uniq_trim_sort_jieba_sort.csv with csv header"</span>

copy tb_scan <span class="token keyword">from</span> <span class="token string">'/etl/dta/20200701/tb_scan_20200701100500.csv'</span> <span class="token keyword">with</span> csv <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>使用gpadmin用户名</li>
<li>数据库 <code>-d</code>选择数据库</li>
<li>指定连接的host的ip <code>-h</code></li>
<li>指定端口<code>-p</code></li>
<li>指定执行的命令<code>-c</code> 。这个命令执行完就退出。如果需要进入交互式模式，则不应该使用该参数。</li>
</ul>
<p>总结：</p>
<p>copy与\copy命令都能实现数据文件与表的数据传递，两者都在psql环境下执行。</p>
<p>主要不同在于数据文件的路径寻址：</p>
<p>1）copy 命令始终是到数据库服务端找文件；</p>
<p>2）\copy 命令可在客户端执行导入客户端的数据文件。</p>
<p>另外，常用的数据文件列之间默认是空格，可以用csv格式的传递，列之间以分号隔离。</p>
<p>完整例子</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">copy target_table_name <span class="token punctuation">(</span>field_1, field_2, field_3<span class="token punctuation">)</span>
from <span class="token string">'C:\sourceData.txt'</span>
with <span class="token punctuation">(</span>
    FORMAT csv,
    DELIMITER <span class="token string">','</span>,
    escape <span class="token string">'\',
    header true,
    quote '</span>"<span class="token string">',
    encoding '</span>UTF8'
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>貌似还能对null处理（待测试）</p>
<pre class="line-numbers language-none"><code class="language-none">NULL as &#39;null string&#39;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>出错问题：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">psql -c <span class="token string">"<span class="token entity" title="\c">\c</span>opy lanjiejian from tmm_busi_intercept.csv with csv"</span><span class="token punctuation">;</span>


psql -c <span class="token string">"<span class="token entity" title="\c">\c</span>opy lanjiejian from tmm_busi_intercept.csv with csv"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>导入时，进行简单的转换数据</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">sed</span> <span class="token string">'<span class="token variable">$d</span>'</span> <span class="token variable">$each</span><span class="token operator">|</span> psql -d  develop -c <span class="token string">"copy i1_import_raw from STDIN with csv"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>上面的效果是， 删除文件最后一行，然后导入数据。</p>
<h3 id="导出数据"><a href="#导出数据" class="headerlink" title="导出数据"></a>导出数据</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">psql -h localhost -U gpadmin -d develop -c <span class="token string">"copy td_count_tb_scan to '/tmp/count_tmp.csv'"</span>
<span class="token comment"># 或者使用下面的形式</span>
psql -h localhost -U gpadmin -d develop -c <span class="token string">"<span class="token entity" title="\c">\c</span>opy td_count_tb_scan to /tmp/count_tmp.csv"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>上面第1行，如果不加入引号，会报错。</p>
<p>上面第2种查询，即使没有引号，也不会报错，能正常执行。</p>
<p>直接在psql命令行界面也能执行，但是，因为没有加上csv 的header，分隔符号等，导致样式有问题。采用下面优化一下。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">copy mytable to <span class="token string">'/tmp/mytable.csv'</span> with csv header delimiter <span class="token string">','</span><span class="token punctuation">;</span> 
<span class="token comment"># 当然，也能写查询的sql并导出。    sql需要用括号包裹</span>
copy <span class="token punctuation">(</span>select * from test_alldata_20210710 where ship_id <span class="token operator">=</span> <span class="token string">'3120'</span> <span class="token punctuation">)</span> to <span class="token string">'/gpdata/mytest.csv'</span> with csv header delimiter <span class="token string">','</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="导出表结构"><a href="#导出表结构" class="headerlink" title="导出表结构"></a>导出表结构</h3><p><a target="_blank" rel="noopener" href="https://www.yisu.com/zixun/221342.html">https://www.yisu.com/zixun/221342.html</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">pg_dump -h localhost  -U gpadmin -p <span class="token number">5432</span>  -s -t mytable develop   <span class="token operator">></span>mytable.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数说明</p>
<ul>
<li>-s 选项用来只导出表结构，而不会导出表中的数据</li>
<li>-t  选项用来指定要导出的数据库表</li>
<li>develop  数据库名称</li>
</ul>
<p>另外一种，使用sql</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> relname<span class="token operator">||</span><span class="token string">'--'</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token keyword">select</span> description <span class="token keyword">from</span> pg_description <span class="token keyword">where</span> objoid<span class="token operator">=</span>oid <span class="token operator">and</span> objsubid<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">comment</span> <span class="token keyword">from</span> pg_class <span class="token keyword">where</span> oid<span class="token operator">=</span>a<span class="token punctuation">.</span>attrelid<span class="token punctuation">)</span> <span class="token keyword">as</span> table_name<span class="token punctuation">,</span>
a<span class="token punctuation">.</span>attname <span class="token keyword">as</span> column_name<span class="token punctuation">,</span>
format_type<span class="token punctuation">(</span>a<span class="token punctuation">.</span>atttypid<span class="token punctuation">,</span>a<span class="token punctuation">.</span>atttypmod<span class="token punctuation">)</span> <span class="token keyword">as</span> data_type<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> atttypmod<span class="token operator">-</span><span class="token number">4</span><span class="token operator">></span><span class="token number">0</span> <span class="token keyword">then</span> atttypmod<span class="token operator">-</span><span class="token number">4</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>data_length<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> pg_constraint <span class="token keyword">where</span> conrelid <span class="token operator">=</span> a<span class="token punctuation">.</span>attrelid <span class="token operator">and</span> conkey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>attnum <span class="token operator">and</span> contype<span class="token operator">=</span><span class="token string">'p'</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'Y'</span> <span class="token keyword">else</span> <span class="token string">'N'</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 主键约束<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> pg_constraint <span class="token keyword">where</span> conrelid <span class="token operator">=</span> a<span class="token punctuation">.</span>attrelid <span class="token operator">and</span> conkey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>attnum <span class="token operator">and</span> contype<span class="token operator">=</span><span class="token string">'u'</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'Y'</span> <span class="token keyword">else</span> <span class="token string">'N'</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 唯一约束<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> pg_constraint <span class="token keyword">where</span> conrelid <span class="token operator">=</span> a<span class="token punctuation">.</span>attrelid <span class="token operator">and</span> conkey<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>attnum <span class="token operator">and</span> contype<span class="token operator">=</span><span class="token string">'f'</span><span class="token punctuation">)</span><span class="token operator">></span><span class="token number">0</span> <span class="token keyword">then</span> <span class="token string">'Y'</span> <span class="token keyword">else</span> <span class="token string">'N'</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> 外键约束<span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> a<span class="token punctuation">.</span>attnotnull<span class="token operator">=</span><span class="token boolean">true</span> <span class="token keyword">then</span> <span class="token string">'Y'</span> <span class="token keyword">else</span> <span class="token string">'N'</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> nullable<span class="token punctuation">,</span>
col_description<span class="token punctuation">(</span>a<span class="token punctuation">.</span>attrelid<span class="token punctuation">,</span>a<span class="token punctuation">.</span>attnum<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">comment</span>
<span class="token keyword">from</span> pg_attribute a
<span class="token keyword">where</span> attstattarget<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">and</span> attrelid <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token keyword">select</span> oid <span class="token keyword">from</span> pg_class <span class="token keyword">where</span> relname <span class="token operator">in</span><span class="token punctuation">(</span><span class="token keyword">select</span> relname <span class="token keyword">from</span> pg_class <span class="token keyword">where</span> relkind <span class="token operator">=</span><span class="token string">'r'</span> <span class="token operator">and</span> relname <span class="token operator">like</span> <span class="token string">'td_%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> table_name<span class="token punctuation">,</span>a<span class="token punctuation">.</span>attnum<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表名称条件 <code>relname like &#39;td_%&#39;</code></p>
<h3 id="执行sql文件"><a href="#执行sql文件" class="headerlink" title="执行sql文件"></a>执行sql文件</h3><p>增加上<code>-f</code>参数。</p>
<pre class="line-numbers language-none"><code class="language-none">psql -d  develop   -h  localhost   -U gpadmin  -p 5432 -f mysql.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>每个sql，要写<code>;</code>不能省略。</p>
<h3 id="压缩表"><a href="#压缩表" class="headerlink" title="压缩表"></a>压缩表</h3><p><a target="_blank" rel="noopener" href="http://blog.itpub.net/29162273/viewspace-2129556/">http://blog.itpub.net/29162273/viewspace-2129556/</a></p>
<h3 id="面向列存储的表"><a href="#面向列存储的表" class="headerlink" title="面向列存储的表"></a>面向列存储的表</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hider/p/9402862.html">https://www.cnblogs.com/hider/p/9402862.html</a></p>
<h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><p>由于有日志文件的产生，导致master所在的磁盘非常的大。故，根据需求，直接删除即可。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token builtin class-name">cd</span> /d/p1/master/gpseg-1/pg_log
<span class="token function">rm</span> -f  <span class="token function">rm</span> -f gpdb-2021-07-*
<span class="token function">du</span> -sh <span class="token builtin class-name">.</span>  <span class="token comment"># 查看释放后的空间大小。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="结果显示"><a href="#结果显示" class="headerlink" title="结果显示"></a>结果显示</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34038293/article/details/86263027">https://blog.csdn.net/weixin_34038293/article/details/86263027</a></p>
<p>使用下面的命令进行开关。</p>
<pre class="line-numbers language-none"><code class="language-none">\x<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>类似于mysql <code>\G</code></p>
<h3 id="窗口函数"><a href="#窗口函数" class="headerlink" title="窗口函数"></a>窗口函数</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2172fd27f06a">https://www.jianshu.com/p/2172fd27f06a</a></p>
<p>利用窗口，取某种序列中，最值的那1条记录。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_scan_qin <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            ship_id<span class="token punctuation">,</span>
            ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ship_id
                <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                    ins_db_tm
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            tb_scan
        <span class="token keyword">WHERE</span>
            ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-7-19'</span>
        <span class="token operator">AND</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-7-20'</span>
        <span class="token operator">AND</span> scan_typ <span class="token operator">=</span> <span class="token string">'10'</span>
        <span class="token operator">AND</span> rmk_id <span class="token operator">=</span> <span class="token string">'1'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T <span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">--  注意，ROW_NUMBER的值从1开始</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h3 id="聚合函数string-agg与array-agg"><a href="#聚合函数string-agg与array-agg" class="headerlink" title="聚合函数string_agg与array_agg"></a>聚合函数string_agg与array_agg</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u011944141/article/details/78902678">https://blog.csdn.net/u011944141/article/details/78902678</a></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 不仅可以去重，还可以排序</span>
<span class="token keyword">select</span> array_agg<span class="token punctuation">(</span><span class="token keyword">distinct</span> deptno <span class="token keyword">order</span> <span class="token keyword">by</span> deptno <span class="token keyword">desc</span><span class="token punctuation">)</span> <span class="token keyword">from</span> jinbo<span class="token punctuation">.</span>employee<span class="token punctuation">;</span>
<span class="token comment">-- array_agg 排序再array取值，例如查询每个部门第一个入职的人</span>
<span class="token keyword">select</span> deptno<span class="token punctuation">,</span> <span class="token punctuation">(</span>array_agg<span class="token punctuation">(</span>ename <span class="token keyword">order</span> <span class="token keyword">by</span> hiredate <span class="token keyword">asc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">from</span> jinbo<span class="token punctuation">.</span>employee <span class="token keyword">group</span> <span class="token keyword">by</span> deptno<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="小数除法"><a href="#小数除法" class="headerlink" title="小数除法"></a>小数除法</h3><p>两个整数相除，结果还是整数，跟c语言的语法非常的相似。故，需要先转换其中的一个数。</p>
<p>参照：<a target="_blank" rel="noopener" href="https://blog.csdn.net/ctypyb2002/article/details/78751715">postgresql 除法保持小数位的方法</a></p>
<pre class="line-numbers language-none"><code class="language-none">round(s.cnt&#x2F;d.cnt::numeric,4)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>具体如下：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">\x
<span class="token keyword">select</span> <span class="token number">8</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c1<span class="token punctuation">,</span>
       <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c2<span class="token punctuation">,</span>
       <span class="token function">round</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>::<span class="token keyword">numeric</span> <span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c3<span class="token punctuation">,</span>
       <span class="token number">8</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span>::<span class="token keyword">numeric</span> <span class="token keyword">as</span> c4
<span class="token punctuation">;</span>

<span class="token operator">-</span><span class="token punctuation">[</span> RECORD <span class="token number">1</span> <span class="token punctuation">]</span><span class="token comment">--------------</span>
c1 <span class="token operator">|</span> <span class="token number">0</span>
c2 <span class="token operator">|</span> <span class="token number">0.0000</span>
c3 <span class="token operator">|</span> <span class="token number">0.0825</span>
c4 <span class="token operator">|</span> <span class="token number">0.08247422680412371134</span>

<span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">row</span><span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><p>数据库中基本的类型有数字、字符串、数组等。</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>类型</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>smallint</td>
<td>65536</td>
</tr>
<tr>
<td>2</td>
<td>int</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>bigint</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>char(10)</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>varchar(10)</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>text</td>
<td>最简单的方式，适合存数据<br>用的时候，再转换类型。</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h3><h4 id="numeric"><a href="#numeric" class="headerlink" title="numeric"></a>numeric</h4><p>注意不要写拼写错了</p>
<p>参考资源：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38486203/article/details/93030268">https://blog.csdn.net/qq_38486203/article/details/93030268</a></p>
<p>使用cast</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">cast <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span> <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用<code>::</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token function">round</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>cnt<span class="token operator">/</span>d<span class="token punctuation">.</span>cnt::<span class="token keyword">numeric</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>双冒号有点局限性，</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 肯定不能直接相除，整数除发，显然不行</span>
<span class="token function">count</span><span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span>
<span class="token comment">-- 方式1</span>
<span class="token comment">-- count(ship_id)::numberic/count(doc_sn)</span>
<span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> tm<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>::numberic
<span class="token comment">-- 方式2</span>
cast <span class="token punctuation">(</span> <span class="token function">COUNT</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span> <span class="token punctuation">)</span>  <span class="token operator">/</span> cast <span class="token punctuation">(</span>  <span class="token function">COUNT</span> <span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">numeric</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>说明，空字符串的时候，无法转换，则可以使用过滤。</p>
<blockquote>
<p>空字符串错误提示：ERROR:  invalid input syntax for type numeric: “”</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">where</span> fields1::<span class="token keyword">numeric</span> <span class="token operator">!=</span> <span class="token string">''</span> <span class="token operator">and</span> fields1::<span class="token keyword">numeric</span> <span class="token operator">></span> <span class="token number">0.6</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>或者case when。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">case</span> 
    <span class="token keyword">when</span> i1l_ftconfid <span class="token operator">=</span> <span class="token string">''</span> <span class="token keyword">then</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">1.1</span> <span class="token keyword">then</span> <span class="token number">1.1</span>
    <span class="token keyword">when</span> i1l_ftconfid::<span class="token keyword">numeric</span> <span class="token operator">>=</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token number">1</span>
    <span class="token keyword">else</span> 
    <span class="token operator">-</span><span class="token number">1</span>
 <span class="token keyword">end</span> <span class="token keyword">as</span> possible<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="text"><a href="#text" class="headerlink" title="text"></a>text</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span>::<span class="token keyword">text</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="varchar"><a href="#varchar" class="headerlink" title="varchar"></a>varchar</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token number">1</span>::<span class="token keyword">varchar</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="regclass"><a href="#regclass" class="headerlink" title="regclass"></a>regclass</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">tableoid::regclass<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="date"><a href="#date" class="headerlink" title="date"></a>date</h4><pre class="line-numbers language-none"><code class="language-none">select &#39;2021-09-01&#39;::date;
select &#39;20210901&#39;::date;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="interval"><a href="#interval" class="headerlink" title="interval"></a>interval</h3><p>转换成时间间隔</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--  -1 days</span>
<span class="token keyword">select</span> <span class="token string">'-1 days'</span>::<span class="token keyword">interval</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token string">'30 days'</span>::<span class="token keyword">interval</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="grouping-set"><a href="#grouping-set" class="headerlink" title="grouping set"></a>grouping set</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sunbocong/article/details/79097713">https://blog.csdn.net/sunbocong/article/details/79097713</a></p>
<p>示例:</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">group</span> <span class="token keyword">by</span> grouping sets<span class="token punctuation">(</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>class<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>相当于，有3个分组union在一起的。以name、class、空3种分组。</p>
<p>另外，cube/rollup是对上面的再次封装。</p>
<h3 id="表空间"><a href="#表空间" class="headerlink" title="表空间"></a>表空间</h3><p>建表的时候，除了可以指定数据库，还可以指定空间。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sunziyue/article/details/51170341">https://blog.csdn.net/sunziyue/article/details/51170341</a></p>
<h3 id="更改密码"><a href="#更改密码" class="headerlink" title="更改密码"></a>更改密码</h3><p>psql</p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html">http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html</a></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token punctuation">\</span>password postgres<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="登录的用户"><a href="#登录的用户" class="headerlink" title="登录的用户"></a>登录的用户</h3><pre class="line-numbers language-none"><code class="language-none">set<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<h3 id="数据库启动、关闭"><a href="#数据库启动、关闭" class="headerlink" title="数据库启动、关闭"></a>数据库启动、关闭</h3><p>一次升级过程中，差点忘了执行关闭gp服务的操作了。结果匆忙，就执行了<code>gpstop</code>，然后等待了半天，提示输入模式选择<code>[&#39;(s)mart_mode&#39;, &#39;(f)ast_mode&#39;, &#39;(i)mmediate_mode&#39;]</code>，输入<code>f</code>即停止了服务。（有连接，服务可能等待服务短掉，才会停）</p>
<blockquote>
<p>先输入的gpstop 服务没有停掉，再另外一个窗口输入的<code>gpstop -M fast</code>，提示停止失败。所以，只能等gpstop的命令。</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">su</span> - gpadmin
<span class="token comment"># 先调整时间，再启动</span>
ntpdate <span class="token number">10.0</span>.2.2
gpstart

<span class="token comment"># 停止服务 使用快速关闭模式   开关闭服务</span>
gpstop -M fast<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="dblink-postgre-fdw"><a href="#dblink-postgre-fdw" class="headerlink" title="dblink/postgre_fdw"></a>dblink/postgre_fdw</h3><p>这两个工具都能连接其他的postgresql，如果需要连接mysql，则需要安装mysql_fdw扩展。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> extension dblink<span class="token punctuation">;</span>
<span class="token keyword">drop</span> extension dblink<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39540651/article/details/104005279">https://blog.csdn.net/weixin_39540651/article/details/104005279</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39540651/article/details/101367310">https://blog.csdn.net/weixin_39540651/article/details/101367310</a></p>
<h3 id="gp-tooltik"><a href="#gp-tooltik" class="headerlink" title="gp_tooltik"></a>gp_tooltik</h3><p>一些工具函数</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/xfg0218/article/details/100896956">https://blog.csdn.net/xfg0218/article/details/100896956</a></p>
<h3 id="查看用户会话和提交的查询等信息"><a href="#查看用户会话和提交的查询等信息" class="headerlink" title="查看用户会话和提交的查询等信息"></a><strong>查看用户会话和提交的查询等信息</strong></h3><p> select * from pg_stat_activity 该表能查看到当前数据库连接的IP 地址，用户名，提交的查询等。另外也可以在master 主机上查看进程，对每个客户端连接，master 都会创建一个进程。 </p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">ps</span> -ef <span class="token operator">|</span><span class="token function">grep</span> -i postgres <span class="token operator">|</span><span class="token function">grep</span> -i con<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> <strong>评：常用的命令，查看数据库死在那个sql上了。</strong> </p>
<h3 id="配置详解"><a href="#配置详解" class="headerlink" title="配置详解"></a>配置详解</h3><p>暂时放一些配置的链接。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/xfg0218/article/details/86650624">https://blog.csdn.net/xfg0218/article/details/86650624</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zsql/p/14602612.html">https://www.cnblogs.com/zsql/p/14602612.html</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1447227">https://cloud.tencent.com/developer/article/1447227</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/41814554">https://zhuanlan.zhihu.com/p/41814554</a></li>
</ul>
<h3 id="终端提示符设置"><a href="#终端提示符设置" class="headerlink" title="终端提示符设置"></a>终端提示符设置</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/logsharing/p/8034322.html">https://www.cnblogs.com/logsharing/p/8034322.html</a></p>
<p>设置</p>
<pre class="line-numbers language-none"><code class="language-none">\set PROMPT1  &#39;%&#x2F;@%M:%&gt;%R%#&#39;

\set PROMPT1 &#39;%[%033[1;33;40m%]%n@%&#x2F;%R%[%033[0m%#%]&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果想长期有效，则应该<code>~/.pgsqlrc</code>中设置。</p>
<p>提示可以包含终端控制字符，这些字符可以改变颜色，北京，或者提示文本的风格， 或者改变终端窗口的标题。为了让 Readline 的行编辑特性正确运行， 这些不可打印的控制字符必须设计成不可见的，方法是用 %[ 和 %] 包围它们。 在提示符里可能出现这些东西的多个配对。</p>
<h3 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h3><p>简单的示例如下：以下代码可以直接在navicat等工具上执行。下面的代码，提供了一个非常主要的可能。比如，我们需要对一段时间内的每天，执行同样统计操作，则可以执行下面的操作。</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">DO</span> $$
<span class="token keyword">BEGIN</span>
   <span class="token keyword">FOR</span> counter <span class="token operator">IN</span> <span class="token number">1.</span><span class="token number">.5</span> <span class="token keyword">LOOP</span>
       <span class="token keyword">RAISE</span> NOTICE  <span class="token string">'Counter:%'</span><span class="token punctuation">,</span>counter<span class="token punctuation">;</span>
   <span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>$$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>涨见识了。</p>
<h3 id="number-of-workfiles-per-query-limit-exceeded"><a href="#number-of-workfiles-per-query-limit-exceeded" class="headerlink" title="number of workfiles per query limit exceeded"></a>number of workfiles per query limit exceeded</h3><p>报错如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">psql:fetch.sql:545: ERROR:  number of workfiles per query limit exceeded  <span class="token punctuation">(</span>seg15 <span class="token number">10.181</span>.86.12:55015 <span class="token assign-left variable">pid</span><span class="token operator">=</span><span class="token number">9803</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>找到文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012948976/article/details/52695372">https://blog.csdn.net/u012948976/article/details/52695372</a></p>
<p>如果为SQL查询分配的内存不足，Greenplum数据库会创建溢出文件（也叫工作文件）。在默认情况下，一个SQL查询最多可以创建 100000 个溢出文件，这足以满足大多数查询。<br>该参数决定了一个查询最多可以创建多少个溢出文件。0 意味着没有限制。限制溢出文件数据可以防止失控查询破坏整个系统。<br>如果分配内存不足或者出现数据倾斜，则一个SQL查询可能产生大量溢出文件。如果超过溢出文件上限，Greenplum数据库报错。</p>
<p>疑惑的是：我并未在gp的配置中找到<code> gp_workfile_limit_files_per_query</code>配置项。</p>
<h3 id="查看数据库的锁情况"><a href="#查看数据库的锁情况" class="headerlink" title="查看数据库的锁情况"></a>查看数据库的锁情况</h3><p>比如有些sql操作后，长时间没有结果，查看下锁情况。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> pg_stat_activity <span class="token keyword">where</span> state <span class="token operator">&lt;></span> <span class="token string">'idle'</span> <span class="token operator">and</span> waiting_reason<span class="token operator">=</span><span class="token string">'lock'</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h2 id="表、库操作"><a href="#表、库操作" class="headerlink" title="表、库操作"></a>表、库操作</h2><p>表的名称，对于默认的表空间，可以省略。</p>
<h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><h4 id="create-table-as-select"><a href="#create-table-as-select" class="headerlink" title="create table as select"></a>create table as select</h4><p>另外，参见   查 create table as select</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> mytable<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mytable <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token comment">--  具体的sql语句</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="万能的建表语句（分布-分区）"><a href="#万能的建表语句（分布-分区）" class="headerlink" title="万能的建表语句（分布+分区）"></a>万能的建表语句（分布+分区）</h4><p>新建分区表，使用主键分布，时间分区。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tu_doc_info <span class="token punctuation">(</span>
	doc_sn <span class="token keyword">VARCHAR</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	dtime <span class="token keyword">TIMESTAMP</span> without <span class="token keyword">time</span> zone
<span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>appendonly<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> compresslevel<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> orientation<span class="token operator">=</span><span class="token keyword">column</span><span class="token punctuation">,</span> compresstype<span class="token operator">=</span>zlib<span class="token punctuation">)</span>
<span class="token keyword">Distributed</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>doc_sn<span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> range <span class="token punctuation">(</span>dtime<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">PARTITION</span> pn <span class="token keyword">START</span> <span class="token punctuation">(</span><span class="token string">'2020-06-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token punctuation">(</span><span class="token string">'2023-01-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> EVERY <span class="token punctuation">(</span><span class="token string">'1 day'</span>::<span class="token keyword">interval</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">DEFAULT</span> <span class="token keyword">PARTITION</span> pdefault
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">comment</span> <span class="token keyword">on</span> <span class="token keyword">table</span> tu_doc_info <span class="token operator">is</span> <span class="token string">'拦截件表，author:myname,2021-07-30 17:29'</span><span class="token punctuation">;</span>
<span class="token keyword">comment</span> <span class="token keyword">on</span> <span class="token keyword">column</span> tu_doc_info<span class="token punctuation">.</span>dtime <span class="token operator">is</span> <span class="token string">'系统时间'</span><span class="token punctuation">;</span>
<span class="token keyword">comment</span> <span class="token keyword">on</span> <span class="token keyword">column</span> tu_doc_info<span class="token punctuation">.</span>doc_sn <span class="token operator">is</span> <span class="token string">'单据号'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>备注：</p>
<blockquote>
<p>Distributed by (column)   ，其中column不用也不能加表的名称，如<code>mytable.column</code>，因为整个sql执行后，column的列是select出来的，应该是唯一、确定的。（变相的相当于加载了 select 字段上）</p>
</blockquote>
<p>万能建表语句，除时间戳以外，都可以简单的用<code>text</code>来表示，这样，也不会存再导入失败的问题。除非明确知道数据的类型。</p>
<p><code>decimal</code>可以单独用，不用指定后面两个参数。<code>varchar</code>也可以不用指定。但是，性能嘛……待研究。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">Create</span> <span class="token keyword">table</span> hlc_cmyk <span class="token punctuation">(</span>color <span class="token keyword">varchar</span><span class="token punctuation">,</span> c <span class="token keyword">decimal</span><span class="token punctuation">,</span> m <span class="token keyword">decimal</span><span class="token punctuation">,</span> y <span class="token keyword">decimal</span><span class="token punctuation">,</span> k <span class="token keyword">decimal</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="create-like"><a href="#create-like" class="headerlink" title="create like"></a>create like</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mytestss<span class="token punctuation">(</span>
    <span class="token operator">LIKE</span> tb_scan
<span class="token punctuation">)</span> 
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> range <span class="token punctuation">(</span>ins_db_tm<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">PARTITION</span> pn <span class="token keyword">START</span> <span class="token punctuation">(</span><span class="token string">'2021-09-07 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token punctuation">(</span><span class="token string">'2021-09-09 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> EVERY <span class="token punctuation">(</span><span class="token string">'1 day'</span>::<span class="token keyword">interval</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">DEFAULT</span> <span class="token keyword">PARTITION</span> pdefault
<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="直接select-into"><a href="#直接select-into" class="headerlink" title="直接select into"></a>直接select into</h4><p>bbbbb是一张不存在的表。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> bbbbb <span class="token keyword">from</span> gs <span class="token keyword">where</span> bm <span class="token operator">=</span> <span class="token string">'200095'</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> bbbbb <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="复制表结构"><a href="#复制表结构" class="headerlink" title="复制表结构"></a>复制表结构</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> table_one <span class="token punctuation">(</span><span class="token operator">like</span> table_two<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输出如下：</p>
<blockquote>
<p>table doesn’t have ‘DISTRIBUTED BY’ clause, defaulting to distribution columns from LIKE table</p>
</blockquote>
<p>采用一样的分布键。</p>
<p>采用create来创建表。</p>
<p>采用select来复制表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 故意不输出数据 用where 1!=1 貌似也是可以的</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> i1_import_raw2 <span class="token keyword">from</span>  i1_import_raw <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">;</span> 
\d<span class="token operator">+</span> i1_import_raw2
<span class="token comment">-- 调整一下表结构</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> i1_import_raw2 <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> ftconfid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="修改表结构"><a href="#修改表结构" class="headerlink" title="修改表结构"></a>修改表结构</h3><h4 id="一般步骤"><a href="#一般步骤" class="headerlink" title="一般步骤"></a>一般步骤</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 更改结构</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">analyze</span> i1_import_raw<span class="token punctuation">;</span>
\d<span class="token operator">+</span> i1_import_raw<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="增加字段"><a href="#增加字段" class="headerlink" title="增加字段"></a>增加字段</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> table_name <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> kafka_time <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意：不能指定插入的位置，只能插入在末尾。标准的sql就没有指定顺序的方式。变通：1、新建表，复制旧数据到新表，删除旧表，2、或者创建视图，来保证顺序一致。</p>
<h4 id="修改字段类型"><a href="#修改字段类型" class="headerlink" title="修改字段类型"></a>修改字段类型</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> oos_order_data_02 <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> sender_name <span class="token keyword">TYPE</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token comment">-- 修改字段，需要先类型转换。</span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> mytable <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> vld_tm <span class="token keyword">TYPE</span> <span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone <span class="token keyword">using</span> vld_tm::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>vld_tm原始数据，是<code>2021-08-03</code>这种，即需要计算，才能转换,报错如：<code>You might need to specify &quot;USING vld_tm::timestamp without time zone&quot;</code></p>
</blockquote>
<p>修改表后，需要执行<code>analyze mytable </code>命令，否则，联表查询的时候，貌似会有下面的错误。</p>
<p>For non-partitioned tables, run analyze <table_name>(<column_list>). For partitioned tables, run analyze rootpartition <table_name>(<column_list>). See log for columns missing statistics.</p>
<p>同理，将text类型，更改为int型，也需要更增加<code>using 字段::integer</code>转换类型。可能遇到空串无法转换问题。</p>
<p><code>using </code>实际上跟得是一个表达式。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"yunchou"</span><span class="token punctuation">.</span><span class="token string">"demo1"</span> <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> <span class="token string">"value"</span> <span class="token keyword">TYPE</span> int4 <span class="token keyword">using</span> <span class="token keyword">value</span>::<span class="token keyword">integer</span><span class="token punctuation">;</span>
<span class="token comment">-- 出现空串无法转换时，则可以使用计算表达式来完成。</span>
<span class="token comment">-- ERROR:  invalid input syntax for integer: ""  </span>
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">"yunchou"</span><span class="token punctuation">.</span><span class="token string">"demo1"</span> <span class="token keyword">ALTER</span> <span class="token keyword">COLUMN</span> <span class="token string">"value"</span> <span class="token keyword">TYPE</span> int4 <span class="token keyword">using</span> <span class="token keyword">case</span> <span class="token keyword">value</span> <span class="token keyword">when</span> <span class="token string">''</span> <span class="token keyword">then</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token keyword">value</span>::<span class="token keyword">integer</span> <span class="token keyword">end</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> mytable <span class="token keyword">DROP</span> <span class="token keyword">COLUMN</span> myfield<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>增加备注、修改备注</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">comment</span> <span class="token keyword">on</span> <span class="token keyword">column</span> mytable<span class="token punctuation">.</span>goods_sn <span class="token operator">is</span> <span class="token string">'物品编号'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>有些情况下，是无法修改字段类型的，如：</p>
<blockquote>
<p>ERROR:  cannot alter type of a column used in a distribution policy</p>
</blockquote>
<blockquote>
<p>临时的解决方式是，重新建一张新表，然后将旧的数据迁移到新表中，然后，交换一下表名称，确认数据无误后，删除旧的表。</p>
</blockquote>
<h3 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> 	mytable<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="清空表"><a href="#清空表" class="headerlink" title="清空表"></a>清空表</h3><p>清空表比delete的方式快一点。但是pg不会清空原有的</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">TRUNCATE</span> mytable<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="修改表名称"><a href="#修改表名称" class="headerlink" title="修改表名称"></a>修改表名称</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> td_mail_02 <span class="token keyword">rename</span> <span class="token keyword">to</span> td_mail_new<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="备份、恢复数据表"><a href="#备份、恢复数据表" class="headerlink" title="备份、恢复数据表"></a>备份、恢复数据表</h3><p>简单的方式，性能、效率估计不会太好。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-- 备份
pg_dump db -t table <span class="token operator">></span> table.out
pg_dump db <span class="token operator">></span> sqls.out
-- 恢复
psql -d gregp -f dball.out<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h2><h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><p>略</p>
<h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><p>略</p>
<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><p>略</p>
<h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><p>分组统计</p>
<p>使用第1个字段进行分组统计和排序，居然能简省写做1。  好神奇。</p>
<p>类推：第2个字段用2   3   4</p>
<blockquote>
<p>同事说 记得sqlserver,oracle也可以省略 </p>
</blockquote>
<pre class="line-numbers language-none"><code class="language-none">select hh,count(1) from td_count_tb_scan_m group by 1 order by 1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="查-create-table-as-select"><a href="#查-create-table-as-select" class="headerlink" title="查 create table as select"></a>查 create table as select</h3><p>注意，select出来的表，应该有具体的名称，否则会有提示。<code>?column?</code></p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_scan_fen<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_scan_fen <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            ship_id<span class="token punctuation">,</span>
            scan_site<span class="token punctuation">,</span>
            scan_emp<span class="token punctuation">,</span>
            scan_tm<span class="token punctuation">,</span>
            rmk_inf<span class="token punctuation">,</span>
            rmk_id<span class="token punctuation">,</span>
            <span class="token keyword">CASE</span>
        <span class="token keyword">WHEN</span> CHAR_LENGTH <span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>
        <span class="token operator">OR</span> rmk_inf SIMILAR <span class="token keyword">TO</span> <span class="token string">'\d&#123;1,&#125;'</span> <span class="token keyword">THEN</span>
            <span class="token number">1</span>
        <span class="token keyword">ELSE</span>
            <span class="token number">0</span>
        <span class="token keyword">END</span> <span class="token keyword">AS</span> is_mark_code<span class="token punctuation">,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ship_id
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                scan_tm <span class="token keyword">DESC</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        tb_scan
    <span class="token keyword">WHERE</span>
        ins_db_tm <span class="token operator">>=</span> <span class="token string">'2021-6-30'</span>
    <span class="token operator">AND</span> ins_db_tm <span class="token operator">&lt;</span> <span class="token string">'2021-7-10'</span>
    <span class="token operator">AND</span> scan_typ <span class="token operator">=</span> <span class="token string">'24'</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> T
<span class="token keyword">WHERE</span>
    T <span class="token punctuation">.</span>rn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>增加DISTRIBUTED</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> branch<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> branch <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span>  <span class="token keyword">AS</span> 
<span class="token keyword">SELECT</span>
    bm<span class="token punctuation">,</span>  <span class="token comment">-- 网点编码</span>
    mc<span class="token punctuation">,</span>  <span class="token comment">-- 网点名称</span>
    szd<span class="token punctuation">,</span> <span class="token comment">-- 区</span>
    county<span class="token punctuation">.</span>CityID <span class="token keyword">as</span> city_id<span class="token punctuation">,</span> <span class="token comment">-- 市</span>
    city<span class="token punctuation">.</span>ProvinceID <span class="token keyword">as</span> province_id<span class="token punctuation">,</span> <span class="token comment">-- 省</span>
    sjdw<span class="token punctuation">,</span><span class="token comment">-- 上级公司id</span>
    wdzzz_cw<span class="token punctuation">.</span>zzz  <span class="token comment">-- 上级分拨id</span>
<span class="token keyword">FROM</span>
    gs
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> county <span class="token keyword">ON</span> gs<span class="token punctuation">.</span>szd <span class="token operator">=</span> county<span class="token punctuation">.</span>CountyID
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> city <span class="token keyword">ON</span> county<span class="token punctuation">.</span>CityID <span class="token operator">=</span> city<span class="token punctuation">.</span>CityID
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> wdzzz_cw <span class="token keyword">ON</span> gs<span class="token punctuation">.</span>bm <span class="token operator">=</span> wdzzz_cw<span class="token punctuation">.</span>wdbm
<span class="token comment">--# 果然，到官网瞬间能找到正确的用法。</span>
<span class="token comment">--# https://gpdb.docs.pivotal.io/6-17/ref_guide/sql_commands/CREATE_TABLE_AS.html</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>bm<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>居然，下面是错的，因为在select后，字段是确定的，故，直接使用最终的字段名即可。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>bm<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="复制表"><a href="#复制表" class="headerlink" title="复制表"></a>复制表</h3><p>另外，一个场景，详见数据迁移。</p>
<p>场景：原始的表，td_daike未加Distributed、partition命令。重新建一张新表，然后将数据导入到新表中。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> td_daike_03 <span class="token punctuation">(</span>
    id bigserial<span class="token punctuation">,</span>
    process_time <span class="token keyword">text</span><span class="token punctuation">,</span>
    processor <span class="token keyword">text</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span>appendonly<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">,</span> compresslevel<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> orientation<span class="token operator">=</span><span class="token keyword">column</span><span class="token punctuation">,</span> compresstype<span class="token operator">=</span>zlib<span class="token punctuation">)</span>

<span class="token keyword">Distributed</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>mail_no<span class="token punctuation">)</span>
<span class="token keyword">partition</span> <span class="token keyword">by</span> range <span class="token punctuation">(</span>insert_time<span class="token punctuation">)</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">PARTITION</span> pn <span class="token keyword">START</span> <span class="token punctuation">(</span><span class="token string">'2020-06-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> <span class="token keyword">END</span> <span class="token punctuation">(</span><span class="token string">'2023-01-01 00:00:00'</span>::<span class="token keyword">timestamp</span> without <span class="token keyword">time</span> zone<span class="token punctuation">)</span> EVERY <span class="token punctuation">(</span><span class="token string">'1 day'</span>::<span class="token keyword">interval</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token keyword">DEFAULT</span> <span class="token keyword">PARTITION</span> pdefault
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>手动建表后，使用下面命令，拷贝到新表中。1亿条数据，greenplum  1、2分钟就搞定。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 比较适合，td_daike_03表已经存在，td_daike_03新表，有分区，td_daike旧表，无分区</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> td_daike_03 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> td_daike<span class="token punctuation">;</span>

<span class="token comment">-- 如果两张表的列数不一致，那么可以填加上具体的列</span>
<span class="token comment">-- 比较适合，td_mail_03    INSERT 0 109585400   14:28  14:48(看时，已经结束）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> td_mail_03 <span class="token keyword">select</span> ship_id<span class="token punctuation">,</span>send_id<span class="token punctuation">,</span>recv_id<span class="token punctuation">,</span>kafka_time<span class="token punctuation">,</span>insert_time <span class="token keyword">from</span> td_mail_02<span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> jd_order_waybill_info_03<span class="token punctuation">(</span>kafka_time<span class="token punctuation">,</span>insert_time<span class="token punctuation">)</span> <span class="token keyword">select</span>   cast<span class="token punctuation">(</span>kafka_time <span class="token keyword">as</span> <span class="token keyword">timestamp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>insert_time <span class="token keyword">from</span> jd_order_waybill_info_02 <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">-- 部分字段测试</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> i1_order2 <span class="token punctuation">(</span>字段列表<span class="token punctuation">)</span> <span class="token keyword">select</span> 字段列表  <span class="token keyword">from</span> i1_order<span class="token punctuation">;</span>
<span class="token comment">-- 部分字段，经测试发现，，insert部分也能省略</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> i1_order2 <span class="token keyword">select</span> 字段列表  <span class="token keyword">from</span> i1_order<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面命令，会自动建一个同样结构的表。如果手动建了td_daike_03表反而会报错。适合相同的表结构。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--  直接会新建一个表td_daike_03，然后迁移数据到其内。</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> td_daike_03 <span class="token keyword">from</span> td_daike<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>交换表名称</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> td_mail_02 <span class="token keyword">rename</span> <span class="token keyword">to</span> td_mail_old<span class="token punctuation">;</span> 
<span class="token keyword">alter</span> <span class="token keyword">table</span> td_mail_03 <span class="token keyword">rename</span> <span class="token keyword">to</span> td_mail_02<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>删除旧表</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> td_mail_old<span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<blockquote>
<p>数据表复制过程中，遇到了如下错误：</p>
<p>ERROR:  column “kafka_time” is of type timestamp without time zone but expression is of type character varying。</p>
<p>首先，尝试着更改类型：</p>
<p>ALTER TABLE jd_order_waybill_info_02 ALTER COLUMN kafka_time TYPE timestamp without time zone;</p>
</blockquote>
<p>使用如下方式，解决插入：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 先执行分析表，否则，会有提示。（因为之前执行了alter table kafka .....）</span>
<span class="token keyword">analyze</span> jd_order_waybill_info_02<span class="token punctuation">;</span> 

<span class="token comment">-- 真正的插入语句，省略了部分</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> jd_order_waybill_info_03 <span class="token keyword">select</span> cast<span class="token punctuation">(</span>kafka_time <span class="token keyword">as</span> <span class="token keyword">timestamp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>insert_time <span class="token keyword">from</span> jd_order_waybill_info_02 <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="增加索引"><a href="#增加索引" class="headerlink" title="增加索引"></a>增加索引</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> send_id_idx
    <span class="token keyword">ON</span> td_mail_02 <span class="token punctuation">(</span>send_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<h2 id="查询相关"><a href="#查询相关" class="headerlink" title="查询相关"></a>查询相关</h2><h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><pre class="line-numbers language-none"><code class="language-none">create view scc_day_percent as <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>示例：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">view</span> scc_day_percent <span class="token keyword">as</span> 
<span class="token keyword">SELECT</span>
    s<span class="token punctuation">.</span>site<span class="token punctuation">,</span>
    s<span class="token punctuation">.</span>cnt <span class="token keyword">AS</span> scan_cnt<span class="token punctuation">,</span>
    d<span class="token punctuation">.</span>cnt <span class="token keyword">AS</span> doc_cnt<span class="token punctuation">,</span>
    <span class="token keyword">CASE</span>
<span class="token keyword">WHEN</span> s<span class="token punctuation">.</span>cnt <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token operator">AND</span> d<span class="token punctuation">.</span>cnt <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">THEN</span>
    <span class="token function">round</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>cnt<span class="token operator">/</span>s<span class="token punctuation">.</span>cnt::<span class="token keyword">numeric</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">ELSE</span>
    <span class="token number">0</span>
<span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token keyword">percent</span>
<span class="token keyword">FROM</span>
    scc_day_scan_site <span class="token keyword">AS</span> s
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> scc_day_doc_site <span class="token keyword">AS</span> d <span class="token keyword">ON</span> s<span class="token punctuation">.</span>site <span class="token operator">=</span> d<span class="token punctuation">.</span>site
<span class="token operator">AND</span> s<span class="token punctuation">.</span>riqi <span class="token operator">=</span> d<span class="token punctuation">.</span>riqi<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>删除视图：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 语法</span>
<span class="token keyword">DROP</span> <span class="token keyword">VIEW</span> view_name
<span class="token comment">-- 示例</span>
<span class="token keyword">drop</span> <span class="token keyword">view</span> scc_day_percent<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h3><p>直接</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> ship_id<span class="token punctuation">,</span> gs <span class="token keyword">from</span> test <span class="token punctuation">;</span> <span class="token comment">-- 这个依然是3条记录</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DISTINCT</span> ship_id <span class="token keyword">from</span> test <span class="token punctuation">;</span> <span class="token comment">-- 这个导是能选择出唯一的 1.2</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token string">"ship_id"</span><span class="token punctuation">,</span> <span class="token string">"gs"</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'shanghai'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token string">"ship_id"</span><span class="token punctuation">,</span> <span class="token string">"gs"</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span> <span class="token string">'shanghai2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token string">"ship_id"</span><span class="token punctuation">,</span> <span class="token string">"gs"</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">,</span> <span class="token string">'shanghai'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="row-number去重"><a href="#row-number去重" class="headerlink" title="row_number去重"></a>row_number去重</h3><p>貌似下面的去重是一种通用的方式。先通过窗口查询，然后再从结果集中取结果。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
    <span class="token operator">*</span>
<span class="token keyword">FROM</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span>
            <span class="token operator">*</span><span class="token punctuation">,</span> ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
                <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> branch_code<span class="token punctuation">,</span>
                salesman_id
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                update_time <span class="token keyword">DESC</span>
            <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
        <span class="token keyword">FROM</span>
            ydwr_base_salesman_sorting
    <span class="token punctuation">)</span> t
<span class="token keyword">WHERE</span>
    rn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="distinct-on"><a href="#distinct-on" class="headerlink" title="distinct on"></a>distinct on</h3><p><code>distinct on</code>需要排序，而且排序的字段，必须出现在on后的括号内，貌似不太好用。待深究。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">distinct</span> <span class="token keyword">on</span> <span class="token punctuation">(</span>ship_id<span class="token punctuation">,</span>batch<span class="token punctuation">)</span> <span class="token operator">*</span>  <span class="token keyword">from</span> test_alldata_20210710 <span class="token keyword">order</span> <span class="token keyword">by</span>  batch <span class="token keyword">desc</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="case-when"><a href="#case-when" class="headerlink" title="case when"></a>case when</h3><p>虽然自己琢磨case when没有参照<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gengyufei/p/12614387.html">这篇文章</a>，但是觉得还不错。</p>
<h4 id="计算"><a href="#计算" class="headerlink" title="计算"></a>计算</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">case</span> 
    <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
    <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
    <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
    <span class="token keyword">else</span>  <span class="token number">4</span>
<span class="token keyword">end</span> <span class="token keyword">as</span> ldsj_val<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有的时候，统计使用</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> 
    <span class="token function">SUM</span> <span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> STU_SEX <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> MALE_COUNT<span class="token punctuation">,</span>
    <span class="token function">SUM</span> <span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> STU_SEX <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> FEMALE_COUNT<span class="token punctuation">,</span>
    <span class="token function">SUM</span> <span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> STU_SCORE <span class="token operator">>=</span> <span class="token number">60</span> <span class="token operator">AND</span> STU_SEX <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> MALE_PASS<span class="token punctuation">,</span>
    <span class="token function">SUM</span> <span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> STU_SCORE <span class="token operator">>=</span> <span class="token number">60</span> <span class="token operator">AND</span> STU_SEX <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> FEMALE_PASS
<span class="token keyword">FROM</span> 
    THTF_STUDENTS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="对比下面两个例子，实际上是表达同一个意思。"><a href="#对比下面两个例子，实际上是表达同一个意思。" class="headerlink" title="对比下面两个例子，实际上是表达同一个意思。"></a>对比下面两个例子，实际上是表达同一个意思。</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	<span class="token keyword">CASE</span> ship_id    <span class="token comment">-- 注意，这个是针对同个字段</span>
        <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'one'</span>
        <span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token string">'two'</span>
        <span class="token keyword">ELSE</span> <span class="token string">'other'</span>
	<span class="token keyword">END</span> <span class="token keyword">AS</span> nu<span class="token punctuation">,</span>
    ship_id<span class="token punctuation">,</span>
    gs
<span class="token keyword">FROM</span> test<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
	<span class="token keyword">CASE</span>     <span class="token comment">-- 这个，没有字段</span>
        <span class="token keyword">WHEN</span> ship_id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'one'</span>
        <span class="token keyword">WHEN</span> ship_id <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token string">'two'</span>
        <span class="token keyword">ELSE</span> <span class="token string">'other'</span>
    <span class="token keyword">END</span> <span class="token keyword">AS</span> nu<span class="token punctuation">,</span>
    ship_id<span class="token punctuation">,</span>
    gs
<span class="token keyword">FROM</span> test<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><p>排序的时候，跟在order by 。</p>
<blockquote>
<p>ORDER BY 居然不能使用select后面的计算字段，故突发奇想，直接放到order by后面算了，（类似于having 后面直接跟表达式一样。）</p>
<p>后发现文章：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/178mz/p/6428958.html">https://www.cnblogs.com/178mz/p/6428958.html</a></p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span>
<span class="token operator">*</span>
<span class="token keyword">from</span> 
<span class="token punctuation">(</span>
    <span class="token keyword">select</span>
        <span class="token operator">*</span><span class="token punctuation">,</span>
        ROW_NUMBER <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> <span class="token punctuation">(</span>
            <span class="token keyword">PARTITION</span> <span class="token keyword">BY</span> ship_id
            <span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
                <span class="token keyword">case</span> 
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'CAINIAO'</span> <span class="token keyword">then</span> <span class="token number">1</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YDEC'</span> <span class="token keyword">then</span> <span class="token number">2</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'JD'</span> <span class="token keyword">then</span> <span class="token number">3</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDD'</span> <span class="token keyword">then</span> <span class="token number">4</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'BM'</span> <span class="token keyword">then</span> <span class="token number">5</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'YJ'</span> <span class="token keyword">then</span> <span class="token number">6</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PDDGJ'</span> <span class="token keyword">then</span> <span class="token number">7</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'其他'</span> <span class="token keyword">then</span> <span class="token number">8</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS_NON_ELE'</span> <span class="token keyword">then</span> <span class="token number">9</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'OOS'</span> <span class="token keyword">then</span> <span class="token number">10</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME_NON_LEL'</span> <span class="token keyword">then</span> <span class="token number">11</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'PC_REAL_NAME'</span> <span class="token keyword">then</span> <span class="token number">12</span>
                <span class="token keyword">when</span>  ldly <span class="token operator">=</span> <span class="token string">'COD'</span> <span class="token keyword">then</span> <span class="token number">13</span>
                <span class="token keyword">else</span>  <span class="token number">14</span>
            <span class="token keyword">end</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span>ldsj <span class="token keyword">desc</span>    <span class="token comment">-- 优先从ldly（按规则顺序取），若相等，则判断ldsj（取最晚）</span>
        <span class="token punctuation">)</span> <span class="token keyword">AS</span> rn
    <span class="token keyword">FROM</span>
        test_alldata_20210710
<span class="token punctuation">)</span> t
<span class="token keyword">where</span> rn <span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>验证：</p>
<p>下面表示要将ship_id为1的放在最后。确实达到效果了。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> test 
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">case</span> ship_id <span class="token keyword">when</span> <span class="token number">1</span> <span class="token keyword">then</span> <span class="token number">2</span> <span class="token keyword">else</span> <span class="token number">1</span> <span class="token keyword">end</span> <span class="token keyword">asc</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h2 id="函数使用"><a href="#函数使用" class="headerlink" title="函数使用"></a>函数使用</h2><h3 id="array-agg"><a href="#array-agg" class="headerlink" title="array_agg"></a>array_agg</h3><p> array_agg(distinct 想要合并的数据)：将想要的数据变成数组。 </p>
<h3 id="array-to-string"><a href="#array-to-string" class="headerlink" title="array_to_string"></a>array_to_string</h3><pre class="line-numbers language-none"><code class="language-none">array_to_string(array_agg(distinct p.c_name), &#39; , &#39;)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="string-to-array"><a href="#string-to-array" class="headerlink" title="string_to_array"></a>string_to_array</h3><p> string_to_array(c.c_groups, ‘,’)：将字符串按照“，”分隔成数组。 </p>
<h3 id="string-to-array-1"><a href="#string-to-array-1" class="headerlink" title="string_to_array"></a>string_to_array</h3><p>转换成数组。</p>
<h3 id="any"><a href="#any" class="headerlink" title="any"></a>any</h3><pre class="line-numbers language-none"><code class="language-none">left join on p.id &#x3D; any (string_to_array(c.persons, &#39;,&#39;)::int[])<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p> id = any(List)：id的值存在于List中，注意List要和id为同种类型。 </p>
<h3 id="with-recursive"><a href="#with-recursive" class="headerlink" title="with recursive"></a>with recursive</h3><pre class="line-numbers language-none"><code class="language-none">with recursive ytt(f1,f2) as (
values (0,&#39; &#39;::text)
union all
select f1+1,split_part(&#39;love,you,hate,number&#39;,&#39;,&#39;,f1+1) from ytt where f1 &lt; 20
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><h4 id="大小写转换"><a href="#大小写转换" class="headerlink" title="大小写转换"></a>大小写转换</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> ship_id<span class="token punctuation">,</span>lower<span class="token punctuation">(</span>gs<span class="token punctuation">)</span><span class="token punctuation">,</span>upper<span class="token punctuation">(</span>gs<span class="token punctuation">)</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


<h4 id="regexp-split-to-array"><a href="#regexp-split-to-array" class="headerlink" title="regexp_split_to_array"></a>regexp_split_to_array</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 没有转义，注意下面的结果返回为数组的表示方法。5个元素</span>
<span class="token keyword">SELECT</span> regexp_split_to_array<span class="token punctuation">(</span><span class="token string">'a|b|c'</span><span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">)</span>
&#123;a<span class="token punctuation">,</span><span class="token operator">|</span><span class="token punctuation">,</span>b<span class="token punctuation">,</span><span class="token operator">|</span><span class="token punctuation">,</span>c&#125;

<span class="token comment">-- 转义一次，才是正确的结果</span>
<span class="token keyword">SELECT</span> regexp_split_to_array<span class="token punctuation">(</span><span class="token string">'a|b|c'</span><span class="token punctuation">,</span><span class="token string">'\|'</span><span class="token punctuation">)</span>
&#123;a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c&#125;


<span class="token comment">-- 取第3个元素，注意函数返回的结果，增加了括号，增加优先级</span>
<span class="token keyword">SELECT</span> <span class="token punctuation">(</span>regexp_split_to_array<span class="token punctuation">(</span><span class="token string">'a|b|c'</span><span class="token punctuation">,</span><span class="token string">'\|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>

<span class="token comment">-- 之前以为可能需要增加别名才能用，实际上增加括号优先级即可。</span>
<span class="token comment">-- SELECT a[3] from (  SELECT regexp_split_to_array('a|b|c', '|') as a ) t;</span>

<span class="token comment">-- 拿真实的表测试。</span>
<span class="token keyword">select</span> <span class="token punctuation">(</span>regexp_split_to_array<span class="token punctuation">(</span><span class="token keyword">rule</span><span class="token punctuation">,</span><span class="token string">'\|'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">as</span> rule2 <span class="token keyword">from</span> addr_real <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="regexp-split-to-table"><a href="#regexp-split-to-table" class="headerlink" title="regexp_split_to_table"></a>regexp_split_to_table</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shenjiangwei/p/14239675.html">https://www.cnblogs.com/shenjiangwei/p/14239675.html</a></p>
<p>切割单词到sql的1条记录。统计地址中出现最多的字。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> regexp_split_to_table<span class="token punctuation">(</span><span class="token string">'您好世界'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_split_world<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_split_world <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> regexp_split_to_table<span class="token punctuation">(</span>recv_addr<span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token keyword">as</span> word <span class="token keyword">from</span> tu_doc_info <span class="token keyword">where</span> dtime <span class="token operator">>=</span><span class="token string">'2021-08-01'</span> <span class="token operator">and</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-08-02'</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_split_world_count<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_split_world_count <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> word<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> test_split_world <span class="token keyword">group</span> <span class="token keyword">by</span> word 
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>word<span class="token punctuation">)</span> <span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>出现最多的词呢？</p>
<p>pg_trgm</p>
<p>安装方式：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35260875/article/details/106148664">https://blog.csdn.net/qq_35260875/article/details/106148664</a></p>
<h4 id="正则-SIMILAR-TO"><a href="#正则-SIMILAR-TO" class="headerlink" title="正则 SIMILAR TO"></a>正则 SIMILAR TO</h4><p>之前用<code>SIMILAR TO</code>总是，判断失败，后来发现，写的正则必须要匹配整个单词（不能只写匹配字段的部分内容的正则）（也可以理解它默认省略了<code>^正则$</code>)。类似于like。 </p>
<blockquote>
<p>‘[S]%’ 匹配以S开头的单词，’[S]’匹配字母<code>s</code></p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 示例1  注意，%不能少，否则匹配的是单个的内容</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> gs SIMILAR <span class="token keyword">TO</span>  <span class="token string">'[S]%'</span><span class="token punctuation">;</span>


<span class="token comment">--示例2，'\d&#123;1,&#125;'   只能匹配全数数字的这种情况，如果是数字开头，则 \d%</span>
<span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> CHAR_LENGTH <span class="token punctuation">(</span>rmk_inf<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">OR</span> rmk_inf SIMILAR <span class="token keyword">TO</span> <span class="token string">'\d&#123;1,&#125;'</span> <span class="token keyword">THEN</span>
    rmk_inf
<span class="token keyword">ELSE</span>
    <span class="token string">''</span>
<span class="token keyword">END</span> <span class="token keyword">AS</span> mark_code<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="substring"><a href="#substring" class="headerlink" title="substring"></a>substring</h4><p>貌似序号从1开始。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">substring<span class="token punctuation">(</span>upper<span class="token punctuation">(</span>gs<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">2</span> <span class="token punctuation">)</span>

<span class="token keyword">SELECT</span> ship_id<span class="token punctuation">,</span>lower<span class="token punctuation">(</span>gs<span class="token punctuation">)</span><span class="token punctuation">,</span>substring<span class="token punctuation">(</span>upper<span class="token punctuation">(</span>gs<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'SH'</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span>
<span class="token comment">-- 更简单的方法</span>
<span class="token keyword">left</span><span class="token punctuation">(</span>upper<span class="token punctuation">(</span>gs<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">'S'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">case</span> <span class="token keyword">when</span> substring<span class="token punctuation">(</span>upper<span class="token punctuation">(</span>udf_4<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token number">1</span> <span class="token keyword">for</span> <span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">'MD'</span> <span class="token keyword">then</span>
                udf_4
            <span class="token keyword">else</span> 
                <span class="token boolean">null</span>
            <span class="token keyword">end</span> <span class="token keyword">as</span> last_signed_code<span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="left-right"><a href="#left-right" class="headerlink" title="left/right"></a>left/right</h4><p>取左边几个字符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">left</span><span class="token punctuation">(</span>str <span class="token keyword">text</span><span class="token punctuation">,</span> n <span class="token keyword">int</span><span class="token punctuation">)</span>

<span class="token comment">-- 中文也适用</span>
<span class="token keyword">select</span> <span class="token keyword">left</span><span class="token punctuation">(</span><span class="token string">'您好，世界'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">left</span> 
<span class="token comment">------</span>
 您好<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="length"><a href="#length" class="headerlink" title="length"></a>length</h4><pre class="line-numbers language-none"><code class="language-none">length(str)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h4 id="regexp-matches"><a href="#regexp-matches" class="headerlink" title="regexp_matches"></a>regexp_matches</h4><p>regexp_match</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> regexp_matches<span class="token punctuation">(</span><span class="token string">'foobarbequebaz'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="split-part"><a href="#split-part" class="headerlink" title="split_part"></a>split_part</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">split_part<span class="token punctuation">(</span>string <span class="token keyword">text</span><span class="token punctuation">,</span> <span class="token keyword">delimiter</span> text2<span class="token punctuation">,</span> field <span class="token keyword">int</span><span class="token punctuation">)</span>

<span class="token keyword">text</span><span class="token operator">=</span>“name<span class="token punctuation">.</span>cn” split_part<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> 结果： name
<span class="token keyword">text</span><span class="token operator">=</span>“name<span class="token punctuation">.</span>cn” split_part<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> 结果： cn
<span class="token keyword">text</span><span class="token operator">=</span>“name<span class="token punctuation">.</span>cn<span class="token punctuation">.</span>com” split_part<span class="token punctuation">(</span><span class="token keyword">text</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> 结果： com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="时间函数"><a href="#时间函数" class="headerlink" title="时间函数"></a>时间函数</h3><h4 id="时间to-char"><a href="#时间to-char" class="headerlink" title="时间to_char"></a>时间to_char</h4><blockquote>
<p>说明to_char的第一个参数，是数据库中的列，时间戳格式的。而字符格式的时间如，<code>2021-08-02 22:20</code>，类型不匹配，无法直接使用。第二个参数，是时间格式，具体见pg的手册说明。</p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 测试用法</span>
<span class="token keyword">SELECT</span> to_char<span class="token punctuation">(</span>dtime<span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span> <span class="token keyword">from</span> tu_doc_info <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>

to_char<span class="token punctuation">(</span>dtime<span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD HH24:MI:SS'</span><span class="token punctuation">)</span>    <span class="token comment">-- HH12按12小时制</span>

<span class="token comment">-- 示例</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>doc_src<span class="token punctuation">)</span> <span class="token keyword">from</span> tu_doc_info <span class="token keyword">where</span>  dtime<span class="token operator">>=</span> <span class="token string">'2021-07-01'</span> <span class="token operator">and</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-07-11'</span> <span class="token keyword">group</span> <span class="token keyword">by</span> to_char<span class="token punctuation">(</span>dtime<span class="token punctuation">,</span><span class="token string">'YYYY-MM-DD'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="to-timestamp"><a href="#to-timestamp" class="headerlink" title="to_timestamp"></a>to_timestamp</h4><p>一般入库的时候使用<code>2021-08-23 15:46</code>这种格式，设置好类型，不需要额外的转换，能自动转换成时间戳。但是呢，并非总有这么简单的需求。如下</p>
<p>欲将<code>I120210823112000</code>，转换为时间戳格式，<code>2021-08-23 11:20:00+08</code></p>
<p>参见<a target="_blank" rel="noopener" href="https://www.cnblogs.com/telwanggs/p/11056500.html">文章</a>,官方也有比较好的说明，但是篇幅太多，不太好找。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 先处理字符串，然后再调用处理成时间戳</span>
<span class="token keyword">select</span>  substring<span class="token punctuation">(</span><span class="token string">'I120210823112000'</span> <span class="token keyword">from</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">select</span> to_timestamp<span class="token punctuation">(</span>substring<span class="token punctuation">(</span><span class="token string">'I120210823112000'</span> <span class="token keyword">from</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'yyyyMMddhh24miss'</span><span class="token punctuation">)</span>


<span class="token comment">-- 不能直接转换</span>
<span class="token comment">-- select  substring('I120210823112000' from 3)::TIMESTAMP ;</span>
<span class="token comment">-- 必须要指定格式 select to_timestamp('20210823112000')</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h3><h4 id="max"><a href="#max" class="headerlink" title="max"></a>max</h4><p>分组后，select的字段，都需要进行聚合运算，而没有加入分组的字段，可以用max/min等计算一次，伪分组</p>
<h4 id="min"><a href="#min" class="headerlink" title="min"></a>min</h4><p>同max，分组或者不分组都可以。</p>
<h4 id="string-agg"><a href="#string-agg" class="headerlink" title="string_agg"></a>string_agg</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span>  ship_id<span class="token punctuation">,</span>string_agg<span class="token punctuation">(</span>ship_type<span class="token punctuation">,</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> ship_type 
<span class="token keyword">from</span> <span class="token punctuation">(</span><span class="token keyword">select</span> ship_id<span class="token punctuation">,</span>ship_type <span class="token keyword">from</span> marked_ship <span class="token keyword">group</span> <span class="token keyword">by</span> ship_id<span class="token punctuation">,</span>ship_type <span class="token punctuation">)</span> <span class="token keyword">as</span> f <span class="token keyword">group</span> <span class="token keyword">by</span>  ship_id



<span class="token keyword">SELECT</span> string_agg<span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token string">','</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> a<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token keyword">table</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_37971850/article/details/112616962">array的常见用法</a></p>
<h4 id="定义数组"><a href="#定义数组" class="headerlink" title="定义数组"></a>定义数组</h4><p><code>ARRAY[1,2]</code></p>
<pre class="line-numbers language-none"><code class="language-none">SELECT max(id) from unnest(ARRAY[1,2]) as id;

-- 字符串比较顺序，输出的是 1111  简单理解，按字符排序
SELECT max(id) from unnest(ARRAY[&#39;1111&#39;,&#39;11102&#39;]) as id;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>



<h4 id="unnest"><a href="#unnest" class="headerlink" title="unnest"></a>unnest</h4><p>首先，自定义函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> pyinc<span class="token punctuation">(</span>a <span class="token keyword">integer</span><span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">as</span> $$
<span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>a<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span>
$$ <span class="token keyword">language</span> plpythonu<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>调用函数，返回的是数据。</p>
<pre class="line-numbers language-plsql" data-language="plsql"><code class="language-plsql"><span class="token keyword">select</span> pyinc<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   pyinc    
<span class="token comment">------------</span>
 &#123;<span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span>&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后，将数组，转换为table的一列。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> unnest<span class="token punctuation">(</span> pyinc<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
 unnest 
<span class="token comment">--------</span>
     <span class="token number">10</span>
     <span class="token number">11</span>
     <span class="token number">12</span>
<span class="token punctuation">(</span><span class="token number">3</span> <span class="token keyword">rows</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="generate-series"><a href="#generate-series" class="headerlink" title="generate_series"></a>generate_series</h4><p>产生一个序列。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> generate_series<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>下面是一个复杂的例子。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">drop</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token keyword">exists</span> tmp_array<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> tmp_array <span class="token punctuation">(</span>
  id   int8<span class="token punctuation">,</span>
  name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">insert</span> <span class="token keyword">into</span> tmp_array
<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token function">mod</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m_id<span class="token punctuation">,</span>
	   array_agg<span class="token punctuation">(</span>id::<span class="token keyword">varchar</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m_id_agg
  <span class="token keyword">from</span> generate_series<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1000000</span><span class="token punctuation">)</span> <span class="token keyword">as</span> id
 <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token function">mod</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">index</span> idx_tmp_array_x1 <span class="token keyword">on</span> tmp_array <span class="token keyword">using</span> gin<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">explain</span> <span class="token keyword">ANALYZE</span> <span class="token keyword">select</span> <span class="token operator">*</span>
<span class="token keyword">from</span> tmp_array ta
<span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token operator">and</span> name @<span class="token operator">></span> array<span class="token punctuation">[</span><span class="token string">'113'</span>::<span class="token keyword">varchar</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><h4 id="coalesce"><a href="#coalesce" class="headerlink" title="coalesce"></a>coalesce</h4><p>返回它的第一个非空参数的值。具有短路效果，即，参数按顺序，找到不为空的值后，后续的表达式将不会被计算。</p>
<p>能在部分场景代替<code>case when is not null then else end</code>语法。</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token operator">/</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">--返回1</span>
<span class="token keyword">select</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">--返回22，后面参数  22/0不会报错</span>
<span class="token keyword">select</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">-- 返回空  null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="GREATEST"><a href="#GREATEST" class="headerlink" title="GREATEST"></a>GREATEST</h4><p> <strong>GREATEST(n1,n2,n3,……….)</strong> 获取最大值 。多列比较，而不是在聚合比较。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">SELECT GREATEST<span class="token punctuation">(</span><span class="token number">3,5</span>,1,8,33,99,34,55,67,43<span class="token punctuation">)</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="LEAST"><a href="#LEAST" class="headerlink" title="LEAST"></a>LEAST</h4><p>对上面的反函数。</p>
<p> <strong>LEAST(N1,N2,N3,N4,……)</strong> 获取最小值。</p>
<h2 id="函数udf"><a href="#函数udf" class="headerlink" title="函数udf"></a>函数udf</h2><h3 id="文字分割测试"><a href="#文字分割测试" class="headerlink" title="文字分割测试"></a>文字分割测试</h3><pre class="line-numbers language-none"><code class="language-none">CREATE OR REPLACE FUNCTION  strip_text(str text,len integer) RETURNS TEXT[] AS $$
DECLARE
rest text[];
n  INTEGER;
i INTEGER;
BEGIN
  n &#x3D; char_length(str);
  if n &lt;&#x3D;len THEN
    rest[1] &#x3D; str;
	  return rest;
  END IF;
  n &#x3D; n - (len-1);
	for i in 1..n LOOP
		rest[i] &#x3D; substring(str from i for len);
	end LOOP;
	RETURN rest ;
END; 
$$ LANGUAGE plpgsql;

-- 测试
-- 返回数组
SELECT strip_text(&#39;1234567&#39;,2);
-- 返回多列
SELECT unnest(strip_text(&#39;1234567&#39;,2));<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_split_world2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_split_world2 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token comment">-- 由于自定义函数没有对null的处理，所以，要过滤</span>
<span class="token keyword">select</span> unnest<span class="token punctuation">(</span>strip_text<span class="token punctuation">(</span>recv_addr<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> word <span class="token keyword">from</span> tu_doc_info <span class="token keyword">where</span> dtime <span class="token operator">>=</span><span class="token string">'2021-08-01'</span> <span class="token operator">and</span> dtime <span class="token operator">&lt;</span> <span class="token string">'2021-08-02'</span> <span class="token operator">and</span> recv_addr <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> test_split_world_count2<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test_split_world_count2 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    APPENDONLY <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
    COMPRESSLEVEL <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
    ORIENTATION <span class="token operator">=</span> <span class="token keyword">COLUMN</span><span class="token punctuation">,</span>
    COMPRESSTYPE <span class="token operator">=</span> ZLIB
<span class="token punctuation">)</span> <span class="token keyword">AS</span> 
<span class="token keyword">select</span> word<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cnt <span class="token keyword">from</span> test_split_world2 <span class="token keyword">group</span> <span class="token keyword">by</span> word 
<span class="token keyword">DISTRIBUTED</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行时间，由此可见，自定义函数的效率也是杠杠的。</p>
<pre class="line-numbers language-none"><code class="language-none">SELECT 1745202170
Time: 169993.833 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>





<pre class="line-numbers language-none"><code class="language-none">DROP TABLE IF EXISTS test_split_world3;
CREATE TABLE test_split_world3 WITH (
    APPENDONLY &#x3D; TRUE,
    COMPRESSLEVEL &#x3D; 5,
    ORIENTATION &#x3D; COLUMN,
    COMPRESSTYPE &#x3D; ZLIB
) AS 
-- 由于自定义函数没有对null的处理，所以，要过滤
select unnest(strip_text(recv_addr,3)) as word from tu_doc_info where dtime &gt;&#x3D;&#39;2021-08-01&#39; and dtime &lt; &#39;2021-08-02&#39; and recv_addr is not null
DISTRIBUTED BY (word);

DROP TABLE IF EXISTS test_split_world_count3;
CREATE TABLE test_split_world_count3 WITH (
    APPENDONLY &#x3D; TRUE,
    COMPRESSLEVEL &#x3D; 5,
    ORIENTATION &#x3D; COLUMN,
    COMPRESSTYPE &#x3D; ZLIB
) AS 
select word,count(1) as cnt from test_split_world3 group by word 
DISTRIBUTED BY (word);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="distribute-分区"><a href="#distribute-分区" class="headerlink" title="distribute + 分区"></a>distribute + 分区</h2><p>本意：提升查询速度、解决<code>/dev/mapper/vg1-lv1</code>占用50%以上，而其他分区站15%。但是，删除上，并未解决。</p>
<p>数据经过distribute、分区，查询总数的性能反而会下降。以下*_old，表示旧表，普通建表语句，没有分区，distribute也没有写。而<code>02</code>后缀的表是distribute、分区。</p>
<p>当然，查询1天之类的，由于能进行剪切，速度当然会很快。</p>
<pre class="line-numbers language-none"><code class="language-none">develop&#x3D;# select count(*) from p_order_waybill_info_old;                                                                                                                                                   
   count    
------------
 1622729642
(1 row)

Time: 59826.072 ms
develop&#x3D;# select count(*) from p_order_waybill_info_02;                                                                                                                                                    
   count    
------------
 1622729642
(1 row)

Time: 172275.076 ms
develop&#x3D;# select count(*) from t_order_waybill_info_old;                                                                                                                                                   
   count    
------------
 2726513394
(1 row)

Time: 202499.226 ms
develop&#x3D;# select count(*) from t_order_waybill_info_02;                                                                                                                                                    
   count    
------------
 2726513394
(1 row)

Time: 296512.553 ms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其他参见，查 create table as select</p>
<p>个人感受：</p>
<p>为啥gp能那么快，首先，distribute，会将相同的运单号，放到同一台worker机器上，那么，这台woker机器，做join运算的时候，就可以在内部完成计算。比如日5000万的量，那么每天机器，实际上才上百万的计算，这样就非常的方便。分区，能保证，分隔在哪天的量上。</p>
<h2 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h2><h3 id="pg"><a href="#pg" class="headerlink" title="pg"></a>pg</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker run --rm --name postgre10 -it -v <span class="token environment constant">$PWD</span>:/mywork -w /mywork postgres:10.1 <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h1 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h1><h3 id="导入-转换"><a href="#导入-转换" class="headerlink" title="导入+转换"></a>导入+转换</h3><ul>
<li>导入</li>
</ul>
<p>单纯的使用shell，将数据加载到gp中，然后再从临时表中，插入到目标表中。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token shebang important">#!/bin/bash</span>

<span class="token function-name function">import_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token assign-left variable">table</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token builtin class-name">echo</span> <span class="token string">'清空临时表i1_import_raw'</span>
    psql -d  develop   -h  localhost   -U gpadmin  -p <span class="token number">5432</span>  -c <span class="token string">"truncate table i1_import_raw"</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">csv_path</span><span class="token operator">=</span><span class="token string">"/i1/<span class="token variable">$table</span>"</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">day</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> day_list.txt<span class="token variable">`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span>
        <span class="token keyword">for</span> <span class="token for-or-select variable">each</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> $csv_path/$day/*00.csv<span class="token variable">`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span>
            <span class="token builtin class-name">echo</span> <span class="token variable">$each</span> 
            <span class="token comment">#each=/addr7/full_piece/real/20210421/addr7_20210421044500.csv</span>
            psql -d  develop   -h  localhost   -U gpadmin  -p <span class="token number">5432</span>  -c <span class="token string">"<span class="token entity" title="\c">\c</span>opy i1_import_raw from <span class="token variable">$each</span> with csv"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span>
                <span class="token builtin class-name">echo</span> <span class="token string">"error: import <span class="token variable">$each</span>"</span>
            <span class="token keyword">fi</span>
        <span class="token keyword">done</span>
    <span class="token keyword">done</span><span class="token punctuation">;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"导入到正式表 i1_<span class="token variable">$table</span> 中"</span>
    psql -d  develop   -h  localhost   -U gpadmin  -p <span class="token number">5432</span>  -c <span class="token string">"insert into i1_<span class="token variable">$table</span> select *,to_timestamp(substring(batch from 3),'yyyyMMddhh24miss') as batch_time from i1_import_raw;"</span>
<span class="token punctuation">&#125;</span>

import_data <span class="token string">'order'</span>
import_data <span class="token string">'record'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>区分以下sql用法</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 不会创建表</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> newtable <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> oldtable
<span class="token comment">-- 会创建旧表</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">into</span> newtable <span class="token keyword">from</span> oldtable<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>转换</li>
</ul>
<ul>
<li>其他</li>
</ul>
<p>导入的时候，比如多个csv文件，1、要不要合并成一个csv文件，并导入。（不要，因为：首先合并csv需要一定的io时间。也许合并成一个sql文件，调用一次psql -f import_csvs.sql，但是担心因为某个sql错误，导致后续的sql异常退出，无法执行？？待检验）</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="csv导入转型问题"><a href="#csv导入转型问题" class="headerlink" title="csv导入转型问题"></a>csv导入转型问题</h3><pre class="line-numbers language-none"><code class="language-none">CREATE TABLE lanjiejian (
    ship_id varchar(20), 
    create_time timestamp without time zone,
    from_table smallint
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>而导入的csv，ship_id，是纯数字，没有加引号。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.chaofml.cn/2021/02/23/pg/%E5%85%A5%E9%97%A8%E7%9F%A5%E8%AF%86%E7%82%B9/" data-id="cld48zep300q411o04lrpbvbh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gp/" rel="tag">gp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/postgre/" rel="tag">postgre</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/02/23/other/%E8%A1%A8%E6%83%85%E5%AD%97%E7%AC%A6%E8%BF%87%E6%BB%A4/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          表情字符过滤
        
      </div>
    </a>
  
  
    <a href="/2021/02/22/pg/%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">访问权限</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/docker/%E6%B8%85%E7%90%86/">清理</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python-tools/">python - tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AD%A3%E5%88%99/">正则</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/">转载</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/js/">js</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%BD%AC%E8%BD%BD/shell/">shell</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">-shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkinsfile/" rel="tag">Jenkinsfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">K8s学习笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apache/" rel="tag">apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/array/" rel="tag">array</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/" rel="tag">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bs4/" rel="tag">bs4</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/celery/" rel="tag">celery</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chmod/" rel="tag">chmod</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chown/" rel="tag">chown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/conf/" rel="tag">conf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/copy/" rel="tag">copy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/csv/" rel="tag">csv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cygwin/" rel="tag">cygwin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/db/" rel="tag">db</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/default/" rel="tag">default</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-php/" rel="tag">docker php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-weblogic/" rel="tag">docker weblogic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/emoji/" rel="tag">emoji</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es/" rel="tag">es</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ext/" rel="tag">ext</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/extjs/" rel="tag">extjs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/for/" rel="tag">for</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gp/" rel="tag">gp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/greenplum/" rel="tag">greenplum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gzip/" rel="tag">gzip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/host/" rel="tag">host</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ingore/" rel="tag">ingore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/install/" rel="tag">install</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/" rel="tag">json</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ldap/" rel="tag">ldap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lua/" rel="tag">lua</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lxml/" rel="tag">lxml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/md5/" rel="tag">md5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/" rel="tag">nodejs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openapi/" rel="tag">openapi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/" rel="tag">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/" rel="tag">other</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pdo/" rel="tag">pdo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pg/" rel="tag">pg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-%E6%89%A9%E5%B1%95/" rel="tag">php 扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-%E6%8F%92%E4%BB%B6/" rel="tag">php 插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pip/" rel="tag">pip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgre/" rel="tag">postgre</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/postgresql/" rel="tag">postgresql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rancher/" rel="tag">rancher</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/requests/" rel="tag">requests</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/restful-api/" rel="tag">restful api</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/session/" rel="tag">session</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socat/" rel="tag">socat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/split/" rel="tag">split</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlite/" rel="tag">sqlite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/static/" rel="tag">static</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tar/" rel="tag">tar</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/think/" rel="tag">think</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tmux/" rel="tag">tmux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/underscope/" rel="tag">underscope</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vb/" rel="tag">vb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue3/" rel="tag">vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yum/" rel="tag">yum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1/" rel="tag">业务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA/" rel="tag">个人</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/" rel="tag">分区表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%8C%E6%AD%A5/" rel="tag">同步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E8%A3%85/" rel="tag">安装</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%BC%E8%88%AA/" rel="tag">导航</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8C%85/" rel="tag">打包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E6%9D%BF/" rel="tag">模板</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A9%BA%E6%A0%BC/" rel="tag">空格</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" rel="tag">编程语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%AD%E6%B3%95/" rel="tag">语法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%9B%E7%A8%8B/" rel="tag">进程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/shell/" style="font-size: 10px;">-shell</a> <a href="/tags/Jenkinsfile/" style="font-size: 10px;">Jenkinsfile</a> <a href="/tags/K8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">K8s学习笔记</a> <a href="/tags/apache/" style="font-size: 10px;">apache</a> <a href="/tags/array/" style="font-size: 10px;">array</a> <a href="/tags/awk/" style="font-size: 10px;">awk</a> <a href="/tags/bs4/" style="font-size: 10px;">bs4</a> <a href="/tags/c/" style="font-size: 10px;">c</a> <a href="/tags/celery/" style="font-size: 10px;">celery</a> <a href="/tags/chmod/" style="font-size: 10px;">chmod</a> <a href="/tags/chown/" style="font-size: 10px;">chown</a> <a href="/tags/conf/" style="font-size: 10px;">conf</a> <a href="/tags/copy/" style="font-size: 10px;">copy</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/csv/" style="font-size: 12.31px;">csv</a> <a href="/tags/cygwin/" style="font-size: 10px;">cygwin</a> <a href="/tags/db/" style="font-size: 10px;">db</a> <a href="/tags/default/" style="font-size: 13.85px;">default</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/docker/" style="font-size: 18.46px;">docker</a> <a href="/tags/docker-php/" style="font-size: 10px;">docker php</a> <a href="/tags/docker-weblogic/" style="font-size: 10px;">docker weblogic</a> <a href="/tags/emoji/" style="font-size: 10px;">emoji</a> <a href="/tags/es/" style="font-size: 10px;">es</a> <a href="/tags/ext/" style="font-size: 10px;">ext</a> <a href="/tags/extjs/" style="font-size: 11.54px;">extjs</a> <a href="/tags/for/" style="font-size: 10.77px;">for</a> <a href="/tags/git/" style="font-size: 11.54px;">git</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/gp/" style="font-size: 10.77px;">gp</a> <a href="/tags/greenplum/" style="font-size: 11.54px;">greenplum</a> <a href="/tags/gzip/" style="font-size: 10px;">gzip</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/host/" style="font-size: 10px;">host</a> <a href="/tags/ingore/" style="font-size: 10px;">ingore</a> <a href="/tags/install/" style="font-size: 10.77px;">install</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/java/" style="font-size: 10.77px;">java</a> <a href="/tags/js/" style="font-size: 15.38px;">js</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/k8s/" style="font-size: 12.31px;">k8s</a> <a href="/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/tags/ldap/" style="font-size: 10px;">ldap</a> <a href="/tags/linux/" style="font-size: 12.31px;">linux</a> <a href="/tags/lua/" style="font-size: 10px;">lua</a> <a href="/tags/lxml/" style="font-size: 10px;">lxml</a> <a href="/tags/md5/" style="font-size: 10px;">md5</a> <a href="/tags/mysql/" style="font-size: 14.62px;">mysql</a> <a href="/tags/nginx/" style="font-size: 13.85px;">nginx</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a> <a href="/tags/openapi/" style="font-size: 10px;">openapi</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/other/" style="font-size: 13.85px;">other</a> <a href="/tags/pdo/" style="font-size: 10px;">pdo</a> <a href="/tags/pg/" style="font-size: 17.69px;">pg</a> <a href="/tags/php/" style="font-size: 16.92px;">php</a> <a href="/tags/php-%E6%89%A9%E5%B1%95/" style="font-size: 10px;">php 扩展</a> <a href="/tags/php-%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">php 插件</a> <a href="/tags/pip/" style="font-size: 10.77px;">pip</a> <a href="/tags/postgre/" style="font-size: 10px;">postgre</a> <a href="/tags/postgresql/" style="font-size: 11.54px;">postgresql</a> <a href="/tags/python/" style="font-size: 19.23px;">python</a> <a href="/tags/rancher/" style="font-size: 10px;">rancher</a> <a href="/tags/redis/" style="font-size: 13.85px;">redis</a> <a href="/tags/requests/" style="font-size: 10px;">requests</a> <a href="/tags/restful-api/" style="font-size: 10.77px;">restful api</a> <a href="/tags/session/" style="font-size: 10px;">session</a> <a href="/tags/shell/" style="font-size: 20px;">shell</a> <a href="/tags/socat/" style="font-size: 10px;">socat</a> <a href="/tags/split/" style="font-size: 10px;">split</a> <a href="/tags/sql/" style="font-size: 16.15px;">sql</a> <a href="/tags/sqlite/" style="font-size: 10px;">sqlite</a> <a href="/tags/ssh/" style="font-size: 11.54px;">ssh</a> <a href="/tags/static/" style="font-size: 10px;">static</a> <a href="/tags/tar/" style="font-size: 10.77px;">tar</a> <a href="/tags/think/" style="font-size: 10px;">think</a> <a href="/tags/tmux/" style="font-size: 10px;">tmux</a> <a href="/tags/underscope/" style="font-size: 10px;">underscope</a> <a href="/tags/vb/" style="font-size: 10px;">vb</a> <a href="/tags/vim/" style="font-size: 10.77px;">vim</a> <a href="/tags/vue/" style="font-size: 11.54px;">vue</a> <a href="/tags/vue3/" style="font-size: 10px;">vue3</a> <a href="/tags/web/" style="font-size: 10px;">web</a> <a href="/tags/yum/" style="font-size: 10px;">yum</a> <a href="/tags/%E4%B8%9A%E5%8A%A1/" style="font-size: 10px;">业务</a> <a href="/tags/%E4%B8%AA%E4%BA%BA/" style="font-size: 10px;">个人</a> <a href="/tags/%E5%88%86%E5%8C%BA%E8%A1%A8/" style="font-size: 10px;">分区表</a> <a href="/tags/%E5%90%8C%E6%AD%A5/" style="font-size: 10px;">同步</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 13.08px;">大数据</a> <a href="/tags/%E5%AE%89%E8%A3%85/" style="font-size: 10px;">安装</a> <a href="/tags/%E5%AF%BC%E8%88%AA/" style="font-size: 10px;">导航</a> <a href="/tags/%E6%89%93%E5%8C%85/" style="font-size: 10px;">打包</a> <a href="/tags/%E6%A8%A1%E6%9D%BF/" style="font-size: 10px;">模板</a> <a href="/tags/%E7%A9%BA%E6%A0%BC/" style="font-size: 10px;">空格</a> <a href="/tags/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">编程语言</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%AF%AD%E6%B3%95/" style="font-size: 10px;">语法</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 19.23px;">转载</a> <a href="/tags/%E8%BF%9B%E7%A8%8B/" style="font-size: 10px;">进程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/01/20/pg/%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5%E5%88%B0%E5%88%86%E5%8C%BA/">数据插入到分区</a>
          </li>
        
          <li>
            <a href="/2022/10/09/shell/%E6%AD%A3%E5%88%99/">常用的正则表达式</a>
          </li>
        
          <li>
            <a href="/2022/09/22/other/%E8%BF%9C%E7%A8%8B%E5%8A%9E%E5%85%AC/">远程办公</a>
          </li>
        
          <li>
            <a href="/2022/09/20/apache/%E5%8E%8B%E6%B5%8B/">压测</a>
          </li>
        
          <li>
            <a href="/2022/09/14/shell/%E5%8E%8B%E7%BC%A9%E3%80%81%E8%A7%A3%E5%8E%8B/">压缩、解压</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2023 chaofml<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>