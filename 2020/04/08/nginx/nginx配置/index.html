<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.chaofml.cn","root":"/","images":"/images","scheme":"Pisces","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}};
  </script>
<meta name="description" content="nginx配置 这是一篇比较全面的，关于nginx如何配置的手册。包含一般配置。示例等。须明白，配置不是代码，不一定严格按着配置顺序生效。">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx配置">
<meta property="og:url" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/index.html">
<meta property="og:site_name" content="超凡魔力">
<meta property="og:description" content="nginx配置 这是一篇比较全面的，关于nginx如何配置的手册。包含一般配置。示例等。须明白，配置不是代码，不一定严格按着配置顺序生效。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/nginx%E9%85%8D%E7%BD%AE.assets/2826276797-5e8bbcbca0a24_articlex.png">
<meta property="og:image" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/nginx%E9%85%8D%E7%BD%AE.assets/Selection_104-1.png">
<meta property="og:image" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/nginx%E9%85%8D%E7%BD%AE.assets/Selection_111.png">
<meta property="og:image" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/nginx%E9%85%8D%E7%BD%AE.assets/1586766155163.png">
<meta property="og:image" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/nginx%E9%85%8D%E7%BD%AE.assets/1586760006026.png">
<meta property="article:published_time" content="2020-04-08T09:16:00.000Z">
<meta property="article:modified_time" content="2023-01-25T02:58:29.796Z">
<meta property="article:author" content="chaofml">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/nginx%E9%85%8D%E7%BD%AE.assets/2826276797-5e8bbcbca0a24_articlex.png">


<link rel="canonical" href="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>nginx配置 | 超凡魔力</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">超凡魔力</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">君子善思，善假于物，而不物于物。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx%E9%85%8D%E7%BD%AE"><span class="nav-number">1.</span> <span class="nav-text">nginx配置</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E8%AE%B2%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">配置讲解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B4%E4%BD%93"><span class="nav-number">2.1.</span> <span class="nav-text">整体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.1.</span> <span class="nav-text">整体结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95"><span class="nav-number">2.1.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E4%BB%A4%E5%9D%97%E7%9A%84%E5%B5%8C%E5%A5%97"><span class="nav-number">2.1.3.</span> <span class="nav-text">指令块的嵌套</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E6%8C%87%E4%BB%A4"><span class="nav-number">2.2.</span> <span class="nav-text">全局指令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#user"><span class="nav-number">2.2.1.</span> <span class="nav-text">user</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#daemon"><span class="nav-number">2.2.2.</span> <span class="nav-text">daemon</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-processes"><span class="nav-number">2.2.3.</span> <span class="nav-text">worker_processes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-cpu-affinity"><span class="nav-number">2.2.4.</span> <span class="nav-text">worker_cpu_affinity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#error-log"><span class="nav-number">2.2.5.</span> <span class="nav-text">error_log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#access-log"><span class="nav-number">2.2.6.</span> <span class="nav-text">access_log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rewrite-log"><span class="nav-number">2.2.7.</span> <span class="nav-text">rewrite_log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#log-format"><span class="nav-number">2.2.8.</span> <span class="nav-text">log_format</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pid"><span class="nav-number">2.2.9.</span> <span class="nav-text">pid</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-rlimit-nofile"><span class="nav-number">2.2.10.</span> <span class="nav-text">worker_rlimit_nofile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#events"><span class="nav-number">2.2.11.</span> <span class="nav-text">events</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#multi-accept"><span class="nav-number">2.2.11.1.</span> <span class="nav-text">multi_accept</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#accept-mutex-delay"><span class="nav-number">2.2.11.2.</span> <span class="nav-text">accept_mutex_delay</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#http"><span class="nav-number">2.3.</span> <span class="nav-text">http</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.1.</span> <span class="nav-text">通用设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fast-cgi"><span class="nav-number">2.3.2.</span> <span class="nav-text">fast_cgi</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip%E6%A8%A1%E5%9D%97%E8%AE%BE%E7%BD%AE"><span class="nav-number">2.3.3.</span> <span class="nav-text">gzip模块设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#index%E6%98%BE%E7%A4%BA%E5%88%97%E8%A1%A8"><span class="nav-number">2.3.4.</span> <span class="nav-text">index显示列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#default-type"><span class="nav-number">2.3.5.</span> <span class="nav-text">default_type</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#server"><span class="nav-number">2.4.</span> <span class="nav-text">server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#listen"><span class="nav-number">2.4.1.</span> <span class="nav-text">listen</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-name"><span class="nav-number">2.4.2.</span> <span class="nav-text">server_name</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#root"><span class="nav-number">2.4.3.</span> <span class="nav-text">root</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include"><span class="nav-number">2.4.4.</span> <span class="nav-text">include</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#error-page"><span class="nav-number">2.4.5.</span> <span class="nav-text">error_page</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#index"><span class="nav-number">2.4.6.</span> <span class="nav-text">index</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#server-tokens"><span class="nav-number">2.4.7.</span> <span class="nav-text">server_tokens</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#location"><span class="nav-number">2.4.8.</span> <span class="nav-text">location</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#location%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="nav-number">2.4.8.1.</span> <span class="nav-text">location配置规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%AF%E5%BE%84"><span class="nav-number">2.4.8.2.</span> <span class="nav-text">@路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IP%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-number">2.4.8.3.</span> <span class="nav-text">IP访问控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E8%AE%BF%E9%97%AE"><span class="nav-number">2.4.8.4.</span> <span class="nav-text">用户认证访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx%E8%AE%BF%E9%97%AE%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7"><span class="nav-number">2.4.8.5.</span> <span class="nav-text">nginx访问状态监控</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="nav-number">2.4.8.6.</span> <span class="nav-text">字符编码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#expires%E7%BC%93%E5%AD%98"><span class="nav-number">2.4.8.7.</span> <span class="nav-text">expires缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#etag%E7%BC%93%E5%AD%98"><span class="nav-number">2.4.8.8.</span> <span class="nav-text">etag缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#last-modify"><span class="nav-number">2.4.8.9.</span> <span class="nav-text">last-modify</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#add-header"><span class="nav-number">2.4.8.10.</span> <span class="nav-text">add_header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rewrite%E9%87%8D%E5%86%99%E6%9C%BA%E5%88%B6"><span class="nav-number">2.4.8.11.</span> <span class="nav-text">rewrite重写机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#try-files"><span class="nav-number">2.4.8.12.</span> <span class="nav-text">try_files</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#return"><span class="nav-number">2.4.8.13.</span> <span class="nav-text">return</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#proxy-pass%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">2.4.8.14.</span> <span class="nav-text">proxy_pass反向代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#upstream"><span class="nav-number">2.4.8.15.</span> <span class="nav-text">upstream</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fast-pass"><span class="nav-number">2.4.9.</span> <span class="nav-text">fast_pass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#fastcgi-pass"><span class="nav-number">2.4.9.1.</span> <span class="nav-text">fastcgi_pass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fastcgi-param"><span class="nav-number">2.4.9.2.</span> <span class="nav-text">fastcgi_param</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fastcgi-index"><span class="nav-number">2.4.9.3.</span> <span class="nav-text">fastcgi_index</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fastcgi-split-path-info"><span class="nav-number">2.4.9.4.</span> <span class="nav-text">fastcgi_split_path_info</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B8%A9%E4%BA%86%E5%A5%BD%E5%A4%9A%E6%AC%A1%E4%BE%9D%E6%97%A7%E4%B8%8D%E8%AE%B0%E5%BE%97%E6%80%8E%E4%B9%88%E8%AE%BE%E7%BD%AE%E7%9A%84ThinkPHP"><span class="nav-number">2.4.9.5.</span> <span class="nav-text">踩了好多次依旧不记得怎么设置的ThinkPHP</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#cgi-fix-pathinfo"><span class="nav-number">2.4.9.6.</span> <span class="nav-text">cgi.fix_pathinfo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if-%E6%A8%A1%E5%9D%97"><span class="nav-number">2.4.10.</span> <span class="nav-text">if 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%88%A4%E6%96%AD"><span class="nav-number">2.4.10.1.</span> <span class="nav-text">文件判断</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#https"><span class="nav-number">2.5.</span> <span class="nav-text">https</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97"><span class="nav-number">2.6.</span> <span class="nav-text">日志</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEaccess-log"><span class="nav-number">2.6.0.0.1.</span> <span class="nav-text">设置access_log</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-1"><span class="nav-number">2.6.0.0.2.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="nav-number">2.6.0.0.3.</span> <span class="nav-text">作用域</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-number">2.6.0.0.4.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8log-format%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="nav-number">2.6.0.0.5.</span> <span class="nav-text">使用log_format自定义日志格式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-2"><span class="nav-number">2.6.0.0.6.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEerror-log"><span class="nav-number">2.6.0.0.7.</span> <span class="nav-text">设置error_log</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-3"><span class="nav-number">2.6.0.0.8.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95-1"><span class="nav-number">2.6.0.0.9.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#open-log-file-cache"><span class="nav-number">2.6.0.0.10.</span> <span class="nav-text">open_log_file_cache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%AF%AD%E6%B3%95-4"><span class="nav-number">2.6.0.0.11.</span> <span class="nav-text">语法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95-2"><span class="nav-number">2.6.0.0.12.</span> <span class="nav-text">基本用法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.6.0.0.13.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%98%E9%87%8F"><span class="nav-number">2.7.</span> <span class="nav-text">变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#geo"><span class="nav-number">2.8.</span> <span class="nav-text">geo</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">3.</span> <span class="nav-text">启动命令</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97"><span class="nav-number">4.</span> <span class="nav-text">模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%89%E8%A3%85"><span class="nav-number">4.1.</span> <span class="nav-text">模块安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E8%A7%A3%E8%AF%BB"><span class="nav-number">4.2.</span> <span class="nav-text">模块解读</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ngx-http-stub-status-module"><span class="nav-number">4.3.</span> <span class="nav-text">ngx_http_stub_status_module</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E5%BD%95"><span class="nav-number">5.</span> <span class="nav-text">附录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%9A%84%E4%B8%89%E5%A4%A7%E6%96%B9%E9%9D%A2"><span class="nav-number">6.</span> <span class="nav-text">Nginx服务器性能优化的三大方面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E7%9A%84worker%E8%BF%9B%E7%A8%8B%E9%85%8D%E7%BD%AE"><span class="nav-number">6.1.</span> <span class="nav-text">Nginx的worker进程配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-processes-1"><span class="nav-number">6.1.1.</span> <span class="nav-text">worker_processes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#accept-mutex"><span class="nav-number">6.1.2.</span> <span class="nav-text">accept_mutex</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#accept-mutex-delay-1"><span class="nav-number">6.1.3.</span> <span class="nav-text">accept_mutex_delay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-connections"><span class="nav-number">6.1.4.</span> <span class="nav-text">worker_connections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#worker-rlimit-nofile-1"><span class="nav-number">6.1.5.</span> <span class="nav-text">worker_rlimit_nofile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#multi-accept-1"><span class="nav-number">6.1.6.</span> <span class="nav-text">multi_accept</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#use"><span class="nav-number">6.1.7.</span> <span class="nav-text">use</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E7%9A%84I-O%E9%85%8D%E7%BD%AE"><span class="nav-number">6.2.</span> <span class="nav-text">Nginx的I&#x2F;O配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sendfile"><span class="nav-number">6.2.1.</span> <span class="nav-text">sendfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Direct-I-O"><span class="nav-number">6.2.2.</span> <span class="nav-text">Direct I&#x2F;O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5I-O"><span class="nav-number">6.2.3.</span> <span class="nav-text">异步I&#x2F;O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%BC%E5%90%88I-O%E8%AE%BE%E7%BD%AE"><span class="nav-number">6.2.4.</span> <span class="nav-text">综合I&#x2F;O设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E7%9A%84TCP%E9%85%8D%E7%BD%AE"><span class="nav-number">6.3.</span> <span class="nav-text">Nginx的TCP配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-NODELAY"><span class="nav-number">6.3.1.</span> <span class="nav-text">TCP_NODELAY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TCP-CORK"><span class="nav-number">6.3.2.</span> <span class="nav-text">TCP_CORK</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%A7%E7%BB%BC%E5%90%88"><span class="nav-number">6.4.</span> <span class="nav-text">大综合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%AF%B9%E6%AF%94"><span class="nav-number">6.5.</span> <span class="nav-text">性能测试对比</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E8%AF%95"><span class="nav-number">7.</span> <span class="nav-text">调试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#set%E6%96%B9%E6%B3%95"><span class="nav-number">7.1.</span> <span class="nav-text">set方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#add-header-1"><span class="nav-number">7.2.</span> <span class="nav-text">add_header</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deny"><span class="nav-number">7.3.</span> <span class="nav-text">deny</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#return-1"><span class="nav-number">7.4.</span> <span class="nav-text">return</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E5%90%88nodejs"><span class="nav-number">7.5.</span> <span class="nav-text">配合nodejs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-number">7.6.</span> <span class="nav-text">调试环境搭建</span></a></li></ol></li></ol></div>
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">chaofml</p>
  <div class="site-description" itemprop="description">思绪偶尔会在这里停留</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">369</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.chaofml.cn/2020/04/08/nginx/nginx%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="chaofml">
      <meta itemprop="description" content="思绪偶尔会在这里停留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="超凡魔力">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nginx配置
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-08 09:16:00" itemprop="dateCreated datePublished" datetime="2020-04-08T09:16:00+00:00">2020-04-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-01-25 02:58:29" itemprop="dateModified" datetime="2023-01-25T02:58:29+00:00">2023-01-25</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h1><blockquote>
<p>这是一篇比较全面的，关于nginx如何配置的手册。包含一般配置。示例等。须明白，配置不是代码，不一定严格按着配置顺序生效。</p>
</blockquote>
<a id="more"></a>

<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/">官方手册地址</a></li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html">官方手册-核心模块功能</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022282235?utm_source=tag-newest">https://segmentfault.com/a/1190000022282235?utm_source=tag-newest</a> </li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022125108">Nginx 日志配置实践</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022148976">Nginx双机主备（Keepalived实现）</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/fengjunoo/article/details/84879449">Nginx升级</a></li>
</ul>
<p>思路：</p>
<ul>
<li>配置讲解</li>
<li>nginx 命令</li>
<li>线上的示例配置讲解。线上配置、避坑</li>
<li>使用场景</li>
<li>升级原有的镜像、增加组件，如何操作</li>
</ul>
<h1 id="配置讲解"><a href="#配置讲解" class="headerlink" title="配置讲解"></a>配置讲解</h1><h2 id="整体"><a href="#整体" class="headerlink" title="整体"></a>整体</h2><h3 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">main
<span class="token keyword">http</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">upstream</span> <span class="token punctuation">&#123;</span> … <span class="token punctuation">&#125;</span>
    <span class="token keyword">split_clients</span> <span class="token punctuation">&#123;</span>…<span class="token punctuation">&#125;</span>
    <span class="token keyword">map</span> <span class="token punctuation">&#123;</span>…<span class="token punctuation">&#125;</span>
    <span class="token keyword">geo</span> <span class="token punctuation">&#123;</span>…<span class="token punctuation">&#125;</span>
    <span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>…<span class="token punctuation">&#125;</span>
        <span class="token keyword">location</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">limit_except</span> <span class="token punctuation">&#123;</span>…<span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">location</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">location</span> <span class="token punctuation">&#123;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>包含配置块、动作指令、值指令等。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>注释只能用#，不能用//，报错如下：</p>
<pre class="line-numbers language-none"><code class="language-none">nginx: [emerg] unknown directive &quot;&#x2F;&#x2F;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>配置块使用花括号，不用加分号。普通的指令，必须结尾加分号。</p>
<h3 id="指令块的嵌套"><a href="#指令块的嵌套" class="headerlink" title="指令块的嵌套"></a>指令块的嵌套</h3><p>在 Nginx 配置文件中，指令块是可以互相嵌套的，例如上面的示例，http 块中可以包含多个 server 块，server 块中还会包含多个 location 块，每一个块中都有相应的指令。</p>
<p>而每一个指令都有 Context 上下文，也就是生效的环境，这在 Nginx 的官方文档中说的很清楚，例如下面的两条指令，Context 中都表明了各自可以生效的环境，access_log 指令可以在多个上下文中生效：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">Syntax<span class="token punctuation">:</span>  <span class="token keyword">access_log</span> path <span class="token punctuation">[</span>format <span class="token punctuation">[</span>buffer<span class="token operator">=</span>size<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">gzip</span><span class="token punctuation">[</span><span class="token operator">=</span>level<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>flush<span class="token operator">=</span>time<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">if</span><span class="token operator">=</span>condition<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
             <span class="token keyword">access_log</span> off<span class="token punctuation">;</span>
Default<span class="token punctuation">:</span> <span class="token keyword">access_log</span> logs<span class="token operator">/</span>access<span class="token punctuation">.</span>log combined<span class="token punctuation">;</span> 
Context<span class="token punctuation">:</span> <span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span><span class="token punctuation">,</span> <span class="token keyword">if</span> in <span class="token keyword">location</span><span class="token punctuation">,</span> <span class="token keyword">limit_except</span>

Syntax<span class="token punctuation">:</span>  <span class="token keyword">log_format</span> name <span class="token punctuation">[</span>escape<span class="token operator">=</span>default<span class="token operator">|</span>json<span class="token operator">|</span>none<span class="token punctuation">]</span> string <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
Default<span class="token punctuation">:</span> <span class="token keyword">log_format</span> combined <span class="token string">"..."</span><span class="token punctuation">;</span> 
Context<span class="token punctuation">:</span> <span class="token keyword">http</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>常用的上下文环境：</p>
<p> <code>http</code>, <code>server</code>, <code>location</code>, <code>if</code> </p>
<h2 id="全局指令"><a href="#全局指令" class="headerlink" title="全局指令"></a>全局指令</h2><h3 id="user"><a href="#user" class="headerlink" title="user"></a>user</h3><p>定义Nginx运行的用户和用户组。需要系统存在这个用户组。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">user</span> nginx<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="daemon"><a href="#daemon" class="headerlink" title="daemon"></a>daemon</h3><p>在docker中，需要前台启动时，这个很重要。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">daemon</span> on<span class="token punctuation">;</span>  <span class="token comment">#后台启动</span>
<span class="token keyword">daemon</span> off<span class="token punctuation">;</span>  <span class="token comment">#前台启动，容器内部可能用到。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="worker-processes"><a href="#worker-processes" class="headerlink" title="worker_processes"></a>worker_processes</h3><p>nginx进程数，建议设置为等于CPU总核心数。即每个CPU运行1个工作进程。 </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">worker_processes</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">worker_processes</span> auto<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p> CPU核心数，输入 ：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token function">grep</span> processor  /proc/cpuinfo  <span class="token operator">|</span>  <span class="token function">wc</span> -l<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="worker-cpu-affinity"><a href="#worker-cpu-affinity" class="headerlink" title="worker_cpu_affinity"></a>worker_cpu_affinity</h3><p>设置worker进程的cpu亲和力，达到充分利用多核cpu 。参见：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u011957758/article/details/50959823">worker_cpu_affinity</a></p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">worker_cpu_affinity</span> auto<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li> 2核cpu，开启2个进程 </li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">worker_processes</span>     <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">worker_cpu_affinity</span> <span class="token number">01</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>解释：01表示启用第一个CPU内核，10表示启用第二个CPU内核</p>
<p>worker_cpu_affinity 01 10;表示开启两个进程，第一个进程对应着第一个CPU内核，第二个进程对应着第二个CPU内核。 </p>
<ul>
<li>2核cpu，开启4个进程 </li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">worker_processes</span>     <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">worker_cpu_affinity</span> <span class="token number">01</span> <span class="token number">10</span> <span class="token number">01</span> <span class="token number">10</span><span class="token punctuation">;</span>  <span class="token comment">#二进制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>4个cpu，开启4个进程 </li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">worker_processes</span>     <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">worker_cpu_affinity</span> <span class="token number">0001</span> <span class="token number">0010</span> <span class="token number">0100</span> <span class="token number">1000</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="error-log"><a href="#error-log" class="headerlink" title="error_log"></a>error_log</h3><p>全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</p>
<pre class="line-numbers language-none"><code class="language-none">error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log info;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="access-log"><a href="#access-log" class="headerlink" title="access_log"></a>access_log</h3><p>同上。具体参见：日志部分。</p>
<h3 id="rewrite-log"><a href="#rewrite-log" class="headerlink" title="rewrite_log"></a>rewrite_log</h3><p>rewrite记录。注意，只有on|off。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">rewrite</span> on<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="log-format"><a href="#log-format" class="headerlink" title="log_format"></a>log_format</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment">#日志格式设定</span>
<span class="token keyword">log_format</span> access <span class="token string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
<span class="token string">'$status $body_bytes_sent "$http_referer" '</span>
<span class="token string">'"$http_user_agent" $http_x_forwarded_for'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pid"><a href="#pid" class="headerlink" title="pid"></a>pid</h3><p>进程文件。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">pid</span>        <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">/</span>nginx<span class="token punctuation">.</span><span class="token keyword">pid</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="worker-rlimit-nofile"><a href="#worker-rlimit-nofile" class="headerlink" title="worker_rlimit_nofile"></a>worker_rlimit_nofile</h3><p>一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值ulimit -n）与nginx进程数相除，但是nginx分配请求并不均匀，所以建议与ulimit -n的值保持一致。</p>
<pre class="line-numbers language-none"><code class="language-none">worker_rlimit_nofile 65535;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="events"><a href="#events" class="headerlink" title="events"></a>events</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">events</span>
	<span class="token punctuation">&#123;</span>
		<span class="token comment"># 参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型是Linux 2.6以上版本内核中的高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型。</span>
        <span class="token keyword">use</span> epoll<span class="token punctuation">;</span>
        <span class="token comment">#单个进程最大连接数（最大连接数=连接数*进程数）</span>
        <span class="token keyword">worker_connections</span> <span class="token number">51200</span><span class="token punctuation">;</span>
        <span class="token keyword">multi_accept</span> off<span class="token punctuation">;</span>
        <span class="token keyword">accept_mutex</span> off<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="multi-accept"><a href="#multi-accept" class="headerlink" title="multi_accept"></a>multi_accept</h4><p>multi_accept可以让nginx worker进程尽可能多地接受请求。它的作用是让worker进程一次性地接受监听队列里的所有请求，然后处理。如果multi_accept的值设为off，那么worker进程必须一个一个地接受监听队列里的请求。 </p>
<h4 id="accept-mutex-delay"><a href="#accept-mutex-delay" class="headerlink" title="accept_mutex_delay"></a>accept_mutex_delay</h4><p> 当accept_mutex功能启用后，只有一个持有mutex锁的worker进程会接受并处理请求，其他worker进程等待。 </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">events</span> <span class="token punctuation">&#123;</span>
   <span class="token keyword">accept_mutex_delay</span> <span class="token number">500</span>ms<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>





<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><h3 id="通用设置"><a href="#通用设置" class="headerlink" title="通用设置"></a>通用设置</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server_names_hash_bucket_size</span> <span class="token number">128</span><span class="token punctuation">;</span> <span class="token comment">#服务器名字的hash表大小</span>
<span class="token keyword">client_header_buffer_size</span> <span class="token number">32</span>k<span class="token punctuation">;</span> <span class="token comment">#上传文件大小限制</span>
<span class="token keyword">large_client_header_buffers</span> <span class="token number">4</span> <span class="token number">64</span>k<span class="token punctuation">;</span> <span class="token comment">#设定请求缓</span>
<span class="token keyword">client_max_body_size</span> <span class="token number">8</span>m<span class="token punctuation">;</span> <span class="token comment">#设定请求缓</span>
<span class="token keyword">sendfile</span> on<span class="token punctuation">;</span> <span class="token comment">#开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。</span>
<span class="token keyword">autoindex</span> on<span class="token punctuation">;</span> <span class="token comment">#开启目录列表访问，合适下载服务器，默认关闭。</span>
<span class="token keyword">tcp_nopush</span> on<span class="token punctuation">;</span> <span class="token comment">#防止网络阻塞</span>
<span class="token keyword">tcp_nodelay</span> on<span class="token punctuation">;</span> <span class="token comment">#防止网络阻塞</span>
<span class="token keyword">keepalive_timeout</span> <span class="token number">120</span><span class="token punctuation">;</span> <span class="token comment">#长连接超时时间，单位是秒</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="fast-cgi"><a href="#fast-cgi" class="headerlink" title="fast_cgi"></a>fast_cgi</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">fastcgi_connect_timeout</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token keyword">fastcgi_send_timeout</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token keyword">fastcgi_read_timeout</span> <span class="token number">300</span><span class="token punctuation">;</span>
<span class="token keyword">fastcgi_buffer_size</span> <span class="token number">64</span>k<span class="token punctuation">;</span>
<span class="token keyword">fastcgi_buffers</span> <span class="token number">4</span> <span class="token number">64</span>k<span class="token punctuation">;</span>
<span class="token keyword">fastcgi_busy_buffers_size</span> <span class="token number">128</span>k<span class="token punctuation">;</span>
<span class="token keyword">fastcgi_temp_file_write_size</span> <span class="token number">128</span>k<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="gzip模块设置"><a href="#gzip模块设置" class="headerlink" title="gzip模块设置"></a>gzip模块设置</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">gzip</span> on<span class="token punctuation">;</span> <span class="token comment">#开启gzip压缩输出</span>
<span class="token keyword">gzip_min_length</span> <span class="token number">1</span>k<span class="token punctuation">;</span> <span class="token comment">#最小压缩文件大小</span>
<span class="token keyword">gzip_buffers</span> <span class="token number">4</span> <span class="token number">16</span>k<span class="token punctuation">;</span> <span class="token comment">#压缩缓冲区</span>
<span class="token keyword">gzip_http_version</span> <span class="token number">1.0</span><span class="token punctuation">;</span> <span class="token comment">#压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span>
<span class="token keyword">gzip_comp_level</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">#压缩等级</span>
<span class="token keyword">gzip_types</span> text<span class="token operator">/</span>plain application<span class="token operator">/</span>x<span class="token operator">-</span>javascript text<span class="token operator">/</span>css application<span class="token operator">/</span>xml<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>压缩类型，默认就已经包含text/html，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">gzip_vary</span> on<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="index显示列表"><a href="#index显示列表" class="headerlink" title="index显示列表"></a>index显示列表</h3><p>（一般为企业内部使用）</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">autoindex</span> on<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>自动显示目录
<span class="token keyword">autoindex_exact_size</span> off<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>人性化方式显示文件大小否则以byte显示
<span class="token keyword">autoindex_localtime</span> on<span class="token punctuation">;</span><span class="token operator">/</span><span class="token operator">/</span>按服务器时间显示，否则以gmt时间显示<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="default-type"><a href="#default-type" class="headerlink" title="default_type"></a>default_type</h3><p>设置响应的默认MIME类型。默认：text/plain</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">default_type</span> text<span class="token operator">/</span>plain<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p>每一个server配置相当于一个虚拟主机。</p>
<p>虚拟主机是一种特殊的软硬件技术，它可以将网络上的每一台计算机分成多个虚拟主机，每个虚拟主机可以独立对外提供www服务，这样就可以实现一台主机对外提供多个web服务，每个虚拟主机之间是独立的，互不影响的</p>
<p>通过nginx可以实现虚拟主机的配置，nginx支持三种类型的虚拟主机配置</p>
<ul>
<li>基于ip的虚拟主机， （一块主机绑定多个ip地址）</li>
<li>基于域名的虚拟主机（servername）</li>
<li>基于端口的虚拟主机（listen如果不写ip端口模式）</li>
</ul>
<h3 id="listen"><a href="#listen" class="headerlink" title="listen"></a>listen</h3><p>listen 指令在 server 块中生效，用来配置监听哪些端口，由这些端口来处理请求。listen 指令的配置如下：</p>
<p><img src="nginx%E9%85%8D%E7%BD%AE.assets/2826276797-5e8bbcbca0a24_articlex.png" alt="img"></p>
<p>如示例所示，listen 指令可以监听的类型有多种，可以配置监听地址和端口，也可以是仅地址和仅端口，还可以仅监听 IPv6 等等。</p>
<p>监听80端口，默认服务器，开启ipv6。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">80</span> default_server ipv6only<span class="token operator">=</span>on<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="server-name"><a href="#server-name" class="headerlink" title="server_name"></a>server_name</h3><p>server_name 指令是用来配置究竟是哪个 server 来处理我们的请求的。有时候，一个 server_name 中可能会有多个域名，这时候是如何选择的呢？</p>
<p>类型：</p>
<ol>
<li>server_name 指令后可以跟多个域名，第一个是主域名，多个域名之间空格分隔</li>
<li>泛域名：仅支持在最前或最后加 *，例如：<code>server_name *.taohui.tech</code></li>
<li>正则表达式匹配：<code>server_name www.taohui.tech ~^www\d+\.taohui\.tech$;</code></li>
</ol>
<p>匹配规则：</p>
<blockquote>
<ol>
<li>精确匹配（与顺序无关）</li>
<li>* 在前的泛域名（与顺序无关）</li>
<li>* 在后的泛域名（与顺序无关）</li>
<li>按文件中的顺序匹配正则表达式域名</li>
<li>default server<ul>
<li>第 1 个</li>
<li>listen 指定 default</li>
</ul>
</li>
</ol>
</blockquote>
<p>当 server_name 指令后有多个域名时，会有一个 server_name_in_redirect 的配置，这个配置默认关闭，它使用来控制域名重定向的，也就是这个配置开启之后，请求过来会重定向到主域名访问。</p>
<pre class="line-numbers language-none"><code class="language-none">Syntax  server_name_in_redirect on | off;
Default server_name_in_redirect off; 
Context http, server, location<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ol>
<li><p>还可以用正则表达式创建变量</p>
<ul>
<li><pre><code># 使用 $1/$2 的方式引用变量
server &#123; 
    server_name ~^(www\.)?(.+)$; 
    location / &#123; root /sites/$2; &#125; 
&#125;
<pre class="line-numbers language-none"><code class="language-none">
- &#96;&#96;&#96;
  # 还可以通过加一个 ?&lt;&gt; 的方式来命名变量
  server &#123; 
      server_name ~^(www\.)?(?&lt;domain&gt;.+)$;
      location &#x2F; &#123; root &#x2F;sites&#x2F;$domain; &#125; 
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></code></pre>
</li>
</ul>
</li>
<li><p>特殊的配置规则</p>
<ul>
<li>.test.tech 可以匹配 test.tech *.test.tech</li>
<li>_ 匹配所有域名请求</li>
<li>“” 匹配没有传递 host 头部的请求</li>
</ul>
</li>
</ol>
<h3 id="root"><a href="#root" class="headerlink" title="root"></a>root</h3><p> root /var/www/example;</p>
<h3 id="include"><a href="#include" class="headerlink" title="include"></a>include</h3><p>include指令加载文件位置，相当于nginx.conf位置。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment">#加载vhost配置文件。</span>
<span class="token keyword">include</span> vhost<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
<span class="token keyword">include</span>       mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="error-page"><a href="#error-page" class="headerlink" title="error_page"></a>error_page</h3><p>使用该<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html?&_ga=2.165971006.1422895350.1586419090-238139083.1576548324#error_page"><code>error_page</code></a>指令，您可以配置返回自定义页面以及错误代码，在响应中替换其他错误代码，或将浏览器重定向到其他URI。 </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">error_page</span> <span class="token number">404</span>             <span class="token operator">/</span><span class="token number">404.</span>html<span class="token punctuation">;</span>
<span class="token keyword">error_page</span> <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在以下示例中，当NGINX Plus无法找到页面时，它将代码替换<code>301</code>为代码<code>404</code>，并将客户端重定向到<strong>http：/example.com/new/path.html</strong>。当客户端仍尝试访问其旧URI的页面时，此配置很有用。该<code>301</code>代码通知浏览器该页面已永久移动，并且需要在返回时自动用新地址替换旧地址。 </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>old<span class="token operator">/</span>path<span class="token punctuation">.</span>html <span class="token punctuation">&#123;</span>
    <span class="token keyword">error_page</span> <span class="token number">404</span> <span class="token operator">=</span><span class="token number">301</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>new<span class="token operator">/</span>path<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm <span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="server-tokens"><a href="#server-tokens" class="headerlink" title="server_tokens"></a><strong>server_tokens</strong></h3><p> 启用或禁用在错误页和“服务器”响应头字段中发出nginx版本。 </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">Syntax<span class="token punctuation">:</span>	<span class="token keyword">server_tokens</span> on <span class="token operator">|</span> off <span class="token operator">|</span> build <span class="token operator">|</span> string<span class="token punctuation">;</span>
Default<span class="token punctuation">:</span>	<span class="token keyword">server_tokens</span> on<span class="token punctuation">;</span>
Context<span class="token punctuation">:</span>	<span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="location"><a href="#location" class="headerlink" title="location"></a>location</h3><p> 基本语法：location [=|<del>|</del>*|^~] /uri/ { … } </p>
<p>注意：上面location、符号、路径、花括号之间有空格。尤其是正则表达式，空格不能少。</p>
<p>示例：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
 <span class="token comment"># 只匹配 / 查询。</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
 <span class="token comment"># 匹配任何查询，因为所有请求都以 / 开头。但是正则表达式规则和长的块规则将被优先和查询匹配。</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>images<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
 <span class="token comment"># 匹配任何以 /images/ 开头的任何查询并且停止搜索。任何正则表达式将不会被测试。</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
 <span class="token comment"># 匹配任何以 gif、jpg 或 jpeg 结尾的请求。</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
  <span class="token keyword">valid_referers</span> none blocked start<span class="token punctuation">.</span>igrow<span class="token punctuation">.</span>cn sta<span class="token punctuation">.</span>igrow<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">#防盗链</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token operator">/</span>logo<span class="token punctuation">.</span>png<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 嵌套模式</span>
<span class="token comment"># 首先，匹配到/路径</span>
<span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span> 
    <span class="token comment"># 然后我们匹配到一个最具体的子字符串，注意这不是regluar表达式</span>
    <span class="token keyword">location</span> <span class="token operator">^</span><span class="token operator">~</span> <span class="token operator">/</span>css<span class="token punctuation">&#123;</span>
        <span class="token comment"># 下面是匹配的正则表达式</span>
        <span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">/</span>css<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span>css$ <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">302</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token number">402</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># 上面，访问 /css  /cssjkjk/  /css/1.txt  返回402。</span>
<span class="token comment"># 访问  /css/1.css  /css/2/3.css 返回302 。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表述1：</p>
<pre class="line-numbers language-none"><code class="language-none">location URI &#123;&#125; 对当前路径及子路径下的所有对象都生效；
location &#x3D; URI &#123;&#125; 注意URL最好为具体路径。 精确匹配指定的路径，不包括子路径，因此，只对当前资源生效；
location ~ URI &#123;&#125; location ~* URI &#123;&#125; 模式匹配URI，此处的URI可使用正则表达式，~区分字符大小写，~*不区分字符大小写；
location ^~ URI &#123;&#125; 禁用正则表达式<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>表述2：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D;：对URI做精确匹配；
	location &#x3D; &#x2F; &#123;
		...
	&#125;
~：对URI做正则表达式模式匹配，区分字符大小写；
~*：对URI做正则表达式模式匹配，不区分字符大小写；
^~：对URI的左半部分做匹配检查，不区分字符大小写；注意，不是正则表达式。
不带符号：匹配起始于此uri的所有的url；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表述3：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x3D; 严格匹配。如果这个查询匹配，那么将停止搜索并立即处理此请求。
~ 为区分大小写匹配(可用正则表达式)
!~为区分大小写不匹配
~* 为不区分大小写匹配(可用正则表达式)
!~*为不区分大小写不匹配
^~ 如果把这个前缀用于一个常规字符串,那么告诉nginx 如果路径匹配那么不测试正则表达式。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>总结：</strong></p>
<p>优先级：=  大于 ^~ 大于 <del>|</del>* 大于 /|/dir/</p>
<p>备注：优先级理解为，最后一次匹配的优先级，即谁最可能成为最后一次匹配。或者理解为，结束匹配的优先级。</p>
<h4 id="location配置规则"><a href="#location配置规则" class="headerlink" title="location配置规则"></a><strong>location配置规则</strong></h4><p>location 的执行逻辑：</p>
<p>1、“普通 location ”的匹配规则是“最大前缀”，因此“普通 location ”的确与 location 编辑顺序无关；</p>
<p>2、“正则 location ”的匹配规则是“顺序匹配，且只要匹配到第一个就停止后面的匹配”；</p>
<p>“普通location ”与“正则 location ”之间的匹配顺序是：先匹配普通 location ，再“考虑”匹配正则 location 。</p>
<p>注意这里的“考虑”是“可能”的意思，也就是说匹配完“普通 location ”后，有的时候需要继续匹配“正则 location ”，有的时候则不需要继续匹配“正则 location ”。两种情况下，不需要继续匹配正则 location ：</p>
<p>（ 1 ）当普通 location 前面指定了“ ^~ ”，特别告诉 Nginx 本条普通 location 一旦匹配上，则不需要继续正则匹配；</p>
<p>（ 2 ）当普通location 恰好严格匹配上，不是最大前缀匹配，则不再继续匹配正则</p>
<h4 id="路径"><a href="#路径" class="headerlink" title="@路径"></a>@路径</h4><p>@路径，相当于起别名。与proxy_pass配合使用。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> @backend<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">location</span> @backend <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="IP访问控制"><a href="#IP访问控制" class="headerlink" title="IP访问控制"></a><strong>IP访问控制</strong></h4><p>参见 <a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018505993">Linux运维 | nginx访问控制与参数调优</a></p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">deny</span> IP <span class="token operator">/</span>IP段<span class="token punctuation">;</span>
    <span class="token keyword">deny</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.109</span><span class="token punctuation">;</span>
    <span class="token keyword">allow</span> <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">;</span><span class="token number">192.168</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">;</span><span class="token number">192.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>deny all;拒绝所有。</p>
<p>另外，配合location的正则， if模块等，完成基于特定路径、请求头的访问控制。</p>
<h4 id="用户认证访问"><a href="#用户认证访问" class="headerlink" title="用户认证访问"></a><strong>用户认证访问</strong></h4><p>模块ngx_http_auth_basic_module 允许使用“HTTP基本认证”协议验证用户名和密码来限制对资源的访问</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>\<span class="token punctuation">.</span>avi$ <span class="token punctuation">&#123;</span>
    <span class="token keyword">auth_basic</span> <span class="token string">"closed site"</span><span class="token punctuation">;</span>
    <span class="token keyword">auth_basic_user_file</span> conf<span class="token operator">/</span>users<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>账号密码通过httpd-tools配置</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum <span class="token function">install</span> httpd
htpasswd -c -d /usr/local/users zhangyang<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="nginx访问状态监控"><a href="#nginx访问状态监控" class="headerlink" title="nginx访问状态监控"></a><strong>nginx访问状态监控</strong></h4><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>basic_status <span class="token punctuation">&#123;</span>
    <span class="token keyword">stub_status</span> on<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h4><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">charset</span> utf<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">#一般是在个别的location中加入此项，具体情况具体对待</span>
     <span class="token keyword">rewrite</span> <span class="token punctuation">.</span><span class="token operator">*</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="expires缓存"><a href="#expires缓存" class="headerlink" title="expires缓存"></a>expires缓存</h4><p>指定缓存时间。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment">#图片缓存时间设置</span>
<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$
<span class="token punctuation">&#123;</span>
    <span class="token keyword">expires</span> <span class="token number">10</span>d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">#JS和CSS缓存时间设置</span>
<span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>js<span class="token operator">|</span>css<span class="token punctuation">)</span><span class="token operator">?</span>$
<span class="token punctuation">&#123;</span>
     <span class="token keyword">expires</span> <span class="token number">1</span>h<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="etag缓存"><a href="#etag缓存" class="headerlink" title="etag缓存"></a>etag缓存</h4><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">etag on <span class="token operator">|</span> off<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>开启缓存</li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span><span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>ico<span class="token operator">|</span>rar<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span>zip<span class="token operator">|</span>xml<span class="token operator">|</span>txt<span class="token operator">|</span><span class="token keyword">flv</span><span class="token operator">|</span>swf<span class="token operator">|</span>mid<span class="token operator">|</span>doc<span class="token operator">|</span>cur<span class="token operator">|</span>xls<span class="token operator">|</span>pdf<span class="token operator">|</span>txt<span class="token operator">|</span><span class="token punctuation">)</span>$ 
<span class="token punctuation">&#123;</span>
    FileETag on<span class="token punctuation">;</span>
    etag_format <span class="token string">"%X%X"</span><span class="token punctuation">;</span>
    <span class="token keyword">expires</span> <span class="token number">30</span>d<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>禁用缓存配置</li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token keyword">index</span>\<span class="token punctuation">.</span>html$
<span class="token punctuation">&#123;</span>
    <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control <span class="token string">"no-store"</span><span class="token punctuation">;</span>
    <span class="token keyword">expires</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    etag off<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="last-modify"><a href="#last-modify" class="headerlink" title="last-modify"></a>last-modify</h4><h4 id="add-header"><a href="#add-header" class="headerlink" title="add_header"></a>add_header</h4><p>添加响应头信息。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token string">"*"</span><span class="token punctuation">;</span>
<span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Origin <span class="token string">"http://local.dev.com"</span><span class="token punctuation">;</span>
<span class="token keyword">add_header</span> Access<span class="token operator">-</span>Control<span class="token operator">-</span><span class="token keyword">Allow</span><span class="token operator">-</span>Credentials <span class="token string">"true"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="rewrite重写机制"><a href="#rewrite重写机制" class="headerlink" title="rewrite重写机制"></a>rewrite重写机制</h4><p>参考：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/czlun/articles/7010604.html">Nginx URL重写（rewrite）配置及信息详解</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000018933857">nginx 之 proxy_pass 接口转发的规则</a></p>
</li>
</ul>
<p>格式：</p>
<p>rewrite  <regex>  <replacement>  [flag];</p>
<p>  关键字    正则     替代内容      flag标记</p>
<p>正则：perl兼容正则表达式语句进行规则匹配</p>
<p>  替代内容：将正则匹配的内容替换成replacement</p>
<p>  flag标记：rewrite支持的flag标记</p>
<blockquote>
<p>last #本条规则匹配完成后，继续向下匹配新的location URI规则</p>
<p>break #本条规则匹配完成即终止，不再匹配后面的任何规则</p>
<p>redirect #返回302临时重定向，浏览器地址会显示跳转后的URL地址</p>
<p>permanent #返回301永久重定向，浏览器地址栏会显示跳转后的URL地址 </p>
</blockquote>
<p>rewrite参数的标签段位置：</p>
<p> server,location,if </p>
<p>示例：（url增加前缀）</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token operator">/</span>prefix$<span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>示例：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">http</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># 定义image日志格式</span>
    <span class="token keyword">log_format</span> imagelog <span class="token string">'[$time_local] '</span> <span class="token variable">$image_file</span> <span class="token string">' '</span> <span class="token variable">$image_type</span> <span class="token string">' '</span> <span class="token variable">$body_bytes_sent</span> <span class="token string">' '</span> <span class="token variable">$status</span><span class="token punctuation">;</span>
    <span class="token comment"># 开启重写日志</span>
    rewrite_log on<span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span>www<span class="token punctuation">;</span>
        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
            <span class="token comment"># 重写规则信息</span>
            <span class="token keyword">error_log</span> logs<span class="token operator">/</span><span class="token keyword">rewrite</span><span class="token punctuation">.</span>log notice<span class="token punctuation">;</span>
            <span class="token comment"># 注意这里要用‘’单引号引起来，避免&#123;&#125;</span>
            <span class="token keyword">rewrite</span> <span class="token string">'^/images/([a-z]&#123;2&#125;)/([a-z0-9]&#123;5&#125;)/(.*)\.(png|jpg|gif)$'</span> <span class="token operator">/</span>data<span class="token operator">?</span>file<span class="token operator">=</span>$<span class="token number">3.</span>$<span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token comment"># 注意不能在上面这条规则后面加上“last”参数，否则下面的set指令不会执行</span>
            <span class="token keyword">set</span> <span class="token variable">$image_file</span> $<span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">set</span> <span class="token variable">$image_type</span> $<span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">location</span> <span class="token operator">/</span>data <span class="token punctuation">&#123;</span>
            <span class="token comment"># 指定针对图片的日志格式，来分析图片类型和大小</span>
            <span class="token keyword">access_log</span> logs<span class="token operator">/</span>images<span class="token punctuation">.</span>log mian<span class="token punctuation">;</span>
            <span class="token keyword">root</span> <span class="token operator">/</span>data<span class="token operator">/</span>images<span class="token punctuation">;</span>
            <span class="token comment"># 应用前面定义的变量。判断首先文件在不在，不在再判断目录在不在，如果还不在就跳转到最后一个url里</span>
            <span class="token keyword">try_files</span> <span class="token operator">/</span><span class="token variable">$arg_file</span> <span class="token operator">/</span>image404<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>image404<span class="token punctuation">.</span>html <span class="token punctuation">&#123;</span>
            <span class="token comment"># 图片不存在返回特定的信息</span>
            <span class="token keyword">return</span> <span class="token number">404</span> <span class="token string">"image not found\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="try-files"><a href="#try-files" class="headerlink" title="try_files"></a>try_files</h4><p>同rewrite一样，也能达到重写url的目的。</p>
<p>该<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files"><code>try_files</code></a>指令可用于检查指定的文件或目录是否存在；NGINX会进行内部重定向，否则会返回指定的状态码。例如，要检查是否存在与请求URI相对应的文件，请使用<code>try_files</code>伪指令和<code>$uri</code>变量，如下所示：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">root</span> <span class="token operator">/</span>www<span class="token operator">/</span>data<span class="token punctuation">;</span>

    <span class="token keyword">location</span> <span class="token operator">/</span>images<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span>images<span class="token operator">/</span>default<span class="token punctuation">.</span>gif<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该文件以URI的形式指定，该URI使用在当前位置或虚拟服务器的上下文中设置的<code>root</code>或<code>alias</code>指令进行处理。在这种情况下，如果不存在与原始URI对应的文件，则NGINX将内部重定向到由最后一个参数指定的URI，返回<code>/www/data/images/default.gif</code>。</p>
<p>最后一个参数也可以是状态代码（直接在等号之后）或位置名称。在以下示例中，如果<code>try_files</code>指令的任何参数都无法解析到现有文件或目录，则将返回<code>404</code>错误。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> <span class="token variable">$uri</span><span class="token punctuation">.</span>html <span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>请求将被重定向到指定位置，该位置会将其传递给代理服务器。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span><span class="token operator">/</span> @backend<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">location</span> @backend <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="return"><a href="#return" class="headerlink" title="return"></a>return</h4><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
     <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span> <span class="token comment"># 或者 '403'。</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>permanently<span class="token operator">/</span>moved<span class="token operator">/</span>url <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>moved<span class="token operator">/</span>here<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>或者直接返回文本内容：</strong></p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>scc <span class="token punctuation">&#123;</span>
    <span class="token keyword">default_type</span>    text<span class="token operator">/</span>plain<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">502</span> <span class="token string">"服务正在升级，请稍后再试……"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>返回json也是可以的：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>get_json <span class="token punctuation">&#123;</span>
    <span class="token keyword">default_type</span> application<span class="token operator">/</span>json<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">200</span> <span class="token string">'&#123;"status":"success","result":"nginx json"&#125;'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>利用上请求的参数：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span>get_text<span class="token operator">/</span>article<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">_</span><span class="token punctuation">(</span>\d<span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">.</span>html$ <span class="token punctuation">&#123;</span>
    <span class="token keyword">default_type</span> text<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token keyword">set</span> <span class="token variable">$s</span> $<span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">set</span> <span class="token variable">$d</span> $<span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">200</span> str<span class="token punctuation">:</span><span class="token variable">$s</span><span class="token variable">$d</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="proxy-pass反向代理"><a href="#proxy-pass反向代理" class="headerlink" title="proxy_pass反向代理"></a>proxy_pass<strong>反向代理</strong></h4><p>参考：<a target="_blank" rel="noopener" href="https://www.toutiao.com/i6797701289871409672/?tt_from=weixin&utm_campaign=client_share&wxshare_count=1&timestamp=1586313927&app=news_article&utm_source=weixin&utm_medium=toutiao_android&req_id=2020040810452601001404707621BDF81F&group_id=6797701289871409672">代理如何去掉或增加前缀</a></p>
<p>通常的代理服务器，只用于代理内部网络对Internet的连接请求，客户机必须指定代理服务器,并将本来要直接发送到Web服务器上的http请求发送到代理服务器中由代理服务器向Internet上的web服务器发起请求，最终达到客户机上网的目的。</p>
<p>反向代理（Reverse Proxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器</p>
<p>注意事项：</p>
<p> 如果location包含了正则表达式,则 “proxy_pass”不能包含URI part 。即 proxy_pass <a href="http://localhost:8080;结尾不能带任务URI部分。">http://localhost:8080;结尾不能带任务URI部分。</a> </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>basic_status <span class="token punctuation">&#123;</span>
     <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>更复杂的配置：</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;ucarapi&#x2F; &#123;
     proxy_pass http:&#x2F;&#x2F;httpds&#x2F;; #已定义的upstream
     proxy_connect_timeout 3; &#x2F;&#x2F;连接超时时间
     proxy_read_timeout 30;
     proxy_set_header Host tapi.51ucar.cn; &#x2F;&#x2F;HTTP头信息,后端服务器根据此来找到特定虚拟主机
     proxy_set_header X-Real-IP $remote_addr; &#x2F;&#x2F;HTTP头信息，真实IP
     proxy_set_header X-Scheme $scheme;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外，公司常用的：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">upstream php <span class="token punctuation">&#123;</span>
        server <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">81</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    server <span class="token punctuation">&#123;</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        location <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
            root   <span class="token operator">/</span>yd<span class="token punctuation">;</span>
            index  index<span class="token punctuation">.</span>php index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                proxy_pass http<span class="token punctuation">:</span><span class="token comment">//php;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html <span class="token punctuation">&#123;</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        location <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">&#123;</span>
            proxy_set_header  Host <span class="token variable">$host</span><span class="token punctuation">:</span><span class="token constant">APP_PORT</span><span class="token punctuation">;</span>
            <span class="token shell-comment comment">#proxy_set_header  X-Real-IP $remote_addr;</span>
            proxy_set_header  <span class="token constant">X</span><span class="token operator">-</span>Forwarded<span class="token operator">-</span><span class="token keyword">For</span> <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
            proxy_pass   http<span class="token punctuation">:</span><span class="token comment">//127.0.0.1:81;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>proxy_pass</p>
<p>proxy_connect_timeout</p>
<p>proxy_set_header</p>
<p>代理时，添加请求头。</p>
<pre class="line-numbers language-none"><code class="language-none"><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>





<h4 id="upstream"><a href="#upstream" class="headerlink" title="upstream"></a><strong>upstream</strong></h4><p>反向代理配合upstream使用</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> httpds <span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.43</span><span class="token number">.152</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">192.168</span><span class="token number">.43</span><span class="token number">.153</span><span class="token punctuation">:</span><span class="token number">80</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>weight(权重)</strong></p>
<p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> httpds <span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8050</span> weight<span class="token operator">=</span><span class="token number">10</span> down<span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8060</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8060</span> weight<span class="token operator">=</span><span class="token number">1</span> backup<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>down：表示当前的server暂时不参与负载</p>
<p>weight：默认为1.weight越大，负载的权重就越大。</p>
<p>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。</p>
<p><strong>max_conns</strong></p>
<p>可以根据服务的好坏来设置最大连接数，防止挂掉，比如1000，我们可以设置800</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> httpds <span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8050</span> weight<span class="token operator">=</span><span class="token number">5</span> max_conns<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8060</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>max_fails、 fail_timeout</strong></p>
<p>max_fails:失败多少次 认为主机已挂掉则，踢出，公司资源少的话一般设置2~3次，多的话设置1次</p>
<p>max_fails=3 fail_timeout=30s代表在30秒内请求某一应用失败3次，认为该应用宕机，后等待30秒，这期间内不会再把新请求发送到宕机应用，而是直接发到正常的那一台，时间到后再有请求进来继续尝试连接宕机应用且仅尝试1次，如果还是失败，则继续等待30秒…以此循环，直到恢复。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">upstream</span> httpds <span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8050</span> weight<span class="token operator">=</span><span class="token number">1</span> max_fails<span class="token operator">=</span><span class="token number">1</span> fail_timeout<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">server</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">8060</span> weight<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>负载均衡算法</strong></p>
<p>轮询、 weight、 ip_hash、 url_hash、 least_conn、 least_time</p>
<p><strong>健康检查模块</strong></p>
<p>配置一个status的location</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>status <span class="token punctuation">&#123;</span>
	check_status<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在upstream配置如下</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx">check interval<span class="token operator">=</span><span class="token number">3000</span> rise<span class="token operator">=</span><span class="token number">2</span> fall<span class="token operator">=</span><span class="token number">5</span> <span class="token keyword">timeout</span><span class="token operator">=</span><span class="token number">1000</span> type<span class="token operator">=</span><span class="token keyword">http</span><span class="token punctuation">;</span>
check_http_send <span class="token string">"HEAD / HTTP/1.0\r\n\r\n"</span><span class="token punctuation">;</span>
check_http_expect_alive http_2xx http_3xx<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>





<h3 id="fast-pass"><a href="#fast-pass" class="headerlink" title="fast_pass"></a>fast_pass</h3><p>参考：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000002667095">ngx_http_fastcgi_module 的那些事</a></p>
<p>示例：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span><span class="token function">php</span><span class="token punctuation">(</span>$<span class="token operator">|</span><span class="token operator">/</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>dev<span class="token operator">/</span>shm<span class="token operator">/</span>php<span class="token operator">-</span>fpm<span class="token punctuation">.</span>unix<span class="token punctuation">;</span>  <span class="token comment">#最重要的一项，根据实际情况来配置（根据php的配置文件listen的配置来配置,其值可以是一个域名、IP地址:端口、或者是一个Unix的Socket文件。</span>
）
 <span class="token keyword">fastcgi_index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span>  <span class="token comment">#当请求以/结尾的时候，会将请求传递给所设置的index.php文件处理。</span>
 <span class="token keyword">fastcgi_split_path_info</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">+</span>\<span class="token punctuation">.</span>php<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$<span class="token punctuation">;</span> <span class="token comment">#Nginx默认获取不到PATH_INFO的值，得通过fastcgi_split_path_info指定定义的正则表达式来给$fastcgi_path_info赋值。</span>
 <span class="token keyword">fastcgi_param</span> PATH_INFO <span class="token variable">$fastcgi_path_info</span><span class="token punctuation">;</span> 
 <span class="token keyword">fastcgi_param</span> SCRIPT_FILENAME <span class="token variable">$document_root</span><span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
 <span class="token keyword">include</span> fastcgi<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置php的fastcgi：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
    <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">root</span>   <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
        <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>php <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html <span class="token punctuation">&#123;</span>
        <span class="token keyword">root</span>   <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">location</span> <span class="token operator">~</span> \<span class="token punctuation">.</span>php$ <span class="token punctuation">&#123;</span>
        <span class="token keyword">root</span>           html<span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_pass</span>   php<span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_param</span>  SCRIPT_FILENAME  <span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>html<span class="token variable">$fastcgi_script_name</span><span class="token punctuation">;</span>
        <span class="token keyword">include</span>        fastcgi_params<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>include指令加载文件位置，相当于nginx.conf位置，fastcgi_params内容如下：</p>
<pre class="line-numbers language-none"><code class="language-none">fastcgi_param  QUERY_STRING       $query_string;
fastcgi_param  REQUEST_METHOD     $request_method;
fastcgi_param  CONTENT_TYPE       $content_type;
fastcgi_param  CONTENT_LENGTH     $content_length;

fastcgi_param  SCRIPT_NAME        $fastcgi_script_name;
fastcgi_param  REQUEST_URI        $request_uri;
fastcgi_param  DOCUMENT_URI       $document_uri;
fastcgi_param  DOCUMENT_ROOT      $document_root;
fastcgi_param  SERVER_PROTOCOL    $server_protocol;
fastcgi_param  REQUEST_SCHEME     $scheme;
fastcgi_param  HTTPS              $https if_not_empty;

fastcgi_param  GATEWAY_INTERFACE  CGI&#x2F;1.1;
fastcgi_param  SERVER_SOFTWARE    nginx&#x2F;$nginx_version;

fastcgi_param  REMOTE_ADDR        $remote_addr;
fastcgi_param  REMOTE_PORT        $remote_port;
fastcgi_param  SERVER_ADDR        $server_addr;
fastcgi_param  SERVER_PORT        $server_port;
fastcgi_param  SERVER_NAME        $server_name;

# PHP only, required if PHP was built with --enable-force-cgi-redirect
fastcgi_param  REDIRECT_STATUS    200;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>ngx_http_fastcgi_module用来处理FastCGI的模块。PHP一般是以PHP-CGI的形式在运行，它就是一种FastCGI，我们在进程中看到的PHP-FPM是PHP-CGI的管理调度器。</p>
<p> <strong>四个常见、重要的配置项</strong></p>
<h4 id="fastcgi-pass"><a href="#fastcgi-pass" class="headerlink" title="fastcgi_pass"></a>fastcgi_pass</h4><blockquote>
<p>作用域：location, if in location</p>
</blockquote>
<p>设置FastCGI服务，其值可以是一个域名、IP地址:端口、或者是一个Unix的Socket文件。</p>
<p>同时，它也只支持一个FastCGI服务集群。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># TCP形式传递</span>
<span class="token keyword">fastcgi_pass</span> localhost<span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>

<span class="token comment"># Socket形式传递</span>
<span class="token keyword">fastcgi_pass</span> unix<span class="token punctuation">:</span><span class="token operator">/</span>tmp<span class="token operator">/</span>fastcgi<span class="token punctuation">.</span>socket<span class="token punctuation">;</span>

<span class="token comment"># 传递给集群</span>
<span class="token keyword">upstream</span> cloud <span class="token punctuation">&#123;</span>
    <span class="token keyword">server</span> cgi_1<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    <span class="token keyword">server</span> cgi_2<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">fastcgi_pass</span> cloud<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="fastcgi-param"><a href="#fastcgi-param" class="headerlink" title="fastcgi_param"></a>fastcgi_param</h4><blockquote>
<p>作用域：http, server, location</p>
</blockquote>
<p>设置一个传递给FastCGI服务的参数，可以是文本或者是变量。</p>
<pre class="line-numbers language-none"><code class="language-none"># 例如在接入层Nginx上面传递如下5个参数
fastcgi_param  REMOTE_ADDR        $remote_addr;
fastcgi_param  REMOTE_PORT        $remote_port;
fastcgi_param  SERVER_ADDR        $server_addr;
fastcgi_param  SERVER_PORT        $server_port;
fastcgi_param  SERVER_NAME        $server_name;

# 那么在FastCGI上面，例如PHP-CGI上面就可以通过$_SERVER这个超全局变量获取。
$_SERVER[&#39;REMOTE_ADDR&#39;]
$_SERVER[&#39;REMOTE_PORT&#39;]
$_SERVER[&#39;SERVER_ADDR&#39;]
$_SERVER[&#39;SERVER_PORT&#39;]
$_SERVER[&#39;SERVER_NAME&#39;]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可传递的参数，遵循<a target="_blank" rel="noopener" href="http://www.faqs.org/rfcs/rfc3875.html">CGI/1.1规范</a>定义。</p>
<p>可以从<a target="_blank" rel="noopener" href="https://github.com/nginx/nginx/blob/master/conf/fastcgi_params">Github</a>上面看到Nginx在3年前实现FastCGI的参数传递后，基本就没变过了。</p>
<h4 id="fastcgi-index"><a href="#fastcgi-index" class="headerlink" title="fastcgi_index"></a>fastcgi_index</h4><blockquote>
<p>作用域：http, server, location</p>
</blockquote>
<p>当请求以<code>/</code>结尾的时候，会将请求传递给所设置的index.php文件处理。</p>
<pre class="line-numbers language-none"><code class="language-none">fastcgi_index index.php;
fastcgi_param SCRIPT_FILENAME &#x2F;home&#x2F;www&#x2F;scripts&#x2F;php$fastcgi_script_name;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="fastcgi-split-path-info"><a href="#fastcgi-split-path-info" class="headerlink" title="fastcgi_split_path_info"></a>fastcgi_split_path_info</h4><blockquote>
<p>作用域：location</p>
</blockquote>
<p>Nginx默认获取不到PATH_INFO的值，得通过fastcgi_split_path_info指定定义的正则表达式来给<code>$fastcgi_path_info</code>赋值。</p>
<p>其正则表达式必须要有两个捕获。</p>
<ul>
<li>第一个捕获的值会重新赋值给<code>$fastcgi_script_name</code>变量。</li>
<li>第二个捕获到的值会重新赋值给<code>$fastcgi_path_info</code>变量。</li>
</ul>
<p>例子：</p>
<pre class="line-numbers language-none"><code class="language-none">location ~ ^(.+\.php)(.*)$ &#123;
    fastcgi_split_path_info       ^(.+\.php)(.*)$;
    fastcgi_param SCRIPT_FILENAME &#x2F;path&#x2F;to&#x2F;php$fastcgi_script_name;
    fastcgi_param PATH_INFO       $fastcgi_path_info;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>原始请求是 <code>/show.php/article/0001</code>。</p>
<p>通过分割，FastCGI得到的结果是：</p>
<ul>
<li>SCRIPT_FILENAME: <code>/path/to/php/show.php</code></li>
<li>PATH_INFO: <code>/article/0001</code></li>
</ul>
<p>Nginx在0.7.31以前是没有fastcgi_split_path_info这个指令的，而0.7.x这个版本一直存活了好多年，后面才高歌猛进，导致网上存在大量旧版本通过正则自己设置PATH_INFO的方法。</p>
<h4 id="踩了好多次依旧不记得怎么设置的ThinkPHP"><a href="#踩了好多次依旧不记得怎么设置的ThinkPHP" class="headerlink" title="踩了好多次依旧不记得怎么设置的ThinkPHP"></a>踩了好多次依旧不记得怎么设置的ThinkPHP</h4><p>为什么总是踩坑？因为我们都会通过重写来隐藏index.php文件，而ThinkPHP的教程，默认教的是旧版Nginx写法，且URL_MODE必须设置为3也说得很隐晦（URL_MODE默认为0）。</p>
<p>例如ThinkPHP的说明有一段旧版的Nginx设置指引。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span> <span class="token operator">/</span><span class="token operator">/</span> …<span class="token punctuation">.</span><span class="token punctuation">.</span>省略部分代码
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$request_filename</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">rewrite</span>  <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$  <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token operator">?</span>s<span class="token operator">=</span>$<span class="token number">1</span>  last<span class="token punctuation">;</span>
  <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该规则是通过将请求rewrite给<code>/index.php?s=</code>来实现的，其ThinkPHP的URL_MODE配置必须为3，也就是兼容模式。</p>
<p>如果使用本文中的传递PATH_INFO方式，且隐藏index.php，则ThinkPHP的URL_MODE需要改为2。</p>
<p>如果使用本文中的传递PATH_INFO方式，但不隐藏index.php，则ThinkPHP的URL_MODE改为1。</p>
<h4 id="cgi-fix-pathinfo"><a href="#cgi-fix-pathinfo" class="headerlink" title="cgi.fix_pathinfo"></a><code>cgi.fix_pathinfo</code></h4><p>cgi.fix_pathinfo参数，藏在PHP-FPM的php.ini配置里面，其默认值为1。</p>
<p>这里存在一个安全风险，我也不通，详情不表，看鸟哥的文章：<a target="_blank" rel="noopener" href="http://www.laruence.com/2010/05/20/1495.html">http://www.laruence.com/2010/05/20/1495.html</a></p>
<p>习惯性将其设置为0即可。</p>
<h3 id="if-模块"><a href="#if-模块" class="headerlink" title="if 模块"></a>if 模块</h3><p>if语句块长用在做单独的限制，如限制访问特定的资源，然后对此类请求做处理，rewire或者deny或者proxy_pass等等。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span> MSIE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">proxy_pass</span>
  <span class="token operator">^</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>$ <span class="token operator">/</span>msie<span class="token operator">/</span>$<span class="token number">1</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token comment">#如果UA包含"MSIE"，rewrite请求到/msid/目录下</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_cookie</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">"id=([^;]+)(?:;|$)"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">set</span> <span class="token variable">$id</span> $<span class="token number">1</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span> <span class="token comment">#如果cookie匹配正则，设置变量$id等于正则引用部分</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_method</span> <span class="token operator">=</span> POST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">return</span> <span class="token number">405</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token comment">#如果提交方法为POST，则返回状态405（Method not allowed）。return不能返回301,302</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$slow</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">limit_rate</span> <span class="token number">10</span>k<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token comment">#限速，$slow可以通过 set 指令设置</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>f <span class="token variable">$request_filename</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment">#-e 也行，表示存在</span>
 <span class="token keyword">break</span><span class="token punctuation">;</span>
 <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token comment">#如果请求的文件名不存在，则反向代理到localhost 。这里的break也是停止rewrite检查</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$args</span> <span class="token operator">~</span> post<span class="token operator">=</span><span class="token number">140</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
 <span class="token keyword">rewrite</span> <span class="token operator">^</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span> permanent<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token comment">#如果query string中包含"post=140"，永久重定向到example.com</span>

<span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>swf<span class="token operator">|</span><span class="token keyword">flv</span><span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
 <span class="token keyword">valid_referers</span> none blocked www<span class="token punctuation">.</span>jefflei<span class="token punctuation">.</span>com www<span class="token punctuation">.</span>leizhenfang<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$invalid_referer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span> <span class="token comment">#防盗链</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="文件判断"><a href="#文件判断" class="headerlink" title="文件判断"></a>文件判断</h4><p>不管filename是什么类型，<code>!-e</code>加了!就取反</p>
<pre class="line-numbers language-none"><code class="language-none">-e filename 如果 filename存在，则为真
-d filename 如果 filename为目录，则为真 
-f filename 如果 filename为常规文件，则为真
-L filename 如果 filename为符号链接，则为真
-r filename 如果 filename可读，则为真 
-w filename 如果 filename可写，则为真 
-x filename 如果 filename可执行，则为真
-s filename 如果文件长度不为0，则为真
-h filename 如果文件是软链接，则为<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="https"><a href="#https" class="headerlink" title="https"></a>https</h2><p>在http配置下新增一个server</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span> localhost<span class="token punctuation">;</span>
        <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
        <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span><span class="token keyword">ssl</span><span class="token operator">/</span>nginx<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token keyword">ssl_session_cache</span>    shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span><span class="token number">1</span>m<span class="token punctuation">;</span>
        <span class="token keyword">ssl_session_timeout</span>  <span class="token number">5</span>m<span class="token punctuation">;</span>
        <span class="token comment">#禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击</span>
        <span class="token keyword">server_tokens</span> off<span class="token punctuation">;</span>
        <span class="token comment">#如果是全站 HTTPS 并且不考虑 HTTP 的话，可以加入 HSTS 告诉你的浏览器本网站全站加密，并且强制用 HTTPS 访问</span>
        <span class="token keyword">fastcgi_param</span>   <span class="token keyword">HTTPS</span>               on<span class="token punctuation">;</span>
        <span class="token keyword">fastcgi_param</span>   HTTP_SCHEME         <span class="token keyword">https</span><span class="token punctuation">;</span>
        <span class="token keyword">access_log</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>logs<span class="token operator">/</span>httpsaccess<span class="token punctuation">.</span>log<span class="token punctuation">;</span>
        <span class="token keyword">root</span> <span class="token operator">/</span>home<span class="token operator">/</span>movie<span class="token operator">/</span><span class="token punctuation">;</span>
        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
             <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
             <span class="token comment">#proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span>
             <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">55055</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">location</span> <span class="token operator">/</span><span class="token keyword">mp4</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>http转https请求</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">listen</span> <span class="token number">80</span><span class="token punctuation">;</span>
 <span class="token keyword">server_name</span> dev<span class="token operator">-</span>payment<span class="token punctuation">.</span>xxxx<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>
 <span class="token keyword">return</span> <span class="token number">307</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>dev<span class="token operator">-</span>payment<span class="token punctuation">.</span>xxxx<span class="token punctuation">.</span>cn<span class="token variable">$request_uri</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> <strong>注意:曾经遇到过这么一个坑，http转https的时候会将POST转换为GET请求，此时需要这样配置</strong> </p>
<h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>参考：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022125108">Nginx 日志配置实践</a></p>
<p><strong>前言</strong></p>
<p>Nginx日志对于统计、系统服务排错很有用。</p>
<p><strong>Nginx日志主要分为两种：</strong>access_log(访问日志)和error_log(错误日志)。通过访问日志我们可以得到用户的IP地址、浏览器的信息，请求的处理时间等信息。错误日志记录了访问出错的信息，可以帮助我们定位错误的原因。</p>
<p><strong>本文将详细描述一下如何配置Nginx日志。</strong></p>
<h5 id="设置access-log"><a href="#设置access-log" class="headerlink" title="设置access_log"></a>设置access_log</h5><hr>
<p>访问日志主要记录客户端的请求。客户端向Nginx服务器发起的每一次请求都记录在这里。客户端IP，浏览器信息，referer，请求处理时间，请求URL等都可以在访问日志中得到。当然具体要记录哪些信息，你可以通过log_format指令定义。</p>
<h5 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h5><pre class="line-numbers language-none"><code class="language-none">access_log path [format [buffer&#x3D;size] [gzip[&#x3D;level]] [flush&#x3D;time] [if&#x3D;condition]]; 
# 设置访问日志

access_log off; 
# 关闭访问日志<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<ul>
<li>path 指定日志的存放位置。</li>
<li>format 指定日志的格式。默认使用预定义的combined。</li>
<li>buffer 用来指定日志写入时的缓存大小。默认是64k。</li>
<li>gzip 日志写入前先进行压缩。压缩率可以指定，从1到9数值越大压缩比越高，同时压缩的速度也越慢。默认是1。</li>
<li>flush 设置缓存的有效时间。如果超过flush指定的时间，缓存中的内容将被清空。</li>
<li>if 条件判断。如果指定的条件计算为0或空字符串，那么该请求不会写入日志。</li>
</ul>
</blockquote>
<p>另外，还有一个特殊的值off。如果指定了该值，当前作用域下的所有的请求日志都被关闭。</p>
<h5 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h5><p>可以应用access_log指令的作用域分别有http，server，location，limit_except。也就是说，在这几个作用域外使用该指令，Nginx会报错。</p>
<p>以上是access_log指令的基本语法和参数的含义。下面我们看一几个例子加深一下理解。</p>
<h5 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h5><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>logs<span class="token operator">/</span>nginx<span class="token operator">-</span>access<span class="token punctuation">.</span>log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该例子指定日志的写入路径为/var/logs/nginx-access.log，日志格式使用默认的combined。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">access_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>logs<span class="token operator">/</span>nginx<span class="token operator">-</span>access<span class="token punctuation">.</span>log buffer<span class="token operator">=</span><span class="token number">32</span>k <span class="token keyword">gzip</span> flush<span class="token operator">=</span><span class="token number">1</span>m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>该例子指定日志的写入路径为/var/logs/nginx-access.log，日志格式使用默认的combined，指定日志的缓存大小为32k，日志写入前启用gzip进行压缩，压缩比使用默认值1，缓存数据有效时间为1分钟。</p>
<h5 id="使用log-format自定义日志格式"><a href="#使用log-format自定义日志格式" class="headerlink" title="使用log_format自定义日志格式"></a>使用log_format自定义日志格式</h5><hr>
<p>Nginx预定义了名为combined日志格式，如果没有明确指定日志格式默认使用该格式：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">log_format</span> combined <span class="token string">'$remote_addr - $remote_user [$time_local] '</span>
        <span class="token string">'"$request" $status $body_bytes_sent '</span>
        <span class="token string">'"$http_referer" "$http_user_agent"'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果不想使用Nginx预定义的格式，可以通过log_format指令来自定义。</p>
<h5 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h5><pre class="line-numbers language-none"><code class="language-none">log_format name [escape&#x3D;default|json] string ...;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<ul>
<li>name 格式名称。在access_log指令中引用。</li>
<li>escape 设置变量中的字符编码方式是json还是default，默认是default。</li>
<li>string 要定义的日志格式内容。该参数可以有多个。参数中可以使用Nginx变量。</li>
</ul>
</blockquote>
<p>下面是log_format指令中常用的一些变量：</p>
<pre class="line-numbers language-none"><code class="language-none">$bytes_sent
发送给客户端的总字节数

$body_bytes_sent
发送给客户端的字节数，不包括响应头的大小

$connection
连接序列号

$connection_requests
当前通过连接发出的请求数量

$msec
日志写入时间，单位为秒，精度是毫秒

$pipe
如果请求是通过http流水线发送，则其值为&quot;p&quot;，否则为“.&quot;

$request_length
求长度（包括请求行，请求头和请求体）

$request_time
请求处理时长，单位为秒，精度为毫秒，从读入客户端的第一个字节开始，直到把最后一个字符发送张客户端进行日志写入为止

$status
响应状态码

$time_iso8601
标准格式的本地时间,形如“2017-05-24T18:31:27+08:00”

$time_local
通用日志格式下的本地时间，如&quot;24&#x2F;May&#x2F;2017:18:31:27 +0800&quot;

$http_referer
请求的referer地址。

$http_user_agent
客户端浏览器信息。

$remote_addr
客户端IP

$http_x_forwarded_for
当前端有代理服务器时，设置web节点记录客户端地址的配置，此参数生效的前提是代理服务器也要进行相关的x_forwarded_for设置。

$request
完整的原始请求行，如 &quot;GET &#x2F; HTTP&#x2F;1.1&quot;

$remote_user
客户端用户名称，针对启用了用户认证的请求

$request_uri
完整的请求地址，如 &quot;https:&#x2F;&#x2F;daojia.com&#x2F;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>下面演示一下自定义日志格式的使用：</p>
<pre class="line-numbers language-none"><code class="language-none">access_log &#x2F;var&#x2F;logs&#x2F;nginx-access.log
   mainlog_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39; 
    &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39; 
     &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们使用log_format指令定义了一个main的格式，并在access_log指令中引用了它。假如客户端有发起请求：<a target="_blank" rel="noopener" href="https://suyunfe.com/%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8B%E4%B8%80%E4%B8%8B%E6%88%91%E6%88%AA%E5%8F%96%E7%9A%84%E4%B8%80%E4%B8%AA%E8%AF%B7%E6%B1%82%E7%9A%84%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95">https://suyunfe.com/，我们看一下我截取的一个请求的日志记录</a>:</p>
<pre class="line-numbers language-none"><code class="language-none">112.195.209.90 - - [20&#x2F;Feb&#x2F;2018:12:12:14 +0800] &quot;GET &#x2F; HTTP&#x2F;1.1&quot; 200 190 &quot;-&quot; &quot;Mozilla&#x2F;5.0 (Linux; Android 6.0; Nexus 5 Build&#x2F;MRA58N) AppleWebKit&#x2F;537.36 (KHTML, like Gecko) Chrome&#x2F;63.0.3239.132 Mobile Safari&#x2F;537.36&quot; &quot;-&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们看到最终的日志记录中<code>$remote_user</code>、<code>$http_referer</code>、<code>$http_x_forwarded_for</code>都对应了一个<code>-</code>，这是因为这几个变量为空。</p>
<h5 id="设置error-log"><a href="#设置error-log" class="headerlink" title="设置error_log"></a>设置error_log</h5><hr>
<p>错误日志在Nginx中是通过error_log指令实现的。该指令记录服务器和请求处理过程中的错误信息。</p>
<h5 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h5><p>配置错误日志文件的路径和日志级别。</p>
<pre class="line-numbers language-none"><code class="language-none">error_log file [level];
Default: 
error_log logs&#x2F;error.log error;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>第一个参数指定日志的写入位置。</p>
<p>第二个参数指定日志的级别。level可以是debug, info, notice, warn, error, crit, alert,emerg中的任意值。可以看到其取值范围是按紧急程度从低到高排列的。只有日志的错误级别等于或高于level指定的值才会写入错误日志中。默认值是error。</p>
<h5 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h5><pre class="line-numbers language-none"><code class="language-none">error_log &#x2F;var&#x2F;logs&#x2F;nginx&#x2F;nginx-error.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>它可以配置在：main， http, mail, stream, server, location作用域。</p>
<p>例子中指定了错误日志的路径为：<code>/var/logs/nginx/nginx-error.log</code>，日志级别使用默认的error。</p>
<h5 id="open-log-file-cache"><a href="#open-log-file-cache" class="headerlink" title="open_log_file_cache"></a><strong>open_log_file_cache</strong></h5><hr>
<p>每一条日志记录的写入都是先打开文件再写入记录，然后关闭日志文件。如果你的日志文件路径中使用了变量，如<code>access_log /var/logs/$host/nginx-access.log</code>，为提高性能，可以使用open_log_file_cache指令设置日志文件描述符的缓存。</p>
<h5 id="语法-4"><a href="#语法-4" class="headerlink" title="语法"></a>语法</h5><pre class="line-numbers language-none"><code class="language-none">open_log_file_cache max&#x3D;N [inactive&#x3D;time] [min_uses&#x3D;N] [valid&#x3D;time];<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<ul>
<li>max 设置缓存中最多容纳的文件描述符数量，如果被占满，采用LRU算法将描述符关闭。</li>
<li>inactive 设置缓存存活时间，默认是10s。</li>
<li>min_uses 在inactive时间段内，日志文件最少使用几次，该日志文件描述符记入缓存，默认是1次。</li>
<li>valid：设置多久对日志文件名进行检查，看是否发生变化，默认是60s。</li>
<li>off：不使用缓存。默认为off。</li>
</ul>
</blockquote>
<h5 id="基本用法-2"><a href="#基本用法-2" class="headerlink" title="基本用法"></a>基本用法</h5><pre class="line-numbers language-none"><code class="language-none">open_log_file_cache max&#x3D;1000 inactive&#x3D;20s valid&#x3D;1m min_uses&#x3D;2;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>它可以配置在http、server、location作用域中。</p>
<p>例子中，设置缓存最多缓存1000个日志文件描述符，20s内如果缓存中的日志文件描述符至少被被访问2次，才不会被缓存关闭。每隔1分钟检查缓存中的文件描述符的文件名是否还存在。</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><hr>
<p>Nginx中通过access_log和error_log指令配置访问日志和错误日志，通过log_format我们可以自定义日志格式。如果日志文件路径中使用了变量，我们可以通过open_log_file_cache指令来设置缓存，提升性能。</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>nginx自带的变量如下，除此之外，还可以通过set来设置自己的变量。详见调试-&gt;set。</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>$args</td>
<td>请求中的参数，如<a target="_blank" rel="noopener" href="http://www.123.com/1.php?a=1&amp;b=2%E7%9A%84$args%E5%B0%B1%E6%98%AFa=1&amp;b=2">www.123.com/1.php?a=1&amp;b=2的$args就是a=1&amp;b=2</a></td>
</tr>
<tr>
<td>$content_length</td>
<td>HTTP请求信息里的”Content-Length”</td>
</tr>
<tr>
<td>$conten_type</td>
<td>HTTP请求信息里的”Content-Type”</td>
</tr>
<tr>
<td>$document_root</td>
<td>nginx虚拟主机配置文件中的root参数对应的值</td>
</tr>
<tr>
<td>$document_uri</td>
<td>当前请求中不包含指令的URI，如<a target="_blank" rel="noopener" href="http://www.123.com/1.php?a=1&amp;b=2%E7%9A%84$document_uri%E5%B0%B1%E6%98%AF1.php,%E4%B8%8D%E5%8C%85%E5%90%AB%E5%90%8E%E9%9D%A2%E7%9A%84%E5%8F%82%E6%95%B0">www.123.com/1.php?a=1&amp;b=2的$document_uri就是1.php,不包含后面的参数</a></td>
</tr>
<tr>
<td>$host</td>
<td>主机头，也就是域名</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端的详细信息，也就是浏览器的标识，用curl -A可以指定</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>客户端的cookie信息</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>如果nginx服务器使用limit_rate配置了显示网络速率，则会显示，如果没有设置， 则显示0</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端的公网ip</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端的port</td>
</tr>
<tr>
<td>$remote_user</td>
<td>如果nginx有配置认证，该变量代表客户端认证的用户名</td>
</tr>
<tr>
<td>$request_body_file</td>
<td>做反向代理时发给后端服务器的本地资源的名称</td>
</tr>
<tr>
<td>$request_method</td>
<td>请求资源的方式，GET/PUT/DELETE等</td>
</tr>
<tr>
<td>$request_filename</td>
<td>当前请求的资源文件的路径名称，相当于是document_uri的组合</td>
</tr>
<tr>
<td>$request_uri</td>
<td>请求的链接，包括和args</td>
</tr>
<tr>
<td>$scheme</td>
<td>请求的协议，如ftp,http,https</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>客户端请求资源使用的协议的版本，如HTTP/1.0，HTTP/1.1，HTTP/2.0等</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器IP地址</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器的主机名</td>
</tr>
<tr>
<td>$server_port</td>
<td>服务器的端口号</td>
</tr>
<tr>
<td>$uri</td>
<td>和$document_uri相同</td>
</tr>
<tr>
<td>$http_referer</td>
<td>客户端请求时的referer，通俗讲就是该请求是通过哪个链接跳过来的，用curl -e可以指定</td>
</tr>
</tbody></table>
<h2 id="geo"><a href="#geo" class="headerlink" title="geo"></a>geo</h2><p>参见：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/kevingrace/p/6165572.html">Nginx通过geo模式实现限速白名单和全局负载均衡 - 运维笔记</a></p>
<h1 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h1><p>Usage: nginx [-?hvVtTq] [-s signal] [-c filename] [-p prefix] [-g directives]</p>
<p>示例：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"><span class="token comment"># 帮助</span>
nginx -h
<span class="token comment"># 启动</span>
nginx
<span class="token comment"># 前台启动</span>
nginx -g <span class="token string">'daemon off;'</span>  <span class="token comment"># -g 可以指定全局参数</span>
<span class="token comment"># 加载新配置</span>
nginx -s reload
<span class="token comment"># 停止</span>
nginx -s stop
nginx -s quit
<span class="token comment"># 测试配置文件是否正确，另外此命令可以看到配置文件的位置。</span>
nginx -t <span class="token comment">#默认位置下的配置</span>
nginx -t -c /path/to/nginx.conf
<span class="token comment"># 查看nginx是否启动</span>
<span class="token function">ps</span> aux <span class="token operator">|</span><span class="token function">grep</span> nginx
<span class="token comment"># 查看安装时，使用的配置，或者安装了哪些模块</span>
nginx -V
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><h2 id="模块安装"><a href="#模块安装" class="headerlink" title="模块安装"></a>模块安装</h2><h2 id="模块解读"><a href="#模块解读" class="headerlink" title="模块解读"></a>模块解读</h2><h2 id="ngx-http-stub-status-module"><a href="#ngx-http-stub-status-module" class="headerlink" title="ngx_http_stub_status_module"></a>ngx_http_stub_status_module</h2><p>参见：<a target="_blank" rel="noopener" href="https://www.linuxidc.com/Linux/2018-10/154672.htm">Nginx解读内置非默认模块</a></p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h1 id="Nginx服务器性能优化的三大方面"><a href="#Nginx服务器性能优化的三大方面" class="headerlink" title="Nginx服务器性能优化的三大方面"></a>Nginx服务器性能优化的三大方面</h1><p>摘抄： <a href="%5Bhttps://www.linuxdashen.com/nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%5D(https://www.linuxdashen.com/nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96)">原文</a></p>
<p>Nginx服务器非常快，但是Nginx的默认设置并没有针对具体的硬件进行调优。在这篇文章中，我们要把Nginx的性能发挥到极限。Nginx的配置分为三大部分：worker进程配置、I/O配置、TCP配置。我们将分别对这三大配置展开讨论，并在最后给出综合性的配置。</p>
<h2 id="Nginx的worker进程配置"><a href="#Nginx的worker进程配置" class="headerlink" title="Nginx的worker进程配置"></a>Nginx的worker进程配置</h2><h3 id="worker-processes-1"><a href="#worker-processes-1" class="headerlink" title="worker_processes"></a>worker_processes</h3><p>worker_processes directive指定nginx worker进程的数量。它是一个全局性配置，不属于events模块，也不属于http或location模块。</p>
<pre class="line-numbers language-none"><code class="language-none">worker_processes 1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>默认的值是1，意味着nignx只打开一个worker进程。最优的设置是worker进程数量要与CPU的核数相等。我们可以用lscpu命令来找出CPU的核数。</p>
<pre class="line-numbers language-none"><code class="language-none">lscpu<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也可以用</p>
<pre class="line-numbers language-none"><code class="language-none">cat &#x2F;proc&#x2F;cpuinfo | grep &#39;processor&#39; | wc -l<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>另外，我们也可以将worker_processes的值设为auto，这样nginx会自动检测CPU核数并打开相同数量的worker进程。</p>
<p>当nginx添加了SSL证书时，最好要打开多个worker进程。SSL握手会进行硬盘I/O操作。 所以打开多个worker进程有利于性能的提升。</p>
<h3 id="accept-mutex"><a href="#accept-mutex" class="headerlink" title="accept_mutex"></a>accept_mutex</h3><p>当我们为nginx打开了多个worker进程后，我们需要配置如何选择worker进程来完成相应的请求处理。在events模块中，我们可以设置</p>
<pre class="line-numbers language-none"><code class="language-none">events &#123;
 accept_mutex on;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>accept_mutex会轮流来选择worker进程。Nginx默认开启了accept_mutex。</p>
<p>如果accept_mutex的值被设为off，那么当有请求需要处理时，所有的worker进程都会从waiting状态中唤醒，但是只有一个worker进程能处理请求，这造成了thundering herd现象，这个现象每一秒钟会发生多次。它使服务器的性能下降，因为所有被唤醒的worker进程在重新进入waiting状态前会占用一段CPU时间。</p>
<h3 id="accept-mutex-delay-1"><a href="#accept-mutex-delay-1" class="headerlink" title="accept_mutex_delay"></a>accept_mutex_delay</h3><p>当accept_mutex功能启用后，只有一个持有mutex锁的worker进程会接受并处理请求，其他worker进程等待。accept_mutex_delay指定的时间就是这些worker进程的等待时间，过了等待时间下一个worker进程便取得mutex锁，处理请求。accept_mutex_delay在events模块中指定，默认的值为500ms。</p>
<pre class="line-numbers language-none"><code class="language-none">events &#123;
 accept_mutex_delay 500ms;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="worker-connections"><a href="#worker-connections" class="headerlink" title="worker_connections"></a>worker_connections</h3><p>worker_connections的默认值是512,它在events模块中。它指定了一个worker进程在同一时间可以处理的最大请求数。</p>
<pre class="line-numbers language-none"><code class="language-none">events &#123;
 worker_connections 512;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>将它的值增加到1024左右。</p>
<p>web服务器同时处理的请求数并不等于它同时服务的客户端数量。一个浏览器会打开多个并发连接来下载网页的各个部分，如图片、脚本等等。而且不同的浏览器对同一个网页打开的并发连接数量也会有所不同。</p>
<h3 id="worker-rlimit-nofile-1"><a href="#worker-rlimit-nofile-1" class="headerlink" title="worker_rlimit_nofile"></a>worker_rlimit_nofile</h3><p>由于每一个socket都会打开一个文件描述符，所以服务器可以同时处理连接数量受到系统文件描述符数量的限制。如果nginx打开的socket数量超过了文件描述符的数量，那么在error.log文件中会出现too many opened files错误。我们可以用下面的命令来查看文件描述符的数量：</p>
<pre class="line-numbers language-none"><code class="language-none">$ ulimit -n<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Nginx worker进程默认的用户名是www-data，用户www-data所拥有的文件描述符的数量要大于worker进程数量与worker_connections之乘积。 nginx有一个worker_rlimit_nofile directive，可以用来设置系统可用的文件描述符。这与ulimit设置可用文件描述符的作用是一样的。如果它们都设置了可用文件描述符，那么worker_rlimit_nofile会覆盖ulimit的设置。</p>
<pre class="line-numbers language-none"><code class="language-none">worker_rlimit_nofile 20960;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看操作系统对一个进程施加的限制，我们可以用命令读取/etc/$pid/limits文件，$pid是进程的pid。</p>
<h3 id="multi-accept-1"><a href="#multi-accept-1" class="headerlink" title="multi_accept"></a>multi_accept</h3><p>multi_accept可以让nginx worker进程尽可能多地接受请求。它的作用是让worker进程一次性地接受监听队列里的所有请求，然后处理。如果multi_accept的值设为off，那么worker进程必须一个一个地接受监听队列里的请求。</p>
<pre class="line-numbers language-none"><code class="language-none">events &#123;
 multi_accept on;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>默认Nginx没有开启multi_accept。</p>
<p>如果web服务器面对的是一个持续的请求流，那么启用multi_accept可能会造成worker进程一次接受的请求大于worker_connections指定可以接受的请求数。这就是overflow，这个overflow会造成性能损失，overflow这部分的请求不会受到处理。</p>
<h3 id="use"><a href="#use" class="headerlink" title="use"></a>use</h3><p>Nginx处理请求的方法有很多种，每一个方法都允许Nginx Worker进程监测多个socket文件描述符。这些方法都分别依赖于特定的平台，用于生成Nginx二进制文件的configure命令会选择适合当前平台的最有效的方法。如果要使用另外的方法，那么我们必须先启用这些方法。</p>
<p>我们可以用use这个directive来选择另外的处理请求的方法。use directive属于events模块。</p>
<pre class="line-numbers language-none"><code class="language-none">events &#123;
 use select;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Nginx支持以下请求处理方法：</p>
<ul>
<li>select: 这是一种标准的请求处理方法。如果一个平台上缺少相应的更加有效的方法，那么Nginx会自动使用select方法。</li>
<li>poll: 这是一种标准的请求处理方法。如果一个平台上缺少相应的更加有效的方法，那么Nginx会自动使用poll方法。</li>
<li>kqueue: 这是BSD家族操作系统上可用的一种高效的请求处理方法。可用于FreeBSD, OpenBSD, NetBSD和OS X。kqueue方法会忽略multi_accept。</li>
<li>epoll: 这是Linux系统上可用的一种高效的请求处理方法，类似于kqueue。它有一个额外的directive，那就是epoll_events。epoll_events指定了Nginx可以向内核传递的事件数量。默认的值是512。</li>
</ul>
<h2 id="Nginx的I-O配置"><a href="#Nginx的I-O配置" class="headerlink" title="Nginx的I/O配置"></a>Nginx的I/O配置</h2><h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p>当一个程序需要传输文件时，Linux内核首先将文件数据缓冲，然后将文件数据传送给程序缓冲，最后程序将文件数据传输到目的地。Sendfile方法是一种数据传输的更高效的方法，数据在内核中的文件描述符之间传输，而不需要将数据传输给程序缓冲。这种方法的结果是改善了对操作系统资源的利用。</p>
<p>我们可以用sendfile directive来启用sendfile方法，在http,server,location三个模块都可以定义。</p>
<pre class="line-numbers language-none"><code class="language-none">http &#123;
 sendfile on ;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>默认情况下，sendfile 的值是on。</p>
<h3 id="Direct-I-O"><a href="#Direct-I-O" class="headerlink" title="Direct I/O"></a>Direct I/O</h3><p>通常，Linux内核会尝试优化和缓存读写请求。数据缓存在内核里，将来任何的读取相同数据的请求会变得更快，因为不需要从缓慢的硬盘中读取数据。</p>
<p>Direct I/O是文件系统的一个功能，它允许程序绕过内核缓存，直接在硬盘上读写数据，这可以充分利用CPU频数，改善缓存的有效性。Directo I/O适用于访问率少的数据。这些数据不需要缓存在任何位置。我们可以用directio directive来启用这一功能，在http, server和location当中定义。</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;video&#x2F; &#123;
 directio 4m;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在上面的设置中，任何大于4M的文件都将以Direct I/O的形式直接从硬盘读取。默认directio没有启用。</p>
<p>如果某个请求是通过directo I/O,那么这个请求不能使用sendfile功能。</p>
<p>Direct I/O取决于硬盘的块大小。Nginx可以使用directio_alignment directive来设置块大小，在http, server, location中定义</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;video&#x2F; &#123;
 directio 4m;
 directio_alignment 512;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>512字节适用于大多数情况。如果Linux文件系统是XFS，那么块大小应该为4KB。</p>
<h3 id="异步I-O"><a href="#异步I-O" class="headerlink" title="异步I/O"></a>异步I/O</h3><p>异步I/O允许一个进程在不阻塞和等待的情况下进行I/O操作。</p>
<p>aio在http, server和location中定义。Linux2.6.22+和FreeBSD4.3支持aio。</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;data &#123;
 aio on;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>默认情况下，aio是关闭的。在Linux发行版上，要先启用directio后才能启用aio。在FreeBSD上，必须先关闭sendfile才能让aio生效。</p>
<p>如果Nginx没有–with-file-aio这个模块，那么启用aio会导致unknown directive aio错误。</p>
<p>aio可以指定线程数，这个多线程功能只在Linux发行版上才可用，并且只能在epoll, kqueue 或 eventport方法下可用。</p>
<p>为了使用多线程，在编译Nginx时要添加–with-threads选项。然后在/etc/nignx/nignx.conf文件中使用一个全局设置。</p>
<pre class="line-numbers language-none"><code class="language-none">thread_pool io_pool threads&#x3D;16;
 http &#123;
 ....
 location &#x2F;data &#123;
 sendfile on;
 aio threads&#x3D;io_pool;
 &#125;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="综合I-O设置"><a href="#综合I-O设置" class="headerlink" title="综合I/O设置"></a>综合I/O设置</h3><p>这三个directive可以综合起来实现不同的目标。在下面的配置中，如果文件的大小小于directio指定的大小，那么使用sendfile功能。以异步I/O的方式读取directio服务的文件。</p>
<pre class="line-numbers language-none"><code class="language-none">location &#x2F;archived-data&#x2F; &#123;
 send file on;
 aio on;
 directio 4m;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Nginx的TCP配置"><a href="#Nginx的TCP配置" class="headerlink" title="Nginx的TCP配置"></a>Nginx的TCP配置</h2><p>HTTP是一个应用层协议，在传输层使用TCP协议。在TCP协议中，数据是以一块一块的TCP数据包传输的。Nginx提供了多个directive，可以用来调整TCP栈。</p>
<h3 id="TCP-NODELAY"><a href="#TCP-NODELAY" class="headerlink" title="TCP_NODELAY"></a>TCP_NODELAY</h3><p>TCP/IP网络有一个“小数据包”的问题，如果一条信息中只有一个字符，那么网络可能会堵塞。这样的数据包大小为41字节，其中TCP信头40字节，内容为1字节。像这种小数据包，它们的开销是4000%。大量的小数据包可以迅速让网络饱和。</p>
<p>John Nagle发明了Nagle算法，它在一定的时间段，将小数据包暂存，将这些小数据包集合起来，整合为一个数据包发送，在下一个时间段又是如此。这改善了网络传输的效率。时间段通常为200ms。</p>
<p>但值得注意的是，小数据包的问题在telnet的通信过程中仍然存在。在telnet中，每一次敲键都分别在网络发送。不过这跟web服务器没有关联。web服务器发送的文件大多是大数据包，所以它们会被立即发送，而不需要等待200ms。</p>
<p>TCP_NODELAY可以用来关闭Nagle的缓冲算法，将数据尽快地发送。Nginx可以在http, server, location当中定义</p>
<pre class="line-numbers language-none"><code class="language-none">http &#123;
tcp_nodelay on;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Nginx默认启用了tcp_nodelay。Nginx在keep-alive模式下会使用tcp_nodelay。</p>
<h3 id="TCP-CORK"><a href="#TCP-CORK" class="headerlink" title="TCP_CORK"></a>TCP_CORK</h3><p>除了Nagle算法外，Linux内核提供了一个TCP_CORK选项，也可以解决小数据包问题。TCP_CORK告诉TCP栈将数据包附加在另外一个数据包，当数据包饱和时或程序明确地指示发送时再发送。在FreeBSD和Mac OS系统上，TCP_NOPUSH选项相当于TCP_CORK。</p>
<p>Nginx可以在http, server和location模块中定义tcp_nopush。</p>
<pre class="line-numbers language-none"><code class="language-none">http &#123;
 tcp_nopush on;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>Nginx默认启用了tcp_nopush</p>
<p>上面的两个directives负责不同的任务。tcp_nodelay可以降低网络延迟，而tcp_nopush可以优化发送的数据包。</p>
<p>同时启用tcp_nopush和sendfile可以确保在传输文件时，内核总是生成最大量的完整TCP数据包以供传输，而最后一个TCP数据包可以是不完整的，这个不完整的数据包</p>
<h2 id="大综合"><a href="#大综合" class="headerlink" title="大综合"></a>大综合</h2><p>下面的配置综合了前面所讨论的worker进程配置、I/O配置、TCP配置。</p>
<pre class="line-numbers language-none"><code class="language-none">worker_processes 1;     ＃假设CPU为单核
worker_rlimit_nofile 8000;

events &#123;
 multi_accept on;
 use epoll;
 worker_connections 1024;
 &#125;

http &#123;
 sendfile on;
 aio on;
 directio 4m;
 tcp_nopush on;
 tcp_nodelay on;
 &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>做完上述配置后，重启nginx</p>
<pre class="line-numbers language-none"><code class="language-none">sudo service nginx restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="性能测试对比"><a href="#性能测试对比" class="headerlink" title="性能测试对比"></a>性能测试对比</h2><p>做上述修改前，主页负载测试结果如下，平均花费4814毫秒加载完主页。</p>
<p><img src="nginx%E9%85%8D%E7%BD%AE.assets/Selection_104-1.png" alt="Nginx服务器性能优化"></p>
<p>做修改后，主页负载测试结果如下，平均花费3851毫秒加载完主页，节约1秒钟。不过从下图中可以看到虽然样本时间下降了，延迟却有所上升。当连接数少时，延迟在500ms左右，而当连接数多时，延迟却升到了2000多。</p>
<p><img src="nginx%E9%85%8D%E7%BD%AE.assets/Selection_111.png" alt="Nginx服务器性能优化"></p>
<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><p>nginx设置，如location的匹配顺序、rewrite等，单从手册和别人的说明，都不如调试更加直观。调试，能直观的看到location等配置的过程，效果，这样就能更加确定匹配方式。个人目前，想到一下方式进行调试。</p>
<h2 id="set方法"><a href="#set方法" class="headerlink" title="set方法"></a>set方法</h2><p>通过set来测试是否匹配到特殊的指令块，如if、location等。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">server</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">set</span> <span class="token variable">$loginfo</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">-</span>e <span class="token variable">$request_filename</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">set</span> <span class="token variable">$loginfo</span> <span class="token number">1234</span><span class="token punctuation">;</span>
        <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token operator">/</span>$<span class="token number">1</span> last<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">add_header</span> <span class="token string">'Log-Info'</span> <span class="token variable">$loginfo</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<p>调试过程：</p>
<p><img src="nginx%E9%85%8D%E7%BD%AE.assets/1586766155163.png" alt="1586766155163"></p>
<p>查看匹配结果</p>
<pre class="line-numbers language-none"><code class="language-none">http:&#x2F;&#x2F;dev.announce.com:30029&#x2F;admin&#x2F;index&#x2F;index.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<p><img src="nginx%E9%85%8D%E7%BD%AE.assets/1586760006026.png" alt="1586760006026"></p>
<p>但是，如果proxy_pass返回错误，结果标记  Loginfo  就看不到了。</p>
<h2 id="add-header-1"><a href="#add-header-1" class="headerlink" title="add_header"></a>add_header</h2><p>add_header不能在if模块内设置，但是可以通过set 变量，然后将此变量在通过add_header的来显示。</p>
<h2 id="deny"><a href="#deny" class="headerlink" title="deny"></a>deny</h2><p>deny all。先匹配到的location会直接返回。</p>
<h2 id="return-1"><a href="#return-1" class="headerlink" title="return"></a>return</h2><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">return</span> <span class="token number">302</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="配合nodejs"><a href="#配合nodejs" class="headerlink" title="配合nodejs"></a>配合nodejs</h2><h2 id="调试环境搭建"><a href="#调试环境搭建" class="headerlink" title="调试环境搭建"></a>调试环境搭建</h2><p>使用docker-compose等方式。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/nginx/" rel="tag"># nginx</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/04/07/docker-compose/%E4%BD%BF%E7%94%A8docker-compose%E9%83%A8%E7%BD%B2lnmp%E7%8E%AF%E5%A2%83/" rel="prev" title="使用docker-compose部署lnmp环境">
                  <i class="fa fa-chevron-left"></i> 使用docker-compose部署lnmp环境
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/04/09/nginx/Nginx+Lua%E5%AE%9E%E7%8E%B0%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/" rel="next" title="Nginx+Lua实现灰度发布">
                  Nginx+Lua实现灰度发布 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">豫ICP备17029463号-1 </a>
  </div>

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chaofml</span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  







  






</body>
</html>
